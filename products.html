<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الأعمال - المنتجات والمخزون</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/accounting.css">
    <link rel="stylesheet" href="css/accounting-fix.css">
    <link rel="stylesheet" href="css/chart-of-accounts.css">
    <link rel="stylesheet" href="css/action-buttons-horizontal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* تنسيق متناسق مع باقي الصفحات */
        .products-management-modern {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px 0;
        }
        
        .section-header-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title h3 {
            margin: 0 0 5px 0;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .header-title p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-modern {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }
        
        /* البطاقات الإحصائية */
        .stats-section-modern {
            padding: 25px;
            background: #f8f9fa;
        }
        
        .stats-grid-modern {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .stat-card-modern {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .stat-card-modern:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon-modern {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .stat-card-modern.primary .stat-icon-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-card-modern.success .stat-icon-modern {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .stat-card-modern.warning .stat-icon-modern {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
        }
        
        .stat-card-modern.danger .stat-icon-modern {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .stat-content-modern h4 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .stat-value-modern {
            font-size: 1.8rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 5px;
        }
        
        .stat-change-modern {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .stat-change-modern.positive {
            color: #28a745;
        }
        
        .stat-change-modern.negative {
            color: #dc3545;
        }
        
        /* أدوات البحث والتصفية */
        .search-filters-modern {
            padding: 20px 25px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box-modern {
            position: relative;
            flex: 1;
            min-width: 250px;
        }
        
        .search-box-modern i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .input-modern {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        
        .input-modern:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filters-modern {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-select-modern {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .filter-select-modern:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #6c757d;
            color: #6c757d;
        }
        
        .btn-outline:hover {
            background: #6c757d;
            color: white;
        }
        
        /* جدول المنتجات */
        .table-container-modern {
            background: white;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }
        
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .modern-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px 10px;
            text-align: right;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        .modern-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .modern-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }
        
        .badge.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .badge.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .badge.danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .badge.primary {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* تحسينات للأيقونات الأفقية */
        .action-buttons-horizontal {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            gap: 6px !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 3px !important;
            width: 100% !important;
            min-width: 120px !important;
        }
        
        .action-buttons-horizontal .action-btn {
            width: 30px !important;
            height: 30px !important;
            min-width: 30px !important;
            max-width: 30px !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            margin: 0 !important;
            padding: 0 !important;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
        }
        
        .action-buttons-horizontal .action-btn.edit {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%) !important;
            color: white !important;
        }
        
        .action-buttons-horizontal .action-btn.view {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
            color: white !important;
        }
        
        .action-buttons-horizontal .action-btn.delete {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            color: white !important;
        }
        
        .action-buttons-horizontal .action-btn:hover {
            transform: translateY(-1px) scale(1.05) !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3) !important;
        }

        /* أنماط النوافذ المنبثقة */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content-modern {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header-modern h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body-modern {
            padding: 20px;
        }

        .form-modern {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .select-modern, .textarea-modern {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .select-modern:focus, .textarea-modern:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* تحسينات إضافية */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 15px;
            color: #495057;
            text-decoration: none;
            transition: background 0.2s;
        }

        .dropdown-menu a:hover {
            background: #f8f9fa;
        }

        .table-footer-modern {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-info-modern {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .pagination-modern {
            display: flex;
            gap: 5px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover {
            background: #e9ecef;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* أنماط معاينة الفئة */
        .category-preview {
            padding: 15px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            text-align: center;
            margin-top: 5px;
        }

        .category-preview .badge {
            font-size: 1rem;
            padding: 8px 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .category-preview .badge i {
            font-size: 1.1rem;
        }

        /* ألوان إضافية للفئات */
        .badge.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .badge.secondary {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        /* تحسينات للنموذج */
        .form-group label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group label::before {
            content: '';
            width: 3px;
            height: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* تحسينات للحقول */
        .input-modern:focus, .select-modern:focus, .textarea-modern:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* رسائل التحقق */
        .field-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .success-message {
            color: #28a745;
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* أنماط نافذة عرض المنتج */
        .product-details-view {
            max-height: 70vh;
            overflow-y: auto;
        }

        .details-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .details-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .detail-value {
            font-weight: 600;
            color: #212529;
        }

        .detail-value.price {
            color: #28a745;
            font-size: 1.1rem;
        }

        .detail-value.cost {
            color: #ffc107;
        }

        .detail-value.profit {
            color: #17a2b8;
        }

        .detail-value.percentage {
            color: #6f42c1;
        }

        .detail-value.quantity {
            color: #fd7e14;
        }

        .detail-value.total {
            color: #dc3545;
            font-size: 1.1rem;
        }

        .detail-value.code {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .description-text {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            line-height: 1.6;
            color: #495057;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quick-stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid;
        }

        .quick-stat-item.success {
            border-left-color: #28a745;
        }

        .quick-stat-item.info {
            border-left-color: #17a2b8;
        }

        .quick-stat-item.warning {
            border-left-color: #ffc107;
        }

        .quick-stat-item i {
            font-size: 1.5rem;
            opacity: 0.7;
        }

        .quick-stat-content {
            display: flex;
            flex-direction: column;
        }

        .quick-stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #212529;
        }

        .quick-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* أنماط قسم الفئات */
        .categories-section-modern {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            padding: 15px;
        }

        .section-header-small {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .section-header-small h4 {
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .categories-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .categories-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .category-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #e9ecef;
        }

        .category-actions {
            display: flex;
            gap: 5px;
        }

        .category-actions button {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .edit-category-btn {
            color: #17a2b8;
        }

        .edit-category-btn:hover {
            background: #17a2b8;
            color: white;
        }

        .delete-category-btn {
            color: #dc3545;
        }

        .delete-category-btn:hover {
            background: #dc3545;
            color: white;
        }
        
        /* أنماط نافذة تعديل المنتج */
        .product-stats-edit {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .stat-label {
            display: block;
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-weight: 700;
            font-size: 1rem;
        }

        .stat-value.profit {
            color: #28a745;
        }

        .stat-value.percentage {
            color: #17a2b8;
        }

        .stat-value.total {
            color: #dc3545;
        }

        /* تحسينات للنوافذ المنبثقة */
        .modal-content-modern {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-overlay {
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* تحسينات للأزرار */
        .btn-modern:hover {
            transform: translateY(-1px);
        }

        .btn-modern:active {
            transform: translateY(0);
        }

        /* ========== شريط التنقل الرئيسي الموحد ========== */
        .main-header {
            background: linear-gradient(to left, #0078ff, #00c3ff);
            color: white;
            padding: 10px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            height: 70px;
        }

        .main-header .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            height: 100%;
        }

        .main-header .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .main-header .logo i {
            font-size: 28px;
            color: #f39c12;
        }

        .main-header .logo h1 {
            font-size: 24px;
            margin: 0;
            font-weight: 600;
            color: white;
        }

        .main-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 0;
        }

        .main-nav li {
            margin: 0;
        }

        .main-nav a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            height: 50px;
            box-sizing: border-box;
        }

        .main-nav a:hover {
            background: rgba(255,255,255,0.1);
            border-bottom-color: #f39c12;
            transform: translateY(-1px);
        }

        .main-nav a.active {
            background: rgba(255,255,255,0.15);
            border-bottom-color: #f39c12;
            font-weight: 600;
        }

        .main-nav a i {
            font-size: 16px;
            width: 18px;
            text-align: center;
        }

        /* استجابة للشاشات الصغيرة */
        @media (max-width: 768px) {
            .main-header .container {
                flex-direction: column;
                height: auto;
                padding: 10px 20px;
            }

            .main-header .logo {
                margin-bottom: 10px;
            }

            .main-nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 5px;
            }

            .main-nav a {
                padding: 12px 15px;
                font-size: 13px;
                height: auto;
            }

            .main-header .logo h1 {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .main-nav ul {
                flex-direction: column;
                width: 100%;
            }

            .main-nav a {
                justify-content: center;
                padding: 15px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
        }
    </style>
</head>
<body>
    <!-- شريط التنقل العلوي -->
    <header class="main-header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>نظام إدارة الأعمال</h1>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
                    <li><a href="sales.html"><i class="fas fa-shopping-cart"></i> المبيعات</a></li>
                    <li><a href="purchases.html"><i class="fas fa-truck"></i> المشتريات</a></li>
                    <li><a href="customers.html"><i class="fas fa-users"></i> العملاء</a></li>
                    <li><a href="suppliers.html"><i class="fas fa-user-tie"></i> الموردين</a></li>
                    <li><a href="products.html" class="active"><i class="fas fa-boxes"></i> المخزون</a></li>
                    <li><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
                    <li><a href="accounting.html"><i class="fas fa-calculator"></i> الحسابات</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- محتوى الصفحة -->
    <main class="main-content">
        <div class="container">
            <!-- قسم إدارة المنتجات والمخزون -->
            <div class="products-management-modern">
                <!-- رأس القسم -->
                <div class="section-header-modern">
                    <div class="header-title">
                        <h3><i class="fas fa-boxes"></i> إدارة المنتجات والمخزون</h3>
                        <p>إدارة شاملة للمنتجات ومراقبة المخزون والأجهزة الإلكترونية</p>
                    </div>
                    <div class="header-actions">
                        <!-- تم حذف زر استيراد وتصدير والقائمة المنسدلة المرتبطة به -->
                        <button class="btn-modern" onclick="showAddProductModal()" style="background: #007bff; color: white; margin-left: 10px;">
                            <i class="fas fa-plus-circle"></i>
                            منتج جديد
                        </button>
                        <button class="btn-modern" onclick="showAddCategoryModal()" style="background: #6c757d; color: white; margin-left: 10px;">
                            <i class="fas fa-plus-circle"></i>
                            فئة جديدة
                        </button>
                        <button class="btn-modern" onclick="showStockMovements()" style="background: #28a745; color: white; margin-left: 10px;">
                            <i class="fas fa-exchange-alt"></i>
                            حركات المخزون
                        </button>
                        <button class="btn-modern" onclick="showLowStockAlert()" style="background: #ffc107; color: #212529;">
                            <i class="fas fa-exclamation-triangle"></i>
                            تنبيه المخزون المنخفض
                        </button>
                    </div>
                </div>

                <!-- تم حذف البطاقات الإحصائية لعدم ارتباطها بالبيانات الفعلية -->

                <!-- أدوات البحث والتصفية -->
                <div class="search-filters-modern">
                    <div class="search-box-modern">
                        <i class="fas fa-search"></i>
                        <input type="text" id="product-search" placeholder="البحث في المنتجات..." class="input-modern">
                        <div class="search-suggestions" id="search-suggestions"></div>
                    </div>
                <!-- تم إزالة قسم الفلاتر -->
            </div>

            <!-- قسم عرض الفئات -->
            <div class="categories-section-modern">
                <div class="section-header-small">
                    <h4><i class="fas fa-list"></i> الفئات</h4>
                    <button class="btn-modern btn-secondary btn-sm" onclick="showAddCategoryModal()">
                        <i class="fas fa-plus-circle"></i> فئة جديدة
                    </button>
                </div>
                <div class="categories-container">
                    <ul class="categories-list" id="categories-list">
                        <!-- سيتم تحميل الفئات ديناميكياً -->
                    </ul>
                </div>
            </div>

                <!-- جدول المنتجات -->
                <div class="table-container-modern">
                    <table class="modern-table products-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> رقم المنتج</th>
                                <th><i class="fas fa-tag"></i> اسم المنتج</th>
                                <th><i class="fas fa-list"></i> الفئة</th>
                                <th><i class="fas fa-barcode"></i> الرمز</th>
                                <th><i class="fas fa-dollar-sign"></i> السعر</th>
                                <th><i class="fas fa-coins"></i> التكلفة</th>
                                <th><i class="fas fa-warehouse"></i> الكمية</th>
                                <th><i class="fas fa-exclamation-triangle"></i> الحد الأدنى</th>
                                <th><i class="fas fa-info-circle"></i> الحالة</th>
                                <th><i class="fas fa-cogs"></i> الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- سيتم تحميل المنتجات ديناميكياً -->
                        </tbody>
                    </table>

                    <!-- نظام التنقل الموحد -->
                    <div id="pagination"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- تذييل الصفحة -->
    <footer class="main-footer">
        <div class="container">
            <p>جميع الحقوق محفوظة &copy; 2023 - نظام إدارة الأعمال</p>
        </div>
    </footer>

    <!-- ربط ملف JavaScript -->
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <!-- <script src="js/products.js"></script> -->

    <!-- استخدام الوحدات بدلاً من ذلك -->
    <script type="module">
        import * as ProductCore from './js/products/product-core.js';
        import * as ProductUI from './js/products/product-ui.js';
        import * as ProductImportExport from './js/products/product-import-export.js';
        
        // تعريف الوظائف في النطاق العالمي للوصول إليها من HTML
        window.showAddProductModal = ProductUI.showAddProductModal;
        window.editProduct = ProductUI.editProduct;
        window.viewProduct = ProductUI.viewProduct;
        window.deleteProduct = ProductUI.deleteProduct;
        window.saveProduct = ProductCore.saveProduct;
        window.updateProduct = ProductCore.updateProduct;
        window.closeModal = ProductUI.closeModal;
        window.showAddCategoryModal = ProductUI.showAddCategoryModal;
        window.saveCategory = ProductCore.saveCategory;
        window.showStockMovements = ProductUI.showStockMovements;
        window.showLowStockAlert = ProductUI.showLowStockAlert;
        window.exportToExcel = ProductImportExport.exportToExcel;
        window.exportToCSV = ProductImportExport.exportToCSV;
        window.downloadTemplate = ProductImportExport.downloadTemplate;
        window.toggleDropdown = ProductUI.toggleDropdown;
        window.changePage = ProductCore.changePage;
        window.searchProducts = ProductCore.searchProducts;
        window.clearProductSearch = ProductCore.clearProductSearch;
        
        // تنفيذ الوظائف عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            ProductCore.loadProductsFromCentralSystem();
            ProductCore.displayCategories();
            ProductCore.setupInventoryMonitoring();
            ProductUI.initializeEventListeners();
        });
    </script>

    <script>
        // إجبار الأيقونات على أن تكون أفقية
        // معالجة نموذج استيراد البيانات
        document.addEventListener('DOMContentLoaded', function() {
            const importForm = document.getElementById('import-form');
            if (importForm) {
                importForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const fileInput = document.getElementById('excel-file');
                    const file = fileInput.files[0];
                    
                    if (!file) {
                        alert('الرجاء اختيار ملف للاستيراد');
                        return;
                    }
                    
                    // هنا يمكن إضافة كود لقراءة ملف Excel/CSV ومعالجته
                    // في هذا المثال، سنعرض رسالة نجاح فقط
                    
                    setTimeout(() => {
                        alert(`تم استيراد البيانات بنجاح من الملف: ${file.name}`);
                        closeModal('import-modal');
                        fileInput.value = ''; // إعادة تعيين حقل الملف
                    }, 1000);
                });
            }

            function forceHorizontalButtons() {
                const containers = document.querySelectorAll('.action-buttons-horizontal');
                containers.forEach(container => {
                    // إجبار الـ flexbox في صف واحد
                    container.style.setProperty('display', 'flex', 'important');
                    container.style.setProperty('flex-direction', 'row', 'important');
                    container.style.setProperty('flex-wrap', 'nowrap', 'important');
                    container.style.setProperty('gap', '6px', 'important');
                    container.style.setProperty('justify-content', 'center', 'important');
                    container.style.setProperty('align-items', 'center', 'important');
                    container.style.setProperty('padding', '3px', 'important');
                    container.style.setProperty('width', '100%', 'important');
                    container.style.setProperty('min-width', '120px', 'important');

                    // تطبيق الأنماط على الأزرار
                    const buttons = container.querySelectorAll('.action-btn');
                    buttons.forEach((btn, index) => {
                        btn.style.setProperty('display', 'flex', 'important');
                        btn.style.setProperty('width', '30px', 'important');
                        btn.style.setProperty('height', '30px', 'important');
                        btn.style.setProperty('min-width', '30px', 'important');
                        btn.style.setProperty('max-width', '30px', 'important');
                        btn.style.setProperty('margin', '0', 'important');
                        btn.style.setProperty('padding', '0', 'important');
                        btn.style.setProperty('border-radius', '6px', 'important');
                        btn.style.setProperty('align-items', 'center', 'important');
                        btn.style.setProperty('justify-content', 'center', 'important');
                        btn.style.setProperty('border', 'none', 'important');
                        btn.style.setProperty('cursor', 'pointer', 'important');
                        btn.style.setProperty('font-size', '12px', 'important');
                        btn.style.setProperty('flex-shrink', '0', 'important');
                        btn.style.setProperty('flex-grow', '0', 'important');

                        // الألوان
                        if (btn.classList.contains('edit')) {
                            btn.style.setProperty('background', 'linear-gradient(135deg, #ffc107 0%, #ff8f00 100%)', 'important');
                            btn.style.setProperty('color', 'white', 'important');
                        } else if (btn.classList.contains('view')) {
                            btn.style.setProperty('background', 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)', 'important');
                            btn.style.setProperty('color', 'white', 'important');
                        } else if (btn.classList.contains('delete')) {
                            btn.style.setProperty('background', 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)', 'important');
                            btn.style.setProperty('color', 'white', 'important');
                        }
                    });
                });
            }

            // تطبيق التنسيق فوراً
            forceHorizontalButtons();

            // إعادة تطبيق التنسيق كل ثانية للتأكد
            setInterval(forceHorizontalButtons, 1000);
            
            // عرض الفئات عند تحميل الصفحة
            displayCategories();
        });

        // وظائف إدارة المنتجات
        function showAddProductModal() {
            console.log('فتح نافذة إضافة منتج جديد...');

            // منع التمرير في الخلفية
            document.body.style.overflow = 'hidden';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content-modern" style="max-width: 800px;">
                    <div class="modal-header-modern">
                        <h3><i class="fas fa-plus"></i> إضافة منتج جديد</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body-modern">
                        <form class="form-modern" id="new-product-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>رقم المنتج</label>
                                    <input type="text" class="input-modern" value="PROD-006" readonly>
                                </div>
                                <div class="form-group">
                                    <label>اسم المنتج</label>
                                    <input type="text" class="input-modern" placeholder="اسم المنتج" id="product-name">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>الفئة</label>
                                    <select class="select-modern" id="product-category">
                                        <option value="">اختر الفئة</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>رمز المنتج</label>
                                    <input type="text" class="input-modern" placeholder="رمز المنتج" id="product-code">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>سعر البيع</label>
                                    <input type="number" class="input-modern" placeholder="0.00" step="0.01" id="product-price">
                                </div>
                                <div class="form-group">
                                    <label>سعر التكلفة</label>
                                    <input type="number" class="input-modern" placeholder="0.00" step="0.01" id="product-cost">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>الكمية الحالية</label>
                                    <input type="number" class="input-modern" placeholder="0" min="0" id="product-quantity">
                                </div>
                                <div class="form-group">
                                    <label>الحد الأدنى</label>
                                    <input type="number" class="input-modern" placeholder="0" min="0" id="product-min-stock">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>وصف المنتج</label>
                                <textarea class="textarea-modern" rows="3" placeholder="وصف المنتج..." id="product-description"></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-modern btn-primary" onclick="saveProduct()">
                                    <i class="fas fa-save"></i> حفظ المنتج
                                </button>
                                <button type="button" class="btn-modern btn-secondary" onclick="closeModal(this)">
                                    <i class="fas fa-times"></i> إلغاء
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // إضافة وظيفة إغلاق عند الضغط على الخلفية
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.close-btn'));
                }
            });

            // تحديث قوائم الفئات من النظام المركزي
            setTimeout(() => {
                updateAllCategorySelects();
            }, 100);
        }

        function editProduct(productId) {
            console.log('تعديل المنتج:', productId);

            // الحصول على بيانات المنتج (محاكاة)
            const productData = getProductData(productId);

            if (!productData) {
                alert('لم يتم العثور على المنتج');
                return;
            }

            // منع التمرير في الخلفية
            document.body.style.overflow = 'hidden';

            const modal = document.createElement('div');
            modal.className = 'modal edit-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                animation: fadeIn 0.3s ease;
            `;
            
            // الحصول على الفئات من النظام المركزي
            const categories = window.dataManager ? window.dataManager.getCategories() : [];
            
            // إنشاء خيارات الفئات ديناميكياً
            let categoryOptions = '<option value="">اختر الفئة</option>';
            categories.forEach(category => {
                categoryOptions += `<option value="${category.code}" ${productData.category === category.code ? 'selected' : ''}>${category.name}</option>`;
            });
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    max-width: 700px;
                    width: 90%;
                    max-height: 85vh;
                    overflow: hidden;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    animation: slideIn 0.3s ease;
                ">
                    <div style="
                        background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
                        color: white;
                        padding: 20px 25px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-edit"></i>
                            تعديل المنتج
                        </h3>
                        <button onclick="closeProductEditModal()" style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 24px;
                            cursor: pointer;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">
                            &times;
                        </button>
                    </div>

                    <div style="padding: 25px; max-height: 60vh; overflow-y: auto;">
                        <form id="editProductForm" class="form-modern">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                        <i class="fas fa-hashtag" style="color: #ffc107;"></i>
                                        رقم المنتج
                                    </label>
                                    <input type="text" value="${productData.id}" readonly style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e9ecef;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                        background: #f8f9fa;
                                        color: #6c757d;
                                    ">
                                </div>

                                <div>
                                    <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                        <i class="fas fa-tag" style="color: #ffc107;"></i>
                                        اسم المنتج
                                    </label>
                                    <input type="text" id="editProductName" value="${productData.name}" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e9ecef;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                        transition: border-color 0.3s ease;
                                    " onfocus="this.style.borderColor='#ffc107'" onblur="this.style.borderColor='#e9ecef'">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                        <i class="fas fa-list" style="color: #ffc107;"></i>
                                        الفئة
                                    </label>
                                    <select id="editProductCategory" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e9ecef;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                        background: white;
                                        cursor: pointer;
                                        transition: border-color 0.3s ease;
                                    " onfocus="this.style.borderColor='#ffc107'" onblur="this.style.borderColor='#e9ecef'">
                                        ${categoryOptions}
                                    </select>
                                </div>

                                <div>
                                    <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                        <i class="fas fa-barcode" style="color: #ffc107;"></i>
                                        رمز المنتج
                                    </label>
                                    <input type="text" id="editProductCode" value="${productData.code}" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e9ecef;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                        transition: border-color 0.3s ease;
                                        font-family: monospace;
                                    " onfocus="this.style.borderColor='#ffc107'" onblur="this.style.borderColor='#e9ecef'">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                        <i class="fas fa-dollar-sign" style="color: #ffc107;"></i>
                                        سعر البيع
                                    </label>
                                    <input type="number" id="editProductPrice" value="${productData.salePrice || productData.price || 0}" step="0.01" min="0" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e9ecef;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                        transition: border-color 0.3s ease;
                                    " onfocus="this.style.borderColor='#ffc107'" onblur="this.style.borderColor='#e9ecef'">
                                </div>

                                <div>
                                    <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                        <i class="fas fa-coins" style="color: #ffc107;"></i>
                                        سعر التكلفة</label>
                                    <input type="number" id="editProductCost" value="${productData.purchasePrice || productData.cost || 0}" step="0.01" min="0" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e9ecef;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                        transition: border-color 0.3s ease;
                                    " onfocus="this.style.borderColor='#ffc107'" onblur="this.style.borderColor='#e9ecef'">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                        <i class="fas fa-warehouse" style="color: #ffc107;"></i>
                                        الكمية الحالية
                                    </label>
                                    <input type="number" id="editProductQuantity" value="${productData.quantity}" min="0" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e9ecef;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                        transition: border-color 0.3s ease;
                                    " onfocus="this.style.borderColor='#ffc107'" onblur="this.style.borderColor='#e9ecef'">
                                </div>

                                <div>
                                    <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                        <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
                                        الحد الأدنى
                                    </label>
                                    <input type="number" id="editProductMinStock" value="${productData.minStock}" min="0" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e9ecef;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                        transition: border-color 0.3s ease;
                                    " onfocus="this.style.borderColor='#ffc107'" onblur="this.style.borderColor='#e9ecef'">
                                </div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                    <i class="fas fa-align-left" style="color: #ffc107;"></i>
                                    وصف المنتج
                                </label>
                                <textarea id="editProductDescription" rows="3" style="
                                    width: 100%;
                                    padding: 12px;
                                    border: 2px solid #e9ecef;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    box-sizing: border-box;
                                    transition: border-color 0.3s ease;
                                    resize: vertical;
                                    min-height: 80px;
                                " onfocus="this.style.borderColor='#ffc107'" onblur="this.style.borderColor='#e9ecef'" placeholder="وصف تفصيلي للمنتج...">${productData.description || ''}</textarea>
                            </div>

                            <div style="
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                border-left: 4px solid #ffc107;
                            ">
                                <h5 style="margin: 0 0 10px 0; color: #ffc107;">إحصائيات المنتج:</h5>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                    <div style="text-align: center;">
                                        <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">الربح المتوقع</p>
                                        <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600; color: #28a745;" id="editProfitMargin">${(productData.price - productData.cost).toFixed(2)} ر.س</p>
                                    </div>
                                    <div style="text-align: center;">
                                        <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">نسبة الربح</p>
                                        <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600; color: #17a2b8;" id="editProfitPercentage">${((productData.price - productData.cost) / productData.cost * 100).toFixed(1)}%</p>
                                    </div>
                                    <div style="text-align: center;">
                                        <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">قيمة المخزون</p>
                                        <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600; color: #6f42c1;" id="editStockValue">${(productData.cost * productData.quantity).toFixed(2)} ر.س</p>
                                    </div>
                                </div>
                            </div>

                            <div style="
                                display: flex;
                                gap: 12px;
                                justify-content: flex-end;
                                padding-top: 20px;
                                border-top: 1px solid #e9ecef;
                                margin-top: 20px;
                            ">
                                <button type="button" onclick="closeProductEditModal()" style="
                                    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 14px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <i class="fas fa-times"></i>
                                    إلغاء
                                </button>

                                <button type="submit" id="updateProductBtn" style="
                                    background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 14px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <i class="fas fa-save"></i>
                                    حفظ التعديلات
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // معالجة النموذج
            const form = document.getElementById('editProductForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                updateProduct(productId);
            });

            window.closeProductEditModal = function() {
                document.body.removeChild(modal);
                document.body.style.overflow = '';
            };

            // إضافة وظيفة إغلاق عند الضغط على الخلفية
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeProductEditModal();
                }
            });

            // إضافة مستمعات لتحديث الإحصائيات
            addEditProductListeners();
        }

        function viewProduct(productId) {
            console.log('عرض المنتج:', productId);

            // الحصول على بيانات المنتج (محاكاة)
            const productData = getProductData(productId);

            if (!productData) {
                alert('لم يتم العثور على المنتج');
                return;
            }

            // منع التمرير في الخلفية
            document.body.style.overflow = 'hidden';

            const modal = document.createElement('div');
            modal.className = 'modal view-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                animation: fadeIn 0.3s ease;
            `;
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow: hidden;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    animation: slideIn 0.3s ease;
                ">
                    <div style="
                        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
                        color: white;
                        padding: 20px 25px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-eye"></i>
                            تفاصيل المنتج
                        </h3>
                        <button onclick="closeProductViewModal()" style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 24px;
                            cursor: pointer;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">
                            &times;
                        </button>
                    </div>
                    <div style="padding: 25px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">رقم المنتج</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600;">${productData.id}</p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">اسم المنتج</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600;">${productData.name}</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">الفئة</label>
                                <p style="margin: 5px 0 0 0;">
                                    <span class="badge ${productData.categoryColor}">${productData.categoryName}</span>
                                </p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">رمز المنتج</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-family: monospace; background: #f8f9fa; padding: 5px 10px; border-radius: 4px; display: inline-block;">${productData.code}</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">سعر البيع</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.2rem; font-weight: 600; color: #28a745;">${productData.salePrice || productData.price || 0} ر.س</p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">سعر التكلفة</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem; color: #dc3545;">${productData.purchasePrice || productData.cost || 0} ر.س</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">الربح المتوقع</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600; color: #17a2b8;">${((productData.salePrice || productData.price || 0) - (productData.purchasePrice || productData.cost || 0)).toFixed(2)} ر.س</p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">نسبة الربح</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600; color: #ffc107;">${(((productData.salePrice || productData.price || 0) - (productData.purchasePrice || productData.cost || 0)) / (productData.purchasePrice || productData.cost || 1) * 100).toFixed(1)}%</p>
                            </div>
                        </div>


                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">الكمية الحالية</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600;">${productData.quantity} قطعة</p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">الحد الأدنى</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem;">${productData.minStock} قطعة</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">حالة المخزون</label>
                                <p style="margin: 5px 0 0 0;">
                                    <span class="badge ${productData.statusColor}">${productData.status}</span>
                                </p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">قيمة المخزون</label>
                                <p style="margin: 5px 0 0 0; font-size: 1.1rem; font-weight: 600; color: #6f42c1;">${((productData.purchasePrice || productData.cost || 0) * productData.quantity).toFixed(2)} ر.س</p>
                            </div>
                        </div>


                        ${productData.description ? `
                        <div style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: #6c757d; font-size: 0.9rem;">وصف المنتج</label>
                            <p style="margin: 5px 0 0 0; font-size: 1rem; line-height: 1.5; background: #f8f9fa; padding: 15px; border-radius: 8px;">${productData.description}</p>
                        </div>
                        ` : ''}

                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="closeProductViewModal(); editProduct('${productId}')" style="
                                background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-edit"></i>
                                تعديل
                            </button>
                            <button onclick="closeProductViewModal()" style="
                                background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-times"></i>
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // إضافة أنماط CSS للانيميشن
            if (!document.querySelector('#products-modal-animations')) {
                const style = document.createElement('style');
                style.id = 'products-modal-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { opacity: 0; transform: translateY(-50px) scale(0.9); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(modal);

            window.closeProductViewModal = function() {
                document.body.removeChild(modal);
                document.body.style.overflow = '';
            };

            // إضافة وظيفة إغلاق عند الضغط على الخلفية
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeProductViewModal();
                }
            });
        }

        function getProductData(productId) {
            console.log('البحث عن المنتج:', productId);

            // الحصول على البيانات الحقيقية من النظام المركزي
            if (window.dataManager) {
                const products = window.dataManager.getProducts();
                const product = products.find(p => p.id == productId || `PROD-${String(p.id).padStart(3, '0')}` === productId);
                if (product) {
                    console.log('تم العثور على المنتج:', product);
                    return product;
                }
            }

            // البحث في localStorage كبديل
            const savedProducts = JSON.parse(localStorage.getItem('monjizProducts')) || [];
            const product = savedProducts.find(p => p.id == productId || `PROD-${String(p.id).padStart(3, '0')}` === productId);
            if (product) {
                console.log('تم العثور على المنتج من localStorage:', product);
                return product;
            }

            // بيانات احتياطية للاختبار
            const fallbackProducts = {
                'PROD-001': {
                    id: 'PROD-001',
                    name: 'لابتوب Dell Inspiron 15',
                    category: 'computers',
                    categoryName: 'حاسوب ولوازمه',
                    categoryColor: 'primary',
                    code: 'DELL-INS-15-3000',
                    price: 2500,
                    cost: 2100,
                    quantity: 15,
                    minStock: 5,
                    status: 'متوفر',
                    statusColor: 'success',
                    description: 'لابتوب Dell Inspiron 15 بمعالج Intel Core i5 وذاكرة 8GB RAM وقرص صلب SSD 256GB'
                },
                'PROD-002': {
                    id: 'PROD-002',
                    name: 'iPhone 15 Pro Max',
                    category: 'phones',
                    categoryName: 'هواتف ذكية',
                    categoryColor: 'primary',
                    code: 'APPLE-IP15-PM-256',
                    price: 4200,
                    cost: 3800,
                    quantity: 8,
                    minStock: 3,
                    status: 'متوفر',
                    statusColor: 'success',
                    description: 'iPhone 15 Pro Max بسعة 256GB مع كاميرا Pro وشاشة Super Retina XDR'
                },
                'PROD-003': {
                    id: 'PROD-003',
                    name: 'Samsung Galaxy S24 Ultra',
                    category: 'phones',
                    categoryName: 'هواتف ذكية',
                    categoryColor: 'primary',
                    code: 'SAM-GS24-U-512',
                    price: 3800,
                    cost: 3400,
                    quantity: 12,
                    minStock: 5,
                    status: 'متوفر',
                    statusColor: 'success',
                    description: 'Samsung Galaxy S24 Ultra بسعة 512GB مع قلم S Pen وكاميرا 200MP'
                },
                'PROD-004': {
                    id: 'PROD-004',
                    name: 'MacBook Air M3',
                    category: 'computers',
                    categoryName: 'حاسوب ولوازمه',
                    categoryColor: 'primary',
                    code: 'APPLE-MBA-M3-512',
                    price: 5200,
                    cost: 4800,
                    quantity: 6,
                    minStock: 3,
                    status: 'متوفر',
                    statusColor: 'success',
                    description: 'MacBook Air مع معالج Apple M3 وذاكرة 16GB وقرص SSD 512GB'
                },
                'PROD-005': {
                    id: 'PROD-005',
                    name: 'iPad Pro 12.9 M4',
                    category: 'electronics',
                    categoryName: 'أجهزة إلكترونية',
                    categoryColor: 'primary',
                    code: 'APPLE-IPP-M4-1TB',
                    price: 4500,
                    cost: 4100,
                    quantity: 4,
                    minStock: 2,
                    status: 'منخفض',
                    statusColor: 'warning',
                    description: 'iPad Pro 12.9 بوصة مع معالج M4 وسعة 1TB وشاشة Liquid Retina XDR'
                }
            };

            const fallbackProduct = fallbackProducts[productId];
            if (fallbackProduct) {
                console.log('استخدام البيانات الاحتياطية للمنتج:', fallbackProduct);
                return fallbackProduct;
            }

            console.log('لم يتم العثور على المنتج:', productId);
            return null;
        }

        function updateProduct(productId) {
            const name = document.getElementById('editProductName').value.trim();
            const category = document.getElementById('editProductCategory').value;
            const code = document.getElementById('editProductCode').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const cost = parseFloat(document.getElementById('editProductCost').value);
            const quantity = parseInt(document.getElementById('editProductQuantity').value);
            const minStock = parseInt(document.getElementById('editProductMinStock').value);
            const description = document.getElementById('editProductDescription').value.trim();

            // التحقق من صحة البيانات
            if (!name || !category || !code || !price || !cost || quantity < 0 || minStock < 0) {
                alert('يرجى ملء جميع الحقول المطلوبة بقيم صحيحة');
                return;
            }

            if (price <= cost) {
                alert('سعر البيع يجب أن يكون أكبر من سعر التكلفة');
                return;
            }

            // تحديث المنتج في النظام الحقيقي
            const updatedProduct = {
                id: productId,
                name: name,
                category: category,
                code: code,
                salePrice: price,
                purchasePrice: cost,
                quantity: quantity,
                minQuantity: minStock,
                description: description,
                status: 'active',
                barcode: code // استخدام الكود كباركود
            };

            console.log('تحديث المنتج:', updatedProduct);

            // تحديث في النظام المركزي
            if (window.dataManager) {
                try {
                    window.dataManager.updateProduct(productId, updatedProduct);
                    console.log('✅ تم تحديث المنتج في النظام المركزي');
                } catch (error) {
                    console.error('❌ خطأ في تحديث المنتج في النظام المركزي:', error);
                }
            }

            // تحديث في localStorage
            const savedProducts = JSON.parse(localStorage.getItem('monjizProducts')) || [];
            const productIndex = savedProducts.findIndex(p => p.id == productId || `PROD-${String(p.id).padStart(3, '0')}` === productId);

            if (productIndex !== -1) {
                savedProducts[productIndex] = { ...savedProducts[productIndex], ...updatedProduct };
                localStorage.setItem('monjizProducts', JSON.stringify(savedProducts));
                console.log('✅ تم تحديث المنتج في localStorage');
            } else {
                console.log('⚠️ لم يتم العثور على المنتج في localStorage');
            }

            // إغلاق النافذة
            closeProductEditModal();

            alert('تم تحديث المنتج بنجاح');

            // إعادة تحميل الجدول لإظهار التغييرات
            setTimeout(() => {
                if (typeof loadProductsData === 'function') {
                    loadProductsData();
                } else {
                    location.reload(); // إعادة تحميل الصفحة كحل بديل
                }
            }, 500);
        }

        function updateProductInTable(productId, data) {
            // محاكاة تحديث الجدول
            console.log('تحديث الجدول للمنتج:', productId, data);
            // يمكن إضافة منطق تحديث الجدول هنا
        }

        function addEditProductListeners() {
            // إضافة مستمعات لتحديث الإحصائيات في نموذج التعديل
            const priceInput = document.getElementById('edit-product-price');
            const costInput = document.getElementById('edit-product-cost');
            const quantityInput = document.getElementById('edit-product-quantity');

            function updateEditStats() {
                const price = parseFloat(priceInput?.value) || 0;
                const cost = parseFloat(costInput?.value) || 0;
                const quantity = parseInt(quantityInput?.value) || 0;

                const profit = price - cost;
                const profitPercentage = cost > 0 ? (profit / cost * 100) : 0;
                const stockValue = cost * quantity;

                const profitElement = document.getElementById('edit-profit-margin');
                const percentageElement = document.getElementById('edit-profit-percentage');
                const stockValueElement = document.getElementById('edit-stock-value');

                if (profitElement) profitElement.textContent = profit.toFixed(2) + ' ر.س';
                if (percentageElement) percentageElement.textContent = profitPercentage.toFixed(1) + '%';
                if (stockValueElement) stockValueElement.textContent = stockValue.toFixed(2) + ' ر.س';
            }

            if (priceInput) priceInput.addEventListener('input', updateEditStats);
            if (costInput) costInput.addEventListener('input', updateEditStats);
            if (quantityInput) quantityInput.addEventListener('input', updateEditStats);
        }

        // دالة البحث في المنتجات
        function searchProducts() {
            const searchInput = document.getElementById('product-search');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const tableRows = document.querySelectorAll('#products-table-body tr');

            console.log('البحث في المنتجات عن:', searchTerm);

            let visibleCount = 0;

            tableRows.forEach(row => {
                if (searchTerm === '') {
                    // إذا كان البحث فارغ، أظهر جميع الصفوف
                    row.style.display = '';
                    visibleCount++;
                } else {
                    // البحث في محتوى الصف
                    const productCode = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
                    const productName = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                    const category = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
                    const barcode = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
                    const salePrice = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
                    const purchasePrice = row.querySelector('td:nth-child(6)')?.textContent.toLowerCase() || '';

                    if (productCode.includes(searchTerm) ||
                        productName.includes(searchTerm) ||
                        category.includes(searchTerm) ||
                        barcode.includes(searchTerm) ||
                        salePrice.includes(searchTerm) ||
                        purchasePrice.includes(searchTerm)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // تحديث عداد النتائج
            updateProductSearchResultsCount(visibleCount);

            // إخفاء/إظهار التنقل حسب البحث
            const paginationContainer = document.getElementById('pagination');
            if (searchTerm !== '') {
                // إخفاء التنقل أثناء البحث
                if (paginationContainer) paginationContainer.style.display = 'none';
            } else {
                // إظهار التنقل عند مسح البحث
                if (paginationContainer) paginationContainer.style.display = 'flex';
                // إعادة تحميل البيانات مع التنقل
                if (typeof changePage === 'function') {
                    changePage(1);
                }
            }

            console.log(`تم العثور على ${visibleCount} منتج`);
        }

        // دالة تحديث عداد نتائج البحث للمنتجات
        function updateProductSearchResultsCount(count) {
            // إنشاء أو تحديث عداد النتائج
            let resultsCounter = document.getElementById('products-search-results');
            if (!resultsCounter) {
                resultsCounter = document.createElement('div');
                resultsCounter.id = 'products-search-results';
                resultsCounter.style.cssText = `
                    padding: 10px 25px;
                    background: #f8f9fa;
                    border-bottom: 1px solid #e9ecef;
                    color: #495057;
                    font-size: 14px;
                `;

                const searchFilters = document.querySelector('.search-filters-modern');
                if (searchFilters) {
                    searchFilters.parentNode.insertBefore(resultsCounter, searchFilters.nextSibling);
                }
            }

            if (document.getElementById('product-search').value.trim() !== '') {
                resultsCounter.innerHTML = `<i class="fas fa-search"></i> تم العثور على <span style="color: #007bff; font-weight: bold;">${count}</span> منتج`;
                resultsCounter.style.display = 'block';
            } else {
                resultsCounter.style.display = 'none';
            }
        }

        // دالة مسح البحث للمنتجات
        function clearProductSearch() {
            const searchInput = document.getElementById('product-search');
            if (searchInput) {
                searchInput.value = '';
                searchProducts(); // إعادة عرض جميع النتائج
            }
        }

        function deleteProduct(productId) {
            console.log('🗑️ طلب حذف المنتج:', productId, 'نوع البيانات:', typeof productId);

            const productData = getProductData(productId);
            console.log('📦 بيانات المنتج المسترجعة:', productData);

            if (!productData) {
                console.log('❌ لم يتم العثور على المنتج في getProductData');
                alert('لم يتم العثور على المنتج');
                return;
            }

            // منع التمرير في الخلفية
            document.body.style.overflow = 'hidden';

            const modal = document.createElement('div');
            modal.className = 'modal delete-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                animation: fadeIn 0.3s ease;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    animation: slideIn 0.3s ease;
                ">
                    <div style="
                        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                        color: white;
                        padding: 20px 25px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-radius: 12px 12px 0 0;
                    ">
                        <h3 style="margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            تأكيد الحذف
                        </h3>
                        <button onclick="closeProductDeleteModal()" style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 24px;
                            cursor: pointer;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">
                            &times;
                        </button>
                    </div>

                    <div style="padding: 25px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="
                                width: 80px;
                                height: 80px;
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 15px auto;
                                color: white;
                                font-size: 2rem;
                            ">
                                <i class="fas fa-trash"></i>
                            </div>
                            <h4 style="margin: 0 0 10px 0; color: #dc3545;">هل أنت متأكد من حذف هذا المنتج؟</h4>
                            <p style="margin: 0; color: #6c757d;">هذا الإجراء لا يمكن التراجع عنه!</p>
                        </div>

                        <div style="
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 20px 0;
                            border-left: 4px solid #dc3545;
                        ">
                            <h5 style="margin: 0 0 10px 0; color: #dc3545;">تفاصيل المنتج:</h5>
                            <p style="margin: 5px 0; color: #333;"><strong>رقم المنتج:</strong> ${productData.id}</p>
                            <p style="margin: 5px 0; color: #333;"><strong>اسم المنتج:</strong> ${productData.name}</p>
                            <p style="margin: 5px 0; color: #333;"><strong>الفئة:</strong> ${productData.categoryName}</p>
                            <p style="margin: 5px 0; color: #333;"><strong>الكمية:</strong> ${productData.quantity} قطعة</p>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeProductDeleteModal()" style="
                                background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 14px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-times"></i>
                                إلغاء
                            </button>

                            <button onclick="confirmDeleteProduct('${productId}')" style="
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 14px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-trash"></i>
                                نعم، احذف المنتج
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            window.closeProductDeleteModal = function() {
                document.body.removeChild(modal);
                document.body.style.overflow = '';
            };

            window.confirmDeleteProduct = function(productId) {
                console.log('تأكيد حذف المنتج:', productId);

                // حذف من النظام المركزي
                if (window.dataManager) {
                    try {
                        window.dataManager.deleteProduct(productId);
                        console.log('✅ تم حذف المنتج من النظام المركزي');
                    } catch (error) {
                        console.error('❌ خطأ في حذف المنتج من النظام المركزي:', error);
                    }
                }

                // حذف من localStorage
                const savedProducts = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                console.log('🔍 البحث عن المنتج في localStorage:', productId);
                console.log('📦 المنتجات المحفوظة:', savedProducts.length);

                // طرق متعددة للبحث عن المنتج
                let productIndex = -1;
                let deletedProduct = null;

                // البحث بالـ ID المباشر
                productIndex = savedProducts.findIndex(p => p.id == productId);
                if (productIndex === -1) {
                    // البحث بتنسيق PROD-XXX
                    productIndex = savedProducts.findIndex(p => `PROD-${String(p.id).padStart(3, '0')}` === productId);
                }
                if (productIndex === -1) {
                    // البحث بالـ ID كنص
                    productIndex = savedProducts.findIndex(p => String(p.id) === String(productId));
                }
                if (productIndex === -1) {
                    // البحث بالاسم أو أي خاصية أخرى
                    productIndex = savedProducts.findIndex(p => p.code === productId || p.barcode === productId);
                }

                console.log('📍 فهرس المنتج الموجود:', productIndex);

                if (productIndex !== -1) {
                    deletedProduct = savedProducts[productIndex];
                    console.log('✅ تم العثور على المنتج:', deletedProduct);

                    savedProducts.splice(productIndex, 1);
                    localStorage.setItem('monjizProducts', JSON.stringify(savedProducts));
                    console.log('✅ تم حذف المنتج من localStorage');

                    // حذف الصف من الجدول مع تأثير
                    const rows = document.querySelectorAll('tbody tr');
                    console.log('🔍 البحث عن الصف في الجدول...');

                    let rowFound = false;
                    for (let row of rows) {
                        // البحث بطرق متعددة
                        const deleteBtn = row.querySelector(`button[onclick*="deleteProduct('${productId}')"]`) ||
                                         row.querySelector(`button[onclick*="deleteProduct(${productId})"]`) ||
                                         row.querySelector(`button[onclick*="${productId}"]`);

                        if (deleteBtn) {
                            console.log('✅ تم العثور على الصف في الجدول');
                            row.style.animation = 'slideOutRow 0.5s ease';
                            row.style.background = '#ffebee';
                            setTimeout(() => {
                                row.remove();
                            }, 500);
                            rowFound = true;
                            break;
                        }
                    }

                    if (!rowFound) {
                        console.log('⚠️ لم يتم العثور على الصف في الجدول - إعادة تحميل الصفحة');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }

                    // إغلاق النافذة
                    closeProductDeleteModal();

                    // عرض رسالة نجاح
                    setTimeout(() => {
                        alert(`تم حذف المنتج "${deletedProduct.name || productId}" بنجاح`);
                    }, 600);
                } else {
                    console.log('⚠️ لم يتم العثور على المنتج للحذف');
                    console.log('📋 قائمة المنتجات المتاحة:');
                    savedProducts.forEach((p, index) => {
                        console.log(`  ${index}: ID=${p.id}, Name=${p.name}, Code=${p.code}`);
                    });

                    // محاولة حذف الصف من الجدول على أي حال
                    const rows = document.querySelectorAll('tbody tr');
                    let rowDeleted = false;
                    for (let row of rows) {
                        const deleteBtn = row.querySelector(`button[onclick*="${productId}"]`);
                        if (deleteBtn) {
                            row.style.animation = 'slideOutRow 0.5s ease';
                            row.style.background = '#ffebee';
                            setTimeout(() => {
                                row.remove();
                            }, 500);
                            rowDeleted = true;
                            break;
                        }
                    }

                    closeProductDeleteModal();

                    if (rowDeleted) {
                        setTimeout(() => {
                            alert('تم حذف المنتج من الجدول');
                        }, 600);
                    } else {
                        alert('لم يتم العثور على المنتج');
                    }
                }
            };

            // إغلاق عند النقر خارج النافذة
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeProductDeleteModal();
                }
            });
        }

        function removeProductFromTable(productId) {
            // محاكاة إزالة المنتج من الجدول
            console.log('إزالة المنتج من الجدول:', productId);
            // يمكن إضافة منطق إزالة الصف من الجدول هنا
        }

        function saveProduct() {
            const name = document.getElementById('product-name').value;
            const category = document.getElementById('product-category').value;
            const code = document.getElementById('product-code').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const cost = parseFloat(document.getElementById('product-cost').value);
            const quantity = parseInt(document.getElementById('product-quantity').value) || 0;
            const minStock = parseInt(document.getElementById('product-min-stock').value) || 1;
            const description = document.getElementById('product-description').value || '';

            console.log('بيانات المنتج المدخلة:', {
                name, category, code, price, cost, quantity, minStock, description
            });

            if (!name || !category || !code || isNaN(price) || isNaN(cost)) {
                alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }

            // إنشاء بيانات المنتج
            const productData = {
                name: name,
                barcode: code,
                category: category,
                purchasePrice: cost,
                salePrice: price,
                quantity: quantity,
                minQuantity: minStock,
                description: description,
                status: 'active'
            };

            // حفظ المنتج باستخدام النظام المركزي
            const savedProduct = window.dataManager.addProduct(productData);

            if (savedProduct) {
                // إغلاق النافذة
                const modal = document.querySelector('.modal-overlay');
                if (modal) {
                    closeModal(modal.querySelector('.close-btn'));
                }

                alert(`تم إضافة المنتج بنجاح!\nاسم المنتج: ${name}\nالباركود: ${code}`);

                // تحديث جدول المنتجات بدلاً من إعادة تحميل الصفحة
                setTimeout(() => {
                    loadProductsFromCentralSystem();
                }, 100);
            } else {
                alert('حدث خطأ أثناء حفظ المنتج');
            }
        }

        function closeModal(closeBtn) {
            const modal = closeBtn.closest('.modal-overlay');
            if (modal) {
                document.body.style.overflow = 'auto';
                modal.remove();
            }
        }

        function showAddCategoryModal() {
            console.log('فتح نافذة إضافة فئة جديدة...');

            // منع التمرير في الخلفية
            document.body.style.overflow = 'hidden';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content-modern" style="max-width: 500px;">
                    <div class="modal-header-modern">
                        <h3><i class="fas fa-plus-circle"></i> إضافة فئة جديدة</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body-modern">
                        <form class="form-modern" id="new-category-form">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> اسم الفئة</label>
                                <input type="text" class="input-modern" placeholder="اسم الفئة الجديدة" id="category-name" required oninput="validateCategoryName()">
                                <div class="error-message" id="name-error" style="display: none;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span></span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-code"></i> رمز الفئة</label>
                                <input type="text" class="input-modern" placeholder="رمز الفئة (مثل: ELEC)" id="category-code" required oninput="validateCategoryCode()" maxlength="10">
                                <div class="error-message" id="code-error" style="display: none;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span></span>
                                </div>
                                <div class="success-message" id="code-success" style="display: none;">
                                    <i class="fas fa-check-circle"></i>
                                    <span>رمز الفئة صحيح</span>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-modern btn-primary" onclick="saveCategory()">
                                    <i class="fas fa-save"></i> حفظ الفئة
                                </button>
                                <button type="button" class="btn-modern btn-secondary" onclick="closeModal(this)">
                                    <i class="fas fa-times"></i> إلغاء
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // إضافة وظيفة إغلاق عند الضغط على الخلفية
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.close-btn'));
                }
            });

            // التركيز على حقل اسم الفئة
            setTimeout(() => {
                const nameInput = document.getElementById('category-name');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 100);
        }

        function saveCategory() {
            const name = document.getElementById('category-name').value.trim();
            const code = document.getElementById('category-code').value.trim().toUpperCase();

            // التحقق من صحة البيانات باستخدام الوظائف الجديدة
            const isNameValid = validateCategoryName();
            const isCodeValid = validateCategoryCode();

            if (!isNameValid || !isCodeValid) {
                // التركيز على أول حقل خاطئ
                if (!isNameValid) {
                    document.getElementById('category-name').focus();
                } else if (!isCodeValid) {
                    document.getElementById('category-code').focus();
                }
                return;
            }

            // التحقق من توفر النظام المركزي
            if (!window.dataManager) {
                alert('النظام المركزي غير متاح. يرجى إعادة تحميل الصفحة.');
                return;
            }

            // حفظ الفئة باستخدام النظام المركزي
            const categoryData = {
                name: name,
                code: code.toLowerCase(),
                description: '',
                color: 'primary',
                icon: 'fas fa-tag'
            };

            const savedCategory = window.dataManager.addCategory(categoryData);

            if (savedCategory) {
                console.log('تم حفظ فئة جديدة:', savedCategory);

                // تحديث جميع قوائم الفئات في الصفحة
                setTimeout(() => {
                    updateAllCategorySelects();
                    displayCategories(); // إضافة هذا السطر لتحديث قائمة الفئات
                }, 100);
            } else {
                alert('حدث خطأ أثناء حفظ الفئة');
                return;
            }

            // إغلاق النافذة
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                closeModal(modal.querySelector('.close-btn'));
            }

            // رسالة نجاح
            alert(`تم إضافة الفئة "${name}" بنجاح!\nرمز الفئة: ${code}`);

            // تحديث الإحصائيات (محاكاة)
            updateCategoryStats();
        }

        function updateCategoryStats() {
            // محاكاة تحديث الإحصائيات
            console.log('تحديث إحصائيات الفئات...');

            // يمكن إضافة منطق تحديث الإحصائيات هنا
            // مثل إعادة حساب عدد المنتجات في كل فئة
        }

        function updateCategoryPreview() {
            const name = document.getElementById('category-name')?.value || 'اسم الفئة';
            const color = document.getElementById('category-color')?.value || 'primary';
            const icon = document.getElementById('category-icon')?.value || 'fas fa-laptop';

            const previewBadge = document.getElementById('preview-badge');
            const previewIcon = document.getElementById('preview-icon');
            const previewName = document.getElementById('preview-name');

            if (previewBadge && previewIcon && previewName) {
                // تحديث اللون
                previewBadge.className = `badge ${color}`;

                // تحديث الأيقونة
                previewIcon.className = icon;

                // تحديث النص
                previewName.textContent = name || 'اسم الفئة';
            }
        }

        function validateCategoryName() {
            const nameInput = document.getElementById('category-name');
            const errorDiv = document.getElementById('name-error');
            const name = nameInput?.value.trim();

            if (!name) {
                showFieldError(nameInput, errorDiv, 'اسم الفئة مطلوب');
                return false;
            } else if (name.length < 2) {
                showFieldError(nameInput, errorDiv, 'اسم الفئة يجب أن يكون أكثر من حرفين');
                return false;
            } else if (name.length > 50) {
                showFieldError(nameInput, errorDiv, 'اسم الفئة طويل جداً (الحد الأقصى 50 حرف)');
                return false;
            } else {
                hideFieldError(nameInput, errorDiv);
                return true;
            }
        }

        function validateCategoryCode() {
            const codeInput = document.getElementById('category-code');
            const errorDiv = document.getElementById('code-error');
            const successDiv = document.getElementById('code-success');
            const code = codeInput?.value.trim().toUpperCase();

            // تحديث القيمة بالأحرف الكبيرة
            if (codeInput) {
                codeInput.value = code;
            }

            if (!code) {
                showFieldError(codeInput, errorDiv, 'رمز الفئة مطلوب');
                hideFieldSuccess(successDiv);
                return false;
            } else if (code.length < 2) {
                showFieldError(codeInput, errorDiv, 'رمز الفئة يجب أن يكون أكثر من حرف واحد');
                hideFieldSuccess(successDiv);
                return false;
            } else if (code.length > 10) {
                showFieldError(codeInput, errorDiv, 'رمز الفئة طويل جداً (الحد الأقصى 10 أحرف)');
                hideFieldSuccess(successDiv);
                return false;
            } else if (!/^[A-Z0-9]+$/.test(code)) {
                showFieldError(codeInput, errorDiv, 'رمز الفئة يجب أن يحتوي على أحرف إنجليزية وأرقام فقط');
                hideFieldSuccess(successDiv);
                return false;
            } else {
                hideFieldError(codeInput, errorDiv);
                showFieldSuccess(successDiv);
                return true;
            }
        }

        function showFieldError(input, errorDiv, message) {
            if (input) {
                input.classList.add('field-error');
            }
            if (errorDiv) {
                errorDiv.querySelector('span').textContent = message;
                errorDiv.style.display = 'flex';
            }
        }

        function hideFieldError(input, errorDiv) {
            if (input) {
                input.classList.remove('field-error');
            }
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        function showFieldSuccess(successDiv) {
            if (successDiv) {
                successDiv.style.display = 'flex';
            }
        }

        function hideFieldSuccess(successDiv) {
            if (successDiv) {
                successDiv.style.display = 'none';
            }
        }

        // دالة لتحديث جميع قوائم الفئات
        function updateAllCategorySelects() {
            console.log('تحديث قوائم الفئات...');

            if (!window.dataManager) {
                console.error('مدير البيانات غير متاح');
                return;
            }

            const categories = window.dataManager.getCategories();
            console.log('الفئات المتاحة:', categories);

            // تحديث قائمة التصفية
            const categoryFilter = document.getElementById('category-filter');
            if (categoryFilter) {
                const currentValue = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="">جميع الفئات</option>';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.code;
                    option.textContent = category.name;
                    if (category.code === currentValue) {
                        option.selected = true;
                    }
                    categoryFilter.appendChild(option);
                });
                console.log('تم تحديث قائمة التصفية');
            }

            // تحديث قائمة الفئات في نموذج إضافة المنتج
            const productCategorySelects = document.querySelectorAll('#product-category, .product-category-select');
            console.log('عدد قوائم الفئات الموجودة:', productCategorySelects.length);

            productCategorySelects.forEach((select, index) => {
                console.log(`تحديث القائمة ${index + 1}:`, select);
                const currentValue = select.value;
                select.innerHTML = '<option value="">اختر الفئة</option>';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.code;
                    option.textContent = category.name;
                    if (category.code === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                console.log(`تم تحديث القائمة ${index + 1} بـ ${categories.length} فئة`);
            });
        }

        // دالة تحميل وعرض المنتجات من النظام المركزي
        function loadProductsFromCentralSystem() {
            console.log('تحميل المنتجات من النظام المركزي...');

            if (!window.dataManager) {
                console.error('النظام المركزي غير متاح');
                return;
            }

            // عرض الفئات
            displayCategories();

            const products = window.dataManager.getProducts();
            console.log('المنتجات المحملة:', products);

            const tableBody = document.querySelector('#products-table-body');
            if (!tableBody) {
                console.error('جدول المنتجات غير موجود');
                return;
            }

            // مسح المحتوى الحالي
            tableBody.innerHTML = '';

            // متغيرات التنقل
            let currentPage = 1;
            const itemsPerPage = 10;

            // دالة عرض صفحة محددة
            function displayPage(page) {
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageProducts = products.slice(startIndex, endIndex);

                // مسح الجدول
                tableBody.innerHTML = '';

                // إضافة منتجات الصفحة الحالية فقط
                pageProducts.forEach(product => {
                    // استرجاع اسم الفئة من رمزها
                    const categories = window.dataManager.getCategories();
                    const categoryName = categories.find(cat => cat.code === product.category)?.name || product.category || 'غير محدد';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>PROD-${String(product.id).padStart(3, '0')}</strong></td>
                        <td>${product.name}</td>
                        <td><span class="badge primary">${categoryName}</span></td>
                        <td>${product.barcode || 'غير محدد'}</td>
                        <td>${product.salePrice ? product.salePrice.toFixed(2) : '0.00'} ر.س</td>
                        <td>${product.purchasePrice ? product.purchasePrice.toFixed(2) : '0.00'} ر.س</td>
                        <td><span class="quantity-badge">${product.quantity || 0}</span></td>
                        <td><span class="min-quantity">${product.minQuantity || 0}</span></td>
                        <td>
                            <span class="status-badge ${product.status === 'active' ? 'active' : 'inactive'}">
                                ${product.status === 'active' ? 'نشط' : 'غير نشط'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons-horizontal">
                                <button class="action-btn view" onclick="viewProduct(${product.id})" title="عرض">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn edit" onclick="editProduct(${product.id})" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete" onclick="deleteProduct(${product.id})" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // تحديث أزرار التنقل
                updatePagination();
            }

            // دالة تحديث أزرار التنقل
            function updatePagination() {
                const totalPages = Math.ceil(products.length / itemsPerPage);
                const paginationContainer = document.getElementById('pagination');

                if (!paginationContainer || totalPages <= 1) {
                    if (paginationContainer) paginationContainer.style.display = 'none';
                    return;
                }

                paginationContainer.style.display = 'flex';
                paginationContainer.style.justifyContent = 'center';
                paginationContainer.style.gap = '8px';
                paginationContainer.style.margin = '20px 0';

                let paginationHTML = '';

                // زر السابق
                if (currentPage > 1) {
                    paginationHTML += `<button onclick="changePage(${currentPage - 1})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">السابق</button>`;
                }

                // أزرار الصفحات
                for (let i = 1; i <= totalPages; i++) {
                    const activeStyle = i === currentPage ? 'background: #007bff; color: white;' : 'background: white;';
                    paginationHTML += `<button onclick="changePage(${i})" style="padding: 8px 12px; border: 1px solid #ddd; cursor: pointer; border-radius: 4px; ${activeStyle}">${i}</button>`;
                }

                // زر التالي
                if (currentPage < totalPages) {
                    paginationHTML += `<button onclick="changePage(${currentPage + 1})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">التالي</button>`;
                }

                paginationContainer.innerHTML = paginationHTML;
            }

            // دالة تغيير الصفحة
            window.changePage = function(page) {
                currentPage = page;
                displayPage(page);
            }

            // عرض الصفحة الأولى
            displayPage(1);

            console.log(`تم عرض ${products.length} منتج في الجدول`);
        }

        // وظيفة عرض حركات المخزون
        function showStockMovements() {
            console.log('📊 عرض حركات المخزون...');

            if (!window.dataManager) {
                alert('النظام المركزي غير متاح');
                return;
            }

            const movements = window.dataManager.getStockMovements();
            console.log('حركات المخزون:', movements);

            // إنشاء نافذة منبثقة
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            let movementsHTML = '';
            if (movements.length === 0) {
                movementsHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            لا توجد حركات مخزون
                        </td>
                    </tr>
                `;
            } else {
                // ترتيب الحركات حسب التاريخ (الأحدث أولاً)
                movements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                movements.slice(0, 50).forEach(movement => { // عرض آخر 50 حركة
                    const typeIcon = movement.movementType === 'in' ?
                        '<i class="fas fa-arrow-up" style="color: #28a745;"></i>' :
                        '<i class="fas fa-arrow-down" style="color: #dc3545;"></i>';

                    const typeText = movement.movementType === 'in' ? 'دخول' : 'خروج';
                    const typeClass = movement.movementType === 'in' ? 'success' : 'danger';

                    movementsHTML += `
                        <tr>
                            <td>${movement.date} ${movement.time}</td>
                            <td><strong>${movement.productCode}</strong></td>
                            <td>${movement.productName}</td>
                            <td>${typeIcon} <span class="badge ${typeClass}">${typeText}</span></td>
                            <td><strong>${movement.quantity}</strong></td>
                            <td>${movement.oldQuantity}</td>
                            <td><strong>${movement.newQuantity}</strong></td>
                            <td><small>${movement.reference}</small></td>
                        </tr>
                    `;
                });
            }

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    max-width: 90%;
                    width: 1000px;
                    max-height: 85vh;
                    overflow: hidden;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                ">
                    <div style="
                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                        color: white;
                        padding: 20px 25px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exchange-alt"></i>
                            حركات المخزون (آخر 50 حركة)
                        </h3>
                        <button onclick="this.closest('.modal-overlay').remove()" style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 24px;
                            cursor: pointer;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">
                            &times;
                        </button>
                    </div>

                    <div style="padding: 0; max-height: 60vh; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-family: 'Cairo', sans-serif;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">التاريخ والوقت</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">كود المنتج</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">اسم المنتج</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">نوع الحركة</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">الكمية</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">الكمية السابقة</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">الكمية الجديدة</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">المرجع</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${movementsHTML}
                            </tbody>
                        </table>
                    </div>

                    <div style="padding: 20px; text-align: center; background: #f8f9fa; border-top: 1px solid #dee2e6;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // إغلاق عند النقر على الخلفية
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // وظيفة تحديث المخزون يدوياً
        function refreshInventory() {
            console.log('🔄 تحديث المخزون يدوياً...');

            if (!window.dataManager) {
                alert('النظام المركزي غير متاح');
                return;
            }

            try {
                // إعادة تحميل البيانات من النظام المركزي
                loadProductsFromCentralSystem();

                // عرض رسالة نجاح
                const products = window.dataManager.getProducts();
                const movements = window.dataManager.getStockMovements();

                alert(`تم تحديث المخزون بنجاح!\n\n📦 المنتجات: ${products.length}\n🔄 حركات المخزون: ${movements.length}`);

                console.log('✅ تم تحديث المخزون بنجاح');

            } catch (error) {
                console.error('❌ خطأ في تحديث المخزون:', error);
                alert('حدث خطأ في تحديث المخزون: ' + error.message);
            }
        }

        // وظيفة عرض تنبيه المخزون المنخفض
        function showLowStockAlert() {
            console.log('⚠️ فحص المخزون المنخفض...');

            if (!window.dataManager) {
                alert('النظام المركزي غير متاح');
                return;
            }

            const products = window.dataManager.getProducts();
            const lowStockProducts = products.filter(product => {
                const currentQuantity = product.quantity || 0;
                const minQuantity = product.minQuantity || 5; // الحد الأدنى الافتراضي
                return currentQuantity <= minQuantity;
            });

            console.log('منتجات المخزون المنخفض:', lowStockProducts);

            // إنشاء نافذة منبثقة
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            let alertHTML = '';
            if (lowStockProducts.length === 0) {
                alertHTML = `
                    <div style="text-align: center; padding: 40px; color: #28a745;">
                        <i class="fas fa-check-circle" style="font-size: 64px; margin-bottom: 20px; display: block;"></i>
                        <h3>ممتاز! جميع المنتجات في المخزون كافية</h3>
                        <p>لا توجد منتجات تحتاج إلى إعادة تموين</p>
                    </div>
                `;
            } else {
                let productsHTML = '';
                lowStockProducts.forEach(product => {
                    const urgencyClass = (product.quantity || 0) === 0 ? 'danger' : 'warning';
                    const urgencyIcon = (product.quantity || 0) === 0 ? 'fas fa-times-circle' : 'fas fa-exclamation-triangle';
                    const urgencyText = (product.quantity || 0) === 0 ? 'نفد المخزون' : 'مخزون منخفض';

                    productsHTML += `
                        <tr>
                            <td><strong>PROD-${String(product.id).padStart(3, '0')}</strong></td>
                            <td>${product.name}</td>
                            <td><span class="badge primary">${product.category || 'غير محدد'}</span></td>
                            <td><strong style="color: ${urgencyClass === 'danger' ? '#dc3545' : '#ffc107'};">${product.quantity || 0}</strong></td>
                            <td>${product.minQuantity || 5}</td>
                            <td>
                                <span class="badge ${urgencyClass}">
                                    <i class="${urgencyIcon}"></i> ${urgencyText}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                alertHTML = `
                    <div style="padding: 0; max-height: 60vh; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-family: 'Cairo', sans-serif;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">كود المنتج</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">اسم المنتج</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">الفئة</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">الكمية الحالية</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">الحد الأدنى</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productsHTML}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            const headerColor = lowStockProducts.length === 0 ? '#28a745' : '#ffc107';
            const headerIcon = lowStockProducts.length === 0 ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
            const headerText = lowStockProducts.length === 0 ?
                'حالة المخزون ممتازة' :
                `تنبيه: ${lowStockProducts.length} منتج يحتاج إعادة تموين`;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    max-width: 90%;
                    width: 800px;
                    max-height: 85vh;
                    overflow: hidden;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                ">
                    <div style="
                        background: linear-gradient(135deg, ${headerColor} 0%, ${headerColor}dd 100%);
                        color: ${lowStockProducts.length === 0 ? 'white' : '#212529'};
                        padding: 20px 25px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <i class="${headerIcon}"></i>
                            ${headerText}
                        </h3>
                        <button onclick="this.closest('.modal-overlay').remove()" style="
                            background: none;
                            border: none;
                            color: ${lowStockProducts.length === 0 ? 'white' : '#212529'};
                            font-size: 24px;
                            cursor: pointer;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">
                            &times;
                        </button>
                    </div>

                    ${alertHTML}

                    <div style="padding: 20px; text-align: center; background: #f8f9fa; border-top: 1px solid #dee2e6;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // إغلاق عند النقر على الخلفية
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // وظيفة مراقبة تحديثات المخزون
        function setupInventoryMonitoring() {
            console.log('🔄 تفعيل مراقبة تحديثات المخزون...');

            // مراقبة تغييرات localStorage للمنتجات
            window.addEventListener('storage', function(e) {
                if (e.key === 'monjizProducts') {
                    console.log('📦 تم تحديث المخزون، إعادة تحميل البيانات...');
                    setTimeout(() => {
                        loadProductsFromCentralSystem();
                    }, 100);
                }
            });

            // مراقبة دورية للتحديثات (كل 3 ثوان)
            setInterval(() => {
                if (window.dataManager) {
                    const currentProducts = window.dataManager.getProducts();
                    const currentCount = currentProducts.length;

                    // حساب مجموع الكميات للتحقق من التغييرات
                    const currentTotalQuantity = currentProducts.reduce((sum, p) => sum + (parseFloat(p.quantity) || 0), 0);

                    // التحقق من تغيير عدد المنتجات أو الكميات
                    if (window.lastProductsCount !== currentCount || window.lastTotalQuantity !== currentTotalQuantity) {
                        console.log('📊 تغيير في المخزون، إعادة تحميل...', {
                            countChange: window.lastProductsCount !== currentCount,
                            quantityChange: window.lastTotalQuantity !== currentTotalQuantity,
                            oldTotal: window.lastTotalQuantity,
                            newTotal: currentTotalQuantity
                        });
                        loadProductsFromCentralSystem();
                        window.lastProductsCount = currentCount;
                        window.lastTotalQuantity = currentTotalQuantity;
                    }
                }
            }, 3000);
        }

        // تحديث قوائم الفئات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // انتظار تحميل النظام المركزي ثم تحديث القوائم والمنتجات
            setTimeout(() => {
                if (window.dataManager) {
                    updateAllCategorySelects();
                    loadProductsFromCentralSystem();
                    setupInventoryMonitoring(); // تفعيل المراقبة

                    // حفظ العدد والكمية الأولية للمنتجات
                    const initialProducts = window.dataManager.getProducts();
                    window.lastProductsCount = initialProducts.length;
                    window.lastTotalQuantity = initialProducts.reduce((sum, p) => sum + (parseFloat(p.quantity) || 0), 0);
                    console.log('📊 تهيئة مراقبة المخزون:', {
                        count: window.lastProductsCount,
                        totalQuantity: window.lastTotalQuantity
                    });
                } else {
                    console.error('النظام المركزي غير محمل');
                }
            }, 500);

            // إضافة مستمع لتغيير اسم الفئة
            document.addEventListener('input', function(e) {
                if (e.target && e.target.id === 'category-name') {
                    updateCategoryPreview();
                }
            });

            // تفعيل البحث الفوري في المنتجات
            const productSearchInput = document.getElementById('product-search');
            if (productSearchInput) {
                console.log('تم تفعيل البحث الفوري في المنتجات');
                productSearchInput.addEventListener('input', searchProducts);

                // إضافة مسح البحث بزر Escape
                productSearchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        clearProductSearch();
                    }
                });
            } else {
                console.error('لم يتم العثور على حقل البحث في المنتجات');
            }

            // إضافة مستمع لتغيير لون الفئة
            document.addEventListener('change', function(e) {
                if (e.target && (e.target.id === 'category-color' || e.target.id === 'category-icon')) {
                    updateCategoryPreview();
                }
            });

            // مراقبة تحديثات البيانات
            window.addEventListener('monjizDataUpdate', function(e) {
                if (e.detail.dataType === 'monjizCategories') {
                    updateAllCategorySelects();
                }
            });
        });

        function printProducts() {
            window.print();
        }

        function exportToExcel() {
            alert('سيتم تصدير البيانات إلى Excel');
        }

        function exportToPDF() {
            alert('سيتم تصدير البيانات إلى PDF');
        }

        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            }
        }

        // إضافة أنماط CSS للانيميشن عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            if (!document.querySelector('#products-animations')) {
                const style = document.createElement('style');
                style.id = 'products-animations';
                style.textContent = `
                    @keyframes slideOutRow {
                        from { opacity: 1; transform: translateX(0); }
                        to { opacity: 0; transform: translateX(-50px); }
                    }
                `;
                document.head.appendChild(style);
            }
        });
    </script>
    <script src="js/data-manager.js"></script>
    <script src="js/products.js"></script>
    <script src="js/apply-buttons-fix.js"></script>
    <script>
        // دالة لعرض الفئات
        function displayCategories() {
            console.log('عرض الفئات...');
            const categoriesList = document.getElementById('categories-list');
            if (!categoriesList) {
                console.error('قائمة الفئات غير موجودة');
                return;
            }

            if (!window.dataManager) {
                console.error('مدير البيانات غير متاح');
                return;
            }

            const categories = window.dataManager.getCategories();
            console.log('الفئات المتاحة:', categories);

            // مسح المحتوى الحالي
            categoriesList.innerHTML = '';

            // عرض الفئات
            categories.forEach(category => {
                const item = document.createElement('li');
                item.className = 'category-item';
                item.innerHTML = `
                    <div class="category-name">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <span>${category.name}</span>
                    </div>
                    <div class="category-actions">
                        <button class="edit-category-btn" data-id="${category.id}" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-category-btn" data-id="${category.id}" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                categoriesList.appendChild(item);
            });

            // إضافة مستمعي الأحداث لأزرار التعديل والحذف
            addCategoryActionListeners();
        }

        // دالة لإضافة مستمعي الأحداث لأزرار التعديل والحذف
        function addCategoryActionListeners() {
            // أزرار التعديل
            document.querySelectorAll('.edit-category-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const categoryId = parseInt(this.getAttribute('data-id'));
                    editCategory(categoryId);
                });
            });

            // أزرار الحذف
            document.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const categoryId = parseInt(this.getAttribute('data-id'));
                    deleteCategory(categoryId);
                });
            });
        }

        // دالة لتعديل فئة
        function editCategory(categoryId) {
            console.log('تعديل الفئة رقم:', categoryId);

            if (!window.dataManager) {
                console.error('مدير البيانات غير متاح');
                return;
            }

            const categories = window.dataManager.getCategories();
            const category = categories.find(c => c.id === categoryId);

            if (!category) {
                console.error('الفئة غير موجودة');
                return;
            }

            // منع التمرير في الخلفية
            document.body.style.overflow = 'hidden';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content-modern" style="max-width: 500px;">
                    <div class="modal-header-modern">
                        <h3><i class="fas fa-edit"></i> تعديل الفئة</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body-modern">
                        <form class="form-modern" id="edit-category-form">
                            <input type="hidden" id="edit-category-id" value="${category.id}">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> اسم الفئة</label>
                                <input type="text" class="input-modern" placeholder="اسم الفئة" id="edit-category-name" required value="${category.name}" oninput="updateEditCategoryPreview(); validateEditCategoryName()">
                                <div class="error-message" id="edit-name-error" style="display: none;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span></span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-code"></i> رمز الفئة</label>
                                <input type="text" class="input-modern" placeholder="رمز الفئة (مثل: ELEC)" id="edit-category-code" required value="${category.code}" oninput="validateEditCategoryCode()" maxlength="10">
                                <div class="error-message" id="edit-code-error" style="display: none;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span></span>
                                </div>
                                <div class="success-message" id="edit-code-success" style="display: none;">
                                    <i class="fas fa-check-circle"></i>
                                    <span>رمز الفئة صحيح</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>وصف الفئة</label>
                                <textarea class="textarea-modern" rows="3" placeholder="وصف مختصر للفئة..." id="edit-category-description">${category.description || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label>لون الفئة</label>
                                <select class="select-modern" id="edit-category-color">
                                    <option value="primary" ${category.color === 'primary' ? 'selected' : ''}>أزرق (Primary)</option>
                                    <option value="success" ${category.color === 'success' ? 'selected' : ''}>أخضر (Success)</option>
                                    <option value="warning" ${category.color === 'warning' ? 'selected' : ''}>أصفر (Warning)</option>
                                    <option value="danger" ${category.color === 'danger' ? 'selected' : ''}>أحمر (Danger)</option>
                                    <option value="info" ${category.color === 'info' ? 'selected' : ''}>فيروزي (Info)</option>
                                    <option value="secondary" ${category.color === 'secondary' ? 'selected' : ''}>رمادي (Secondary)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>أيقونة الفئة</label>
                                <select class="select-modern" id="edit-category-icon" onchange="updateEditCategoryPreview()">
                                    <option value="fas fa-laptop" ${category.icon === 'fas fa-laptop' ? 'selected' : ''}>💻 لابتوب</option>
                                    <option value="fas fa-mobile-alt" ${category.icon === 'fas fa-mobile-alt' ? 'selected' : ''}>📱 هاتف</option>
                                    <option value="fas fa-tablet-alt" ${category.icon === 'fas fa-tablet-alt' ? 'selected' : ''}>📟 تابلت</option>
                                    <option value="fas fa-headphones" ${category.icon === 'fas fa-headphones' ? 'selected' : ''}>🎧 سماعات</option>
                                    <option value="fas fa-keyboard" ${category.icon === 'fas fa-keyboard' ? 'selected' : ''}>⌨️ لوحة مفاتيح</option>
                                    <option value="fas fa-mouse" ${category.icon === 'fas fa-mouse' ? 'selected' : ''}>🖱️ ماوس</option>
                                    <option value="fas fa-tv" ${category.icon === 'fas fa-tv' ? 'selected' : ''}>📺 شاشة</option>
                                    <option value="fas fa-camera" ${category.icon === 'fas fa-camera' ? 'selected' : ''}>📷 كاميرا</option>
                                    <option value="fas fa-gamepad" ${category.icon === 'fas fa-gamepad' ? 'selected' : ''}>🎮 ألعاب</option>
                                    <option value="fas fa-microchip" ${category.icon === 'fas fa-microchip' ? 'selected' : ''}>🔧 قطع غيار</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>معاينة الفئة</label>
                                <div class="category-preview" id="edit-category-preview">
                                    <span class="badge ${category.color}" id="edit-preview-badge">
                                        <i class="${category.icon}" id="edit-preview-icon"></i>
                                        <span id="edit-preview-name">${category.name}</span>
                                    </span>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-modern btn-primary" onclick="updateCategory()">
                                    <i class="fas fa-save"></i> حفظ التغييرات
                                </button>
                                <button type="button" class="btn-modern btn-secondary" onclick="closeModal(this)">
                                    <i class="fas fa-times"></i> إلغاء
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // إضافة وظيفة إغلاق عند الضغط على الخلفية
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.close-btn'));
                }
            });

            // التركيز على حقل اسم الفئة
            setTimeout(() => {
                const nameInput = document.getElementById('edit-category-name');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 100);
        }

        // دالة لتحديث معاينة الفئة في نموذج التعديل
        function updateEditCategoryPreview() {
            const name = document.getElementById('edit-category-name')?.value || 'اسم الفئة';
            const iconSelect = document.getElementById('edit-category-icon');
            const icon = iconSelect ? iconSelect.value : 'fas fa-laptop';
            const colorSelect = document.getElementById('edit-category-color');
            const color = colorSelect ? colorSelect.value : 'primary';

            const previewName = document.getElementById('edit-preview-name');
            const previewIcon = document.getElementById('edit-preview-icon');
            const previewBadge = document.getElementById('edit-preview-badge');

            if (previewName) previewName.textContent = name;
            if (previewIcon) {
                previewIcon.className = icon;
            }
            if (previewBadge) {
                previewBadge.className = `badge ${color}`;
            }
        }

        // دالة للتحقق من صحة اسم الفئة في نموذج التعديل
        function validateEditCategoryName() {
            const nameInput = document.getElementById('edit-category-name');
            const errorDiv = document.getElementById('edit-name-error');

            if (!nameInput || !errorDiv) return true;

            const name = nameInput.value.trim();

            if (name.length < 2) {
                showFieldError(nameInput, errorDiv, 'اسم الفئة يجب أن يكون أكثر من حرفين');
                return false;
            } else {
                hideFieldError(nameInput, errorDiv);
                return true;
            }
        }

        // دالة للتحقق من صحة رمز الفئة في نموذج التعديل
        function validateEditCategoryCode() {
            const codeInput = document.getElementById('edit-category-code');
            const errorDiv = document.getElementById('edit-code-error');
            const successDiv = document.getElementById('edit-code-success');

            if (!codeInput || !errorDiv || !successDiv) return true;

            const code = codeInput.value.trim();
            const codeRegex = /^[A-Za-z0-9_-]+$/;

            if (code.length < 2) {
                showFieldError(codeInput, errorDiv, 'رمز الفئة يجب أن يكون أكثر من حرفين');
                hideFieldSuccess(successDiv);
                return false;
            } else if (!codeRegex.test(code)) {
                showFieldError(codeInput, errorDiv, 'رمز الفئة يجب أن يحتوي على أحرف إنجليزية وأرقام فقط');
                hideFieldSuccess(successDiv);
                return false;
            } else {
                hideFieldError(codeInput, errorDiv);
                showFieldSuccess(successDiv);
                return true;
            }
        }

        // دالة لتحديث الفئة
        function updateCategory() {
            const id = parseInt(document.getElementById('edit-category-id').value);
            const name = document.getElementById('edit-category-name').value.trim();
            const code = document.getElementById('edit-category-code').value.trim();
            const description = document.getElementById('edit-category-description').value.trim();
            const color = document.getElementById('edit-category-color').value;
            const icon = document.getElementById('edit-category-icon').value;

            // التحقق من صحة البيانات
            if (!validateEditCategoryName() || !validateEditCategoryCode()) {
                return;
            }

            // تحديث الفئة
            const categoryData = {
                name,
                code,
                description,
                color,
                icon
            };

            const updatedCategory = window.dataManager.updateCategory(id, categoryData);

            if (updatedCategory) {
                console.log('تم تحديث الفئة:', updatedCategory);

                // تحديث جميع قوائم الفئات في الصفحة
                setTimeout(() => {
                    updateAllCategorySelects();
                    displayCategories();
                }, 100);
            } else {
                alert('حدث خطأ أثناء تحديث الفئة');
                return;
            }

            // إغلاق النافذة
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                closeModal(modal.querySelector('.close-btn'));
            }

            // رسالة نجاح
            alert(`تم تحديث الفئة "${name}" بنجاح!`);
        }

        // دالة لحذف فئة
        function deleteCategory(categoryId) {
            console.log('حذف الفئة رقم:', categoryId);

            if (!window.dataManager) {
                console.error('مدير البيانات غير متاح');
                return;
            }

            const categories = window.dataManager.getCategories();
            const category = categories.find(c => c.id === categoryId);

            if (!category) {
                console.error('الفئة غير موجودة');
                return;
            }

            // تأكيد الحذف
            if (!confirm(`هل أنت متأكد من حذف الفئة "${category.name}"؟`)) {
                return;
            }

            // حذف الفئة
            const deletedCategory = window.dataManager.deleteCategory(categoryId);

            if (deletedCategory) {
                console.log('تم حذف الفئة:', deletedCategory);

                // تحديث جميع قوائم الفئات في الصفحة
                setTimeout(() => {
                    updateAllCategorySelects();
                    displayCategories();
                }, 100);

                // رسالة نجاح
                alert(`تم حذف الفئة "${deletedCategory.name}" بنجاح!`);
            } else {
                alert('حدث خطأ أثناء حذف الفئة');
            }
        }
        
        // مستمع لتحديثات البيانات لتحديث قائمة الفئات في نموذج تعديل المنتج
        window.addEventListener('monjizDataUpdate', function(e) {
            if (e.detail.dataType === 'monjizCategories') {
                // تحديث قائمة الفئات في نموذج التعديل إذا كان مفتوحاً
                const editCategorySelect = document.getElementById('editProductCategory');
                if (editCategorySelect) {
                    const currentValue = editCategorySelect.value;
                    const categories = window.dataManager.getCategories();
                    
                    // مسح الخيارات الحالية
                    editCategorySelect.innerHTML = '<option value="">اختر الفئة</option>';
                    
                    // إضافة الفئات الجديدة
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.code;
                        option.textContent = category.name;
                        if (category.code === currentValue) {
                            option.selected = true;
                        }
                        editCategorySelect.appendChild(option);
                    });
                }
            }
        });
    </script>
    <script>
        // دالة لعرض الفئات
        function displayCategories() {
            console.log('عرض الفئات...');
            const categoriesList = document.getElementById('categories-list');
            if (!categoriesList) {
                console.error('قائمة الفئات غير موجودة');
                return;
            }

            if (!window.dataManager) {
                console.error('مدير البيانات غير متاح');
                return;
            }

            const categories = window.dataManager.getCategories();
            console.log('الفئات المتاحة:', categories);

            // مسح المحتوى الحالي
            categoriesList.innerHTML = '';

            // عرض الفئات
            categories.forEach(category => {
                const item = document.createElement('li');
                item.className = 'category-item';
                item.innerHTML = `
                    <div class="category-name">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <span>${category.name}</span>
                    </div>
                    <div class="category-actions">
                        <button class="edit-category-btn" data-id="${category.id}" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-category-btn" data-id="${category.id}" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                categoriesList.appendChild(item);
            });

            // إضافة مستمعي الأحداث لأزرار التعديل والحذف
            addCategoryActionListeners();
        }

        // دالة لإضافة مستمعي الأحداث لأزرار التعديل والحذف
        function addCategoryActionListeners() {
            // أزرار التعديل
            document.querySelectorAll('.edit-category-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const categoryId = parseInt(this.getAttribute('data-id'));
                    editCategory(categoryId);
                });
            });

            // أزرار الحذف
            document.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const categoryId = parseInt(this.getAttribute('data-id'));
                    deleteCategory(categoryId);
                });
            });
        }

        // دالة لتعديل فئة
        function editCategory(categoryId) {
            console.log('تعديل الفئة رقم:', categoryId);

            if (!window.dataManager) {
                console.error('مدير البيانات غير متاح');
                return;
            }

            const categories = window.dataManager.getCategories();
            const category = categories.find(c => c.id === categoryId);

            if (!category) {
                console.error('الفئة غير موجودة');
                return;
            }

            // منع التمرير في الخلفية
            document.body.style.overflow = 'hidden';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content-modern" style="max-width: 500px;">
                    <div class="modal-header-modern">
                        <h3><i class="fas fa-edit"></i> تعديل الفئة</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body-modern">
                        <form class="form-modern" id="edit-category-form">
                            <input type="hidden" id="edit-category-id" value="${category.id}">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> اسم الفئة</label>
                                <input type="text" class="input-modern" placeholder="اسم الفئة" id="edit-category-name" required value="${category.name}" oninput="updateEditCategoryPreview(); validateEditCategoryName()">
                                <div class="error-message" id="edit-name-error" style="display: none;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span></span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-code"></i> رمز الفئة</label>
                                <input type="text" class="input-modern" placeholder="رمز الفئة (مثل: ELEC)" id="edit-category-code" required value="${category.code}" oninput="validateEditCategoryCode()" maxlength="10">
                                <div class="error-message" id="edit-code-error" style="display: none;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span></span>
                                </div>
                                <div class="success-message" id="edit-code-success" style="display: none;">
                                    <i class="fas fa-check-circle"></i>
                                    <span>رمز الفئة صحيح</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>وصف الفئة</label>
                                <textarea class="textarea-modern" rows="3" placeholder="وصف مختصر للفئة..." id="edit-category-description">${category.description || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label>لون الفئة</label>
                                <select class="select-modern" id="edit-category-color">
                                    <option value="primary" ${category.color === 'primary' ? 'selected' : ''}>أزرق (Primary)</option>
                                    <option value="success" ${category.color === 'success' ? 'selected' : ''}>أخضر (Success)</option>
                                    <option value="warning" ${category.color === 'warning' ? 'selected' : ''}>أصفر (Warning)</option>
                                    <option value="danger" ${category.color === 'danger' ? 'selected' : ''}>أحمر (Danger)</option>
                                    <option value="info" ${category.color === 'info' ? 'selected' : ''}>فيروزي (Info)</option>
                                    <option value="secondary" ${category.color === 'secondary' ? 'selected' : ''}>رمادي (Secondary)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>أيقونة الفئة</label>
                                <select class="select-modern" id="edit-category-icon" onchange="updateEditCategoryPreview()">
                                    <option value="fas fa-laptop" ${category.icon === 'fas fa-laptop' ? 'selected' : ''}>💻 لابتوب</option>
                                    <option value="fas fa-mobile-alt" ${category.icon === 'fas fa-mobile-alt' ? 'selected' : ''}>📱 هاتف</option>
                                    <option value="fas fa-tablet-alt" ${category.icon === 'fas fa-tablet-alt' ? 'selected' : ''}>📟 تابلت</option>
                                    <option value="fas fa-headphones" ${category.icon === 'fas fa-headphones' ? 'selected' : ''}>🎧 سماعات</option>
                                    <option value="fas fa-keyboard" ${category.icon === 'fas fa-keyboard' ? 'selected' : ''}>⌨️ لوحة مفاتيح</option>
                                    <option value="fas fa-mouse" ${category.icon === 'fas fa-mouse' ? 'selected' : ''}>🖱️ ماوس</option>
                                    <option value="fas fa-tv" ${category.icon === 'fas fa-tv' ? 'selected' : ''}>📺 شاشة</option>
                                    <option value="fas fa-camera" ${category.icon === 'fas fa-camera' ? 'selected' : ''}>📷 كاميرا</option>
                                    <option value="fas fa-gamepad" ${category.icon === 'fas fa-gamepad' ? 'selected' : ''}>🎮 ألعاب</option>
                                    <option value="fas fa-microchip" ${category.icon === 'fas fa-microchip' ? 'selected' : ''}>🔧 قطع غيار</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>معاينة الفئة</label>
                                <div class="category-preview" id="edit-category-preview">
                                    <span class="badge ${category.color}" id="edit-preview-badge">
                                        <i class="${category.icon}" id="edit-preview-icon"></i>
                                        <span id="edit-preview-name">${category.name}</span>
                                    </span>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-modern btn-primary" onclick="updateCategory()">
                                    <i class="fas fa-save"></i> حفظ التغييرات
                                </button>
                                <button type="button" class="btn-modern btn-secondary" onclick="closeModal(this)">
                                    <i class="fas fa-times"></i> إلغاء
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // إضافة وظيفة إغلاق عند الضغط على الخلفية
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.close-btn'));
                }
            });

            // التركيز على حقل اسم الفئة
            setTimeout(() => {
                const nameInput = document.getElementById('edit-category-name');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 100);
        }

        // دالة لتحديث معاينة الفئة في نموذج التعديل
        function updateEditCategoryPreview() {
            const name = document.getElementById('edit-category-name')?.value || 'اسم الفئة';
            const iconSelect = document.getElementById('edit-category-icon');
            const icon = iconSelect ? iconSelect.value : 'fas fa-laptop';
            const colorSelect = document.getElementById('edit-category-color');
            const color = colorSelect ? colorSelect.value : 'primary';

            const previewName = document.getElementById('edit-preview-name');
            const previewIcon = document.getElementById('edit-preview-icon');
            const previewBadge = document.getElementById('edit-preview-badge');

            if (previewName) previewName.textContent = name;
            if (previewIcon) {
                previewIcon.className = icon;
            }
            if (previewBadge) {
                previewBadge.className = `badge ${color}`;
            }
        }

        // دالة للتحقق من صحة اسم الفئة في نموذج التعديل
        function validateEditCategoryName() {
            const nameInput = document.getElementById('edit-category-name');
            const errorDiv = document.getElementById('edit-name-error');

            if (!nameInput || !errorDiv) return true;

            const name = nameInput.value.trim();

            if (name.length < 2) {
                showFieldError(nameInput, errorDiv, 'اسم الفئة يجب أن يكون أكثر من حرفين');
                return false;
            } else {
                hideFieldError(nameInput, errorDiv);
                return true;
            }
        }

        // دالة للتحقق من صحة رمز الفئة في نموذج التعديل
        function validateEditCategoryCode() {
            const codeInput = document.getElementById('edit-category-code');
            const errorDiv = document.getElementById('edit-code-error');
            const successDiv = document.getElementById('edit-code-success');

            if (!codeInput || !errorDiv || !successDiv) return true;

            const code = codeInput.value.trim();
            const codeRegex = /^[A-Za-z0-9_-]+$/;

            if (code.length < 2) {
                showFieldError(codeInput, errorDiv, 'رمز الفئة يجب أن يكون أكثر من حرفين');
                hideFieldSuccess(successDiv);
                return false;
            } else if (!codeRegex.test(code)) {
                showFieldError(codeInput, errorDiv, 'رمز الفئة يجب أن يحتوي على أحرف إنجليزية وأرقام فقط');
                hideFieldSuccess(successDiv);
                return false;
            } else {
                hideFieldError(codeInput, errorDiv);
                showFieldSuccess(successDiv);
                return true;
            }
        }

        // دالة لتحديث الفئة
        function updateCategory() {
            const id = parseInt(document.getElementById('edit-category-id').value);
            const name = document.getElementById('edit-category-name').value.trim();
            const code = document.getElementById('edit-category-code').value.trim();
            const description = document.getElementById('edit-category-description').value.trim();
            const color = document.getElementById('edit-category-color').value;
            const icon = document.getElementById('edit-category-icon').value;

            // التحقق من صحة البيانات
            if (!validateEditCategoryName() || !validateEditCategoryCode()) {
                return;
            }

            // تحديث الفئة
            const categoryData = {
                name,
                code,
                description,
                color,
                icon
            };

            const updatedCategory = window.dataManager.updateCategory(id, categoryData);

            if (updatedCategory) {
                console.log('تم تحديث الفئة:', updatedCategory);

                // تحديث جميع قوائم الفئات في الصفحة
                setTimeout(() => {
                    updateAllCategorySelects();
                    displayCategories();
                }, 100);
            } else {
                alert('حدث خطأ أثناء تحديث الفئة');
                return;
            }

            // إغلاق النافذة
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                closeModal(modal.querySelector('.close-btn'));
            }

            // رسالة نجاح
            alert(`تم تحديث الفئة "${name}" بنجاح!`);
        }

        // دالة لحذف فئة
        function deleteCategory(categoryId) {
            console.log('حذف الفئة رقم:', categoryId);

            if (!window.dataManager) {
                console.error('مدير البيانات غير متاح');
                return;
            }

            const categories = window.dataManager.getCategories();
            const category = categories.find(c => c.id === categoryId);

            if (!category) {
                console.error('الفئة غير موجودة');
                return;
            }

            // تأكيد الحذف
            if (!confirm(`هل أنت متأكد من حذف الفئة "${category.name}"؟`)) {
                return;
            }

            // حذف الفئة
            const deletedCategory = window.dataManager.deleteCategory(categoryId);

            if (deletedCategory) {
                console.log('تم حذف الفئة:', deletedCategory);

                // تحديث جميع قوائم الفئات في الصفحة
                setTimeout(() => {
                    updateAllCategorySelects();
                    displayCategories();
                }, 100);

                // رسالة نجاح
                alert(`تم حذف الفئة "${deletedCategory.name}" بنجاح!`);
            } else {
                alert('حدث خطأ أثناء حذف الفئة');
            }
        }
    </script>
</body>
</html>
