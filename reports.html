<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الأعمال - التقارير</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: white;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* تخصيص منطقة التقارير */
        .reports-section {
            background: white;
            min-height: calc(100vh - 80px);
            padding: 20px;
            margin-top: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .report-header-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .report-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 32px;
            position: relative;
            z-index: 1;
        }

        .report-info-enhanced {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .report-icon-wrapper {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .report-main-icon {
            font-size: 24px;
            color: white;
            display: block;
        }

        .report-text-info h2 {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
        }

        .system-status.connected {
            color: #28a745;
        }

        .system-status.connected i {
            color: #28a745;
        }

        .system-status.disconnected {
            color: #dc3545;
        }

        .system-status.disconnected i {
            color: #dc3545;
        }

        .system-status.checking i {
            color: #ffc107;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .report-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .breadcrumb-separator {
            opacity: 0.6;
        }

        .report-actions-enhanced {
            display: flex;
            gap: 12px;
        }

        .btn-enhanced {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-family: 'Cairo', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-generate {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.6);
        }

        .report-categories-modern {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .category-card-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: right;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
            border: none;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 18px;
            min-height: 100px;
        }

        .category-card-modern:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.35);
        }

        .category-icon-modern {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            width: 65px;
            height: 65px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
        }

        .category-card-modern:hover .category-icon-modern {
            transform: scale(1.1);
        }

        .category-content-modern {
            flex: 1;
        }

        .category-content-modern h3 {
            font-size: 19px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .category-content-modern p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
            line-height: 1.5;
            font-weight: 400;
            margin: 0;
        }

        #selected-report {
            display: none;
        }

        .report-content-modern {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        /* تنسيق التقارير المتاحة */
        .available-reports-modern {
            margin-top: 20px;
        }

        .reports-grid-modern {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 22px;
            margin-top: 25px;
        }

        .report-card-modern {
            background: white;
            border-radius: 15px;
            padding: 22px;
            box-shadow: 0 5px 18px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #f5f7fa;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .report-card-modern:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 28px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .report-card-modern:hover .report-icon-modern {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .report-icon-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .report-details-modern {
            flex: 1;
        }

        .report-details-modern h5 {
            margin: 0 0 6px 0;
            font-size: 17px;
            font-weight: 700;
            color: #2c3e50;
        }

        .report-details-modern p {
            margin: 0;
            font-size: 14px;
            color: #64748b;
            line-height: 1.5;
            font-weight: 400;
        }

        .report-action-modern {
            color: #667eea;
            font-size: 18px;
            flex-shrink: 0;
        }

        /* تنسيقات التقارير المفصلة */
        .report-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
        }

        .report-header h2 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .report-header p {
            color: #666;
            margin: 0;
            font-size: 16px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        .table-container {
            margin: 30px 0;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .empty-state {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .report-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #495057;
        }

        .report-table td {
            border: 1px solid #dee2e6;
            padding: 10px 8px;
            text-align: center;
        }

        .report-table .subtotal {
            background: #e9ecef;
            font-weight: 600;
        }

        .report-table .total {
            background: #667eea;
            color: white;
            font-weight: 700;
        }

        .report-table .final-total {
            background: #28a745;
            color: white;
            font-weight: 700;
        }

        .report-table .profit {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .summary-card .amount {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .summary-card .count {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .summary-card .average {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .summary-card .warning {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            color: #ffc107;
        }

        /* تحسين تنسيق التقارير */
        .report-container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }

        .report-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .report-header p {
            margin: 5px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .report-summary .summary-card {
            background: white;
            color: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .report-summary .summary-card h3 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .report-summary .summary-card .summary-value {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .report-table-container {
            padding: 0;
            margin: 0;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            background: white;
        }

        .report-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: right;
            font-size: 14px;
            font-weight: 600;
        }

        .report-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }

        .report-table tr:hover {
            background: #f8f9fa;
        }

        .status-available {
            color: #28a745;
            font-weight: bold;
        }

        .status-low {
            color: #ffc107;
            font-weight: bold;
        }

        .status-out {
            color: #dc3545;
            font-weight: bold;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }

        .summary-card .amount {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 0;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .no-data-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            background: white;
        }

        .no-data-message i {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 15px;
            display: block;
        }

        .no-data-message small {
            display: block;
            margin-top: 10px;
            color: #999;
            font-size: 12px;
        }

        /* تحسين النافذة المنبثقة للتقارير */
        .modal-overlay .modal-content {
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            margin: 2vh auto;
        }

        .modal-overlay .report-container {
            border-radius: 0;
            box-shadow: none;
        }

        /* تحسين الجدول للشاشات الصغيرة */
        @media (max-width: 768px) {
            .report-summary {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
                padding: 15px;
            }

            .report-summary .summary-card {
                padding: 10px;
            }

            .report-summary .summary-card h3 {
                font-size: 11px;
            }

            .report-summary .summary-card .summary-value {
                font-size: 16px;
            }

            .report-table th,
            .report-table td {
                padding: 8px 4px;
                font-size: 12px;
            }
        }

        /* تحسين ألوان الحالة */
        .status-paid {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .report-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .btn-print, .btn-excel, .btn-pdf {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-print {
            background: #6c757d;
            color: white;
        }

        .btn-excel {
            background: #28a745;
            color: white;
        }

        .btn-pdf {
            background: #dc3545;
            color: white;
        }

        .btn-print:hover, .btn-excel:hover, .btn-pdf:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* حالات الأصناف والعملاء */
        .status-paid { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-pending { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-good { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-warning { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-critical { background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-low { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 12px; }

        /* عناصر التحكم في التقارير */
        .report-controls-modern {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-control {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-apply-filters {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            font-family: 'Cairo', sans-serif;
        }

        .btn-apply-filters:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }



        /* ========== شريط التنقل الرئيسي الموحد ========== */
        .main-header {
            background: linear-gradient(to left, #0078ff, #00c3ff);
            color: white;
            padding: 10px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            height: 70px;
        }

        .main-header .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            height: 100%;
        }

        .main-header .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .main-header .logo i {
            font-size: 28px;
            color: #f39c12;
        }

        .main-header .logo h1 {
            font-size: 24px;
            margin: 0;
            font-weight: 600;
            color: white;
        }

        .main-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 0;
        }

        .main-nav li {
            margin: 0;
        }

        .main-nav a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            height: 50px;
            box-sizing: border-box;
        }

        .main-nav a:hover {
            background: rgba(255,255,255,0.1);
            border-bottom-color: #f39c12;
            transform: translateY(-1px);
        }

        .main-nav a.active {
            background: rgba(255,255,255,0.15);
            border-bottom-color: #f39c12;
            font-weight: 600;
        }

        .main-nav a i {
            font-size: 16px;
            width: 18px;
            text-align: center;
        }

        /* استجابة للشاشات الصغيرة */
        @media (max-width: 768px) {
            .main-header .container {
                flex-direction: column;
                height: auto;
                padding: 10px 20px;
            }

            .main-header .logo {
                margin-bottom: 10px;
            }

            .main-nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 5px;
            }

            .main-nav a {
                padding: 12px 15px;
                font-size: 13px;
                height: auto;
            }

            .main-header .logo h1 {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .main-nav ul {
                flex-direction: column;
                width: 100%;
            }

            .main-nav a {
                justify-content: center;
                padding: 15px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
        }

        /* أنماط حالة المخزون */
        .status-available {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-low {
            background-color: #fff3e0;
            color: #f57c00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-out {
            background-color: #ffebee;
            color: #d32f2f;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .total-row {
            border-top: 2px solid #dee2e6;
            background: #f8f9fa !important;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .badge.secondary {
            background-color: #f5f5f5;
            color: #616161;
        }

        .positive {
            color: #2e7d32;
            font-weight: 600;
        }

        /* إصلاح ألوان التقارير */
        .report-container {
            background: white;
            color: #333;
        }

        .report-header h2 {
            color: #333 !important;
            font-weight: 600;
        }

        .report-header p {
            color: #666 !important;
        }

        .report-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
        }

        .report-table td {
            color: #333 !important;
        }

        .summary-card h3,
        .summary-card h4 {
            color: #333 !important;
        }

        .summary-card p {
            color: #666 !important;
        }

        /* تأكيد ألوان النصوص في التقارير */
        #report-content h1,
        #report-content h2,
        #report-content h3,
        #report-content h4 {
            color: #333 !important;
        }

        #report-content p,
        #report-content span,
        #report-content div {
            color: #333 !important;
        }

        /* ألوان خاصة للقيم المالية */
        .amount {
            color: #2e7d32 !important;
            font-weight: bold;
        }

        .count {
            color: #1976d2 !important;
            font-weight: bold;
        }

        .average {
            color: #f57c00 !important;
            font-weight: bold;
        }

        /* ألوان الربح والخسارة */
        .profit {
            color: #2e7d32 !important;
            font-weight: bold;
        }

        .loss {
            color: #d32f2f !important;
            font-weight: bold;
        }

        .cost {
            color: #ff6f00 !important;
            font-weight: bold;
        }

        .margin {
            color: #1976d2 !important;
            font-weight: bold;
        }

        .negative {
            color: #d32f2f !important;
            font-weight: 600;
        }

        /* ألوان هامش الربح */
        .profit-high {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .profit-medium {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .profit-low {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .profit-loss {
            background-color: #ffebee;
            color: #d32f2f;
        }

        /* أنماط الطباعة لتقرير إغلاق اليوم */
        @media print {
            .report-container {
                max-width: none !important;
                margin: 0 !important;
                padding: 10px !important;
                box-shadow: none !important;
                page-break-inside: avoid;
            }

            .report-header {
                padding: 15px !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid;
            }

            .report-table {
                font-size: 0.75em !important;
                page-break-inside: auto;
            }

            .report-table thead {
                display: table-header-group;
            }

            .report-table tr {
                page-break-inside: avoid;
            }

            .total-row {
                page-break-inside: avoid;
            }

            /* إخفاء الأزرار عند الطباعة */
            button {
                display: none !important;
            }

            /* ضغط المساحات للطباعة */
            h3 {
                margin-bottom: 8px !important;
                font-size: 1em !important;
            }

            .summary-cards > div {
                padding: 8px !important;
            }
        }
    </style>
</head>
<body>
    <!-- شريط التنقل العلوي -->
    <header class="main-header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>نظام إدارة الأعمال</h1>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
                    <li><a href="sales.html"><i class="fas fa-shopping-cart"></i> المبيعات</a></li>
                    <li><a href="purchases.html"><i class="fas fa-truck"></i> المشتريات</a></li>
                    <li><a href="customers.html"><i class="fas fa-users"></i> العملاء</a></li>
                    <li><a href="suppliers.html"><i class="fas fa-user-tie"></i> الموردين</a></li>
                    <li><a href="products.html"><i class="fas fa-boxes"></i> المخزون</a></li>
                    <li><a href="reports.html" class="active"><i class="fas fa-chart-bar"></i> التقارير</a></li>
                    <li><a href="accounting.html"><i class="fas fa-calculator"></i> الحسابات</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- قسم التقارير -->
    <div class="reports-section">
        <div class="container">
        <!-- رأس التقرير المدمج -->
        <div class="report-header-modern" id="selected-report" style="padding: 15px 20px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="background: #667eea; color: white; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-chart-line" style="font-size: 1.2em;"></i>
                    </div>
                    <div>
                        <h2 id="report-title" style="margin: 0; font-size: 1.3em; color: white;">تقرير مفصل</h2>
                        <div style="font-size: 0.85em; color: rgba(255,255,255,0.8); margin-top: 2px;">
                            <i class="fas fa-home"></i> التقارير > <span id="breadcrumb-category">المالية</span>
                        </div>
                    </div>
                </div>
                <button class="btn-enhanced btn-back" onclick="goBack()" style="padding: 8px 15px; font-size: 0.9em;">
                    <i class="fas fa-arrow-right"></i>
                    <span>العودة</span>
                </button>
            </div>

            <!-- عناصر التحكم المحسنة -->
            <div class="report-controls-modern" id="report-controls" style="display: none; background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <!-- فلاتر المشتريات الشهرية -->
                <div id="monthly-controls" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <label style="font-size: 0.9em; color: #495057; margin-bottom: 8px; display: block; font-weight: 600;">
                                <i class="fas fa-calendar" style="margin-left: 8px; color: #667eea;"></i>
                                السنة
                            </label>
                            <select id="report-year" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95em; background: white; transition: border-color 0.3s;" onchange="updateMonthOptions()">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <label style="font-size: 0.9em; color: #495057; margin-bottom: 8px; display: block; font-weight: 600;">
                                <i class="fas fa-calendar-day" style="margin-left: 8px; color: #28a745;"></i>
                                الشهر
                            </label>
                            <select id="report-month" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95em; background: white; transition: border-color 0.3s;">
                                <option value="all">جميع الأشهر</option>
                                <option value="1">يناير</option>
                                <option value="2">فبراير</option>
                                <option value="3">مارس</option>
                                <option value="4">أبريل</option>
                                <option value="5">مايو</option>
                                <option value="6">يونيو</option>
                                <option value="7">يوليو</option>
                                <option value="8">أغسطس</option>
                                <option value="9">سبتمبر</option>
                                <option value="10">أكتوبر</option>
                                <option value="11">نوفمبر</option>
                                <option value="12">ديسمبر</option>
                            </select>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <label style="font-size: 0.9em; color: #495057; margin-bottom: 8px; display: block; font-weight: 600;">
                                <i class="fas fa-chart-bar" style="margin-left: 8px; color: #ffc107;"></i>
                                نوع العرض
                            </label>
                            <select id="report-view-type" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95em; background: white; transition: border-color 0.3s;">
                                <option value="summary">📊 ملخص شهري</option>
                                <option value="detailed">📋 تفاصيل بالفواتير</option>
                                <option value="comparison">📈 مقارنة بالسنة السابقة</option>
                            </select>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <button onclick="applyMonthlyReportFilters()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 0.95em; width: 100%; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-sync-alt" style="margin-left: 8px;"></i>
                                تحديث التقرير
                            </button>
                        </div>
                    </div>
                </div>

                <!-- فلاتر المبيعات الشهرية -->
                <div id="sales-monthly-controls" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <label style="font-size: 0.9em; color: #495057; margin-bottom: 8px; display: block; font-weight: 600;">
                                <i class="fas fa-calendar" style="margin-left: 8px; color: #667eea;"></i>
                                السنة
                            </label>
                            <select id="sales-report-year" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95em; background: white; transition: border-color 0.3s;">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <label style="font-size: 0.9em; color: #495057; margin-bottom: 8px; display: block; font-weight: 600;">
                                <i class="fas fa-calendar-day" style="margin-left: 8px; color: #28a745;"></i>
                                الشهر
                            </label>
                            <select id="sales-report-month" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95em; background: white; transition: border-color 0.3s;">
                                <option value="all">جميع الأشهر</option>
                                <option value="1">يناير</option>
                                <option value="2">فبراير</option>
                                <option value="3">مارس</option>
                                <option value="4">أبريل</option>
                                <option value="5">مايو</option>
                                <option value="6">يونيو</option>
                                <option value="7">يوليو</option>
                                <option value="8">أغسطس</option>
                                <option value="9">سبتمبر</option>
                                <option value="10">أكتوبر</option>
                                <option value="11">نوفمبر</option>
                                <option value="12">ديسمبر</option>
                            </select>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <label style="font-size: 0.9em; color: #495057; margin-bottom: 8px; display: block; font-weight: 600;">
                                <i class="fas fa-chart-bar" style="margin-left: 8px; color: #ffc107;"></i>
                                نوع العرض
                            </label>
                            <select id="sales-report-view-type" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95em; background: white; transition: border-color 0.3s;">
                                <option value="summary">📊 ملخص شهري</option>
                                <option value="detailed">📋 تفاصيل بالفواتير</option>
                                <option value="comparison">📈 مقارنة بالسنة السابقة</option>
                            </select>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <button onclick="applySalesMonthlyReportFilters()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 0.95em; width: 100%; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-sync-alt" style="margin-left: 8px;"></i>
                                تحديث التقرير
                            </button>
                        </div>
                    </div>
                </div>

                <!-- فلاتر عامة للتقارير الأخرى -->
                <div id="general-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                    <div>
                        <label for="report-date-from" style="font-size: 0.85em; color: #666; margin-bottom: 5px; display: block;">من تاريخ:</label>
                        <input type="date" id="report-date-from" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label for="report-date-to" style="font-size: 0.85em; color: #666; margin-bottom: 5px; display: block;">إلى تاريخ:</label>
                        <input type="date" id="report-date-to" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label for="report-account" style="font-size: 0.85em; color: #666; margin-bottom: 5px; display: block;">الحساب:</label>
                        <select id="report-account" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em;">
                            <!-- سيتم ملء الخيارات ديناميكياً -->
                        </select>
                    </div>
                    <div>
                        <button onclick="applyReportFilters()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9em; width: 100%;">
                            <i class="fas fa-filter"></i> تطبيق
                        </button>
                    </div>
                </div>
            </div>

            <!-- محتوى التقرير المحسن -->
            <div class="report-content-modern" id="report-content">
                <!-- سيتم ملء هذا القسم ديناميكياً حسب الفئة المختارة -->
            </div>
        </div>

        <!-- اختيار نوع التقرير -->
        <div class="report-categories-modern">
            <div class="category-card-modern" data-category="financial" onclick="selectCategory('financial')">
                <div class="category-icon-modern">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="category-content-modern">
                    <h3>التقارير المالية</h3>
                    <p>قوائم مالية وتقارير محاسبية شاملة</p>
                </div>
            </div>

            <div class="category-card-modern" data-category="sales" onclick="selectCategory('sales')">
                <div class="category-icon-modern">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="category-content-modern">
                    <h3>تقارير المبيعات</h3>
                    <p>تحليل المبيعات والأداء التجاري</p>
                </div>
            </div>

            <div class="category-card-modern" data-category="purchases" onclick="selectCategory('purchases')">
                <div class="category-icon-modern">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="category-content-modern">
                    <h3>تقارير المشتريات</h3>
                    <p>تحليل المشتريات وأداء الموردين</p>
                </div>
            </div>

            <div class="category-card-modern" data-category="inventory" onclick="selectCategory('inventory')">
                <div class="category-icon-modern">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="category-content-modern">
                    <h3>تقارير المخزون</h3>
                    <p>حركة المخزون والجرد والتقييم</p>
                </div>
            </div>

            <div class="category-card-modern" data-category="customers" onclick="selectCategory('customers')">
                <div class="category-icon-modern">
                    <i class="fas fa-users"></i>
                </div>
                <div class="category-content-modern">
                    <h3>تقارير العملاء</h3>
                    <p>تحليل العملاء والمديونيات</p>
                </div>
            </div>

            <div class="category-card-modern" data-category="suppliers" onclick="selectCategory('suppliers')">
                <div class="category-icon-modern">
                    <i class="fas fa-handshake"></i>
                </div>
                <div class="category-content-modern">
                    <h3>تقارير الموردين</h3>
                    <p>تحليل الموردين والمدفوعات</p>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // متغيرات عامة محسنة
        let currentCategory = null;
        let currentReportType = null;
        let navigationHistory = [];
        let currentView = 'categories'; // categories, reports, report-detail
        let savedFilters = {}; // لحفظ المرشحات المختارة

        // وظيفة عرض التقرير مباشرة
        function generateReportDirectly(reportType) {
            console.log('📊 عرض التقرير مباشرة:', reportType);

            try {
                let reportData;

                if (reportType === 'end-of-day') {
                    // تعيين نوع التقرير
                    currentReportType = 'end-of-day';

                    // الحصول على بيانات التقرير
                    reportData = getDetailedReportData('end-of-day');

                    if (!reportData || !reportData.html) {
                        throw new Error('فشل في إنشاء تقرير إغلاق اليوم');
                    }

                    // عرض التقرير
                    const reportContent = document.getElementById('report-content');
                    if (reportContent) {
                        reportContent.innerHTML = reportData.html;
                        showSuccessMessage('تم عرض تقرير إغلاق اليوم بنجاح!');
                    } else {
                        throw new Error('عنصر عرض التقرير غير موجود');
                    }
                } else {
                    throw new Error('نوع التقرير غير مدعوم: ' + reportType);
                }

            } catch (error) {
                console.error('❌ خطأ في عرض التقرير:', error);
                showErrorMessage('حدث خطأ في عرض التقرير: ' + error.message);
            }
        }

        // وظيفة فحص حالة النظام المركزي
        function checkSystemStatus() {
            console.log('🔍 فحص حالة النظام المركزي...');

            let statusMessage = '';
            let statusColor = '';

            try {
                // التحقق من وجود النظام المركزي
                if (!window.dataManager) {
                    console.log('🔄 تهيئة النظام المركزي...');
                    window.dataManager = new DataManager();
                }

                // جمع إحصائيات النظام
                const products = window.dataManager.getProducts();
                const customers = window.dataManager.getCustomers();
                const sales = window.dataManager.getSales();
                const suppliers = window.dataManager.getSuppliers ? window.dataManager.getSuppliers() : [];

                statusMessage = `
                    ✅ النظام المركزي يعمل بشكل طبيعي

                    📊 إحصائيات النظام:
                    • المنتجات: ${products.length}
                    • العملاء: ${customers.length}
                    • المبيعات: ${sales.length}
                    • الموردين: ${suppliers.length}

                    🔗 جميع التقارير مرتبطة بالنظام المركزي
                    📈 البيانات محدثة في الوقت الفعلي
                `;
                statusColor = '#28a745';

                console.log('✅ النظام المركزي يعمل بشكل طبيعي:', {
                    products: products.length,
                    customers: customers.length,
                    sales: sales.length,
                    suppliers: suppliers.length
                });

            } catch (error) {
                console.error('❌ خطأ في النظام المركزي:', error);
                statusMessage = `
                    ❌ خطأ في النظام المركزي

                    تفاصيل الخطأ: ${error.message}

                    🔧 الحلول المقترحة:
                    • إعادة تحميل الصفحة
                    • التحقق من ملف data-manager.js
                    • مراجعة وحدة التحكم للأخطاء
                `;
                statusColor = '#dc3545';
            }

            // عرض النتيجة
            const reportContent = document.getElementById('report-content');
            if (reportContent) {
                reportContent.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); text-align: center;">
                        <div style="font-size: 4em; margin-bottom: 20px; color: ${statusColor};">
                            <i class="fas fa-${statusColor === '#28a745' ? 'check-circle' : 'exclamation-triangle'}"></i>
                        </div>
                        <h2 style="color: ${statusColor}; margin-bottom: 20px;">حالة النظام المركزي</h2>
                        <pre style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: right; white-space: pre-wrap; font-family: 'Arial', sans-serif;">${statusMessage}</pre>
                        <div style="margin-top: 30px;">
                            <button class="btn" onclick="location.reload()" style="background: #667eea; color: white; margin: 5px;">
                                <i class="fas fa-redo"></i> إعادة تحميل الصفحة
                            </button>

                        </div>
                    </div>
                `;
            }

            showSuccessMessage('تم فحص حالة النظام المركزي');
        }



        // وظيفة اختبار إنشاء التقارير
        function testReportGeneration() {
            console.log('🧪 بدء اختبار إنشاء التقارير...');

            // التحقق من وجود الوظائف المطلوبة
            if (typeof generateSalesReport === 'undefined') {
                console.error('❌ وظيفة generateSalesReport غير معرّفة');
                showErrorMessage('وظيفة generateSalesReport غير معرّفة. تأكد من تحميل ملف js/reports.js');
                return;
            }

            // اختبار تقرير المبيعات اليومية
            currentReportType = 'daily';
            console.log('📊 اختبار تقرير المبيعات اليومية...');

            try {
                // اختبار الوظائف الأساسية أولاً
                console.log('🔧 اختبار الوظائف الأساسية...');
                const salesData = generateSalesReport('daily');
                console.log('✅ وظيفة generateSalesReport تعمل:', salesData);

                const reportData = getDetailedReportData('daily');
                console.log('✅ نجح إنشاء تقرير المبيعات اليومية:', reportData);

                const reportContent = document.getElementById('report-content');
                if (reportContent) {
                    reportContent.innerHTML = reportData.html;
                    showSuccessMessage('تم اختبار التقرير بنجاح! جميع الوظائف تعمل بشكل صحيح.');
                } else {
                    console.error('❌ عنصر report-content غير موجود');
                    showErrorMessage('عنصر عرض التقرير غير موجود');
                }
            } catch (error) {
                console.error('❌ فشل اختبار التقرير:', error);
                showErrorMessage('فشل في اختبار التقرير: ' + error.message);
            }
        }

        // إضافة event listener عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ تم تحميل صفحة التقارير بنجاح');
            console.log('🔧 تم إصلاح تقرير المشتريات حسب المورد - جاهز للاستخدام!');
            console.log('📦 تم إضافة تقرير المشتريات حسب المنتج - مرتبط بالنظام المركزي!');
            console.log('🛠️ تم إصلاح جميع أخطاء includes - الفلاتر تعمل بشكل صحيح!');
            console.log('🔍 تم إضافة البحث المتقدم في localStorage للمشتريات!');

            // تشخيص سريع للمشتريات
            console.log('🔍 تشخيص سريع للمشتريات:');
            const storageKeys = Object.keys(localStorage);
            console.log('📂 جميع مفاتيح localStorage:', storageKeys);

            const purchaseKeys = storageKeys.filter(key =>
                key.toLowerCase().includes('purchase') ||
                key.toLowerCase().includes('شراء') ||
                key === 'monjizPurchases'
            );
            console.log('🛒 مفاتيح المشتريات:', purchaseKeys);

            purchaseKeys.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key) || '[]');
                    console.log(`📦 ${key}: ${Array.isArray(data) ? data.length : 'ليس مصفوفة'} عنصر`);
                    if (Array.isArray(data) && data.length > 0) {
                        console.log(`📊 عينة من ${key}:`, data[0]);
                    }
                } catch (e) {
                    console.log(`⚠️ خطأ في قراءة ${key}:`, e.message);
                }
            });

            // تهيئة الحالة الأولية
            initializeReportsPage();

            // إعداد نظام التحديث التلقائي
            setupAutoRefresh();

            // فحص حالة النظام المركزي
            checkSystemStatus();

            // إصلاح بيانات المنتجات عند تحميل الصفحة
            if (typeof fixProductsData === 'function') {
                setTimeout(() => {
                    fixProductsData();
                }, 1000);
            }

            // مستمع لتحديثات المخزون
            window.addEventListener('inventoryUpdated', function(event) {
                console.log('📦 تم استلام إشعار تحديث المخزون في التقارير');

                // إعادة تحميل تقرير المخزون إذا كان مفتوحاً
                if (currentReportType && currentReportType.includes('inventory')) {
                    console.log('🔄 إعادة تحميل تقرير المخزون...');
                    setTimeout(() => {
                        generateReport(currentReportType);
                    }, 500);
                }
            });

            // إضافة event delegation للتقارير
            document.addEventListener('click', function(e) {
                const reportCard = e.target.closest('.report-card-modern');
                if (reportCard) {
                    const reportType = reportCard.getAttribute('data-report-type');
                    if (reportType) {
                        console.log('📊 تم النقر على التقرير:', reportType);

                        // رسالة خاصة لتقرير المشتريات حسب المورد
                        if (reportType === 'by-supplier') {
                            console.log('🎉 تم إصلاح تقرير المشتريات حسب المورد - جاري التحميل...');
                        }

                        currentReportType = reportType;
                        generateReportDirectly(reportType);
                    }
                }
            });

            // إضافة دعم للتنقل بالكيبورد
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    goBack();
                }
            });
        });

        // دالة تهيئة الصفحة
        function initializeReportsPage() {
            currentView = 'categories';
            navigationHistory = [];
            updateBreadcrumb();
        }

        // دالة اختيار فئة التقرير محسنة
        function selectCategory(category) {
            console.log('تم اختيار فئة:', category);

            // حفظ الحالة السابقة في التاريخ
            if (currentView === 'categories') {
                navigationHistory.push({
                    view: 'categories',
                    category: null,
                    reportType: null
                });
            }

            // تحديث الحالة الحالية
            currentCategory = category;
            currentReportType = null;
            currentView = 'reports';

            // إخفاء قسم الفئات وإظهار قسم التقرير المحدد مع تأثير انتقال
            const categoriesSection = document.querySelector('.report-categories-modern');
            const selectedSection = document.getElementById('selected-report');

            categoriesSection.style.opacity = '0';
            setTimeout(() => {
                categoriesSection.style.display = 'none';
                selectedSection.style.display = 'block';
                selectedSection.style.opacity = '0';
                setTimeout(() => {
                    selectedSection.style.opacity = '1';
                }, 50);
            }, 200);

            // تحديث عنوان التقرير
            const titles = {
                'financial': 'التقارير المالية',
                'sales': 'تقارير المبيعات',
                'purchases': 'تقارير المشتريات',
                'inventory': 'تقارير المخزون',
                'customers': 'تقارير العملاء',
                'suppliers': 'تقارير الموردين'
            };

            const categoryNames = {
                'financial': 'المالية',
                'sales': 'المبيعات',
                'purchases': 'المشتريات',
                'inventory': 'المخزون',
                'customers': 'العملاء',
                'suppliers': 'الموردين'
            };

            document.getElementById('report-title').textContent = titles[category] || 'تقرير مفصل';
            document.getElementById('breadcrumb-category').textContent = categoryNames[category] || 'تقرير مفصل';

            // تحديث breadcrumb
            updateBreadcrumb();

            // عرض التقارير المتاحة للفئة المختارة
            displayAvailableReports(category);
        }

        // دالة عرض التقارير المتاحة
        function displayAvailableReports(category) {
            const reportContent = document.getElementById('report-content');
            if (!reportContent) return;

            const categoryOptions = {
                'financial': [
                    { value: 'end-of-day', text: 'إغلاق اليوم', icon: 'fas fa-moon', description: 'تقرير شامل لإغلاق اليوم مع المبيعات والحركة المحاسبية' },
                    { value: 'balance-sheet', text: 'قائمة المركز المالي', icon: 'fas fa-balance-scale', description: 'الميزانية العمومية والأصول والخصوم' },
                    { value: 'profit-loss', text: 'قائمة الأرباح والخسائر', icon: 'fas fa-chart-line', description: 'الإيرادات والمصروفات وصافي الربح' },
                    { value: 'cash-flow', text: 'قائمة التدفقات النقدية', icon: 'fas fa-money-bill-wave', description: 'التدفقات النقدية الداخلة والخارجة' },
                    { value: 'trial-balance', text: 'ميزان المراجعة', icon: 'fas fa-calculator', description: 'أرصدة جميع الحسابات' },
                    { value: 'account-statement', text: 'كشف الحساب', icon: 'fas fa-file-invoice', description: 'كشف حساب محاسبي مفصل مع الحركات والأرصدة' }
                ],
                'sales': [
                    { value: 'daily', text: 'المبيعات اليومية', icon: 'fas fa-calendar-day', description: 'تقرير مبيعات اليوم' },
                    { value: 'monthly', text: 'المبيعات الشهرية', icon: 'fas fa-calendar-alt', description: 'تقرير مبيعات الشهر' },
                    { value: 'by-customer', text: 'المبيعات حسب العميل', icon: 'fas fa-user-tie', description: 'تحليل مبيعات كل عميل' },
                    { value: 'by-product', text: 'المبيعات حسب المنتج', icon: 'fas fa-box', description: 'تحليل مبيعات كل منتج' }
                ],
                'purchases': [
                    { value: 'purchases-daily', text: 'المشتريات اليومية', icon: 'fas fa-calendar-day', description: 'تقرير مشتريات اليوم' },
                    { value: 'purchases-monthly', text: 'المشتريات الشهرية', icon: 'fas fa-calendar-alt', description: 'تقرير مشتريات الشهر' },
                    { value: 'by-supplier', text: 'المشتريات حسب المورد', icon: 'fas fa-handshake', description: 'تحليل مشتريات كل مورد' },
                    { value: 'purchases-by-product', text: 'المشتريات حسب المنتج', icon: 'fas fa-box', description: 'تحليل مشتريات كل منتج' }
                ],
                'inventory': [
                    { value: 'current-stock', text: 'المخزون الحالي', icon: 'fas fa-warehouse', description: 'كميات وقيم المخزون الحالي' },
                    { value: 'stock-movement', text: 'حركة المخزون', icon: 'fas fa-exchange-alt', description: 'حركات الدخول والخروج' },
                    { value: 'product-operations', text: 'عمليات صنف', icon: 'fas fa-chart-line', description: 'حركات شراء وبيع صنف خلال فترة زمنية' },
                    { value: 'low-stock', text: 'تقرير النواقص', icon: 'fas fa-exclamation-triangle', description: 'الأصناف التي وصلت للحد الأدنى' },
                    { value: 'stock-valuation', text: 'تقييم المخزون', icon: 'fas fa-dollar-sign', description: 'تقييم المخزون بالتكلفة والسوق' }
                ],
                'customers': [
                    { value: 'customer-list', text: 'قائمة العملاء', icon: 'fas fa-list', description: 'جميع بيانات العملاء' },
                    { value: 'customer-balances', text: 'أرصدة العملاء', icon: 'fas fa-credit-card', description: 'المديونيات والمدفوعات' },
                    { value: 'customer-analysis', text: 'تحليل العملاء', icon: 'fas fa-chart-bar', description: 'تحليل سلوك وأداء العملاء' },
                    { value: 'customer-aging', text: 'أعمار الديون', icon: 'fas fa-clock', description: 'تحليل أعمار ديون العملاء' }
                ],
                'suppliers': [
                    { value: 'supplier-list', text: 'قائمة الموردين', icon: 'fas fa-user-tie', description: 'جميع بيانات الموردين' },
                    { value: 'supplier-balances', text: 'أرصدة الموردين', icon: 'fas fa-credit-card', description: 'المستحقات والمدفوعات' },
                    { value: 'supplier-analysis', text: 'تحليل الموردين', icon: 'fas fa-chart-bar', description: 'أداء الموردين والجودة' },
                    { value: 'supplier-evaluation', text: 'تقييم الموردين', icon: 'fas fa-star', description: 'تقييم أداء وموثوقية الموردين' }
                ]
            };

            const reports = categoryOptions[category] || [];

            if (reports.length === 0) {
                reportContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">لا توجد تقارير متاحة لهذه الفئة</div>';
                return;
            }

            reportContent.innerHTML = `
                <div class="available-reports-modern">
                    <div class="reports-grid-modern">
                        ${reports.map(report => `
                            <div class="report-card-modern" data-report-type="${report.value}">
                                <div class="report-icon-modern">
                                    <i class="${report.icon}"></i>
                                </div>
                                <div class="report-details-modern">
                                    <h5>${report.text}</h5>
                                    <p>${report.description}</p>
                                </div>
                                <div class="report-action-modern">
                                    <i class="fas fa-arrow-left"></i>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // دالة العودة المحسنة
        function goBack() {
            console.log('العودة من:', currentView);

            if (currentView === 'report-detail') {
                // العودة من تفاصيل التقرير إلى قائمة التقارير
                currentView = 'reports';
                // لا نعيد تعيين currentReportType للاحتفاظ بالمرشحات
                // currentReportType = null;

                // إخفاء عناصر التحكم
                const reportControls = document.getElementById('report-controls');
                if (reportControls) {
                    reportControls.style.display = 'none';
                }

                // إخفاء زر إنشاء التقرير
                const generateBtn = document.getElementById('generate-report-btn');
                if (generateBtn) {
                    generateBtn.style.display = 'none';
                }

                // عرض قائمة التقارير للفئة الحالية
                displayAvailableReports(currentCategory);

                // تحديث العنوان
                const titles = {
                    'financial': 'التقارير المالية',
                    'sales': 'تقارير المبيعات',
                    'purchases': 'تقارير المشتريات',
                    'inventory': 'تقارير المخزون',
                    'customers': 'تقارير العملاء',
                    'suppliers': 'تقارير الموردين'
                };

                document.getElementById('report-title').textContent = titles[currentCategory] || 'تقرير مفصل';

            } else if (currentView === 'reports') {
                // العودة من قائمة التقارير إلى الفئات الرئيسية
                currentView = 'categories';
                currentCategory = null;
                // نعيد تعيين currentReportType فقط عند العودة للفئات الرئيسية
                currentReportType = null;

                // إخفاء عناصر التحكم
                const reportControls = document.getElementById('report-controls');
                if (reportControls) {
                    reportControls.style.display = 'none';
                }

                // إخفاء قسم التقرير المحدد وإظهار الفئات مع تأثير انتقال
                const categoriesSection = document.querySelector('.report-categories-modern');
                const selectedSection = document.getElementById('selected-report');

                selectedSection.style.opacity = '0';
                setTimeout(() => {
                    selectedSection.style.display = 'none';
                    categoriesSection.style.display = 'grid';
                    categoriesSection.style.opacity = '0';
                    setTimeout(() => {
                        categoriesSection.style.opacity = '1';
                    }, 50);
                }, 200);

                // إخفاء زر إنشاء التقرير
                const generateBtn = document.getElementById('generate-report-btn');
                if (generateBtn) {
                    generateBtn.style.display = 'none';
                }
            }

            // تحديث breadcrumb
            updateBreadcrumb();
        }

        // وظيفة تحديث تقرير المخزون
        function refreshInventoryReport() {
            console.log('🔄 إعادة تحميل تقرير المخزون...');

            // استخدام وظيفة الإصلاح الجديدة
            if (typeof fixProductsData === 'function') {
                fixProductsData();
            } else {
                console.warn('⚠️ وظيفة fixProductsData غير متاحة');
            }

            // إعادة إنشاء التقرير
            if (currentReportType && currentReportType.includes('inventory')) {
                setTimeout(() => {
                    generateReport(currentReportType);
                }, 500);
            } else {
                // إذا لم يكن هناك تقرير مفتوح، افتح تقرير المخزون الحالي
                setTimeout(() => {
                    generateReport('inventory-current');
                }, 500);
            }
        }

        // إعداد نظام التحديث التلقائي للتقارير
        function setupAutoRefresh() {
            console.log('🔄 إعداد نظام التحديث التلقائي للتقارير');

            // الاستماع لتحديثات النظام المركزي
            if (window.BroadcastChannel) {
                const channel = new BroadcastChannel('monjiz-updates');
                channel.addEventListener('message', function(event) {
                    const { type, data } = event.data;
                    console.log('📡 تم استلام تحديث:', type, data);

                    // تحديث التقارير عند تغيير البيانات
                    switch(type) {
                        case 'sales-updated':
                        case 'purchase-updated':
                        case 'customer-updated':
                        case 'supplier-updated':
                        case 'product-updated':
                        case 'account-updated':
                            refreshCurrentReport();
                            break;
                    }
                });
            }

            // الاستماع لتحديثات localStorage
            window.addEventListener('storage', function(e) {
                if (e.key && (
                    e.key.startsWith('monjiz') ||
                    e.key === 'chartOfAccounts'
                )) {
                    console.log('💾 تم تحديث البيانات في localStorage:', e.key);
                    refreshCurrentReport();
                }
            });

            // تحديث دوري كل 30 ثانية
            setInterval(function() {
                if (currentReportType && window.dataManager) {
                    console.log('⏰ تحديث دوري للتقرير');
                    refreshCurrentReport();
                }
            }, 30000);
        }

        // تحديث التقرير الحالي مع الحفاظ على الفلاتر
        function refreshCurrentReportLegacy() {
            if (currentReportType && currentView === 'report-detail') {
                console.log('🔄 تحديث التقرير الحالي (Legacy):', currentReportType);
                // استخدام الفلاتر المحفوظة
                const filters = savedFilters[currentReportType] || {};
                const reportData = getDetailedReportData(currentReportType, filters);
                const reportContent = document.getElementById('report-content');
                if (reportContent && reportData) {
                    reportContent.innerHTML = reportData.html;
                }
            }
        }

        // فحص حالة النظام المركزي
        function checkSystemStatus() {
            const statusElement = document.getElementById('system-status');
            if (!statusElement) return;

            // تحديث حالة الفحص
            statusElement.className = 'system-status checking';
            statusElement.innerHTML = '<i class="fas fa-circle"></i><span>جاري فحص النظام...</span>';

            setTimeout(() => {
                if (window.dataManager) {
                    // النظام متصل
                    statusElement.className = 'system-status connected';
                    statusElement.innerHTML = '<i class="fas fa-circle"></i><span>النظام المركزي متصل</span>';

                    // عرض إحصائيات سريعة
                    const stats = getSystemStats();
                    if (stats) {
                        statusElement.innerHTML = `<i class="fas fa-circle"></i><span>متصل - ${stats.customers} عميل، ${stats.products} منتج، ${stats.sales} فاتورة</span>`;
                    }

                    console.log('✅ النظام المركزي متصل ويعمل بشكل طبيعي');
                } else {
                    // النظام غير متصل
                    statusElement.className = 'system-status disconnected';
                    statusElement.innerHTML = '<i class="fas fa-circle"></i><span>النظام المركزي غير متاح - البيانات من التخزين المحلي</span>';

                    console.log('⚠️ النظام المركزي غير متاح، سيتم استخدام البيانات المحلية');
                }
            }, 1000);

            // فحص دوري كل دقيقة
            setInterval(() => {
                checkSystemStatus();
            }, 60000);
        }

        // الحصول على إحصائيات النظام
        function getSystemStats() {
            if (!window.dataManager) return null;

            try {
                const customers = window.dataManager.getCustomers().length;
                const products = window.dataManager.getProducts().length;
                const sales = window.dataManager.getSales().length;
                const suppliers = window.dataManager.getSuppliers().length;

                return { customers, products, sales, suppliers };
            } catch (error) {
                console.error('خطأ في جلب إحصائيات النظام:', error);
                return null;
            }
        }



        // دالة إنشاء التقرير مباشرة محسنة
        function generateReportDirectly(reportType) {
            console.log('إنشاء التقرير:', reportType);

            // تحديث الحالة
            currentReportType = reportType;
            currentView = 'report-detail';

            const reportContent = document.getElementById('report-content');
            const reportControls = document.getElementById('report-controls');
            const monthlyControls = document.getElementById('monthly-controls');
            const generalControls = document.getElementById('general-controls');

            if (reportContent) {
                // إظهار عناصر التحكم
                if (reportControls) {
                    reportControls.style.display = 'block';

                    // إظهار الفلاتر المناسبة حسب نوع التقرير
                    const salesMonthlyControls = document.getElementById('sales-monthly-controls');

                    if (reportType === 'purchases-monthly') {
                        // إظهار فلاتر المشتريات الشهرية
                        if (monthlyControls) monthlyControls.style.display = 'block';
                        if (salesMonthlyControls) salesMonthlyControls.style.display = 'none';
                        if (generalControls) generalControls.style.display = 'none';
                        console.log('📊 تم تفعيل فلاتر المشتريات الشهرية');
                    } else if (reportType === 'monthly') {
                        // إظهار فلاتر المبيعات الشهرية
                        if (monthlyControls) monthlyControls.style.display = 'none';
                        if (salesMonthlyControls) salesMonthlyControls.style.display = 'block';
                        if (generalControls) generalControls.style.display = 'none';
                        console.log('📊 تم تفعيل فلاتر المبيعات الشهرية');
                    } else {
                        // إظهار الفلاتر العامة للتقارير الأخرى
                        if (monthlyControls) monthlyControls.style.display = 'none';
                        if (salesMonthlyControls) salesMonthlyControls.style.display = 'none';
                        if (generalControls) generalControls.style.display = 'grid';
                        // تعيين التواريخ الافتراضية
                        setDefaultDates();
                        // تحديث خيارات الحسابات حسب نوع التقرير
                        updateAccountOptions(reportType);
                        // استعادة المرشحات المحفوظة إن وجدت
                        restoreSavedFilters(reportType);
                    }
                }

                // إظهار مؤشر التحميل
                reportContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 20px; color: #666;">جاري تحميل التقرير...</p>
                    </div>
                `;

                // تأخير قصير لإظهار التحميل
                setTimeout(() => {
                    try {
                        console.log('🔄 بدء إنشاء التقرير:', reportType);
                        const reportData = getDetailedReportData(reportType);

                        if (!reportData) {
                            throw new Error('لم يتم العثور على بيانات التقرير');
                        }

                        if (!reportData.html) {
                            throw new Error('محتوى التقرير فارغ');
                        }

                        console.log('✅ تم إنشاء التقرير بنجاح:', reportData.title);
                        reportContent.innerHTML = reportData.html;

                        // تحديث العنوان
                        document.getElementById('report-title').textContent = reportData.title;

                        // إظهار زر إنشاء التقرير
                        const generateBtn = document.getElementById('generate-report-btn');
                        if (generateBtn) {
                            generateBtn.style.display = 'flex';
                        }

                        // تحديث breadcrumb
                        updateBreadcrumb();

                        // تمرير سلس إلى أعلى التقرير
                        reportContent.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    } catch (error) {
                        console.error('❌ خطأ في إنشاء التقرير:', error);
                        reportContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                                <h3>خطأ في تحميل التقرير</h3>
                                <p>حدث خطأ أثناء تحميل التقرير: ${error.message}</p>
                                <button onclick="generateReportDirectly('${reportType}')" class="btn-enhanced" style="margin-top: 20px;">
                                    <i class="fas fa-redo"></i>
                                    <span>إعادة المحاولة</span>
                                </button>
                            </div>
                        `;
                    }

                }, 500);
            }
        }

        // دوال عناصر التحكم في التقارير
        function setDefaultDates() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            const dateFromInput = document.getElementById('report-date-from');
            const dateToInput = document.getElementById('report-date-to');

            if (dateFromInput) {
                dateFromInput.value = firstDayOfMonth.toISOString().split('T')[0];
            }
            if (dateToInput) {
                dateToInput.value = today.toISOString().split('T')[0];
            }
        }

        // متغير عام لخيارات التقارير
        window.reportFilters = {};

        // دالة استعادة المرشحات المحفوظة
        function restoreSavedFilters(reportType) {
            if (!savedFilters[reportType]) return;

            const filters = savedFilters[reportType];
            console.log('🔄 استعادة المرشحات المحفوظة لـ', reportType, ':', filters);

            // استعادة التواريخ
            const dateFromElement = document.getElementById('report-date-from');
            const dateToElement = document.getElementById('report-date-to');
            const accountElement = document.getElementById('report-account');
            const branchElement = document.getElementById('report-branch');

            if (dateFromElement && filters.dateFrom) {
                dateFromElement.value = filters.dateFrom;
            }
            if (dateToElement && filters.dateTo) {
                dateToElement.value = filters.dateTo;
            }
            if (accountElement && filters.account) {
                accountElement.value = filters.account;
            }
            if (branchElement && filters.branch) {
                branchElement.value = filters.branch;
            }

            console.log('✅ تم استعادة المرشحات بنجاح');
        }

        // تأكيد تسجيل الدخول عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تسجيل دخول تلقائي
            localStorage.setItem('monjizLoggedIn', 'true');
        });



        // دالة تحديث خيارات الحسابات حسب نوع التقرير
        function updateAccountOptions(reportType) {
            console.log('🔄 تحديث خيارات الحسابات لتقرير:', reportType);

            const accountSelect = document.getElementById('report-account');
            if (!accountSelect) {
                console.log('❌ عنصر report-account غير موجود');
                return;
            }

            // حفظ القيمة المختارة حالياً
            const currentValue = accountSelect.value;
            console.log('💾 القيمة المحفوظة:', currentValue);

            // مسح الخيارات الحالية بالكامل
            accountSelect.innerHTML = '';
            console.log('🧹 تم مسح جميع الخيارات');

            // إضافة الخيار الافتراضي
            const defaultOption = document.createElement('option');
            defaultOption.value = '';

            if (reportType === 'sales-by-customer' || reportType === 'by-customer' ||
                reportType === 'customer-analysis' || reportType === 'customer-balances' ||
                reportType === 'customer-aging' || reportType === 'customer-list') {

                // تنظيف القائمة أولاً لمنع التكرار
                accountSelect.innerHTML = '';
                console.log('🧹 تم تنظيف قائمة العملاء');

                // إضافة الخيار الافتراضي
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'جميع العملاء';
                accountSelect.appendChild(defaultOption);

                let customersData = [];
                if (window.dataManager) {
                    customersData = window.dataManager.getCustomers();
                    console.log('👥 تم جلب العملاء من النظام المركزي:', customersData.length);
                } else {
                    customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                    console.log('👥 تم جلب العملاء من localStorage:', customersData.length);
                }

                // إزالة العملاء المكررين بناءً على الاسم والهاتف (أكثر ذكاءً)
                const uniqueCustomers = [];
                const seenCustomers = new Map();

                customersData.forEach(customer => {
                    if (customer && customer.name) {
                        // إنشاء مفتاح فريد بناءً على الاسم والهاتف
                        const customerKey = `${customer.name.trim()}_${customer.phone || 'no-phone'}`;

                        if (!seenCustomers.has(customerKey)) {
                            seenCustomers.set(customerKey, customer);
                            uniqueCustomers.push(customer);
                        }
                    }
                });

                console.log('🔍 العملاء الأصليين:', customersData.length, 'العملاء الفريدين:', uniqueCustomers.length);

                // ترتيب العملاء أبجدياً
                uniqueCustomers.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));

                uniqueCustomers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;

                    // إضافة معلومات إضافية للعميل لسهولة التعرف عليه
                    let customerInfo = '';
                    if (customer.phone) {
                        customerInfo += ` (${customer.phone})`;
                    }

                    option.textContent = `${customer.name}${customerInfo}`;
                    option.setAttribute('data-customer-id', customer.id);
                    option.setAttribute('data-customer-name', customer.name);
                    accountSelect.appendChild(option);
                });

                console.log('✅ تم ملء قائمة العملاء بـ', uniqueCustomers.length, 'عميل فريد');

                // استعادة القيمة المختارة سابقاً
                if (currentValue) {
                    accountSelect.value = currentValue;
                    console.log('🔄 تم استعادة العميل المختار:', currentValue);
                }

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) label.textContent = 'العميل:';
                return;

            } else if (reportType === 'current-stock') {
                // ملء قائمة المنتجات من النظام المركزي لتقرير المخزون الحالي
                defaultOption.textContent = 'جميع الأصناف';
                accountSelect.appendChild(defaultOption);

                let productsData = [];
                if (window.dataManager) {
                    productsData = window.dataManager.getProducts();
                    console.log('📦 تم جلب المنتجات من النظام المركزي لتقرير المخزون:', productsData.length);
                } else {
                    productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                    console.log('📦 تم جلب المنتجات من localStorage لتقرير المخزون:', productsData.length);
                }

                productsData.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id || product.name;
                    option.textContent = product.name;
                    accountSelect.appendChild(option);
                });

                // استعادة القيمة المختارة سابقاً
                if (currentValue) {
                    accountSelect.value = currentValue;
                }

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) label.textContent = 'الصنف:';

                console.log('✅ تم ملء قائمة المنتجات لتقرير المخزون الحالي بنجاح');
                return;

            } else if (reportType === 'sales-by-product' || reportType === 'by-product' ||
                       reportType === 'product-operations' || reportType === 'stock-movement') {
                // ملء قائمة المنتجات من النظام المركزي
                if (reportType === 'product-operations') {
                    defaultOption.textContent = 'اختر الصنف';
                } else if (reportType === 'stock-movement') {
                    defaultOption.textContent = 'جميع الأصناف';
                } else {
                    defaultOption.textContent = 'جميع المنتجات';
                }
                accountSelect.appendChild(defaultOption);

                let productsData = [];
                if (window.dataManager) {
                    productsData = window.dataManager.getProducts();
                    console.log('📦 تم جلب المنتجات من النظام المركزي:', productsData.length);
                } else {
                    productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                    console.log('📦 تم جلب المنتجات من localStorage:', productsData.length);
                }

                // للتقارير المخزونية، عرض فقط المنتجات الحقيقية التي لها حركات مخزون
                if (reportType === 'stock-movement') {
                    // قائمة المنتجات الوهمية التي يجب استبعادها
                    const fakeProductNames = [
                        'لابتوب ديل XPS 13',
                        'لابتوب ديل',
                        'هاتف آيفون 14',
                        'هاتف آيفون',
                        'آيفون',
                        'لابتوب',
                        'كتاب إدارة الأعمال',
                        'شامبو للشعر',
                        'قميص قطني'
                    ];

                    // استبعاد المنتجات الوهمية أولاً
                    const originalCount = productsData.length;
                    productsData = productsData.filter(product => {
                        const isFake = fakeProductNames.some(fakeName => {
                            const productName = product.name || '';
                            const fakeNameStr = fakeName || '';
                            return (productName && fakeNameStr && productName.includes(fakeNameStr)) ||
                                   (fakeNameStr && productName && fakeNameStr.includes(productName));
                        });
                        return !isFake;
                    });

                    console.log(`🧹 تم استبعاد المنتجات الوهمية: ${originalCount} → ${productsData.length} منتج`);

                    const stockMovements = window.dataManager ? window.dataManager.getStockMovements() :
                                         JSON.parse(localStorage.getItem('monjizStockMovements')) || [];

                    // الحصول على معرفات المنتجات التي لها حركات حقيقية
                    const productsWithMovements = new Set();
                    stockMovements.forEach(movement => {
                        // تجاهل الحركات للمنتجات الوهمية
                        const isFakeMovement = fakeProductNames.some(fakeName => {
                            const productName = movement.productName || '';
                            const fakeNameStr = fakeName || '';
                            return productName && fakeNameStr && productName.includes(fakeNameStr);
                        });

                        if (!isFakeMovement) {
                            if (movement.productId) {
                                productsWithMovements.add(String(movement.productId));
                            }
                            if (movement.productName) {
                                // البحث عن المنتج بالاسم
                                const product = productsData.find(p => p.name === movement.productName);
                                if (product) {
                                    productsWithMovements.add(String(product.id));
                                }
                            }
                        }
                    });

                    // فلترة المنتجات لعرض فقط التي لها حركات حقيقية
                    const beforeMovementFilter = productsData.length;
                    productsData = productsData.filter(product =>
                        productsWithMovements.has(String(product.id))
                    );

                    console.log(`🔍 تم فلترة المنتجات للتقرير: ${beforeMovementFilter} → ${productsData.length} منتج له حركات حقيقية`);
                }

                productsData.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id || product.name;
                    option.textContent = product.name;
                    accountSelect.appendChild(option);
                });

                // استعادة القيمة المختارة سابقاً
                if (currentValue) {
                    accountSelect.value = currentValue;
                }

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) {
                    if (reportType === 'product-operations') {
                        label.textContent = 'الصنف:';
                    } else {
                        label.textContent = 'المنتج:';
                    }
                }

                console.log('✅ تم ملء قائمة المنتجات بنجاح');
                return;

            } else if (reportType === 'stock-movement') {
                // ملء قائمة المنتجات من النظام المركزي لتقرير حركة المخزون
                defaultOption.textContent = 'جميع المنتجات';
                accountSelect.appendChild(defaultOption);

                let productsData = [];
                if (window.dataManager) {
                    productsData = window.dataManager.getProducts();
                    console.log('📦 تم جلب المنتجات من النظام المركزي لحركة المخزون:', productsData.length);
                } else {
                    productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                    console.log('📦 تم جلب المنتجات من localStorage لحركة المخزون:', productsData.length);
                }

                productsData.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id || product.name;
                    option.textContent = product.name;
                    accountSelect.appendChild(option);
                });

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) label.textContent = 'المنتج:';

                console.log('✅ تم ملء قائمة المنتجات لتقرير حركة المخزون بنجاح');
                return;

            } else if (reportType === 'stock-valuation') {
                // ملء قائمة المنتجات من النظام المركزي لتقرير تقييم المخزون
                defaultOption.textContent = 'جميع المنتجات';
                accountSelect.appendChild(defaultOption);

                let productsData = [];
                if (window.dataManager) {
                    productsData = window.dataManager.getProducts();
                    console.log('📦 تم جلب المنتجات من النظام المركزي لتقييم المخزون:', productsData.length);
                } else {
                    productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                    console.log('📦 تم جلب المنتجات من localStorage لتقييم المخزون:', productsData.length);
                }

                productsData.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id || product.name;
                    option.textContent = product.name;
                    accountSelect.appendChild(option);
                });

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) label.textContent = 'المنتج:';

                console.log('✅ تم ملء قائمة المنتجات لتقرير تقييم المخزون بنجاح');
                return;

            } else if (reportType === 'low-stock') {
                // ملء قائمة المنتجات من النظام المركزي لتقرير النواقص
                defaultOption.textContent = 'جميع المنتجات';
                accountSelect.appendChild(defaultOption);

                let productsData = [];
                if (window.dataManager) {
                    productsData = window.dataManager.getProducts();
                    console.log('📦 تم جلب المنتجات من النظام المركزي لتقرير النواقص:', productsData.length);
                } else {
                    productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                    console.log('📦 تم جلب المنتجات من localStorage لتقرير النواقص:', productsData.length);
                }

                productsData.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id || product.name;
                    option.textContent = product.name;
                    accountSelect.appendChild(option);
                });

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) label.textContent = 'المنتج:';

                console.log('✅ تم ملء قائمة المنتجات لتقرير النواقص بنجاح');
                return;

            } else if (reportType === 'purchases-by-product' || reportType === 'by-product') {
                // ملء قائمة المنتجات من النظام المركزي لتقرير المشتريات حسب المنتج
                console.log('📦 تحديث قائمة المنتجات لتقرير:', reportType);

                defaultOption.textContent = 'جميع المنتجات';
                accountSelect.appendChild(defaultOption);

                let productsData = [];
                if (window.dataManager) {
                    productsData = window.dataManager.getProducts();
                    console.log('📦 تم جلب المنتجات من النظام المركزي:', productsData.length);
                } else {
                    productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                    console.log('📦 تم جلب المنتجات من localStorage:', productsData.length);
                }

                // إزالة المنتجات المكررة
                const uniqueProducts = [];
                const seenProducts = new Map();

                productsData.forEach(product => {
                    if (product && product.name) {
                        const productKey = `${product.name.trim()}_${product.code || 'no-code'}`;
                        if (!seenProducts.has(productKey)) {
                            seenProducts.set(productKey, product);
                            uniqueProducts.push(product);
                        }
                    }
                });

                console.log('🔍 المنتجات الأصلية:', productsData.length, 'المنتجات الفريدة:', uniqueProducts.length);

                // ترتيب المنتجات أبجدياً
                uniqueProducts.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));

                uniqueProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;

                    // إضافة معلومات إضافية للمنتج لسهولة التعرف عليه
                    let productInfo = '';
                    if (product.code) {
                        productInfo += ` (${product.code})`;
                    }

                    option.textContent = `${product.name}${productInfo}`;
                    option.setAttribute('data-product-id', product.id);
                    option.setAttribute('data-product-name', product.name);
                    accountSelect.appendChild(option);
                });

                console.log('✅ تم ملء قائمة المنتجات بـ', uniqueProducts.length, 'منتج فريد');

                // استعادة القيمة المختارة سابقاً
                if (currentValue) {
                    accountSelect.value = currentValue;
                    console.log('🔄 تم استعادة المنتج المختار:', currentValue);
                }

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) label.textContent = 'المنتج:';
                return;

            } else if (reportType === 'by-supplier' || reportType === 'purchases-by-supplier' ||
                       reportType === 'supplier-list' || reportType === 'supplier-balances' ||
                       reportType === 'supplier-analysis' || reportType === 'supplier-evaluation') {
                // ملء قائمة الموردين من النظام المركزي
                console.log('🏪 تحديث قائمة الموردين لتقرير:', reportType);

                defaultOption.textContent = 'جميع الموردين';
                accountSelect.appendChild(defaultOption);

                let suppliersData = [];
                if (window.dataManager) {
                    suppliersData = window.dataManager.getSuppliers();
                    console.log('🏪 تم جلب الموردين من النظام المركزي:', suppliersData.length);
                } else {
                    suppliersData = JSON.parse(localStorage.getItem('monjizSuppliers')) || [];
                    console.log('🏪 تم جلب الموردين من localStorage:', suppliersData.length);
                }

                // إنشاء بيانات تجريبية إذا لم تكن موجودة
                if (suppliersData.length === 0) {
                    console.log('📝 إنشاء موردين تجريبيين...');
                    const sampleData = createSamplePurchasesData();
                    suppliersData = sampleData.suppliers;
                    console.log('✅ تم إنشاء', suppliersData.length, 'مورد تجريبي');
                }

                // إزالة الموردين المكررين
                const uniqueSuppliers = [];
                const seenSuppliers = new Map();

                suppliersData.forEach(supplier => {
                    if (supplier && supplier.name) {
                        const supplierKey = `${supplier.name.trim()}_${supplier.phone || 'no-phone'}`;
                        if (!seenSuppliers.has(supplierKey)) {
                            seenSuppliers.set(supplierKey, supplier);
                            uniqueSuppliers.push(supplier);
                        }
                    }
                });

                console.log('🔍 الموردين الأصليين:', suppliersData.length, 'الموردين الفريدين:', uniqueSuppliers.length);

                // ترتيب الموردين أبجدياً
                uniqueSuppliers.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));

                uniqueSuppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;

                    // إضافة معلومات إضافية للمورد لسهولة التعرف عليه
                    let supplierInfo = '';
                    if (supplier.phone) {
                        supplierInfo += ` (${supplier.phone})`;
                    }

                    option.textContent = `${supplier.name}${supplierInfo}`;
                    option.setAttribute('data-supplier-id', supplier.id);
                    option.setAttribute('data-supplier-name', supplier.name);
                    accountSelect.appendChild(option);
                });

                console.log('✅ تم ملء قائمة الموردين بـ', uniqueSuppliers.length, 'مورد فريد');

                // استعادة القيمة المختارة سابقاً
                if (currentValue) {
                    accountSelect.value = currentValue;
                    console.log('🔄 تم استعادة المورد المختار:', currentValue);
                }

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) label.textContent = 'المورد:';
                return;

            } else {
                // للتقارير الأخرى، استخدام القوائم الثابتة
                defaultOption.textContent = 'جميع الحسابات';
                accountSelect.appendChild(defaultOption);

                // تحديث التسمية
                const label = accountSelect.previousElementSibling;
                if (label) label.textContent = 'الحساب:';
            }

            // تحديد الخيارات المناسبة لكل نوع تقرير (للتقارير الأخرى)
            const accountOptions = {
                // التقارير المالية
                'balance-sheet': [
                    { value: '', text: 'جميع الحسابات' },
                    { value: 'assets', text: 'الأصول' },
                    { value: 'liabilities', text: 'الخصوم' },
                    { value: 'equity', text: 'حقوق الملكية' },
                    { value: 'cash', text: 'النقدية' },
                    { value: 'bank', text: 'البنوك' }
                ],
                'profit-loss': [
                    { value: '', text: 'جميع الحسابات' },
                    { value: 'revenue', text: 'الإيرادات' },
                    { value: 'expenses', text: 'المصروفات' },
                    { value: 'sales', text: 'المبيعات' },
                    { value: 'cost-of-goods', text: 'تكلفة البضاعة المباعة' }
                ],
                'cash-flow': [
                    { value: '', text: 'جميع الحسابات النقدية' },
                    { value: 'cash', text: 'النقدية' },
                    { value: 'bank-main', text: 'البنك الرئيسي' },
                    { value: 'bank-secondary', text: 'البنك الثانوي' },
                    { value: 'petty-cash', text: 'النثرية' }
                ],
                'trial-balance': [
                    { value: '', text: 'جميع الحسابات' },
                    { value: 'assets', text: 'الأصول' },
                    { value: 'liabilities', text: 'الخصوم' },
                    { value: 'equity', text: 'حقوق الملكية' },
                    { value: 'revenue', text: 'الإيرادات' },
                    { value: 'expenses', text: 'المصروفات' }
                ],

                // تقارير المبيعات
                'daily': [
                    { value: '', text: 'جميع طرق الدفع' },
                    { value: 'نقداً', text: 'نقداً' },
                    { value: 'آجل', text: 'آجل' },
                    { value: 'تحويل بنكي', text: 'تحويل بنكي' }
                ],
                'monthly': [
                    { value: '', text: 'جميع طرق الدفع' },
                    { value: 'cash', text: 'نقداً' },
                    { value: 'credit-card', text: 'بطاقة ائتمان' },
                    { value: 'bank-transfer', text: 'تحويل بنكي' },
                    { value: 'installment', text: 'تقسيط' }
                ],


                // تقارير المشتريات
                'purchases-daily': [
                    { value: '', text: 'جميع طرق الدفع' },
                    { value: 'cash', text: 'نقداً' },
                    { value: 'credit', text: 'آجل' },
                    { value: 'bank-transfer', text: 'تحويل بنكي' },
                    { value: 'check', text: 'شيك' }
                ],
                'monthly': [
                    { value: '', text: 'جميع طرق الدفع' },
                    { value: 'cash', text: 'نقداً' },
                    { value: 'credit', text: 'آجل' },
                    { value: 'bank-transfer', text: 'تحويل بنكي' },
                    { value: 'check', text: 'شيك' }
                ],
                'by-supplier': [
                    { value: '', text: 'جميع الموردين' },
                    { value: 'advanced-tech', text: 'شركة التقنية المتقدمة المحدودة' },
                    { value: 'modern-furniture', text: 'مؤسسة الأثاث الحديث' },
                    { value: 'office-solutions', text: 'شركة الحلول المكتبية' },
                    { value: 'electronics-world', text: 'عالم الإلكترونيات التجاري' },
                    { value: 'stationery-house', text: 'بيت القرطاسية والمكتبيات' },
                    { value: 'computer-center', text: 'مركز الحاسوب والتقنية' },
                    { value: 'mobile-plaza', text: 'مجمع الجوالات والاتصالات' },
                    { value: 'office-depot', text: 'مستودع المكاتب والأثاث' }
                ],
                'by-category': [
                    { value: '', text: 'جميع الفئات' },
                    { value: 'electronics', text: 'الإلكترونيات' },
                    { value: 'furniture', text: 'الأثاث' },
                    { value: 'stationery', text: 'القرطاسية' },
                    { value: 'accessories', text: 'الإكسسوارات' },
                    { value: 'computers', text: 'الحاسوب' },
                    { value: 'mobiles', text: 'الجوالات' }
                ],

                // تقارير المخزون - سيتم ملؤها ديناميكياً من النظام المركزي
                'current-stock': [
                    { value: '', text: 'جميع الأصناف' }
                ],
                'stock-movement': [
                    { value: '', text: 'جميع المنتجات' }
                ],
                'low-stock': [
                    { value: '', text: 'جميع المنتجات' }
                ],
                'stock-valuation': [
                    { value: '', text: 'جميع المنتجات' }
                ],

                // تقارير العملاء
                'customer-list': [
                    { value: '', text: 'جميع العملاء' },
                    { value: 'ahmed-ali', text: 'أحمد محمد علي' },
                    { value: 'fatima-saad', text: 'فاطمة السعد' },
                    { value: 'mohammed-ahmed', text: 'محمد الأحمد' },
                    { value: 'sara-khalid', text: 'سارة خالد' },
                    { value: 'abdullah-otaibi', text: 'عبدالله العتيبي' },
                    { value: 'nora-zahrani', text: 'نورا الزهراني' },
                    { value: 'khalid-mutairi', text: 'خالد المطيري' },
                    { value: 'reem-shahri', text: 'ريم الشهري' },
                    { value: 'omar-salem', text: 'عمر سالم' },
                    { value: 'layla-ahmed', text: 'ليلى أحمد' }
                ],
                'customer-balances': [
                    { value: '', text: 'جميع العملاء' },
                    { value: 'ahmed-ali', text: 'أحمد محمد علي' },
                    { value: 'fatima-saad', text: 'فاطمة السعد' },
                    { value: 'mohammed-ahmed', text: 'محمد الأحمد' },
                    { value: 'sara-khalid', text: 'سارة خالد' },
                    { value: 'abdullah-otaibi', text: 'عبدالله العتيبي' },
                    { value: 'nora-zahrani', text: 'نورا الزهراني' },
                    { value: 'khalid-mutairi', text: 'خالد المطيري' },
                    { value: 'reem-shahri', text: 'ريم الشهري' }
                ],
                'customer-analysis': [
                    { value: '', text: 'جميع العملاء' },
                    { value: 'high-value', text: 'عملاء عالي القيمة (أكثر من 20,000 ر.س)' },
                    { value: 'medium-value', text: 'عملاء متوسط القيمة (10,000 - 20,000 ر.س)' },
                    { value: 'low-value', text: 'عملاء منخفض القيمة (أقل من 10,000 ر.س)' },
                    { value: 'frequent-buyers', text: 'عملاء دائمين (أكثر من 10 مشتريات)' },
                    { value: 'new-customers', text: 'عملاء جدد (آخر 3 أشهر)' }
                ],
                'customer-aging': [
                    { value: '', text: 'جميع العملاء' },
                    { value: 'current', text: 'مستحق حالياً (0-30 يوم)' },
                    { value: 'overdue-30', text: 'متأخر 30 يوم (31-60 يوم)' },
                    { value: 'overdue-60', text: 'متأخر 60 يوم (61-90 يوم)' },
                    { value: 'overdue-90', text: 'متأخر 90 يوم (أكثر من 90 يوم)' }
                ],

                // تقارير الموردين
                'supplier-list': [
                    { value: '', text: 'جميع الموردين' },
                    { value: 'advanced-tech', text: 'شركة التقنية المتقدمة المحدودة' },
                    { value: 'modern-furniture', text: 'مؤسسة الأثاث الحديث' },
                    { value: 'office-solutions', text: 'شركة الحلول المكتبية' },
                    { value: 'electronics-world', text: 'عالم الإلكترونيات التجاري' },
                    { value: 'stationery-house', text: 'بيت القرطاسية والمكتبيات' },
                    { value: 'computer-center', text: 'مركز الحاسوب والتقنية' },
                    { value: 'mobile-plaza', text: 'مجمع الجوالات والاتصالات' },
                    { value: 'office-depot', text: 'مستودع المكاتب والأثاث' },
                    { value: 'tech-innovations', text: 'شركة الابتكارات التقنية' }
                ],
                'supplier-balances': [
                    { value: '', text: 'جميع الموردين' },
                    { value: 'advanced-tech', text: 'شركة التقنية المتقدمة المحدودة' },
                    { value: 'modern-furniture', text: 'مؤسسة الأثاث الحديث' },
                    { value: 'office-solutions', text: 'شركة الحلول المكتبية' },
                    { value: 'electronics-world', text: 'عالم الإلكترونيات التجاري' },
                    { value: 'stationery-house', text: 'بيت القرطاسية والمكتبيات' },
                    { value: 'computer-center', text: 'مركز الحاسوب والتقنية' },
                    { value: 'mobile-plaza', text: 'مجمع الجوالات والاتصالات' }
                ],
                'supplier-analysis': [
                    { value: '', text: 'جميع الموردين' },
                    { value: 'high-volume', text: 'موردين عالي الحجم (أكثر من 50,000 ر.س)' },
                    { value: 'medium-volume', text: 'موردين متوسط الحجم (20,000 - 50,000 ر.س)' },
                    { value: 'low-volume', text: 'موردين منخفض الحجم (أقل من 20,000 ر.س)' },
                    { value: 'reliable-suppliers', text: 'موردين موثوقين (تقييم ممتاز)' },
                    { value: 'new-suppliers', text: 'موردين جدد (آخر 6 أشهر)' }
                ],
                'supplier-evaluation': [
                    { value: '', text: 'جميع الموردين' },
                    { value: 'excellent-rating', text: 'تقييم ممتاز (90-100%)' },
                    { value: 'good-rating', text: 'تقييم جيد (80-89%)' },
                    { value: 'average-rating', text: 'تقييم متوسط (70-79%)' },
                    { value: 'poor-rating', text: 'تقييم ضعيف (أقل من 70%)' }
                ]
            };

            // للتقارير الأخرى، استخدام القوائم الثابتة
            const options = accountOptions[reportType] || [
                { value: '', text: 'جميع الحسابات' },
                { value: 'cash', text: 'النقدية' },
                { value: 'bank', text: 'البنك' },
                { value: 'customers', text: 'العملاء' },
                { value: 'suppliers', text: 'الموردين' }
            ];

            // إضافة الخيارات الجديدة (فقط للتقارير الأخرى)
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                accountSelect.appendChild(optionElement);
            });

            // تهيئة reportFilters مع البيانات الحالية
            window.reportFilters = accountOptions;
        }

        // دالة تحديث خيارات الشهر حسب السنة
        function updateMonthOptions() {
            const yearElement = document.getElementById('report-year');
            const monthElement = document.getElementById('report-month');

            if (!yearElement || !monthElement) return;

            const selectedYear = parseInt(yearElement.value);
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // إعادة تعيين خيارات الشهر
            monthElement.innerHTML = '<option value="all">جميع الأشهر</option>';

            const months = [
                'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
            ];

            for (let i = 1; i <= 12; i++) {
                // إذا كانت السنة الحالية، لا نعرض الأشهر المستقبلية
                if (selectedYear === currentYear && i > currentMonth) {
                    continue;
                }

                const option = document.createElement('option');
                option.value = i;
                option.textContent = months[i - 1];
                monthElement.appendChild(option);
            }
        }

        // دالة خاصة لفلاتر التقرير الشهري المحسنة
        function applyMonthlyReportFilters() {
            console.log('📊 تطبيق فلاتر التقرير الشهري المحسن...');

            try {
                const yearElement = document.getElementById('report-year');
                const monthElement = document.getElementById('report-month');
                const viewTypeElement = document.getElementById('report-view-type');

                const selectedYear = yearElement ? yearElement.value : '2025';
                const selectedMonth = monthElement ? monthElement.value : 'all';
                const viewType = viewTypeElement ? viewTypeElement.value : 'summary';

                console.log('📅 السنة المختارة:', selectedYear);
                console.log('📅 الشهر المختار:', selectedMonth);
                console.log('📊 نوع العرض:', viewType);

                // إنشاء نطاق تاريخي
                let dateRange;
                if (selectedMonth === 'all') {
                    dateRange = `السنة المالية ${selectedYear}`;
                } else {
                    const monthNames = ['', 'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                                      'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                    dateRange = `${monthNames[selectedMonth]} ${selectedYear}`;
                }

                // إنشاء التقرير مع الفلاتر الجديدة
                const filters = {
                    year: selectedYear,
                    month: selectedMonth,
                    viewType: viewType,
                    dateFrom: selectedMonth === 'all' ? `${selectedYear}-01-01` : `${selectedYear}-${selectedMonth.padStart(2, '0')}-01`,
                    dateTo: selectedMonth === 'all' ? `${selectedYear}-12-31` : `${selectedYear}-${selectedMonth.padStart(2, '0')}-31`
                };

                // إظهار مؤشر التحميل
                const reportContent = document.getElementById('report-content');
                if (reportContent) {
                    reportContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 20px; color: #666;">جاري تحديث التقرير...</p>
                        </div>
                    `;

                    // تأخير قصير لإظهار التحميل
                    setTimeout(() => {
                        const reportData = createPurchasesMonthlyReport(dateRange, filters);
                        reportContent.innerHTML = reportData;
                        console.log('✅ تم تحديث التقرير الشهري بنجاح');
                    }, 500);
                }

            } catch (error) {
                console.error('❌ خطأ في تطبيق فلاتر التقرير الشهري:', error);
                const reportContent = document.getElementById('report-content');
                if (reportContent) {
                    reportContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                            <h3>خطأ في تحديث التقرير</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // دالة خاصة لفلاتر تقرير المبيعات الشهرية
        function applySalesMonthlyReportFilters() {
            console.log('📊 تطبيق فلاتر تقرير المبيعات الشهرية...');

            try {
                const yearElement = document.getElementById('sales-report-year');
                const monthElement = document.getElementById('sales-report-month');
                const viewTypeElement = document.getElementById('sales-report-view-type');

                const selectedYear = yearElement ? yearElement.value : '2025';
                const selectedMonth = monthElement ? monthElement.value : 'all';
                const viewType = viewTypeElement ? viewTypeElement.value : 'summary';

                console.log('📅 السنة المختارة:', selectedYear);
                console.log('📅 الشهر المختار:', selectedMonth);
                console.log('📊 نوع العرض:', viewType);

                // إنشاء نطاق تاريخي
                let dateRange;
                if (selectedMonth === 'all') {
                    dateRange = `السنة المالية ${selectedYear}`;
                } else {
                    const monthNames = ['', 'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                                      'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                    dateRange = `${monthNames[selectedMonth]} ${selectedYear}`;
                }

                // إنشاء التقرير مع الفلاتر الجديدة
                const filters = {
                    year: selectedYear,
                    month: selectedMonth,
                    viewType: viewType,
                    dateFrom: selectedMonth === 'all' ? `${selectedYear}-01-01` : `${selectedYear}-${selectedMonth.padStart(2, '0')}-01`,
                    dateTo: selectedMonth === 'all' ? `${selectedYear}-12-31` : `${selectedYear}-${selectedMonth.padStart(2, '0')}-31`
                };

                // إظهار مؤشر التحميل
                const reportContent = document.getElementById('report-content');
                if (reportContent) {
                    reportContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #28a745; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 20px; color: #666;">جاري تحديث تقرير المبيعات...</p>
                        </div>
                    `;

                    // تأخير قصير لإظهار التحميل
                    setTimeout(() => {
                        const reportData = createMonthlySalesReport(dateRange, filters);
                        reportContent.innerHTML = reportData;
                        console.log('✅ تم تحديث تقرير المبيعات الشهرية بنجاح');
                    }, 500);
                }

            } catch (error) {
                console.error('❌ خطأ في تطبيق فلاتر تقرير المبيعات الشهرية:', error);
                const reportContent = document.getElementById('report-content');
                if (reportContent) {
                    reportContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                            <h3>خطأ في تحديث التقرير</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function applyReportFilters() {
            console.log('🚀 بدء تشغيل دالة applyReportFilters...');

            try {
                // فحص وجود العناصر قبل قراءة القيم
                const dateFromElement = document.getElementById('report-date-from');
                const dateToElement = document.getElementById('report-date-to');
                const accountElement = document.getElementById('report-account');
                const branchElement = document.getElementById('report-branch');

                console.log('🔍 فحص وجود العناصر:');
                console.log('   📅 report-date-from:', dateFromElement ? 'موجود' : 'غير موجود');
                console.log('   📅 report-date-to:', dateToElement ? 'موجود' : 'غير موجود');
                console.log('   👤 report-account:', accountElement ? 'موجود' : 'غير موجود');
                console.log('   🏢 report-branch:', branchElement ? 'موجود' : 'غير موجود');

                const dateFrom = dateFromElement ? dateFromElement.value : '';
                const dateTo = dateToElement ? dateToElement.value : '';
                const account = accountElement ? accountElement.value : '';
                const branch = branchElement ? branchElement.value : '';

                // حفظ المرشحات للاستخدام لاحقاً
                savedFilters[currentReportType] = {
                    dateFrom: dateFrom,
                    dateTo: dateTo,
                    account: account,
                    branch: branch
                };

                // إضافة علامة لمنع إعادة التحميل التلقائي
                window.isApplyingFilters = true;

            console.log('🔧 تطبيق المرشحات:');
            console.log('   📊 نوع التقرير الحالي:', currentReportType);
            console.log('   📅 من تاريخ:', dateFrom);
            console.log('   📅 إلى تاريخ:', dateTo);
            console.log('   👤 الحساب/الصنف:', account);
            console.log('   🏢 الفرع:', branch);
            console.log('💾 تم حفظ المرشحات:', savedFilters[currentReportType]);

            // التحقق من صحة التواريخ
            if (dateFrom && dateTo && new Date(dateFrom) > new Date(dateTo)) {
                showErrorMessage('تاريخ البداية يجب أن يكون قبل تاريخ النهاية!');
                return;
            }

            // إظهار مؤشر التحميل
            showLoadingMessage('جاري تطبيق المرشحات وإعادة إنشاء التقرير...');

            // محاكاة تطبيق المرشحات
            setTimeout(() => {
                hideLoadingMessage();

                // إعادة إنشاء التقرير بالمرشحات الجديدة
                console.log('🔄 إعادة إنشاء التقرير بالفلاتر الجديدة...');
                const reportData = getDetailedReportData(currentReportType, {
                    dateFrom: dateFrom,
                    dateTo: dateTo,
                    account: account,
                    branch: branch
                });

                console.log('📊 بيانات التقرير المحدثة:', reportData ? 'تم الحصول عليها' : 'فارغة');

                const reportContent = document.getElementById('report-content');
                if (reportContent && reportData && reportData.html) {
                    console.log('✅ تحديث محتوى التقرير...');
                    reportContent.innerHTML = reportData.html;
                } else {
                    console.error('❌ فشل في تحديث التقرير:', {
                        reportContent: !!reportContent,
                        reportData: !!reportData,
                        html: !!(reportData && reportData.html)
                    });
                }

                // إظهار رسالة نجاح مع تفاصيل المرشحات
                let filterDetails = [];
                if (dateFrom && dateTo) {
                    filterDetails.push(`الفترة: ${dateFrom} إلى ${dateTo}`);
                }
                if (account && accountElement && accountElement.selectedOptions.length > 0) {
                    const accountText = accountElement.selectedOptions[0].text;
                    filterDetails.push(`الصنف: ${accountText}`);
                }
                if (branch && branchElement && branchElement.selectedOptions.length > 0) {
                    const branchText = branchElement.selectedOptions[0].text;
                    filterDetails.push(`الفرع: ${branchText}`);
                }

                const message = filterDetails.length > 0
                    ? `تم تطبيق المرشحات بنجاح! (${filterDetails.join(', ')})`
                    : 'تم تحديث التقرير بنجاح!';

                showSuccessMessage(message);

                // إزالة علامة تطبيق الفلاتر
                setTimeout(() => {
                    window.isApplyingFilters = false;
                }, 1000);
            }, 1000);

            } catch (error) {
                console.error('❌ خطأ في دالة applyReportFilters:', error);
                hideLoadingMessage();
                showErrorMessage(`خطأ في تطبيق المرشحات: ${error.message}`);
            }
        }



        // دالة تحديث breadcrumb
        function updateBreadcrumb() {
            const breadcrumbCategory = document.getElementById('breadcrumb-category');

            if (currentView === 'categories') {
                breadcrumbCategory.textContent = 'اختيار نوع التقرير';
            } else if (currentView === 'reports') {
                const categoryNames = {
                    'financial': 'المالية',
                    'sales': 'المبيعات',
                    'purchases': 'المشتريات',
                    'inventory': 'المخزون',
                    'customers': 'العملاء',
                    'suppliers': 'الموردين'
                };
                breadcrumbCategory.textContent = categoryNames[currentCategory] || 'تقرير';
            } else if (currentView === 'report-detail') {
                const reportNames = {
                    'balance-sheet': 'قائمة المركز المالي',
                    'profit-loss': 'قائمة الأرباح والخسائر',
                    'daily': 'المبيعات اليومية',
                    'current-stock': 'المخزون الحالي'
                };
                breadcrumbCategory.textContent = reportNames[currentReportType] || 'تقرير مفصل';
            }
        }

        // دالة تحسين الأداء - تحميل مسبق للبيانات
        function preloadReportData() {
            // تحميل مسبق للتقارير الأكثر استخداماً
            const popularReports = ['balance-sheet', 'profit-loss', 'daily', 'current-stock'];
            popularReports.forEach(reportType => {
                setTimeout(() => {
                    getDetailedReportData(reportType);
                }, 100);
            });
        }

        // دالة إضافة تأثيرات بصرية محسنة
        function addVisualEnhancements() {
            // إضافة تأثير hover للبطاقات
            const categoryCards = document.querySelectorAll('.category-card-modern');
            categoryCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        }

        // دالة تنسيق التاريخ بالميلادي
        function formatDateArabic(date) {
            if (!date) return '';

            const dateObj = typeof date === 'string' ? new Date(date) : date;

            return dateObj.toLocaleDateString('ar', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                calendar: 'gregory'
            });
        }

        // دالة تنسيق التاريخ بصيغة أكثر وضوحاً
        function formatDateDetailed(date) {
            if (!date) return '';

            const dateObj = typeof date === 'string' ? new Date(date) : date;

            return dateObj.toLocaleDateString('ar', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                calendar: 'gregory'
            });
        }

        // دالة تنسيق التاريخ بالميلادي (تنسيق مختصر)
        function formatDateGregorian(date) {
            if (!date) return '';
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // دالة تنسيق التاريخ بالعربية الميلادية
        function formatDateArabicGregorian(date) {
            if (!date) return '';
            return new Date(date).toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                calendar: 'gregory'
            });
        }

        // دالة الحصول على بيانات التقرير المفصلة محسنة
        function getDetailedReportData(reportType, filters = {}) {
            try {
                console.log('📊 إنشاء بيانات التقرير:', reportType, filters);

                // تنسيق التاريخ بالميلادي
                const currentDate = formatDateArabic(new Date());

                // تطبيق المرشحات على البيانات
                let dateRange = null;
                let dateRangeText = '';
                if (filters.dateFrom && filters.dateTo) {
                    const fromDate = formatDateArabic(filters.dateFrom);
                    const toDate = formatDateArabic(filters.dateTo);
                    dateRangeText = `من ${fromDate} إلى ${toDate}`;
                    // إنشاء object للتاريخ للاستخدام في الفلترة
                    dateRange = {
                        from: filters.dateFrom,
                        to: filters.dateTo
                    };
                } else {
                    dateRangeText = `كما في ${currentDate}`;
                }

                console.log('📅 نطاق التاريخ:', dateRangeText);
                console.log('📅 كائن التاريخ للفلترة:', dateRange);

                console.log('🔧 إنشاء قوالب التقارير...');
                const reportTemplates = {
                // التقارير المالية
                'end-of-day': {
                    title: 'تقرير إغلاق اليوم',
                    category: 'financial',
                    html: createEndOfDayReportRedirect(dateRange, filters)
                },
                'balance-sheet': {
                    title: 'قائمة المركز المالي',
                    category: 'financial',
                    html: createBalanceSheetReport(dateRange, filters)
                },
                'profit-loss': {
                    title: 'قائمة الأرباح والخسائر',
                    category: 'financial',
                    html: createProfitLossReport(dateRange, filters)
                },
                'cash-flow': {
                    title: 'قائمة التدفقات النقدية',
                    category: 'financial',
                    html: createCashFlowReport(dateRange, filters)
                },
                'trial-balance': {
                    title: 'ميزان المراجعة',
                    category: 'financial',
                    html: createTrialBalanceReport(dateRange, filters)
                },

                // تقارير المبيعات
                'daily': {
                    title: 'تقرير المبيعات اليومية',
                    category: 'sales',
                    html: createDailySalesReport(dateRange, filters)
                },
                'monthly': {
                    title: 'تقرير المبيعات الشهرية',
                    category: 'sales',
                    html: createMonthlySalesReport(dateRange, filters),
                    getDynamicTitle: function() {
                        if (filters.dateFrom && filters.dateTo) {
                            const startDate = new Date(filters.dateFrom);
                            const endDate = new Date(filters.dateTo);
                            const startMonth = startDate.toLocaleDateString('ar', { month: 'long', year: 'numeric' });
                            const endMonth = endDate.toLocaleDateString('ar', { month: 'long', year: 'numeric' });

                            if (startMonth === endMonth) {
                                return `مبيعات شهر ${startMonth}`;
                            } else {
                                return `المبيعات الشهرية من ${startMonth} إلى ${endMonth}`;
                            }
                        }
                        return 'تقرير المبيعات الشهرية';
                    }
                },
                'by-customer': {
                    title: 'المبيعات حسب العميل',
                    category: 'sales',
                    html: createSalesByCustomerReport(dateRange, filters),
                    getDynamicTitle: function() {
                        // إذا كان هناك عميل محدد، استخدم اسمه في العنوان
                        if (filters.account && filters.account !== '') {
                            // البحث عن العميل المحدد
                            let customersData = [];
                            if (window.dataManager) {
                                customersData = window.dataManager.getCustomers();
                            } else {
                                customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                            }
                            const selectedCustomer = customersData.find(c => c.id == filters.account || c.id === filters.account);
                            if (selectedCustomer) {
                                return `مبيعات العميل: ${selectedCustomer.name}`;
                            }
                        }
                        return 'المبيعات حسب العميل';
                    }
                },
                'by-product': {
                    title: 'المبيعات حسب المنتج',
                    category: 'sales',
                    html: createSalesByProductReport(dateRange, filters),
                    getDynamicTitle: function() {
                        // إذا كان هناك منتج محدد، استخدم اسمه في العنوان
                        if (filters.account && filters.account !== '') {
                            // البحث عن المنتج المحدد
                            let productsData = [];
                            if (window.dataManager) {
                                productsData = window.dataManager.getProducts();
                            } else {
                                productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                            }
                            const selectedProduct = productsData.find(p => p.id == filters.account || p.name === filters.account);
                            if (selectedProduct) {
                                return `مبيعات المنتج: ${selectedProduct.name}`;
                            }
                        }
                        return 'المبيعات حسب المنتج';
                    }
                },

                // تقارير المشتريات
                'purchases-daily': {
                    title: 'المشتريات اليومية',
                    category: 'purchases',
                    html: createPurchasesDailyReport(dateRange, filters)
                },
                'purchases-monthly': {
                    title: 'المشتريات الشهرية',
                    category: 'purchases',
                    html: createPurchasesMonthlyReport(dateRange, filters)
                },
                'by-supplier': {
                    title: 'المشتريات حسب المورد',
                    category: 'purchases',
                    html: createPurchasesBySupplierReport(dateRange, filters),
                    getDynamicTitle: function() {
                        // إذا كان هناك مورد محدد، استخدم اسمه في العنوان
                        if (filters.account && filters.account !== '') {
                            // البحث عن المورد المحدد
                            let suppliersData = [];
                            if (window.dataManager) {
                                suppliersData = window.dataManager.getSuppliers();
                            } else {
                                suppliersData = JSON.parse(localStorage.getItem('monjizSuppliers')) || [];
                            }

                            // إنشاء بيانات تجريبية إذا لم تكن موجودة
                            if (suppliersData.length === 0) {
                                const sampleData = createSamplePurchasesData();
                                suppliersData = sampleData.suppliers;
                            }

                            const selectedSupplier = suppliersData.find(s =>
                                String(s.id) === String(filters.account) ||
                                s.name === filters.account
                            );

                            if (selectedSupplier) {
                                return `مشتريات المورد: ${selectedSupplier.name}`;
                            }
                        }
                        return 'المشتريات حسب المورد';
                    }
                },
                'purchases-by-product': {
                    title: 'المشتريات حسب المنتج',
                    category: 'purchases',
                    html: createPurchasesByProductReport(dateRange, filters),
                    getDynamicTitle: function() {
                        // إذا كان هناك منتج محدد، استخدم اسمه في العنوان
                        if (filters.account && filters.account !== '') {
                            // البحث عن المنتج المحدد
                            let productsData = [];
                            if (window.dataManager) {
                                productsData = window.dataManager.getProducts();
                            } else {
                                productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                            }

                            const selectedProduct = productsData.find(p =>
                                String(p.id) === String(filters.account) ||
                                p.name === filters.account
                            );

                            if (selectedProduct) {
                                return `مشتريات المنتج: ${selectedProduct.name}`;
                            }
                        }
                        return 'المشتريات حسب المنتج';
                    }
                },

                // تقارير المخزون
                'current-stock': {
                    title: 'تقرير المخزون الحالي',
                    category: 'inventory',
                    html: createStockReport(dateRange, filters)
                },
                'stock-movement': {
                    title: 'حركة المخزون',
                    category: 'inventory',
                    html: createStockMovementReport(dateRange, filters),
                    getDynamicTitle: function() {
                        if (filters.account && filters.account !== '') {
                            // البحث عن المنتج المحدد
                            let productsData = [];
                            if (window.dataManager) {
                                productsData = window.dataManager.getProducts();
                            } else {
                                productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                            }

                            const selectedProduct = productsData.find(p =>
                                p.id == filters.account ||
                                p.id === filters.account ||
                                p.name === filters.account ||
                                String(p.id) === String(filters.account)
                            );

                            if (selectedProduct) {
                                return `حركة المخزون: ${selectedProduct.name}`;
                            }
                        }
                        return 'حركة المخزون';
                    }
                },
                'product-operations': {
                    title: 'تقرير عمليات صنف',
                    category: 'inventory',
                    html: createProductOperationsReport(currentDate, filters),
                    getDynamicTitle: function() {
                        // إذا كان هناك صنف محدد، استخدم اسمه في العنوان
                        if (filters.account && filters.account !== '') {
                            // البحث عن المنتج المحدد
                            let productsData = [];
                            if (window.dataManager) {
                                productsData = window.dataManager.getProducts();
                            } else {
                                productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                            }
                            const selectedProduct = productsData.find(p => p.id == filters.account || p.name === filters.account);
                            if (selectedProduct) {
                                return `عمليات الصنف: ${selectedProduct.name}`;
                            }
                        }
                        return 'تقرير عمليات صنف';
                    }
                },
                'low-stock': {
                    title: 'تقرير النواقص',
                    category: 'inventory',
                    html: createLowStockReport(dateRange, filters)
                },
                'stock-valuation': {
                    title: 'تقييم المخزون',
                    category: 'inventory',
                    html: createStockValuationReport(dateRange, filters)
                },

                // تقارير العملاء
                'customer-list': {
                    title: 'قائمة العملاء',
                    category: 'customers',
                    html: createCustomerListReport(dateRange, filters)
                },
                'customer-balances': {
                    title: 'أرصدة العملاء',
                    category: 'customers',
                    html: createCustomerBalancesReport(dateRange, filters),
                    getDynamicTitle: function() {
                        if (filters.account && filters.account !== '') {
                            // البحث عن العميل المحدد
                            let customersData = [];
                            if (window.dataManager) {
                                customersData = window.dataManager.getCustomers();
                            } else {
                                customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                            }
                            const selectedCustomer = customersData.find(c => c.id == filters.account || c.name === filters.account);
                            if (selectedCustomer) {
                                return `رصيد العميل: ${selectedCustomer.name}`;
                            }
                        }
                        return 'أرصدة العملاء';
                    }
                },
                'customer-analysis': {
                    title: 'تحليل العملاء',
                    category: 'customers',
                    html: createCustomerAnalysisReport(dateRange, filters),
                    getDynamicTitle: function() {
                        if (filters.account && filters.account !== '') {
                            // البحث عن العميل المحدد
                            let customersData = [];
                            if (window.dataManager) {
                                customersData = window.dataManager.getCustomers();
                            } else {
                                customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                            }

                            // البحث بطرق متعددة للتأكد من الدقة
                            const selectedCustomer = customersData.find(c =>
                                c.id == filters.account ||
                                c.id === filters.account ||
                                c.name === filters.account ||
                                String(c.id) === String(filters.account)
                            );

                            if (selectedCustomer) {
                                return `تحليل العميل: ${selectedCustomer.name}`;
                            }
                        }
                        return 'تحليل العملاء';
                    }
                },
                'customer-aging': {
                    title: 'أعمار الديون',
                    category: 'customers',
                    html: createCustomerAgingReport(dateRange, filters),
                    getDynamicTitle: function() {
                        if (filters.account && filters.account !== '') {
                            // البحث عن العميل المحدد
                            let customersData = [];
                            if (window.dataManager) {
                                customersData = window.dataManager.getCustomers();
                            } else {
                                customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                            }

                            const selectedCustomer = customersData.find(c =>
                                c.id == filters.account ||
                                c.id === filters.account ||
                                c.name === filters.account ||
                                String(c.id) === String(filters.account)
                            );

                            if (selectedCustomer) {
                                return `أعمار ديون العميل: ${selectedCustomer.name}`;
                            }
                        }
                        return 'أعمار الديون';
                    }
                },

                // تقارير الموردين
                'supplier-list': {
                    title: 'قائمة الموردين',
                    category: 'suppliers',
                    html: createSupplierListReport(dateRange, filters)
                },
                'supplier-balances': {
                    title: 'أرصدة الموردين',
                    category: 'suppliers',
                    html: createSupplierBalancesReport(dateRange, filters)
                },
                'supplier-analysis': {
                    title: 'تحليل الموردين',
                    category: 'suppliers',
                    html: createSupplierAnalysisReport(dateRange, filters)
                },
                'supplier-evaluation': {
                    title: 'تقييم الموردين',
                    category: 'suppliers',
                    html: createSupplierEvaluationReport(dateRange, filters)
                }
            };

                const result = reportTemplates[reportType] || {
                    title: 'تقرير عام',
                    category: 'general',
                    html: createDefaultReport(reportType, currentDate)
                };

                // استخدام العنوان الديناميكي إذا كان متاحاً
                if (result.getDynamicTitle && typeof result.getDynamicTitle === 'function') {
                    result.title = result.getDynamicTitle();
                }

                console.log('✅ تم إنشاء بيانات التقرير:', result.title);
                return result;

            } catch (error) {
                console.error('❌ خطأ في إنشاء بيانات التقرير:', error);
                return {
                    title: 'خطأ في التقرير',
                    category: 'error',
                    html: `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <h3>خطأ في إنشاء التقرير</h3>
                            <p>حدث خطأ أثناء إنشاء التقرير: ${error.message}</p>
                            <p style="font-size: 14px; color: #666; margin-top: 20px;">نوع التقرير: ${reportType}</p>
                        </div>
                    `
                };
            }
        }

        // تم حذف الدالة المكررة - سيتم استخدام الدالة المحسنة في الأسفل

        // دالة إنشاء تقرير الأرباح والخسائر
        function createProfitLossReport(currentDate) {
            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>قائمة الأرباح والخسائر</h2>
                        <p>للفترة المنتهية في ${currentDate}</p>
                    </div>
                    <div class="report-content">
                        <table class="report-table">
                            <thead>
                                <tr><th>البند</th><th>المبلغ (ر.س)</th><th>النسبة %</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>إيرادات المبيعات</td><td>1,200,000</td><td>100.0%</td></tr>
                                <tr><td>تكلفة البضاعة المباعة</td><td>(720,000)</td><td>60.0%</td></tr>
                                <tr class="profit"><td><strong>إجمالي الربح</strong></td><td><strong>480,000</strong></td><td><strong>40.0%</strong></td></tr>
                                <tr><td>مصروفات البيع والتسويق</td><td>(120,000)</td><td>10.0%</td></tr>
                                <tr><td>المصروفات الإدارية</td><td>(85,000)</td><td>7.1%</td></tr>
                                <tr><td>مصروفات الإهلاك</td><td>(35,000)</td><td>2.9%</td></tr>
                                <tr class="profit"><td><strong>الربح التشغيلي</strong></td><td><strong>240,000</strong></td><td><strong>20.0%</strong></td></tr>
                                <tr><td>مصروفات الفوائد</td><td>(18,000)</td><td>1.5%</td></tr>
                                <tr><td>ضريبة الدخل</td><td>(33,000)</td><td>2.8%</td></tr>
                                <tr class="final-total"><td><strong>صافي الربح</strong></td><td><strong>189,000</strong></td><td><strong>15.7%</strong></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="report-actions">
                        <button onclick="window.print()" class="btn-print">طباعة</button>
                        <button onclick="exportToExcel('profit-loss')" class="btn-excel">تصدير Excel</button>
                        <button onclick="exportToPDF('profit-loss')" class="btn-pdf">تصدير PDF</button>
                    </div>
                </div>
            `;
        }

        // دالة مساعدة لتنسيق الأرقام بأمان
        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || value === '' || isNaN(value)) {
                return '0.00';
            }
            const num = parseFloat(value);
            if (isNaN(num)) {
                return '0.00';
            }
            return num.toFixed(decimals);
        }

        // دالة تحويل طرق الدفع من الإنجليزية إلى العربية
        function convertPaymentMethodToArabic(paymentMethod) {
            const conversionMap = {
                'cash': 'نقداً',
                'credit': 'آجل',
                'transfer': 'تحويل بنكي',
                'bank-transfer': 'تحويل بنكي',
                'card': 'تحويل بنكي'
            };
            return conversionMap[paymentMethod] || paymentMethod;
        }

        // دالة إنشاء تقرير المبيعات اليومية
        function createDailySalesReport(dateRange, filters = {}) {
            console.log('📊 إنشاء تقرير المبيعات اليومية من البيانات الحقيقية...', filters);

            try {
                // الحصول على البيانات الحقيقية من النظام
                let salesData = [];
                let customersData = [];

                if (window.dataManager) {
                    salesData = window.dataManager.getSales();
                    customersData = window.dataManager.getCustomers();
                    console.log('📊 تم جلب البيانات من النظام المركزي:', salesData.length, 'فاتورة،', customersData.length, 'عميل');
                } else {
                    // الرجوع للبيانات المحلية
                    salesData = JSON.parse(localStorage.getItem('monjizSales')) || [];
                    const invoicesData = JSON.parse(localStorage.getItem('monjizInvoices')) || [];
                    customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];

                    // دمج البيانات من المفتاحين
                    salesData = [...salesData, ...invoicesData];

                    // إزالة المكررات
                    salesData = salesData.filter((sale, index, self) =>
                        index === self.findIndex(s => s.id === sale.id)
                    );

                    console.log('📊 تم جلب البيانات من localStorage:', salesData.length, 'فاتورة،', customersData.length, 'عميل');
                }

                // استخدام الكود الأصلي لمعالجة التاريخ مع إصلاح البيانات فقط
                console.log('📅 نطاق التاريخ المستلم:', dateRange);

                // فلترة المبيعات حسب التاريخ إذا تم تحديده
                let filteredSales = salesData;
                let dateInfo = '';

                if (dateRange && dateRange.from && dateRange.to) {
                    console.log('📅 تطبيق فلتر التاريخ:', dateRange);
                    const fromDate = new Date(dateRange.from);
                    const toDate = new Date(dateRange.to);
                    toDate.setHours(23, 59, 59, 999); // نهاية اليوم

                    filteredSales = salesData.filter(sale => {
                        if (!sale.date && !sale.createdAt) return false;

                        let saleDate;
                        if (sale.createdAt) {
                            saleDate = new Date(sale.createdAt);
                        } else if (sale.date) {
                            // محاولة تحويل التاريخ بتنسيقات مختلفة
                            if (sale.date.includes('/')) {
                                // تنسيق DD/MM/YYYY
                                const parts = sale.date.split('/');
                                if (parts.length === 3) {
                                    saleDate = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            } else {
                                saleDate = new Date(sale.date);
                            }
                        }

                        return saleDate && saleDate >= fromDate && saleDate <= toDate;
                    });

                    dateInfo = `${fromDate.toLocaleDateString('ar-EG')} - ${toDate.toLocaleDateString('ar-EG')}`;
                    console.log('📊 المبيعات بعد فلتر التاريخ:', filteredSales.length, 'فاتورة');
                } else {
                    // إذا لم يتم تحديد تاريخ، استخدم اليوم الحالي
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    const todayDDMMYYYY = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;

                    filteredSales = salesData.filter(sale => {
                        if (!sale.date && !sale.createdAt) return false;

                        if (sale.date) {
                            // تحقق من تنسيقات مختلفة
                            if (sale.date === todayDDMMYYYY || sale.date === todayStr) {
                                return true;
                            }

                            // محاولة تحويل وقارن
                            try {
                                const saleDate = new Date(sale.date);
                                const saleDateStr = saleDate.toISOString().split('T')[0];
                                return saleDateStr === todayStr;
                            } catch (e) {
                                return false;
                            }
                        }

                        if (sale.createdAt) {
                            try {
                                const createdDate = new Date(sale.createdAt);
                                const createdDateStr = createdDate.toISOString().split('T')[0];
                                return createdDateStr === todayStr;
                            } catch (e) {
                                return false;
                            }
                        }

                        return false;
                    });

                    dateInfo = today.toLocaleDateString('ar-EG');
                    console.log('📅 مبيعات اليوم (افتراضي):', filteredSales.length, 'فاتورة');
                }



                // تطبيق فلتر طريقة الدفع إذا وجد
                if (filters.account && filters.account !== '') {
                    const paymentMethodMap = {
                        'نقداً': ['cash', 'نقداً', 'نقدي'],
                        'بطاقة ائتمان': ['card', 'بطاقة ائتمان', 'بطاقة'],
                        'تحويل بنكي': ['bank', 'تحويل بنكي', 'تحويل'],
                        'آجل': ['credit', 'آجل', 'أجل']
                    };

                    const allowedMethods = paymentMethodMap[filters.account] || [filters.account];
                    filteredSales = filteredSales.filter(sale =>
                        allowedMethods.includes(sale.paymentMethod)
                    );
                    console.log('💳 مبيعات اليوم بعد فلتر طريقة الدفع:', filteredSales.length);
                }

                // تحويل البيانات إلى تنسيق التقرير
                const dailyInvoices = filteredSales.map(sale => {
                    // البحث عن اسم العميل
                    let customerName = sale.customerName || sale.customer || 'عميل غير محدد';
                    if (sale.customerId) {
                        const customer = customersData.find(c => c.id == sale.customerId);
                        if (customer) {
                            customerName = customer.name;
                        }
                    }

                    // تحويل طريقة الدفع للعربية
                    const paymentMethodMap = {
                        'cash': 'نقداً',
                        'card': 'بطاقة ائتمان',
                        'bank': 'تحويل بنكي',
                        'credit': 'آجل'
                    };
                    const paymentMethod = paymentMethodMap[sale.paymentMethod] || sale.paymentMethod || 'غير محدد';

                    // استخراج الوقت من التاريخ
                    let time = 'غير محدد';
                    if (sale.createdAt) {
                        const date = new Date(sale.createdAt);
                        time = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                    }

                    // تحديد الحالة
                    const statusMap = {
                        'completed': 'مدفوعة',
                        'paid': 'مدفوعة',
                        'pending': 'معلقة',
                        'cancelled': 'ملغية'
                    };
                    const status = statusMap[sale.status] || 'مدفوعة';

                    return {
                        id: sale.id,
                        customer: customerName,
                        amount: parseFloat(sale.total) || 0,
                        method: paymentMethod,
                        time: time,
                        status: status
                    };
                });

                // حساب الإحصائيات
                const totalAmount = dailyInvoices.reduce((sum, invoice) => sum + invoice.amount, 0);
                const totalInvoices = dailyInvoices.length;
                const averageInvoice = totalInvoices > 0 ? totalAmount / totalInvoices : 0;
                const paidInvoices = dailyInvoices.filter(inv => inv.status === 'مدفوعة').length;
                const pendingInvoices = dailyInvoices.filter(inv => inv.status === 'معلقة').length;

                // إنشاء بيانات التقرير
                const reportData = {
                    total: totalAmount,
                    invoices: totalInvoices,
                    average: averageInvoice,
                    paid: paidInvoices,
                    pending: pendingInvoices,
                    rawData: dailyInvoices,
                    date: dateInfo, // استخدام التاريخ المحسوب من الفلترة
                    filterInfo: filters.account ? ` - طريقة الدفع: ${filters.account}` : ''
                };

                console.log('📊 إحصائيات التقرير:', reportData);

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <!-- الإحصائيات المصغرة -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💰 إجمالي المبيعات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.total)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📄 عدد الفواتير</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.invoices}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📈 متوسط الفاتورة</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.average)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">✅ فواتير مدفوعة</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.paid}</div>
                            </div>
                            ${reportData.pending > 0 ? `
                            <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">⏳ فواتير معلقة</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.pending}</div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- جدول تفاصيل الفواتير -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                                📋 تفاصيل فواتير ${dateRange && dateRange.from ? 'الفترة' : 'اليوم'} - ${reportData.date}${reportData.filterInfo}
                            </h3>

                            ${reportData.rawData && reportData.rawData.length > 0 ? `
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">رقم الفاتورة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">العميل</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">المبلغ</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">طريقة الدفع</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الوقت</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reportData.rawData.map((invoice, index) => {
                                                const isEven = index % 2 === 0;


                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${invoice.id}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057;">${invoice.customer}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(invoice.amount)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${invoice.method}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057; font-size: 0.9em;">${invoice.time}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                            <!-- صف الإجمالي -->
                                            <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold;">
                                                <td colspan="2" style="padding: 16px 12px; text-align: center; font-size: 1.1em;">الإجمالي</td>
                                                <td style="padding: 16px 12px; text-align: center; font-size: 1.2em;">${formatCurrency(reportData.total)}</td>
                                                <td colspan="2" style="padding: 16px 12px; text-align: center;">${reportData.invoices} فاتورة</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px; color: #666;">
                                    <i class="fas fa-receipt" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;"></i>
                                    <br>لا توجد فواتير مبيعات اليوم
                                    <div style="margin-top: 20px;">
                                        <a href="sales.html" style="background: #28a745; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: 600;">
                                            <i class="fas fa-plus"></i> إضافة فاتورة جديدة
                                        </a>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- معلومات إضافية -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 25px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">📊 ملخص ${dateRange && dateRange.from ? 'التاريخ المحدد' : 'اليوم'}</h4>
                                <div style="color: #495057; line-height: 1.6;">
                                    <div style="margin-bottom: 8px;">• إجمالي المبيعات: <strong style="color: #28a745;">${formatCurrency(reportData.total)}</strong></div>
                                    <div style="margin-bottom: 8px;">• عدد الفواتير: <strong>${reportData.invoices}</strong></div>
                                    <div style="margin-bottom: 8px;">• متوسط الفاتورة: <strong style="color: #667eea;">${formatCurrency(reportData.average)}</strong></div>
                                    <div>• معدل الإنجاز: <strong style="color: #28a745;">${reportData.invoices > 0 ? ((reportData.paid / reportData.invoices) * 100).toFixed(1) : '0'}%</strong></div>
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">⏰ توزيع المبيعات</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    ${reportData.rawData.length > 0 ? `
                                        <div style="margin-bottom: 8px;">• الفترة الصباحية: ${reportData.rawData.filter(inv => {
                                            const hour = inv.time.includes(':') ? parseInt(inv.time.split(':')[0]) : 0;
                                            return hour < 12;
                                        }).length} فاتورة</div>
                                        <div style="margin-bottom: 8px;">• فترة الظهيرة: ${reportData.rawData.filter(inv => {
                                            const hour = inv.time.includes(':') ? parseInt(inv.time.split(':')[0]) : 0;
                                            return hour >= 12 && hour < 17;
                                        }).length} فاتورة</div>
                                        <div style="margin-bottom: 8px;">• الفترة المسائية: ${reportData.rawData.filter(inv => {
                                            const hour = inv.time.includes(':') ? parseInt(inv.time.split(':')[0]) : 0;
                                            return hour >= 17;
                                        }).length} فاتورة</div>
                                        <div>• أعلى مبيعات: <strong style="color: #28a745;">${formatCurrency(Math.max(...reportData.rawData.map(inv => inv.amount)))}</strong></div>
                                    ` : `
                                        <div style="margin-bottom: 8px;">• الفترة الصباحية: 0 فاتورة</div>
                                        <div style="margin-bottom: 8px;">• فترة الظهيرة: 0 فاتورة</div>
                                        <div style="margin-bottom: 8px;">• الفترة المسائية: 0 فاتورة</div>
                                        <div>• أعلى مبيعات: <strong style="color: #28a745;">0 ر.س</strong></div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <!-- أزرار التصدير -->
                        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="printReport()" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(108, 117, 125, 0.3)'">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button onclick="exportToExcel('daily-sales')" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                <i class="fas fa-file-excel"></i> تصدير Excel
                            </button>
                            <button onclick="exportToPDF('daily-sales')" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)'">
                                <i class="fas fa-file-pdf"></i> تصدير PDF
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('خطأ في إنشاء تقرير المبيعات اليومية:', error);
                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 40px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center;">
                        <div style="color: #dc3545; margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 15px;"></i>
                            <h3>خطأ في تحميل التقرير</h3>
                            <p>عذراً، حدث خطأ أثناء إنشاء تقرير المبيعات اليومية. يرجى المحاولة مرة أخرى.</p>
                        </div>
                        <button onclick="location.reload()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }

        // دالة إنشاء تقرير قائمة العملاء
        function createCustomerListReport(dateRange, filters = {}) {
            console.log('🔄 إنشاء تقرير قائمة العملاء...', { dateRange, filters });

            // الحصول على البيانات الحقيقية من النظام المركزي
            let customersData = [];
            if (window.dataManager) {
                customersData = window.dataManager.getCustomers();
                console.log('✅ تم جلب', customersData.length, 'عميل من النظام المركزي');
            } else {
                customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                console.log('📦 تم جلب', customersData.length, 'عميل من localStorage');
            }

            // تطبيق فلتر العميل المحدد إذا وجد
            if (filters.account && filters.account !== '') {
                console.log('🔍 تطبيق فلتر العميل:', filters.account);
                customersData = customersData.filter(customer => {
                    return String(customer.id) === String(filters.account) ||
                           customer.name === filters.account ||
                           customer.name.includes(filters.account);
                });
                console.log('📊 العملاء بعد الفلتر:', customersData.length);
            }

            // تطبيق فلتر التاريخ (العملاء المضافين في فترة معينة)
            if (dateRange && dateRange.from && dateRange.to) {
                console.log('📅 تطبيق فلتر التاريخ:', dateRange);
                const fromDate = new Date(dateRange.from);
                const toDate = new Date(dateRange.to);
                toDate.setHours(23, 59, 59, 999);

                customersData = customersData.filter(customer => {
                    if (!customer.createdAt && !customer.dateAdded) return true; // إذا لم يكن هناك تاريخ، اعرض العميل

                    let customerDate;
                    if (customer.createdAt) {
                        customerDate = new Date(customer.createdAt);
                    } else if (customer.dateAdded) {
                        customerDate = new Date(customer.dateAdded);
                    }

                    return customerDate && customerDate >= fromDate && customerDate <= toDate;
                });

                console.log('📊 العملاء بعد فلتر التاريخ:', customersData.length);
            }

            // إحصائيات العملاء
            const totalCustomers = customersData.length;
            const activeCustomers = customersData.filter(c => c.status === 'active' || !c.status).length;
            const individualCustomers = customersData.filter(c => c.type === 'individual').length;
            const companyCustomers = customersData.filter(c => c.type === 'company').length;

            // بناء صفوف الجدول
            let tableRows = '';
            if (customersData.length > 0) {
                customersData.forEach((customer, index) => {
                    const customerType = customer.type === 'company' ? 'شركة' : 'فرد';
                    const customerStatus = customer.status === 'active' || !customer.status ? 'نشط' : 'غير نشط';
                    const customerBalance = formatNumber(customer.balance);
                    const balanceClass = parseFloat(customerBalance) >= 0 ? 'positive' : 'negative';
                    const statusClass = customer.status === 'active' || !customer.status ? 'status-paid' : 'status-pending';

                    tableRows += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${customer.name || 'غير محدد'}</strong></td>
                            <td>${customerType}</td>
                            <td>${customer.phone || 'غير محدد'}</td>
                            <td>${customer.email || 'غير محدد'}</td>
                            <td>${customer.address || 'غير محدد'}</td>
                            <td><span class="${balanceClass}">${customerBalance} ر.س</span></td>
                            <td><span class="${statusClass}">${customerStatus}</span></td>
                        </tr>
                    `;
                });
            } else {
                tableRows = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                            <br>لا توجد عملاء مسجلين في النظام
                        </td>
                    </tr>
                `;
            }

            return `
                <div class="report-container">
                    <div class="report-header">
                        <p>تاريخ التقرير: ${formatDateGregorian(new Date())}</p>
                    </div>
                    <div class="report-content">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th><i class="fas fa-user"></i> اسم العميل</th>
                                    <th><i class="fas fa-tag"></i> النوع</th>
                                    <th><i class="fas fa-phone"></i> الهاتف</th>
                                    <th><i class="fas fa-envelope"></i> البريد الإلكتروني</th>
                                    <th><i class="fas fa-map-marker-alt"></i> العنوان</th>
                                    <th><i class="fas fa-money-bill-wave"></i> الرصيد</th>
                                    <th><i class="fas fa-info-circle"></i> الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    <div class="report-actions">
                        <button onclick="window.print()" class="btn-print">طباعة</button>
                        <button onclick="exportToExcel('customer-list')" class="btn-excel">تصدير Excel</button>
                        <button onclick="exportToPDF('customer-list')" class="btn-pdf">تصدير PDF</button>
                    </div>
                </div>

                <style>
                .card-icon {
                    font-size: 1.5rem;
                    margin-bottom: 8px;
                    color: #007bff;
                }
                .card-content h4 {
                    margin: 0 0 8px 0;
                    font-size: 0.9rem;
                    color: #666;
                }
                .card-content .count {
                    margin: 0;
                    font-size: 1.8rem;
                    font-weight: bold;
                    color: #333;
                }
                .positive {
                    color: #28a745;
                    font-weight: 600;
                }
                .negative {
                    color: #dc3545;
                    font-weight: 600;
                }
                .status-paid {
                    background-color: #d4edda;
                    color: #155724;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 0.85rem;
                    font-weight: 600;
                }
                .status-pending {
                    background-color: #f8d7da;
                    color: #721c24;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 0.85rem;
                    font-weight: 600;
                }
                </style>
            `;
        }

        // دالة إنشاء تقرير أرصدة العملاء
        function createCustomerBalancesReport(dateRange, filters = {}) {
            console.log('💰 إنشاء تقرير أرصدة العملاء...', { dateRange, filters });

            // الحصول على بيانات العملاء والمبيعات
            let customersData = [];
            let salesData = [];

            if (window.dataManager) {
                customersData = window.dataManager.getCustomers();
                salesData = window.dataManager.getSales();
            } else {
                customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                salesData = JSON.parse(localStorage.getItem('monjizSales')) ||
                           JSON.parse(localStorage.getItem('monjizInvoices')) || [];
            }

            // إزالة العملاء المكررين من البيانات الأساسية
            const uniqueCustomersMap = new Map();
            customersData.forEach(customer => {
                if (customer && customer.name) {
                    const customerKey = `${customer.name.trim()}_${customer.phone || 'no-phone'}`;
                    if (!uniqueCustomersMap.has(customerKey)) {
                        uniqueCustomersMap.set(customerKey, customer);
                    }
                }
            });
            customersData = Array.from(uniqueCustomersMap.values());

            console.log('👥 بيانات العملاء (بعد إزالة التكرار):', customersData.length);
            console.log('💰 بيانات المبيعات:', salesData.length);

            // تطبيق فلاتر التاريخ
            let filteredSales = salesData;
            if (dateRange && dateRange.from && dateRange.to) {
                console.log('📅 تطبيق فلتر التاريخ:', dateRange.from, 'إلى', dateRange.to);
                const fromDate = new Date(dateRange.from);
                const toDate = new Date(dateRange.to);
                toDate.setHours(23, 59, 59, 999);

                filteredSales = salesData.filter(sale => {
                    let saleDate;
                    if (sale.createdAt) {
                        saleDate = new Date(sale.createdAt);
                    } else if (sale.date) {
                        if (sale.date && sale.date.includes && sale.date.includes('/')) {
                            const parts = sale.date.split('/');
                            if (parts.length === 3) {
                                saleDate = new Date(`${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`);
                            } else {
                                saleDate = new Date(sale.date);
                            }
                        } else {
                            saleDate = new Date(sale.date);
                        }
                    }
                    return saleDate && !isNaN(saleDate.getTime()) && saleDate >= fromDate && saleDate <= toDate;
                });
                console.log('📊 المبيعات بعد فلتر التاريخ:', filteredSales.length);
            } else {
                console.log('📅 لم يتم تحديد فلتر تاريخ، سيتم عرض جميع المبيعات');
            }

            // تطبيق فلتر العميل المحدد
            if (filters.account && filters.account !== '') {
                const selectedCustomer = customersData.find(c => c.id == filters.account || c.name === filters.account);
                if (selectedCustomer) {
                    customersData = [selectedCustomer];
                    console.log('👤 تم تحديد عميل واحد:', selectedCustomer.name);
                }
            }

            // حساب أرصدة العملاء المفصلة
            const customerBalances = customersData.map(customer => {
                const customerSales = filteredSales.filter(sale =>
                    sale.customerId === customer.id ||
                    sale.customerName === customer.name
                );

                // حساب إجمالي المبيعات
                const totalSales = customerSales.reduce((sum, sale) => sum + (parseFloat(sale.total) || 0), 0);
                const totalInvoices = customerSales.length;

                // حساب المدفوعات (الفواتير المدفوعة)
                const paidSales = customerSales.filter(sale =>
                    sale.status === 'paid' || sale.paymentStatus === 'paid' || sale.paymentMethod === 'نقداً'
                );
                const totalPaid = paidSales.reduce((sum, sale) => sum + (parseFloat(sale.total) || 0), 0);

                // حساب المبالغ المستحقة (غير المدفوعة)
                const unpaidSales = customerSales.filter(sale =>
                    sale.status === 'pending' || sale.paymentStatus === 'pending' || sale.paymentMethod === 'آجل'
                );
                const totalDue = unpaidSales.reduce((sum, sale) => sum + (parseFloat(sale.total) || 0), 0);

                // الرصيد النهائي (المبلغ المستحق من العميل)
                const balance = totalSales - totalPaid;

                // آخر عملية شراء
                const lastSale = customerSales.length > 0 ?
                    customerSales.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt))[0] : null;

                // حالة العميل
                let customerStatus = 'نشط';
                if (balance > 1000) {
                    customerStatus = 'مديون';
                } else if (balance < 0) {
                    customerStatus = 'دائن';
                } else if (totalInvoices === 0) {
                    customerStatus = 'غير نشط';
                }

                return {
                    ...customer,
                    totalSales,
                    totalPaid,
                    totalDue,
                    balance,
                    totalInvoices,
                    lastSaleDate: lastSale ? (lastSale.date || lastSale.createdAt) : 'لا توجد مبيعات',
                    averageSale: totalInvoices > 0 ? totalSales / totalInvoices : 0,
                    customerStatus
                };
            });

            // تطبيق فلتر العميل المحدد على النتائج النهائية
            let finalCustomerBalances = customerBalances;
            if (filters.account && filters.account !== '') {
                finalCustomerBalances = customerBalances.filter(customer =>
                    customer.id == filters.account || customer.name === filters.account
                );
                console.log('👤 تم تصفية العملاء للعميل المحدد:', finalCustomerBalances.length);
            }

            // ترتيب العملاء حسب الرصيد (الأكثر استحقاقاً أولاً)
            finalCustomerBalances.sort((a, b) => b.balance - a.balance);

            // بناء صفوف الجدول
            let tableRows = '';
            let totalAllSales = 0;
            let totalAllPaid = 0;
            let totalAllDue = 0;
            let totalAllBalance = 0;

            if (finalCustomerBalances.length > 0) {
                finalCustomerBalances.forEach((customer, index) => {
                    totalAllSales += customer.totalSales;
                    totalAllPaid += customer.totalPaid;
                    totalAllDue += customer.totalDue;
                    totalAllBalance += customer.balance;

                    // تحديد لون الرصيد
                    let balanceClass = '';
                    let balanceIcon = '';
                    if (customer.balance > 0) {
                        balanceClass = 'text-danger'; // أحمر للمديون
                        balanceIcon = '⚠️';
                    } else if (customer.balance < 0) {
                        balanceClass = 'text-success'; // أخضر للدائن
                        balanceIcon = '✅';
                    } else {
                        balanceClass = 'text-muted'; // رمادي للمتوازن
                        balanceIcon = '➖';
                    }

                    // تحديد لون حالة العميل
                    let statusClass = '';
                    switch (customer.customerStatus) {
                        case 'مديون': statusClass = 'status-warning'; break;
                        case 'دائن': statusClass = 'status-success'; break;
                        case 'نشط': statusClass = 'status-good'; break;
                        default: statusClass = 'status-inactive'; break;
                    }

                    tableRows += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 6px; text-align: center;">${index + 1}</td>
                            <td style="padding: 6px;">
                                <strong style="font-size: 13px;">${customer.name}</strong>
                                ${customer.phone ? `<br><small style="color: #666; font-size: 11px;">${customer.phone}</small>` : ''}
                            </td>
                            <td style="padding: 6px; text-align: right; font-weight: 500;">${formatNumber(customer.totalSales)}</td>
                            <td style="padding: 6px; text-align: right; color: #28a745;">${formatNumber(customer.totalPaid)}</td>
                            <td style="padding: 6px; text-align: right;" class="${balanceClass}">
                                <span style="font-size: 12px;">${balanceIcon}</span> ${formatNumber(Math.abs(customer.balance))}
                            </td>
                            <td style="padding: 6px; text-align: center;">${customer.totalInvoices}</td>
                            <td style="padding: 6px; text-align: right;">${formatNumber(customer.averageSale)}</td>
                            <td style="padding: 6px; text-align: center;">
                                <span class="badge ${statusClass}" style="font-size: 10px; padding: 2px 6px;">${customer.customerStatus}</span>
                            </td>
                            <td style="padding: 6px; text-align: center; font-size: 11px; color: #666;">
                                ${customer.lastSaleDate !== 'لا توجد مبيعات' ? new Date(customer.lastSaleDate).toLocaleDateString('ar') : customer.lastSaleDate}
                            </td>
                        </tr>
                    `;
                });

                // صف الإجمالي
                const totalBalanceClass = totalAllBalance > 0 ? 'color: #dc3545' : totalAllBalance < 0 ? 'color: #28a745' : 'color: #6c757d';
                tableRows += `
                    <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                        <td colspan="2" style="padding: 8px;"><strong>الإجمالي</strong></td>
                        <td style="padding: 8px; text-align: right;"><strong>${formatNumber(totalAllSales)}</strong></td>
                        <td style="padding: 8px; text-align: right; color: #28a745;"><strong>${formatNumber(totalAllPaid)}</strong></td>
                        <td style="padding: 8px; text-align: right; ${totalBalanceClass}"><strong>${formatNumber(Math.abs(totalAllBalance))}</strong></td>
                        <td colspan="4" style="padding: 8px;"></td>
                    </tr>
                `;
            } else {
                const noDataMessage = filters.account && filters.account !== '' ?
                    'لا توجد بيانات للعميل المحدد في الفترة المختارة' :
                    'لا توجد بيانات عملاء';
                tableRows = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">${noDataMessage}</td></tr>`;
            }

            return `
                <div class="report-container" style="padding: 0; margin: 0;">
                    <div class="report-content">
                        <!-- الجدول المفصل -->
                        <div class="table-container" style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333;">📋 تفاصيل الأرصدة</h3>
                                <div style="font-size: 12px; color: #666;">
                                    <span><strong>الفترة:</strong> ${dateRange}</span> |
                                    <span>تاريخ الإنشاء: ${new Date().toLocaleDateString('ar')}</span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="report-table enhanced" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">#</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">العميل</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">إجمالي المبيعات</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">المدفوع</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">المستحق</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">الفواتير</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">متوسط الفاتورة</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">الحالة</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">آخر شراء</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="report-actions" style="margin-top: 15px; text-align: center;">
                        <button onclick="window.print()" class="btn-print" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 طباعة
                        </button>
                        <button onclick="exportToExcel('customer-balances')" class="btn-excel" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📊 Excel
                        </button>
                        <button onclick="exportToPDF('customer-balances')" class="btn-pdf" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 PDF
                        </button>
                    </div>
                </div>
            `;
        }

        // دالة إنشاء تقرير تحليل العملاء
        function createCustomerAnalysisReport(dateRange, filters = {}) {
            console.log('📊 إنشاء تقرير تحليل العملاء...', { dateRange, filters });

            // الحصول على بيانات العملاء والمبيعات
            let customersData = [];
            let salesData = [];

            if (window.dataManager) {
                customersData = window.dataManager.getCustomers();
                salesData = window.dataManager.getSales();
            } else {
                customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                salesData = JSON.parse(localStorage.getItem('monjizSales')) ||
                           JSON.parse(localStorage.getItem('monjizInvoices')) || [];
            }

            // إزالة العملاء المكررين من البيانات الأساسية
            const uniqueCustomersMap = new Map();
            customersData.forEach(customer => {
                if (customer && customer.name) {
                    const customerKey = `${customer.name.trim()}_${customer.phone || 'no-phone'}`;
                    if (!uniqueCustomersMap.has(customerKey)) {
                        uniqueCustomersMap.set(customerKey, customer);
                    }
                }
            });
            customersData = Array.from(uniqueCustomersMap.values());

            console.log('👥 بيانات العملاء (بعد إزالة التكرار):', customersData.length);
            console.log('💰 بيانات المبيعات:', salesData.length);

            // تطبيق فلاتر التاريخ
            let filteredSales = salesData;
            if (filters.dateFrom && filters.dateTo) {
                console.log('📅 تطبيق فلتر التاريخ:', filters.dateFrom, 'إلى', filters.dateTo);
                const fromDate = new Date(filters.dateFrom);
                const toDate = new Date(filters.dateTo);
                toDate.setHours(23, 59, 59, 999);

                filteredSales = salesData.filter(sale => {
                    let saleDate;
                    if (sale.createdAt) {
                        saleDate = new Date(sale.createdAt);
                    } else if (sale.date) {
                        if (sale.date && sale.date.includes && sale.date.includes('/')) {
                            const parts = sale.date.split('/');
                            if (parts.length === 3) {
                                saleDate = new Date(`${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`);
                            } else {
                                saleDate = new Date(sale.date);
                            }
                        } else {
                            saleDate = new Date(sale.date);
                        }
                    }
                    return saleDate && !isNaN(saleDate.getTime()) && saleDate >= fromDate && saleDate <= toDate;
                });
                console.log('📊 المبيعات بعد فلتر التاريخ:', filteredSales.length);
            }

            // تطبيق فلتر العميل المحدد
            let finalCustomersData = customersData;
            if (filters.account && filters.account !== '') {
                console.log('🔍 البحث عن العميل المحدد:', filters.account);

                // البحث بطرق متعددة للتأكد من الدقة
                const selectedCustomer = customersData.find(c =>
                    c.id == filters.account ||
                    c.id === filters.account ||
                    c.name === filters.account ||
                    String(c.id) === String(filters.account)
                );

                if (selectedCustomer) {
                    finalCustomersData = [selectedCustomer];
                    console.log('✅ تم العثور على العميل:', selectedCustomer.name, 'ID:', selectedCustomer.id);
                } else {
                    console.log('❌ لم يتم العثور على العميل المحدد:', filters.account);
                    console.log('📋 العملاء المتاحون:', customersData.map(c => ({ id: c.id, name: c.name })));
                }
            }

            // تحليل العملاء المفصل
            const customerAnalysis = finalCustomersData.map(customer => {
                const customerSales = filteredSales.filter(sale => {
                    // مقارنة دقيقة للعميل
                    return (
                        sale.customerId == customer.id ||
                        sale.customerId === customer.id ||
                        String(sale.customerId) === String(customer.id) ||
                        sale.customerName === customer.name ||
                        (sale.customerName && sale.customerName.trim() === customer.name.trim())
                    );
                });

                console.log(`📊 العميل ${customer.name}: ${customerSales.length} فاتورة`);

                // حساب الإحصائيات
                const totalSales = customerSales.reduce((sum, sale) => sum + (parseFloat(sale.total) || 0), 0);
                const totalInvoices = customerSales.length;
                const avgInvoiceValue = totalInvoices > 0 ? totalSales / totalInvoices : 0;

                // تحليل الفترات الزمنية
                const salesByMonth = {};
                customerSales.forEach(sale => {
                    const saleDate = new Date(sale.createdAt || sale.date);
                    if (!isNaN(saleDate.getTime())) {
                        const monthKey = `${saleDate.getFullYear()}-${(saleDate.getMonth() + 1).toString().padStart(2, '0')}`;
                        if (!salesByMonth[monthKey]) {
                            salesByMonth[monthKey] = { count: 0, total: 0 };
                        }
                        salesByMonth[monthKey].count++;
                        salesByMonth[monthKey].total += (parseFloat(sale.total) || 0);
                    }
                });

                // آخر عملية شراء
                const lastSale = customerSales.length > 0 ?
                    customerSales.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt))[0] : null;

                // تصنيف العميل
                let customerCategory = 'جديد';
                if (totalSales > 10000) {
                    customerCategory = 'VIP';
                } else if (totalSales > 5000) {
                    customerCategory = 'ذهبي';
                } else if (totalSales > 1000) {
                    customerCategory = 'فضي';
                } else if (totalInvoices > 0) {
                    customerCategory = 'عادي';
                }

                // معدل التكرار (عدد الأشهر النشطة)
                const activeMonths = Object.keys(salesByMonth).length;
                const frequency = activeMonths > 0 ? totalInvoices / activeMonths : 0;

                return {
                    ...customer,
                    totalSales,
                    totalInvoices,
                    avgInvoiceValue,
                    activeMonths,
                    frequency: frequency.toFixed(1),
                    lastSaleDate: lastSale ? (lastSale.date || lastSale.createdAt) : 'لا توجد مبيعات',
                    customerCategory,
                    salesByMonth: Object.keys(salesByMonth).length
                };
            });

            // ترتيب العملاء حسب إجمالي المبيعات
            customerAnalysis.sort((a, b) => b.totalSales - a.totalSales);

            // بناء صفوف الجدول
            let tableRows = '';
            if (customerAnalysis.length > 0) {
                customerAnalysis.forEach((customer, index) => {
                    // تحديد لون التصنيف
                    let categoryClass = '';
                    switch (customer.customerCategory) {
                        case 'VIP': categoryClass = 'badge status-success'; break;
                        case 'ذهبي': categoryClass = 'badge status-warning'; break;
                        case 'فضي': categoryClass = 'badge status-good'; break;
                        case 'عادي': categoryClass = 'badge status-inactive'; break;
                        default: categoryClass = 'badge status-pending'; break;
                    }

                    tableRows += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 8px; text-align: center;">${index + 1}</td>
                            <td style="padding: 8px;">
                                <strong style="font-size: 14px;">${customer.name}</strong>
                                ${customer.phone ? `<br><small style="color: #666; font-size: 11px;">${customer.phone}</small>` : ''}
                            </td>
                            <td style="padding: 8px; text-align: right; font-weight: 500;">${formatNumber(customer.totalSales)}</td>
                            <td style="padding: 8px; text-align: center;">${customer.totalInvoices}</td>
                            <td style="padding: 8px; text-align: right;">${formatNumber(customer.avgInvoiceValue)}</td>
                            <td style="padding: 8px; text-align: center;">${customer.activeMonths}</td>
                            <td style="padding: 8px; text-align: center;">${customer.frequency}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span class="${categoryClass}" style="font-size: 10px; padding: 2px 6px;">${customer.customerCategory}</span>
                            </td>
                            <td style="padding: 8px; text-align: center; font-size: 11px; color: #666;">
                                ${customer.lastSaleDate !== 'لا توجد مبيعات' ? new Date(customer.lastSaleDate).toLocaleDateString('ar') : customer.lastSaleDate}
                            </td>
                        </tr>
                    `;
                });
            } else {
                const noDataMessage = filters.account && filters.account !== '' ?
                    'لا توجد بيانات للعميل المحدد في الفترة المختارة' :
                    'لا توجد بيانات عملاء';
                tableRows = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">${noDataMessage}</td></tr>`;
            }

            return `
                <div class="report-container">
                    <div class="report-content">
                        <!-- الجدول المفصل -->
                        <div class="table-container" style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333;">📊 تحليل أداء العملاء</h3>
                                <div style="font-size: 12px; color: #666;">
                                    <span><strong>الفترة:</strong> ${dateRange}</span> |
                                    <span>تاريخ الإنشاء: ${new Date().toLocaleDateString('ar')}</span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="report-table enhanced" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">#</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">العميل</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">إجمالي المبيعات</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">عدد الفواتير</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">متوسط الفاتورة</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">الأشهر النشطة</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">معدل التكرار</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">التصنيف</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">آخر شراء</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="report-actions" style="margin-top: 15px; text-align: center;">
                        <button onclick="window.print()" class="btn-print" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 طباعة
                        </button>
                        <button onclick="exportToExcel('customer-analysis')" class="btn-excel" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📊 Excel
                        </button>
                        <button onclick="exportToPDF('customer-analysis')" class="btn-pdf" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 PDF
                        </button>
                    </div>
                </div>
            `;
        }

        // دالة إنشاء تقرير أعمار الديون
        function createCustomerAgingReport(dateRange, filters = {}) {
            console.log('⏰ إنشاء تقرير أعمار الديون...', { dateRange, filters });

            // الحصول على بيانات العملاء والمبيعات
            let customersData = [];
            let salesData = [];

            if (window.dataManager) {
                customersData = window.dataManager.getCustomers();
                salesData = window.dataManager.getSales();
            } else {
                customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                salesData = JSON.parse(localStorage.getItem('monjizSales')) ||
                           JSON.parse(localStorage.getItem('monjizInvoices')) || [];
            }

            // إزالة العملاء المكررين من البيانات الأساسية
            const uniqueCustomersMap = new Map();
            customersData.forEach(customer => {
                if (customer && customer.name) {
                    const customerKey = `${customer.name.trim()}_${customer.phone || 'no-phone'}`;
                    if (!uniqueCustomersMap.has(customerKey)) {
                        uniqueCustomersMap.set(customerKey, customer);
                    }
                }
            });
            customersData = Array.from(uniqueCustomersMap.values());

            console.log('👥 بيانات العملاء (بعد إزالة التكرار):', customersData.length);
            console.log('💰 بيانات المبيعات:', salesData.length);

            // تطبيق فلاتر التاريخ
            let filteredSales = salesData;
            if (filters.dateFrom && filters.dateTo) {
                console.log('📅 تطبيق فلتر التاريخ:', filters.dateFrom, 'إلى', filters.dateTo);
                const fromDate = new Date(filters.dateFrom);
                const toDate = new Date(filters.dateTo);
                toDate.setHours(23, 59, 59, 999);

                filteredSales = salesData.filter(sale => {
                    let saleDate;
                    if (sale.createdAt) {
                        saleDate = new Date(sale.createdAt);
                    } else if (sale.date) {
                        if (sale.date && sale.date.includes && sale.date.includes('/')) {
                            const parts = sale.date.split('/');
                            if (parts.length === 3) {
                                saleDate = new Date(`${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`);
                            } else {
                                saleDate = new Date(sale.date);
                            }
                        } else {
                            saleDate = new Date(sale.date);
                        }
                    }
                    return saleDate && !isNaN(saleDate.getTime()) && saleDate >= fromDate && saleDate <= toDate;
                });
                console.log('📊 المبيعات بعد فلتر التاريخ:', filteredSales.length);
            }

            // تطبيق فلتر العميل المحدد
            let finalCustomersData = customersData;
            if (filters.account && filters.account !== '') {
                console.log('🔍 البحث عن العميل المحدد:', filters.account);

                const selectedCustomer = customersData.find(c =>
                    c.id == filters.account ||
                    c.id === filters.account ||
                    c.name === filters.account ||
                    String(c.id) === String(filters.account)
                );

                if (selectedCustomer) {
                    finalCustomersData = [selectedCustomer];
                    console.log('✅ تم العثور على العميل:', selectedCustomer.name, 'ID:', selectedCustomer.id);
                } else {
                    console.log('❌ لم يتم العثور على العميل المحدد:', filters.account);
                }
            }

            // تحليل أعمار الديون
            const currentDate = new Date();
            const customerAging = finalCustomersData.map(customer => {
                const customerSales = filteredSales.filter(sale => {
                    return (
                        sale.customerId == customer.id ||
                        sale.customerId === customer.id ||
                        String(sale.customerId) === String(customer.id) ||
                        sale.customerName === customer.name ||
                        (sale.customerName && sale.customerName.trim() === customer.name.trim())
                    );
                });

                console.log(`📊 العميل ${customer.name}: ${customerSales.length} فاتورة`);

                // حساب الأرصدة والأعمار
                let current = 0;      // 0-30 يوم
                let days30 = 0;       // 31-60 يوم
                let days60 = 0;       // 61-90 يوم
                let days90 = 0;       // 91-120 يوم
                let over120 = 0;      // أكثر من 120 يوم
                let totalDue = 0;

                customerSales.forEach(sale => {
                    const saleTotal = parseFloat(sale.total) || 0;
                    const salePaid = parseFloat(sale.paid) || 0;
                    const saleBalance = saleTotal - salePaid;

                    if (saleBalance > 0) { // فقط الفواتير غير المدفوعة
                        const saleDate = new Date(sale.createdAt || sale.date);
                        const daysDiff = Math.floor((currentDate - saleDate) / (1000 * 60 * 60 * 24));

                        totalDue += saleBalance;

                        if (daysDiff <= 30) {
                            current += saleBalance;
                        } else if (daysDiff <= 60) {
                            days30 += saleBalance;
                        } else if (daysDiff <= 90) {
                            days60 += saleBalance;
                        } else if (daysDiff <= 120) {
                            days90 += saleBalance;
                        } else {
                            over120 += saleBalance;
                        }
                    }
                });

                // تحديد مستوى المخاطر
                let riskLevel = 'منخفض';
                let riskClass = 'status-success';

                if (over120 > 0) {
                    riskLevel = 'عالي جداً';
                    riskClass = 'status-danger';
                } else if (days90 > 0) {
                    riskLevel = 'عالي';
                    riskClass = 'status-warning';
                } else if (days60 > 0) {
                    riskLevel = 'متوسط';
                    riskClass = 'status-pending';
                } else if (days30 > 0) {
                    riskLevel = 'منخفض';
                    riskClass = 'status-good';
                }

                return {
                    ...customer,
                    current,
                    days30,
                    days60,
                    days90,
                    over120,
                    totalDue,
                    riskLevel,
                    riskClass
                };
            });

            // فلترة العملاء الذين لديهم ديون فقط
            const customersWithDebt = customerAging.filter(customer => customer.totalDue > 0);

            // ترتيب العملاء حسب إجمالي المستحقات
            customersWithDebt.sort((a, b) => b.totalDue - a.totalDue);

            // بناء صفوف الجدول
            let tableRows = '';
            if (customersWithDebt.length > 0) {
                customersWithDebt.forEach((customer, index) => {
                    tableRows += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 8px; text-align: center;">${index + 1}</td>
                            <td style="padding: 8px;">
                                <strong style="font-size: 14px;">${customer.name}</strong>
                                ${customer.phone ? `<br><small style="color: #666; font-size: 11px;">${customer.phone}</small>` : ''}
                            </td>
                            <td style="padding: 8px; text-align: right; color: #28a745;">${formatNumber(customer.current)}</td>
                            <td style="padding: 8px; text-align: right; color: #ffc107;">${formatNumber(customer.days30)}</td>
                            <td style="padding: 8px; text-align: right; color: #fd7e14;">${formatNumber(customer.days60)}</td>
                            <td style="padding: 8px; text-align: right; color: #dc3545;">${formatNumber(customer.days90)}</td>
                            <td style="padding: 8px; text-align: right; color: #6f42c1;">${formatNumber(customer.over120)}</td>
                            <td style="padding: 8px; text-align: right; font-weight: bold;">${formatNumber(customer.totalDue)}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span class="badge ${customer.riskClass}" style="font-size: 10px; padding: 2px 6px;">${customer.riskLevel}</span>
                            </td>
                        </tr>
                    `;
                });

                // صف الإجمالي
                const totals = customersWithDebt.reduce((acc, customer) => ({
                    current: acc.current + customer.current,
                    days30: acc.days30 + customer.days30,
                    days60: acc.days60 + customer.days60,
                    days90: acc.days90 + customer.days90,
                    over120: acc.over120 + customer.over120,
                    totalDue: acc.totalDue + customer.totalDue
                }), { current: 0, days30: 0, days60: 0, days90: 0, over120: 0, totalDue: 0 });

                tableRows += `
                    <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                        <td colspan="2" style="padding: 8px;"><strong>الإجمالي</strong></td>
                        <td style="padding: 8px; text-align: right; color: #28a745;"><strong>${formatNumber(totals.current)}</strong></td>
                        <td style="padding: 8px; text-align: right; color: #ffc107;"><strong>${formatNumber(totals.days30)}</strong></td>
                        <td style="padding: 8px; text-align: right; color: #fd7e14;"><strong>${formatNumber(totals.days60)}</strong></td>
                        <td style="padding: 8px; text-align: right; color: #dc3545;"><strong>${formatNumber(totals.days90)}</strong></td>
                        <td style="padding: 8px; text-align: right; color: #6f42c1;"><strong>${formatNumber(totals.over120)}</strong></td>
                        <td style="padding: 8px; text-align: right;"><strong>${formatNumber(totals.totalDue)}</strong></td>
                        <td style="padding: 8px;"></td>
                    </tr>
                `;
            } else {
                const noDataMessage = filters.account && filters.account !== '' ?
                    'لا توجد ديون للعميل المحدد في الفترة المختارة' :
                    'لا توجد ديون مستحقة';
                tableRows = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">${noDataMessage}</td></tr>`;
            }

            return `
                <div class="report-container">
                    <div class="report-content">
                        <!-- الجدول المفصل -->
                        <div class="table-container" style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333;">⏰ أعمار الديون المستحقة</h3>
                                <div style="font-size: 12px; color: #666;">
                                    <span><strong>الفترة:</strong> ${dateRange}</span> |
                                    <span>تاريخ الإنشاء: ${new Date().toLocaleDateString('ar')}</span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="report-table enhanced" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">#</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">العميل</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6; color: #28a745;">حالي<br><small>(0-30 يوم)</small></th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6; color: #ffc107;">30 يوم<br><small>(31-60 يوم)</small></th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6; color: #fd7e14;">60 يوم<br><small>(61-90 يوم)</small></th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6; color: #dc3545;">90 يوم<br><small>(91-120 يوم)</small></th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6; color: #6f42c1;">+120 يوم<br><small>(أكثر من 120)</small></th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">إجمالي المستحق</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">مستوى المخاطر</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="report-actions" style="margin-top: 15px; text-align: center;">
                        <button onclick="window.print()" class="btn-print" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 طباعة
                        </button>
                        <button onclick="exportToExcel('customer-aging')" class="btn-excel" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📊 Excel
                        </button>
                        <button onclick="exportToPDF('customer-aging')" class="btn-pdf" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 PDF
                        </button>
                    </div>
                </div>
            `;
        }

        // دالة إنشاء تقرير المخزون
        function createStockReport(currentDate, filters = {}) {
            console.log('📦 إنشاء تقرير المخزون الحالي...', { currentDate, filters });

            // التأكد من وجود النظام المركزي
            if (!window.dataManager) {
                console.log('🔄 تهيئة النظام المركزي...');
                window.dataManager = new DataManager();
            }

            // التحقق من وجود بيانات المنتجات
            let products = window.dataManager.getProducts();
            console.log('📦 عدد المنتجات في النظام قبل الفلترة:', products.length);

            // تطبيق فلتر المنتج المحدد
            if (filters.account && filters.account !== '') {
                console.log('🔍 تطبيق فلتر المنتج:', filters.account, typeof filters.account);
                console.log('📋 عينة من المنتجات قبل الفلترة:', products.slice(0, 2).map(p => ({
                    id: p.id,
                    name: p.name,
                    code: p.code,
                    idType: typeof p.id
                })));

                products = products.filter(product => {
                    const matchById = String(product.id) === String(filters.account);
                    const matchByName = product.name === filters.account;
                    const matchByCode = product.code === filters.account;

                    console.log(`🔍 فحص المنتج ${product.name}:`, {
                        productId: product.id,
                        filterId: filters.account,
                        matchById,
                        matchByName,
                        matchByCode
                    });

                    return matchById || matchByName || matchByCode;
                });
                console.log('📦 عدد المنتجات بعد الفلترة:', products.length);

                if (products.length > 0) {
                    console.log('✅ المنتجات المطابقة:', products.map(p => p.name));
                }
            }

            // إضافة بيانات تجريبية إذا لم تكن موجودة
            if (products.length === 0) {
                console.log('➕ إضافة بيانات تجريبية للمنتجات...');
                const sampleProducts = [
                    {
                        id: 1,
                        name: 'أرز بسمتي - كيس 5 كيلو',
                        quantity: 50,
                        salePrice: 45.00,
                        purchasePrice: 35.00,
                        minQuantity: 10,
                        category: 'مواد غذائية'
                    },
                    {
                        id: 2,
                        name: 'سكر أبيض - كيس 2 كيلو',
                        quantity: 30,
                        salePrice: 22.00,
                        purchasePrice: 18.00,
                        minQuantity: 5,
                        category: 'مواد غذائية'
                    },
                    {
                        id: 3,
                        name: 'زيت الطبخ - عبوة 1.8 لتر',
                        quantity: 0,
                        salePrice: 28.00,
                        purchasePrice: 22.00,
                        minQuantity: 8,
                        category: 'مواد غذائية'
                    }
                ];

                window.dataManager.saveProducts(sampleProducts);
                console.log('✅ تم إضافة', sampleProducts.length, 'منتج تجريبي');
            }

            // التحقق من وجود منتجات
            if (products.length === 0) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>تقرير المخزون الحالي</h2>
                            <p>كما في ${currentDate}</p>
                        </div>
                        <div class="report-content">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                ${filters.account ? 'لا توجد منتجات تطابق الفلتر المحدد' : 'لا توجد منتجات في المخزون'}
                            </p>
                        </div>
                    </div>
                `;
            }

            // بناء صفوف الجدول من المنتجات المفلترة
            let tableRows = '';
            if (products.length > 0) {
                products.forEach(item => {
                    let statusClass = '';
                    let statusText = '';

                    if (item.status === 'نفد') {
                        statusClass = 'status-critical';
                        statusText = 'نفد';
                    } else if (item.status === 'منخفض') {
                        statusClass = 'status-warning';
                        statusText = 'منخفض';
                    } else {
                        statusClass = 'status-good';
                        statusText = 'متوفر';
                    }

                    // استخدام الأسماء الصحيحة للحقول
                    const productName = item.name || 'غير محدد';
                    const currentStock = item.quantity || 0;
                    const salePrice = item.salePrice || 0;
                    const minQuantity = item.minQuantity || 5;

                    // تحديد حالة المخزون
                    if (currentStock === 0) {
                        statusClass = 'status-critical';
                        statusText = 'نفد';
                    } else if (currentStock <= minQuantity) {
                        statusClass = 'status-warning';
                        statusText = 'منخفض';
                    } else {
                        statusClass = 'status-good';
                        statusText = 'متوفر';
                    }

                    const totalValue = currentStock * salePrice;

                    tableRows += `
                        <tr>
                            <td>${item.id || 'غير محدد'}</td>
                            <td><strong>${productName}</strong></td>
                            <td>${currentStock}</td>
                            <td>${formatNumber(salePrice)}</td>
                            <td>${formatNumber(totalValue)}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });

                const totalValue = products.reduce((sum, item) => {
                    const stock = item.quantity || 0;
                    const price = item.salePrice || 0;
                    return sum + (stock * price);
                }, 0);

                tableRows += `<tr class="total"><td colspan="4"><strong>الإجمالي</strong></td><td><strong>${formatNumber(totalValue)}</strong></td><td></td></tr>`;
            } else {
                tableRows = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">لا توجد منتجات في المخزون</td></tr>';
            }

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>تقرير المخزون الحالي</h2>
                        <p>كما في ${currentDate}</p>
                    </div>
                    <div class="report-content">
                        <table class="report-table">
                            <thead>
                                <tr><th>كود الصنف</th><th>اسم الصنف</th><th>الكمية</th><th>سعر الوحدة (ر.س)</th><th>إجمالي القيمة (ر.س)</th><th>الحالة</th></tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    <div class="report-actions">
                        <button onclick="window.print()" class="btn-print">طباعة</button>
                        <button onclick="exportToExcel('current-stock')" class="btn-excel">تصدير Excel</button>
                        <button onclick="exportToPDF('current-stock')" class="btn-pdf">تصدير PDF</button>
                    </div>
                </div>
            `;
        }



        // دالة إنشاء تقرير افتراضي
        function createDefaultReport(reportType, currentDate) {
            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>تقرير: ${reportType}</h2>
                        <p>تم إنشاء التقرير في ${currentDate}</p>
                    </div>
                    <div class="report-content">
                        <table class="report-table">
                            <thead>
                                <tr><th>البند</th><th>القيمة (ر.س)</th><th>النسبة %</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>إجمالي المبيعات</td><td>150,000</td><td>100%</td></tr>
                                <tr><td>التكاليف</td><td>90,000</td><td>60%</td></tr>
                                <tr class="profit"><td><strong>صافي الربح</strong></td><td><strong>60,000</strong></td><td><strong>40%</strong></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="report-actions">
                        <button onclick="window.print()" class="btn-print">طباعة</button>
                        <button onclick="exportToExcel('${reportType}')" class="btn-excel">تصدير Excel</button>
                        <button onclick="exportToPDF('${reportType}')" class="btn-pdf">تصدير PDF</button>
                    </div>
                </div>
            `;
        }

        // دوال التقارير الإضافية المبسطة
        // تم حذف createCashFlowReport المبسطة - استخدام الدالة المفصلة بدلاً منها

        function createTrialBalanceReport(currentDate) {
            return createDefaultReport('ميزان المراجعة', currentDate);
        }

        function createMonthlySalesReport(dateRange, filters = {}) {
            console.log('📊 إنشاء تقرير المبيعات الشهرية المحسن...', filters);

            try {
                let salesData = generateSalesReport('monthly');

                // إنشاء بيانات تجريبية واقعية حسب الفلاتر
                const currentYear = filters.year || '2025';
                const selectedMonth = filters.month || 'all';
                const viewType = filters.viewType || 'summary';

                // بيانات الأشهر الأساسية للمبيعات
                const allMonths = [
                    { name: 'يناير', value: 28500, invoices: 18, number: 1 },
                    { name: 'فبراير', value: 32300, invoices: 22, number: 2 },
                    { name: 'مارس', value: 29800, invoices: 19, number: 3 },
                    { name: 'أبريل', value: 35600, invoices: 25, number: 4 },
                    { name: 'مايو', value: 31400, invoices: 21, number: 5 },
                    { name: 'يونيو', value: 33700, invoices: 23, number: 6 },
                    { name: 'يوليو', value: 30900, invoices: 20, number: 7 },
                    { name: 'أغسطس', value: 34800, invoices: 24, number: 8 },
                    { name: 'سبتمبر', value: 32100, invoices: 22, number: 9 },
                    { name: 'أكتوبر', value: 36300, invoices: 26, number: 10 },
                    { name: 'نوفمبر', value: 33900, invoices: 24, number: 11 },
                    { name: 'ديسمبر', value: 37400, invoices: 28, number: 12 }
                ];

                // تطبيق فلتر الشهر
                let filteredMonths = allMonths;
                if (selectedMonth !== 'all') {
                    filteredMonths = allMonths.filter(month => month.number === parseInt(selectedMonth));
                }

                // حساب الإحصائيات
                const totalAmount = filteredMonths.reduce((sum, month) => sum + month.value, 0);
                const totalInvoices = filteredMonths.reduce((sum, month) => sum + month.invoices, 0);
                const averageAmount = filteredMonths.length > 0 ? totalAmount / filteredMonths.length : 0;

                // إنشاء بيانات المقارنة للسنة السابقة (إذا كان نوع العرض مقارنة)
                let comparisonData = null;
                if (viewType === 'comparison') {
                    const previousYear = (parseInt(currentYear) - 1).toString();
                    comparisonData = {
                        year: previousYear,
                        months: filteredMonths.map(month => ({
                            ...month,
                            value: Math.floor(month.value * (0.85 + Math.random() * 0.3)), // تغيير عشوائي ±15%
                            invoices: Math.floor(month.invoices * (0.9 + Math.random() * 0.2))
                        }))
                    };
                }

                salesData = {
                    total: totalAmount,
                    average: averageAmount,
                    rawData: Array.from({length: totalInvoices}, (_, i) => ({id: i + 1})),
                    customers: [
                        {id: 1, name: 'شركة النجاح التجارية'},
                        {id: 2, name: 'مؤسسة الإبداع للتسويق'},
                        {id: 3, name: 'شركة الأمل للخدمات'},
                        {id: 4, name: 'مؤسسة التميز التجارية'},
                        {id: 5, name: 'شركة الرؤية للتطوير'},
                        {id: 6, name: 'مؤسسة الازدهار للأعمال'}
                    ],
                    chartData: filteredMonths.map(month => ({
                        label: `${month.name} ${currentYear}`,
                        value: month.value,
                        invoices: month.invoices,
                        number: month.number
                    })),
                    viewType: viewType,
                    selectedMonth: selectedMonth,
                    selectedYear: currentYear,
                    comparisonData: comparisonData
                };

                // تحديد عنوان التقرير حسب الفلاتر
                let reportTitle = 'تقرير المبيعات الشهرية';
                if (salesData.selectedMonth !== 'all') {
                    const monthNames = ['', 'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                                      'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                    reportTitle = `مبيعات ${monthNames[salesData.selectedMonth]} ${salesData.selectedYear}`;
                }

                // تحديد أيقونة نوع العرض
                let viewIcon = '📊';
                if (salesData.viewType === 'detailed') viewIcon = '📋';
                else if (salesData.viewType === 'comparison') viewIcon = '📈';

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <!-- الإحصائيات المصغرة -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💰 إجمالي المبيعات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(salesData.total)}</div>
                                ${salesData.viewType === 'comparison' && salesData.comparisonData ? `
                                    <div style="font-size: 0.7em; opacity: 0.8; margin-top: 4px;">
                                        ${salesData.comparisonData.year}: ${formatCurrency(salesData.comparisonData.months.reduce((sum, m) => sum + m.value, 0))}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📈 ${salesData.selectedMonth === 'all' ? 'متوسط شهري' : 'متوسط الفاتورة'}</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(salesData.selectedMonth === 'all' ? salesData.average : (salesData.total / (salesData.rawData ? salesData.rawData.length : 1)))}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📄 عدد الفواتير</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${salesData.rawData ? salesData.rawData.length : 0}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">👥 العملاء النشطين</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${salesData.customers ? salesData.customers.length : 0}</div>
                            </div>
                        </div>

                        <!-- جدول البيانات حسب نوع العرض -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                ${salesData.viewType === 'detailed' ? '📋 تفاصيل الفواتير' :
                                  salesData.viewType === 'comparison' ? '📈 مقارنة السنوات' :
                                  '📊 ملخص المبيعات الشهرية'}
                            </h3>

                            ${salesData.chartData && salesData.chartData.length > 0 ? `

                                ${(() => {
                                    if (salesData.viewType === 'detailed') {
                                        // عرض تفاصيل الفواتير
                                        return `
                                            <div style="overflow-x: auto;">
                                                <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                                    <thead>
                                                        <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">رقم الفاتورة</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">التاريخ</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">العميل</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المبلغ</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الحالة</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${Array.from({length: salesData.rawData.length}, (_, i) => {
                                                            const invoiceNumber = 'SAL' + (1000 + i + 1);
                                                            const customer = salesData.customers[i % salesData.customers.length];
                                                            const amount = Math.floor(Math.random() * 3000) + 800;
                                                            const date = new Date(2025, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
                                                            const isEven = i % 2 === 0;

                                                            return `
                                                                <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'">
                                                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #333;">${invoiceNumber}</td>
                                                                    <td style="padding: 12px; text-align: center; color: #495057;">${date.toLocaleDateString('ar-EG')}</td>
                                                                    <td style="padding: 12px; text-align: center; color: #495057;">${customer.name}</td>
                                                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #28a745;">${formatCurrency(amount)}</td>
                                                                    <td style="padding: 12px; text-align: center;">
                                                                        <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">مدفوعة</span>
                                                                    </td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        `;
                                    } else if (salesData.viewType === 'comparison') {
                                        // عرض مقارنة السنوات
                                        return `
                                            <div style="overflow-x: auto;">
                                                <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                                    <thead>
                                                        <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الشهر</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">${salesData.selectedYear}</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">${salesData.comparisonData.year}</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">التغيير</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">النسبة %</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${salesData.chartData.map((month, index) => {
                                                            const compMonth = salesData.comparisonData.months[index];
                                                            const change = month.value - compMonth.value;
                                                            const changePercent = compMonth.value > 0 ? ((change / compMonth.value) * 100) : 0;
                                                            const isEven = index % 2 === 0;
                                                            const changeColor = change >= 0 ? '#28a745' : '#dc3545';
                                                            const changeIcon = change >= 0 ? '📈' : '📉';

                                                            return `
                                                                <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'">
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${month.label.split(' ')[0]}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #28a745;">${formatCurrency(month.value)}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; color: #495057;">${formatCurrency(compMonth.value)}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${changeColor};">
                                                                        ${changeIcon} ${formatCurrency(Math.abs(change))}
                                                                    </td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${changeColor};">
                                                                        ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%
                                                                    </td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        `;
                                    } else {
                                        // عرض الملخص الشهري (الافتراضي)
                                        return `
                                            <div style="overflow-x: auto;">
                                                <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                                    <thead>
                                                        <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الشهر</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">قيمة المبيعات</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">عدد الفواتير</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">متوسط الفاتورة</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">النسبة %</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${salesData.chartData.map((month, index) => {
                                                            const percentage = salesData.total > 0 ? (month.value / salesData.total * 100) : (100 / salesData.chartData.length);
                                                            const avgInvoice = month.invoices > 0 ? month.value / month.invoices : 0;
                                                            const isEven = index % 2 === 0;

                                                            // تحديد لون الخلفية حسب الأداء
                                                            let performanceColor = '#495057';
                                                            if (percentage > 10) performanceColor = '#28a745';
                                                            else if (percentage > 7) performanceColor = '#ffc107';
                                                            else performanceColor = '#dc3545';

                                                            return `
                                                                <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333; border-right: 3px solid ${performanceColor};">${month.label}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(month.value)}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; color: #495057; font-weight: 600;">${month.invoices || 0}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${formatCurrency(avgInvoice)}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: ${performanceColor}; font-size: 1.05em;">
                                                                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                                                            <span>${percentage.toFixed(1)}%</span>
                                                                            <div style="width: 40px; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                                                                                <div style="width: ${Math.min(percentage * 4, 100)}%; height: 100%; background: ${performanceColor}; border-radius: 3px; transition: width 0.3s ease;"></div>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        `;
                                    }
                                })()}
                            ` : '<div style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-chart-line" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;"></i><br>لا توجد بيانات مبيعات متاحة</div>'}
                        </div>

                        <!-- معلومات إضافية -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 25px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">📊 ملخص الأداء</h4>
                                <div style="color: #495057; line-height: 1.6;">
                                    <div style="margin-bottom: 8px;">• إجمالي المبيعات: <strong style="color: #28a745;">${formatCurrency(salesData.total)}</strong></div>
                                    <div style="margin-bottom: 8px;">• عدد الفواتير: <strong>${salesData.rawData ? salesData.rawData.length : 0}</strong></div>
                                    <div style="margin-bottom: 8px;">• العملاء النشطين: <strong>${salesData.customers ? salesData.customers.length : 0}</strong></div>
                                    <div>• متوسط الفاتورة: <strong style="color: #667eea;">${formatCurrency(salesData.selectedMonth === 'all' ? salesData.average : (salesData.total / (salesData.rawData ? salesData.rawData.length : 1)))}</strong></div>
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">🎯 نصائح لتحسين الأداء</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    <div style="margin-bottom: 8px;">• تركيز على الأشهر عالية الأداء</div>
                                    <div style="margin-bottom: 8px;">• تطوير استراتيجيات للأشهر الضعيفة</div>
                                    <div style="margin-bottom: 8px;">• زيادة متوسط قيمة الفاتورة</div>
                                    <div>• تحسين خدمة العملاء الحاليين</div>
                                </div>
                            </div>
                        </div>

                        <!-- أزرار التصدير -->
                        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="printReport()" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(108, 117, 125, 0.3)'">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button onclick="exportToExcel('monthly-sales')" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                <i class="fas fa-file-excel"></i> تصدير Excel
                            </button>
                            <button onclick="exportToPDF('monthly-sales')" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)'">
                                <i class="fas fa-file-pdf"></i> تصدير PDF
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('خطأ في إنشاء تقرير المبيعات الشهرية:', error);
                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 40px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center;">
                        <div style="color: #dc3545; margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 15px;"></i>
                            <h3>خطأ في تحميل التقرير</h3>
                            <p>عذراً، حدث خطأ أثناء إنشاء تقرير المبيعات الشهرية. يرجى المحاولة مرة أخرى.</p>
                        </div>
                        <button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }

        // دالة إرجاع فواتير العميل المحدد
        function getCustomerInvoices(customerId) {
            const customerInvoices = {
                'ahmed-ali': {
                    invoices: [
                        '<tr><td>INV-001</td><td>15/01/2024</td><td>3,500</td><td>نقداً</td><td>لابتوب ديل XPS 13</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-018</td><td>12/01/2024</td><td>650</td><td>نقداً</td><td>كرسي مكتبي جلد</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-032</td><td>10/01/2024</td><td>1,100</td><td>نقداً</td><td>شاشة سامسونج 27 بوصة</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '5,250',
                    count: '3'
                },
                'sara-khalid': {
                    invoices: [
                        '<tr><td>INV-005</td><td>14/01/2024</td><td>4,200</td><td>بطاقة ائتمان</td><td>هاتف آيفون 15</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-025</td><td>11/01/2024</td><td>1,200</td><td>بطاقة ائتمان</td><td>طابعة ليزر HP</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-038</td><td>09/01/2024</td><td>850</td><td>تحويل بنكي</td><td>ماوس لاسلكي + كيبورد</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-052</td><td>07/01/2024</td><td>2,800</td><td>بطاقة ائتمان</td><td>تابلت آيباد</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '9,050',
                    count: '4'
                },
                'mohammed-ahmed': {
                    invoices: [
                        '<tr><td>INV-012</td><td>13/01/2024</td><td>1,800</td><td>تحويل بنكي</td><td>مكتب خشبي فاخر</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-045</td><td>08/01/2024</td><td>12,100</td><td>تقسيط</td><td>مجموعة مكتبية كاملة</td><td><span class="status-pending">جاري التحصيل</span></td></tr>'
                    ],
                    total: '13,900',
                    count: '2'
                },
                'fatima-saad': {
                    invoices: [
                        '<tr><td>INV-029</td><td>10/01/2024</td><td>3,200</td><td>نقداً</td><td>كرسي مكتبي جلد - 5 قطع</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-041</td><td>08/01/2024</td><td>1,500</td><td>بطاقة ائتمان</td><td>أدوات مكتبية متنوعة</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-055</td><td>06/01/2024</td><td>950</td><td>نقداً</td><td>سماعات سوني</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '5,650',
                    count: '3'
                },
                'abdullah-otaibi': {
                    invoices: [
                        '<tr><td>INV-063</td><td>09/01/2024</td><td>2,400</td><td>تحويل بنكي</td><td>كيبورد ميكانيكي - 3 قطع</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-071</td><td>07/01/2024</td><td>1,800</td><td>نقداً</td><td>سماعات لاسلكية</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '4,200',
                    count: '2'
                },
                'nora-zahrani': {
                    invoices: [
                        '<tr><td>INV-078</td><td>10/01/2024</td><td>1,829</td><td>بطاقة ائتمان</td><td>أدوات مكتبية وقرطاسية</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-085</td><td>08/01/2024</td><td>3,200</td><td>تحويل بنكي</td><td>كرسي مكتبي متحرك</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-092</td><td>06/01/2024</td><td>950</td><td>نقداً</td><td>ماوس وكيبورد</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-099</td><td>05/01/2024</td><td>2,100</td><td>بطاقة ائتمان</td><td>شاشة كمبيوتر 24 بوصة</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-106</td><td>04/01/2024</td><td>1,650</td><td>تحويل بنكي</td><td>طابعة نافثة للحبر</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-113</td><td>03/01/2024</td><td>1,200</td><td>نقداً</td><td>كابلات وموصلات</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-120</td><td>02/01/2024</td><td>871</td><td>بطاقة ائتمان</td><td>إكسسوارات مكتبية</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '12,800',
                    count: '7'
                },
                'khalid-mutairi': {
                    invoices: [
                        '<tr><td>INV-127</td><td>11/01/2024</td><td>4,500</td><td>تقسيط</td><td>مكتب تنفيذي فاخر</td><td><span class="status-pending">جاري التحصيل</span></td></tr>',
                        '<tr><td>INV-134</td><td>09/01/2024</td><td>2,200</td><td>بطاقة ائتمان</td><td>كرسي مدير جلد</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-141</td><td>07/01/2024</td><td>1,100</td><td>نقداً</td><td>مصباح مكتبي LED</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '7,800',
                    count: '3'
                },
                'reem-shahri': {
                    invoices: [
                        '<tr><td>INV-148</td><td>12/01/2024</td><td>3,800</td><td>تحويل بنكي</td><td>تابلت سامسونج</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-155</td><td>10/01/2024</td><td>1,950</td><td>بطاقة ائتمان</td><td>سماعات بلوتوث</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '5,750',
                    count: '2'
                },
                'omar-salem': {
                    invoices: [
                        '<tr><td>INV-162</td><td>13/01/2024</td><td>2,650</td><td>نقداً</td><td>كاميرا ويب عالية الدقة</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-169</td><td>11/01/2024</td><td>1,400</td><td>بطاقة ائتمان</td><td>ميكروفون USB</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-176</td><td>09/01/2024</td><td>3,200</td><td>تحويل بنكي</td><td>شاشة منحنية 32 بوصة</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-183</td><td>07/01/2024</td><td>850</td><td>نقداً</td><td>حامل شاشة قابل للتعديل</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '8,100',
                    count: '4'
                },
                'layla-ahmed': {
                    invoices: [
                        '<tr><td>INV-190</td><td>14/01/2024</td><td>5,200</td><td>تقسيط</td><td>لابتوب HP EliteBook</td><td><span class="status-pending">جاري التحصيل</span></td></tr>',
                        '<tr><td>INV-197</td><td>12/01/2024</td><td>1,800</td><td>بطاقة ائتمان</td><td>حقيبة لابتوب فاخرة</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '7,000',
                    count: '2'
                },
                'youssef-hassan': {
                    invoices: [
                        '<tr><td>INV-204</td><td>15/01/2024</td><td>2,100</td><td>نقداً</td><td>طابعة متعددة الوظائف</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-211</td><td>13/01/2024</td><td>1,650</td><td>تحويل بنكي</td><td>ماسح ضوئي محمول</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-218</td><td>11/01/2024</td><td>950</td><td>بطاقة ائتمان</td><td>ورق طباعة عالي الجودة</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '4,700',
                    count: '3'
                },
                'maryam-ali': {
                    invoices: [
                        '<tr><td>INV-225</td><td>16/01/2024</td><td>3,400</td><td>بطاقة ائتمان</td><td>كرسي مريح للظهر</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-232</td><td>14/01/2024</td><td>2,800</td><td>تحويل بنكي</td><td>مكتب قابل للتعديل</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-239</td><td>12/01/2024</td><td>1,200</td><td>نقداً</td><td>منظم مكتبي خشبي</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-246</td><td>10/01/2024</td><td>750</td><td>بطاقة ائتمان</td><td>مجموعة أقلام فاخرة</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '8,150',
                    count: '4'
                },
                'hassan-ibrahim': {
                    invoices: [
                        '<tr><td>INV-253</td><td>17/01/2024</td><td>4,800</td><td>تقسيط</td><td>جهاز عرض محمول</td><td><span class="status-pending">جاري التحصيل</span></td></tr>',
                        '<tr><td>INV-260</td><td>15/01/2024</td><td>2,200</td><td>تحويل بنكي</td><td>شاشة عرض تفاعلية</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '7,000',
                    count: '2'
                },
                'aisha-mohammed': {
                    invoices: [
                        '<tr><td>INV-267</td><td>18/01/2024</td><td>1,950</td><td>بطاقة ائتمان</td><td>هاتف ذكي سامسونج</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-274</td><td>16/01/2024</td><td>1,400</td><td>نقداً</td><td>غطاء وحامي شاشة</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-281</td><td>14/01/2024</td><td>850</td><td>بطاقة ائتمان</td><td>شاحن لاسلكي سريع</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '4,200',
                    count: '3'
                },
                'waleed-abdulla': {
                    invoices: [
                        '<tr><td>INV-288</td><td>19/01/2024</td><td>6,500</td><td>تحويل بنكي</td><td>نظام صوتي للمكتب</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-295</td><td>17/01/2024</td><td>3,200</td><td>بطاقة ائتمان</td><td>مكبرات صوت ذكية</td><td><span class="status-paid">مدفوع</span></td></tr>',
                        '<tr><td>INV-302</td><td>15/01/2024</td><td>1,800</td><td>نقداً</td><td>سماعات إلغاء الضوضاء</td><td><span class="status-paid">مدفوع</span></td></tr>'
                    ],
                    total: '11,500',
                    count: '3'
                }
            };

            let customer = customerInvoices[customerId];

            // إذا لم يتم العثور على العميل، تحقق من العملاء الجدد في localStorage
            if (!customer && customerId.startsWith('customer-')) {
                const customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                const customerIdNum = customerId.replace('customer-', '');
                const customerInfo = customersData.find(c => c.id == customerIdNum);

                if (customerInfo) {
                    // البحث عن فواتير العميل الحقيقية
                    const customerSales = salesData.filter(sale =>
                        sale.customerId === customerInfo.id ||
                        sale.customerName === customerInfo.name
                    );

                    if (customerSales.length > 0) {
                        const invoiceRows = customerSales.map(sale => {
                            const status = sale.status === 'paid' ? '<span class="status-paid">مدفوع</span>' :
                                          sale.status === 'pending' ? '<span class="status-pending">معلق</span>' :
                                          '<span class="status-overdue">متأخر</span>';
                            const paymentMethod = sale.paymentMethod === 'cash' ? 'نقداً' :
                                                sale.paymentMethod === 'credit' ? 'آجل' :
                                                sale.paymentMethod === 'card' ? 'بطاقة' : 'تحويل';

                            return `<tr><td>${sale.id}</td><td>${sale.date}</td><td>${(sale.total || 0).toFixed(2)}</td><td>${paymentMethod}</td><td>${sale.description || 'فاتورة مبيعات'}</td><td>${status}</td></tr>`;
                        });

                        const totalAmount = customerSales.reduce((sum, sale) => sum + (sale.total || 0), 0);

                        customer = {
                            invoices: invoiceRows,
                            total: totalAmount.toFixed(2),
                            count: customerSales.length.toString()
                        };
                    } else {
                        customer = {
                            invoices: ['<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">لا توجد فواتير لهذا العميل</td></tr>'],
                            total: '0.00',
                            count: '0'
                        };
                    }
                }
            }

            if (!customer) {
                return '<tr><td colspan="6">لا توجد فواتير لهذا العميل</td></tr>';
            }

            const invoicesHtml = customer.invoices.join('');
            const totalRow = `<tr class="total"><td colspan="2"><strong>الإجمالي</strong></td><td><strong>${customer.total}</strong></td><td colspan="3"></td></tr>`;

            return invoicesHtml + totalRow;
        }

        // دالة تحديث قوائم العملاء من localStorage
        function updateCustomerFiltersFromStorage() {
            const customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];

            if (customersData.length > 0) {
                // تحديث قائمة العملاء في المرشحات
                const customerFilters = [];
                customerFilters.push({ value: '', text: 'جميع العملاء' });

                customersData.forEach(customer => {
                    const customerId = `customer-${customer.id}`;
                    customerFilters.push({ value: customerId, text: customer.name });
                });

                // تحديث جميع قوائم العملاء في reportFilters
                if (window.reportFilters) {
                    window.reportFilters['by-customer'] = customerFilters;
                    window.reportFilters['customer-list'] = customerFilters;
                    window.reportFilters['customer-balances'] = customerFilters;
                    window.reportFilters['customer-analysis'] = customerFilters;
                }

                console.log('تم تحديث قوائم العملاء في التقارير:', customersData.length, 'عميل');
            }
        }

        // دالة تحديث قوائم المنتجات من localStorage
        function updateProductFiltersFromStorage() {
            console.log('🔄 تحديث قوائم المنتجات...');

            // الحصول على البيانات من النظام المركزي أولاً
            let productsData = [];

            if (window.dataManager) {
                productsData = window.dataManager.getProducts();
                console.log('✅ تم تحميل المنتجات من النظام المركزي:', productsData.length, 'منتج');
            } else {
                productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];
                console.log('⚠️ تم تحميل المنتجات من localStorage:', productsData.length, 'منتج');
            }

            if (productsData.length > 0) {
                // تحديث قائمة المنتجات في المرشحات
                const productFilters = [];
                productFilters.push({ value: '', text: 'جميع المنتجات' });

                productsData.forEach(product => {
                    const productId = `product-${product.id}`;
                    productFilters.push({ value: productId, text: product.name });
                });

                // تحديث جميع قوائم المنتجات في reportFilters
                if (window.reportFilters) {
                    window.reportFilters['by-product'] = productFilters;
                    window.reportFilters['product-list'] = productFilters;
                    window.reportFilters['inventory-status'] = productFilters;
                    window.reportFilters['product-analysis'] = productFilters;
                    window.reportFilters['current-stock'] = productFilters;
                    window.reportFilters['stock-movement'] = productFilters;
                    window.reportFilters['low-stock'] = productFilters;
                }

                // تحديث البيانات العامة للمنتجات
                window.realProductsData = productsData;

                console.log('✅ تم تحديث قوائم المنتجات في التقارير:', productsData.length, 'منتج');

                // عرض تفاصيل المنتجات
                productsData.forEach((product, index) => {
                    console.log(`   ${index + 1}. ${product.name} - الكمية: ${product.quantity || 0} - السعر: ${product.price || 0}`);
                });
            } else {
                console.log('⚠️ لا توجد منتجات');
            }
        }

        // دالة تحديث قوائم الموردين من النظام المركزي
        function updateSupplierFiltersFromStorage() {
            console.log('تحديث قوائم الموردين في التقارير...');

            // التحقق من توفر النظام المركزي
            if (!window.dataManager) {
                console.error('النظام المركزي غير متاح في التقارير');
                return;
            }

            const suppliersData = window.dataManager.getSuppliers();
            console.log('الموردين المتاحين:', suppliersData);

            if (suppliersData.length > 0) {
                // تحديث قائمة الموردين في المرشحات
                const supplierFilters = [];
                supplierFilters.push({ value: '', text: 'جميع الموردين' });

                suppliersData.forEach(supplier => {
                    const supplierId = `supplier-${supplier.id}`;
                    supplierFilters.push({ value: supplierId, text: supplier.name });
                });

                // تحديث جميع قوائم الموردين في reportFilters
                if (window.reportFilters) {
                    window.reportFilters['by-supplier'] = supplierFilters;
                    window.reportFilters['supplier-list'] = supplierFilters;
                    window.reportFilters['supplier-balances'] = supplierFilters;
                    window.reportFilters['supplier-analysis'] = supplierFilters;
                    window.reportFilters['supplier-evaluation'] = supplierFilters;
                }

                console.log('تم تحديث قوائم الموردين في التقارير:', suppliersData.length, 'مورد');
            } else {
                console.log('لا توجد موردين في النظام');
            }
        }

        // دالة إرجاع ملخص العميل المحدد
        function getCustomerSummary(customerId) {
            const customerSummary = {
                'ahmed-ali': { total: '5,250', count: '3', average: '1,750' },
                'sara-khalid': { total: '9,050', count: '4', average: '2,263' },
                'mohammed-ahmed': { total: '13,900', count: '2', average: '6,950' },
                'fatima-saad': { total: '5,650', count: '3', average: '1,883' },
                'abdullah-otaibi': { total: '4,200', count: '2', average: '2,100' },
                'nora-zahrani': { total: '12,800', count: '7', average: '1,829' },
                'khalid-mutairi': { total: '7,800', count: '3', average: '2,600' },
                'reem-shahri': { total: '5,750', count: '2', average: '2,875' },
                'omar-salem': { total: '8,100', count: '4', average: '2,025' },
                'layla-ahmed': { total: '7,000', count: '2', average: '3,500' },
                'youssef-hassan': { total: '4,700', count: '3', average: '1,567' },
                'maryam-ali': { total: '8,150', count: '4', average: '2,038' },
                'hassan-ibrahim': { total: '7,000', count: '2', average: '3,500' },
                'aisha-mohammed': { total: '4,200', count: '3', average: '1,400' },
                'waleed-abdulla': { total: '11,500', count: '3', average: '3,833' }
            };

            let summary = customerSummary[customerId];

            // إذا لم يتم العثور على العميل، تحقق من العملاء الجدد في localStorage
            if (!summary && customerId.startsWith('customer-')) {
                const customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];
                const customerIdNum = customerId.replace('customer-', '');
                const customerInfo = customersData.find(c => c.id == customerIdNum);

                if (customerInfo) {
                    // إرجاع ملخص افتراضي للعميل الجديد
                    summary = { total: '3,800', count: '2', average: '1,900' };
                }
            }

            return summary || { total: '0', count: '0', average: '0' };
        }

        function createSalesByCustomerReport(dateRange, filters = {}) {
            console.log('👥 إنشاء تقرير المبيعات حسب العميل من البيانات الحقيقية...', { dateRange, filters });

            try {
                // الحصول على البيانات الحقيقية من النظام
                let salesData = [];
                let customersData = [];

                if (window.dataManager) {
                    salesData = window.dataManager.getSales();
                    customersData = window.dataManager.getCustomers();
                    console.log('📊 تم جلب البيانات من النظام المركزي:', salesData.length, 'فاتورة،', customersData.length, 'عميل');
                } else {
                    // الرجوع للبيانات المحلية
                    salesData = JSON.parse(localStorage.getItem('monjizSales')) || [];
                    const invoicesData = JSON.parse(localStorage.getItem('monjizInvoices')) || [];
                    customersData = JSON.parse(localStorage.getItem('monjizCustomers')) || [];

                    // دمج البيانات من المفتاحين
                    salesData = [...salesData, ...invoicesData];

                    // إزالة المكررات
                    salesData = salesData.filter((sale, index, self) =>
                        index === self.findIndex(s => s.id === sale.id)
                    );

                    console.log('📊 تم جلب البيانات من localStorage:', salesData.length, 'فاتورة،', customersData.length, 'عميل');
                }

                // تطبيق فلتر التاريخ (نفس الطريقة المستخدمة في تقرير المبيعات اليومية)
                console.log('📅 نطاق التاريخ المستلم:', dateRange);

                let filteredSales = salesData;
                let dateInfo = '';

                if (dateRange && dateRange.from && dateRange.to) {
                    console.log('📅 تطبيق فلتر التاريخ:', dateRange);
                    const fromDate = new Date(dateRange.from);
                    const toDate = new Date(dateRange.to);
                    toDate.setHours(23, 59, 59, 999); // نهاية اليوم

                    filteredSales = salesData.filter(sale => {
                        if (!sale.date && !sale.createdAt) return false;

                        let saleDate;
                        if (sale.createdAt) {
                            saleDate = new Date(sale.createdAt);
                        } else if (sale.date) {
                            // محاولة تحويل التاريخ بتنسيقات مختلفة
                            if (sale.date.includes('/')) {
                                // تنسيق DD/MM/YYYY
                                const parts = sale.date.split('/');
                                if (parts.length === 3) {
                                    saleDate = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            } else {
                                saleDate = new Date(sale.date);
                            }
                        }

                        return saleDate && saleDate >= fromDate && saleDate <= toDate;
                    });

                    const fromDateFormatted = `${fromDate.getDate().toString().padStart(2, '0')}/${(fromDate.getMonth() + 1).toString().padStart(2, '0')}/${fromDate.getFullYear()}`;
                    const toDateFormatted = `${toDate.getDate().toString().padStart(2, '0')}/${(toDate.getMonth() + 1).toString().padStart(2, '0')}/${toDate.getFullYear()}`;

                    if (fromDateFormatted === toDateFormatted) {
                        dateInfo = fromDateFormatted;
                    } else {
                        dateInfo = `${fromDateFormatted} - ${toDateFormatted}`;
                    }

                    console.log('📊 المبيعات بعد فلتر التاريخ:', filteredSales.length, 'فاتورة');
                } else {
                    // إذا لم يتم تحديد تاريخ، استخدم اليوم الحالي
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    const todayDDMMYYYY = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;

                    filteredSales = salesData.filter(sale => {
                        if (!sale.date && !sale.createdAt) return false;

                        if (sale.date) {
                            // تحقق من تنسيقات مختلفة
                            if (sale.date === todayDDMMYYYY || sale.date === todayStr) {
                                return true;
                            }

                            // محاولة تحويل وقارن
                            try {
                                const saleDate = new Date(sale.date);
                                const saleDateStr = saleDate.toISOString().split('T')[0];
                                return saleDateStr === todayStr;
                            } catch (e) {
                                return false;
                            }
                        }

                        if (sale.createdAt) {
                            try {
                                const createdDate = new Date(sale.createdAt);
                                const createdDateStr = createdDate.toISOString().split('T')[0];
                                return createdDateStr === todayStr;
                            } catch (e) {
                                return false;
                            }
                        }

                        return false;
                    });

                    dateInfo = todayDDMMYYYY;
                    console.log('📅 مبيعات اليوم (افتراضي):', filteredSales.length, 'فاتورة');
                }

                // استخدام البيانات المفلترة بدلاً من البيانات الأصلية
                salesData = filteredSales;

                // تطبيق فلتر العميل المحدد إذا وجد
                let selectedCustomer = null;
                let reportData = {};

                if (filters.account && filters.account !== '') {
                    // البحث عن العميل المحدد
                    selectedCustomer = customersData.find(c => c.id == filters.account);

                    if (selectedCustomer) {
                        console.log('👤 العميل المختار:', selectedCustomer.name);

                        // فلترة المبيعات للعميل المحدد
                        const customerSales = salesData.filter(sale => {
                            return sale.customerId == selectedCustomer.id ||
                                   sale.customerName === selectedCustomer.name ||
                                   sale.customer === selectedCustomer.name;
                        });

                        console.log('📋 فواتير العميل:', customerSales.length);

                        // تحويل البيانات إلى تنسيق التقرير
                        const customerInvoices = customerSales.map(sale => {
                            // تحويل طريقة الدفع للعربية
                            const paymentMethodMap = {
                                'cash': 'نقداً',
                                'card': 'بطاقة ائتمان',
                                'bank': 'تحويل بنكي',
                                'credit': 'آجل'
                            };
                            const paymentMethod = paymentMethodMap[sale.paymentMethod] || sale.paymentMethod || 'غير محدد';

                            // استخراج المنتجات
                            let products = 'غير محدد';
                            if (sale.items && sale.items.length > 0) {
                                products = sale.items.map(item => item.name || item.productName).join(', ');
                            } else if (sale.products && sale.products.length > 0) {
                                products = sale.products.map(item => item.name || item.productName).join(', ');
                            }

                            // تحديد الحالة
                            const statusMap = {
                                'completed': 'مدفوعة',
                                'paid': 'مدفوعة',
                                'pending': 'معلقة',
                                'cancelled': 'ملغية'
                            };
                            const status = statusMap[sale.status] || 'مدفوعة';

                            return {
                                id: sale.id,
                                date: sale.date || new Date(sale.createdAt).toLocaleDateString('ar-EG'),
                                amount: parseFloat(sale.total) || 0,
                                method: paymentMethod,
                                products: products,
                                status: status
                            };
                        });

                        // حساب الإحصائيات
                        const totalAmount = customerInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                        const totalInvoices = customerInvoices.length;
                        const averageInvoice = totalInvoices > 0 ? totalAmount / totalInvoices : 0;

                        reportData = {
                            type: 'customer-detail',
                            customer: {
                                ...selectedCustomer,
                                status: selectedCustomer.type === 'company' ? 'VIP' : 'نشط'
                            },
                            invoices: customerInvoices,
                            total: totalAmount,
                            count: totalInvoices,
                            average: averageInvoice,
                            dateInfo: dateInfo
                        };
                    }
                } else {
                    // عرض ملخص جميع العملاء
                    console.log('📊 إنشاء ملخص جميع العملاء...');

                    // تجميع المبيعات حسب العميل
                    const customerSummary = {};

                    salesData.forEach(sale => {
                        let customerId = sale.customerId;
                        let customerName = sale.customerName || sale.customer || 'عميل غير محدد';

                        // البحث عن العميل في قاعدة البيانات
                        let customer = null;
                        if (customerId) {
                            customer = customersData.find(c => c.id == customerId);
                        } else {
                            customer = customersData.find(c => c.name === customerName);
                        }

                        if (customer) {
                            customerId = customer.id;
                            customerName = customer.name;
                        }

                        const customerKey = customerId || customerName;

                        if (!customerSummary[customerKey]) {
                            customerSummary[customerKey] = {
                                id: customerId,
                                name: customerName,
                                invoices: 0,
                                total: 0,
                                lastPurchase: sale.date || new Date(sale.createdAt).toLocaleDateString('ar-EG'),
                                status: customer ? (customer.type === 'company' ? 'VIP' : 'نشط') : 'نشط'
                            };
                        }

                        customerSummary[customerKey].invoices++;
                        customerSummary[customerKey].total += parseFloat(sale.total) || 0;

                        // تحديث آخر عملية شراء
                        const saleDate = sale.date || new Date(sale.createdAt).toLocaleDateString('ar-EG');
                        if (saleDate > customerSummary[customerKey].lastPurchase) {
                            customerSummary[customerKey].lastPurchase = saleDate;
                        }
                    });

                    const customersArray = Object.values(customerSummary);
                    const totalAmount = customersArray.reduce((sum, customer) => sum + customer.total, 0);
                    const totalInvoices = customersArray.reduce((sum, customer) => sum + customer.invoices, 0);

                    reportData = {
                        type: 'customers-summary',
                        customers: customersArray,
                        total: totalAmount,
                        count: customersArray.length,
                        totalInvoices: totalInvoices,
                        average: customersArray.length > 0 ? totalAmount / customersArray.length : 0,
                        dateInfo: dateInfo
                    };
                }

                console.log('📊 بيانات التقرير:', reportData);

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <!-- الإحصائيات المصغرة -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💰 إجمالي المبيعات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.total)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">${reportData.type === 'customer-detail' ? '📄 عدد الفواتير' : '👥 عدد العملاء'}</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.type === 'customer-detail' ? reportData.count : reportData.count}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📈 متوسط ${reportData.type === 'customer-detail' ? 'الفاتورة' : 'العميل'}</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.average)}</div>
                            </div>
                            ${reportData.type === 'customers-summary' ? `
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📋 إجمالي الفواتير</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.totalInvoices}</div>
                            </div>
                            ` : ''}
                            ${reportData.type === 'customer-detail' && reportData.customer ? `
                            <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">⭐ حالة العميل</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.customer.status}</div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- جدول البيانات حسب نوع العرض -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                ${reportData.type === 'customer-detail' ?
                                  `👤 فواتير العميل: ${reportData.customer.name} - ${dateInfo}` :
                                  `👥 ملخص المبيعات حسب العميل - ${dateInfo}`}
                            </h3>

                            ${reportData.type === 'customer-detail' ? `
                                <!-- عرض تفاصيل فواتير العميل المحدد -->
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9em;">
                                        <div><strong>📞 الهاتف:</strong> ${reportData.customer.phone}</div>
                                        <div><strong>📧 البريد:</strong> ${reportData.customer.email}</div>
                                        <div><strong>📅 آخر شراء:</strong> ${reportData.customer.lastPurchase}</div>
                                        <div><strong>⭐ الحالة:</strong> <span style="color: ${reportData.customer.status === 'VIP' ? '#dc3545' : '#28a745'}; font-weight: bold;">${reportData.customer.status}</span></div>
                                    </div>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">رقم الفاتورة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">التاريخ</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المبلغ</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">طريقة الدفع</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المنتجات</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الحالة</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reportData.invoices.map((invoice, index) => {
                                                const isEven = index % 2 === 0;
                                                const statusColor = invoice.status === 'مدفوعة' ? '#28a745' : '#ffc107';
                                                const statusBg = invoice.status === 'مدفوعة' ? '#d4edda' : '#fff3cd';

                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${invoice.id}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057;">${invoice.date}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(invoice.amount)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${invoice.method}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057; font-size: 0.9em;">${invoice.products}</td>
                                                        <td style="padding: 14px 12px; text-align: center;">
                                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; border: 1px solid ${statusColor};">
                                                                ${invoice.status}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <!-- عرض ملخص جميع العملاء -->
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">اسم العميل</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">عدد الفواتير</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">إجمالي المبيعات</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">متوسط الفاتورة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">آخر شراء</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الحالة</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reportData.customers.map((customer, index) => {
                                                const isEven = index % 2 === 0;
                                                const avgInvoice = customer.total / customer.invoices;
                                                const statusColor = customer.status === 'VIP' ? '#dc3545' : '#28a745';
                                                const statusBg = customer.status === 'VIP' ? '#f8d7da' : '#d4edda';

                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${customer.name}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057; font-weight: 600;">${customer.invoices}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(customer.total)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${formatCurrency(avgInvoice)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057; font-size: 0.9em;">${customer.lastPurchase}</td>
                                                        <td style="padding: 14px 12px; text-align: center;">
                                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; border: 1px solid ${statusColor};">
                                                                ${customer.status}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>

                        <!-- معلومات إضافية -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 25px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">📊 ملخص الأداء</h4>
                                <div style="color: #495057; line-height: 1.6;">
                                    ${reportData.type === 'customer-detail' ? `
                                        <div style="margin-bottom: 8px;">• إجمالي المبيعات: <strong style="color: #28a745;">${formatCurrency(reportData.total)}</strong></div>
                                        <div style="margin-bottom: 8px;">• عدد الفواتير: <strong>${reportData.count}</strong></div>
                                        <div style="margin-bottom: 8px;">• متوسط الفاتورة: <strong style="color: #667eea;">${formatCurrency(reportData.average)}</strong></div>
                                        <div>• حالة العميل: <strong style="color: ${reportData.customer.status === 'VIP' ? '#dc3545' : '#28a745'};">${reportData.customer.status}</strong></div>
                                    ` : `
                                        <div style="margin-bottom: 8px;">• إجمالي المبيعات: <strong style="color: #28a745;">${formatCurrency(reportData.total)}</strong></div>
                                        <div style="margin-bottom: 8px;">• عدد العملاء: <strong>${reportData.count}</strong></div>
                                        <div style="margin-bottom: 8px;">• متوسط العميل: <strong style="color: #667eea;">${formatCurrency(reportData.average)}</strong></div>
                                        <div>• إجمالي الفواتير: <strong>${reportData.totalInvoices}</strong></div>
                                    `}
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">🎯 نصائح لتحسين المبيعات</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    ${reportData.type === 'customer-detail' ? `
                                        <div style="margin-bottom: 8px;">• متابعة العميل بانتظام</div>
                                        <div style="margin-bottom: 8px;">• تقديم عروض خاصة</div>
                                        <div style="margin-bottom: 8px;">• تحسين خدمة ما بعد البيع</div>
                                        <div>• زيادة قيمة الفاتورة المتوسطة</div>
                                    ` : `
                                        <div style="margin-bottom: 8px;">• التركيز على العملاء المميزين</div>
                                        <div style="margin-bottom: 8px;">• تطوير برامج الولاء</div>
                                        <div style="margin-bottom: 8px;">• تحليل سلوك الشراء</div>
                                        <div>• زيادة تكرار الشراء</div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <!-- أزرار التصدير -->
                        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="printReport()" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(108, 117, 125, 0.3)'">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button onclick="exportToExcel('sales-by-customer')" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                <i class="fas fa-file-excel"></i> تصدير Excel
                            </button>
                            <button onclick="exportToPDF('sales-by-customer')" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)'">
                                <i class="fas fa-file-pdf"></i> تصدير PDF
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('خطأ في إنشاء تقرير المبيعات حسب العميل:', error);
                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 40px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center;">
                        <div style="color: #dc3545; margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 15px;"></i>
                            <h3>خطأ في تحميل التقرير</h3>
                            <p>عذراً، حدث خطأ أثناء إنشاء تقرير المبيعات حسب العميل. يرجى المحاولة مرة أخرى.</p>
                        </div>
                        <button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }

        function createSalesByProductReport(dateRange, filters = {}) {
            console.log('📦 إنشاء تقرير المبيعات حسب المنتج من البيانات الحقيقية...', { dateRange, filters });

            try {
                // الحصول على البيانات الحقيقية من النظام
                let salesData = [];
                let productsData = [];

                if (window.dataManager) {
                    salesData = window.dataManager.getSales();
                    productsData = window.dataManager.getProducts();
                    console.log('📊 تم جلب البيانات من النظام المركزي:', salesData.length, 'فاتورة،', productsData.length, 'منتج');
                } else {
                    // الرجوع للبيانات المحلية
                    salesData = JSON.parse(localStorage.getItem('monjizSales')) || [];
                    const invoicesData = JSON.parse(localStorage.getItem('monjizInvoices')) || [];
                    productsData = JSON.parse(localStorage.getItem('monjizProducts')) || [];

                    // دمج البيانات من المفتاحين
                    salesData = [...salesData, ...invoicesData];

                    // إزالة المكررات
                    salesData = salesData.filter((sale, index, self) =>
                        index === self.findIndex(s => s.id === sale.id)
                    );

                    console.log('📊 تم جلب البيانات من localStorage:', salesData.length, 'فاتورة،', productsData.length, 'منتج');
                }

                // تطبيق فلتر التاريخ (نفس الطريقة المستخدمة في تقرير المبيعات اليومية)
                console.log('📅 نطاق التاريخ المستلم:', dateRange);

                let filteredSales = salesData;
                let dateInfo = '';

                if (dateRange && dateRange.from && dateRange.to) {
                    console.log('📅 تطبيق فلتر التاريخ:', dateRange);
                    const fromDate = new Date(dateRange.from);
                    const toDate = new Date(dateRange.to);
                    toDate.setHours(23, 59, 59, 999); // نهاية اليوم

                    filteredSales = salesData.filter(sale => {
                        if (!sale.date && !sale.createdAt) {
                            console.log('❌ فاتورة بدون تاريخ:', sale.id);
                            return false;
                        }

                        let saleDate;
                        if (sale.createdAt) {
                            saleDate = new Date(sale.createdAt);
                        } else if (sale.date) {
                            // محاولة تحويل التاريخ بتنسيقات مختلفة
                            if (sale.date.includes('/')) {
                                // تنسيق DD/MM/YYYY
                                const parts = sale.date.split('/');
                                if (parts.length === 3) {
                                    saleDate = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            } else {
                                saleDate = new Date(sale.date);
                            }
                        }

                        const isIncluded = saleDate && saleDate >= fromDate && saleDate <= toDate;
                        if (isIncluded) {
                            console.log('✅ فاتورة مشمولة:', sale.id, 'تاريخ:', sale.date || sale.createdAt);
                        } else {
                            console.log('❌ فاتورة مستبعدة:', sale.id, 'تاريخ:', sale.date || sale.createdAt, 'تاريخ محول:', saleDate);
                        }
                        return isIncluded;
                    });

                    const fromDateFormatted = `${fromDate.getDate().toString().padStart(2, '0')}/${(fromDate.getMonth() + 1).toString().padStart(2, '0')}/${fromDate.getFullYear()}`;
                    const toDateFormatted = `${toDate.getDate().toString().padStart(2, '0')}/${(toDate.getMonth() + 1).toString().padStart(2, '0')}/${toDate.getFullYear()}`;

                    if (fromDateFormatted === toDateFormatted) {
                        dateInfo = fromDateFormatted;
                    } else {
                        dateInfo = `${fromDateFormatted} - ${toDateFormatted}`;
                    }

                    console.log('📊 المبيعات بعد فلتر التاريخ:', filteredSales.length, 'فاتورة');
                } else {
                    // إذا لم يتم تحديد تاريخ، استخدم اليوم الحالي
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    const todayDDMMYYYY = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;

                    filteredSales = salesData.filter(sale => {
                        if (!sale.date && !sale.createdAt) return false;

                        if (sale.date) {
                            // تحقق من تنسيقات مختلفة
                            if (sale.date === todayDDMMYYYY || sale.date === todayStr) {
                                return true;
                            }

                            // محاولة تحويل وقارن
                            try {
                                const saleDate = new Date(sale.date);
                                const saleDateStr = saleDate.toISOString().split('T')[0];
                                return saleDateStr === todayStr;
                            } catch (e) {
                                return false;
                            }
                        }

                        if (sale.createdAt) {
                            try {
                                const createdDate = new Date(sale.createdAt);
                                const createdDateStr = createdDate.toISOString().split('T')[0];
                                return createdDateStr === todayStr;
                            } catch (e) {
                                return false;
                            }
                        }

                        return false;
                    });

                    dateInfo = todayDDMMYYYY;
                    console.log('📅 مبيعات اليوم (افتراضي):', filteredSales.length, 'فاتورة');
                }

                // استخدام البيانات المفلترة بدلاً من البيانات الأصلية
                salesData = filteredSales;

                // تطبيق فلتر المنتج المحدد إذا وجد
                let selectedProduct = null;
                let reportData = {};

                if (filters.account && filters.account !== '') {
                    // البحث عن المنتج المحدد
                    selectedProduct = productsData.find(p => p.id == filters.account);

                    if (selectedProduct) {
                        console.log('📦 المنتج المختار:', selectedProduct.name);

                        // فلترة المبيعات للمنتج المحدد
                        const productSales = [];

                        salesData.forEach(sale => {
                            const items = sale.items || sale.products || [];
                            items.forEach(item => {
                                if (item.productId == selectedProduct.id ||
                                    item.name === selectedProduct.name ||
                                    item.productName === selectedProduct.name) {

                                    // البحث عن اسم العميل
                                    let customerName = sale.customerName || sale.customer || 'عميل غير محدد';

                                    productSales.push({
                                        invoiceId: sale.id,
                                        date: sale.date || new Date(sale.createdAt).toLocaleDateString('ar-EG'),
                                        customer: customerName,
                                        quantity: item.quantity || 1,
                                        unitPrice: item.price || item.unitPrice || selectedProduct.salePrice || 0,
                                        total: item.total || (item.quantity * (item.price || item.unitPrice)) || 0,
                                        profit: 0 // سيتم حسابه
                                    });
                                }
                            });
                        });

                        // حساب الربح لكل فاتورة
                        productSales.forEach(sale => {
                            const costPrice = selectedProduct.purchasePrice || selectedProduct.costPrice || selectedProduct.cost || 0;
                            sale.profit = sale.quantity * (sale.unitPrice - costPrice);
                        });

                        // حساب الإحصائيات
                        const totalQuantity = productSales.reduce((sum, sale) => sum + sale.quantity, 0);
                        const totalSales = productSales.reduce((sum, sale) => sum + sale.total, 0);
                        const totalProfit = productSales.reduce((sum, sale) => sum + sale.profit, 0);
                        const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;

                        reportData = {
                            type: 'product-detail',
                            product: {
                                ...selectedProduct,
                                costPrice: selectedProduct.purchasePrice || selectedProduct.costPrice || selectedProduct.cost || 0,
                                profitMargin: profitMargin
                            },
                            sales: productSales,
                            totalQuantity: totalQuantity,
                            totalSales: totalSales,
                            totalProfit: totalProfit,
                            profitMargin: profitMargin,
                            dateInfo: dateInfo
                        };

                        console.log('📋 مبيعات المنتج:', productSales.length, 'فاتورة');
                    }
                } else {
                    // عرض ملخص جميع المنتجات
                    console.log('📊 إنشاء ملخص جميع المنتجات...');
                    console.log('📊 عدد المبيعات المفلترة للمعالجة:', salesData.length);

                    // طباعة عينة من المبيعات المفلترة للتشخيص
                    if (salesData.length > 0) {
                        console.log('🔍 عينة من المبيعات المفلترة:', salesData.slice(0, 3).map(s => ({
                            id: s.id,
                            date: s.date,
                            createdAt: s.createdAt,
                            items: s.items ? s.items.length : 0,
                            products: s.products ? s.products.length : 0
                        })));
                    } else {
                        console.log('⚠️ لا توجد مبيعات مفلترة للتاريخ المحدد!');
                    }

                    // تجميع المبيعات حسب المنتج
                    const productSummary = {};

                    salesData.forEach((sale, index) => {
                        console.log(`🔍 معالجة فاتورة ${index + 1}:`, sale.id, 'تاريخ:', sale.date || sale.createdAt);
                        const items = sale.items || sale.products || [];
                        console.log(`  📦 عناصر الفاتورة ${sale.id}:`, items.length, 'عنصر');

                        items.forEach((item, itemIndex) => {
                            console.log(`    🔸 عنصر ${itemIndex + 1}:`, item.name || item.productName, 'كمية:', item.quantity);
                            let productId = item.productId;
                            let productName = item.name || item.productName || 'منتج غير محدد';

                            // البحث عن المنتج في قاعدة البيانات
                            let product = null;
                            if (productId) {
                                product = productsData.find(p => p.id == productId);
                            } else {
                                product = productsData.find(p => p.name === productName);
                            }

                            if (product) {
                                productId = product.id;
                                productName = product.name;
                            }

                            const productKey = productId || productName;

                            if (!productSummary[productKey]) {
                                const costPrice = product ? (product.purchasePrice || product.costPrice || product.cost || 0) : 0;
                                const salePrice = product ? (product.salePrice || product.price || 0) : (item.price || item.unitPrice || 0);

                                productSummary[productKey] = {
                                    id: productId,
                                    name: productName,
                                    category: product ? product.category : 'غير محدد',
                                    quantity: 0,
                                    totalSales: 0,
                                    costPrice: costPrice,
                                    salePrice: salePrice,
                                    profit: 0,
                                    profitMargin: 0,
                                    invoices: 0
                                };
                            }

                            const quantity = item.quantity || 1;
                            const total = item.total || (quantity * (item.price || item.unitPrice)) || 0;
                            const costPrice = productSummary[productKey].costPrice;
                            const profit = quantity * ((item.price || item.unitPrice || 0) - costPrice);

                            productSummary[productKey].quantity += quantity;
                            productSummary[productKey].totalSales += total;
                            productSummary[productKey].profit += profit;
                            productSummary[productKey].invoices++;
                        });
                    });

                    // حساب هامش الربح لكل منتج
                    Object.values(productSummary).forEach(product => {
                        if (product.totalSales > 0) {
                            product.profitMargin = (product.profit / product.totalSales) * 100;
                        }
                    });

                    const productsArray = Object.values(productSummary);
                    console.log('📊 ملخص المنتجات بعد المعالجة:', productsArray.length, 'منتج');
                    console.log('🔍 عينة من المنتجات:', productsArray.slice(0, 3).map(p => ({
                        name: p.name,
                        quantity: p.quantity,
                        totalSales: p.totalSales,
                        invoices: p.invoices
                    })));

                    const totalSales = productsArray.reduce((sum, product) => sum + product.totalSales, 0);
                    const totalProfit = productsArray.reduce((sum, product) => sum + product.profit, 0);
                    const totalQuantity = productsArray.reduce((sum, product) => sum + product.quantity, 0);
                    const totalCost = totalSales - totalProfit;

                    console.log('💰 الإجماليات:', {
                        totalSales,
                        totalProfit,
                        totalQuantity,
                        productsCount: productsArray.length
                    });

                    reportData = {
                        type: 'products-summary',
                        products: productsArray,
                        totalSales: totalSales,
                        totalProfit: totalProfit,
                        totalCost: totalCost,
                        totalQuantity: totalQuantity,
                        profitMargin: totalSales > 0 ? (totalProfit / totalSales * 100) : 0,
                        productsCount: productsArray.length,
                        dateInfo: dateInfo
                    };
                }

                console.log('📊 بيانات التقرير:', reportData);

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <!-- الإحصائيات المصغرة -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💰 إجمالي المبيعات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.totalSales || reportData.totalSales)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💸 إجمالي التكلفة</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.totalCost || (reportData.totalSales - reportData.totalProfit))}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💎 إجمالي الربح</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.totalProfit)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📊 هامش الربح</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${(reportData.profitMargin || 0).toFixed(1)}%</div>
                            </div>
                            ${reportData.type === 'products-summary' ? `
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📦 عدد المنتجات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.productsCount}</div>
                            </div>
                            ` : ''}
                            ${reportData.type === 'product-detail' ? `
                            <div style="background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(111, 66, 193, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📋 عدد الفواتير</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.sales ? reportData.sales.length : 0}</div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- جدول البيانات حسب نوع العرض -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                                ${reportData.type === 'product-detail' ?
                                  `📦 تفاصيل مبيعات المنتج: ${reportData.product.name} - ${reportData.dateInfo}` :
                                  `📊 ملخص المبيعات حسب المنتج - ${reportData.dateInfo}`}
                            </h3>

                            ${reportData.type === 'product-detail' ? `
                                <!-- عرض تفاصيل مبيعات المنتج المحدد -->
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9em;">
                                        <div><strong>🏷️ الفئة:</strong> ${reportData.product.category}</div>
                                        <div><strong>💰 سعر البيع:</strong> ${formatCurrency(reportData.product.salePrice)}</div>
                                        <div><strong>💸 سعر التكلفة:</strong> ${formatCurrency(reportData.product.costPrice)}</div>
                                        <div><strong>📊 هامش الربح:</strong> <span style="color: #28a745; font-weight: bold;">${reportData.product.profitMargin.toFixed(1)}%</span></div>
                                    </div>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">رقم الفاتورة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">التاريخ</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">العميل</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الكمية</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">سعر الوحدة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الإجمالي</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الربح</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reportData.sales.map((sale, index) => {
                                                const isEven = index % 2 === 0;

                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${sale.invoiceId}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057;">${sale.date}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057;">${sale.customer}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #17a2b8;">${sale.quantity}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${formatCurrency(sale.unitPrice)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(sale.total)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #ffc107; font-size: 1.05em;">${formatCurrency(sale.profit)}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                            <!-- صف الإجمالي -->
                                            <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold;">
                                                <td colspan="3" style="padding: 16px 12px; text-align: center; font-size: 1.1em;">الإجمالي</td>
                                                <td style="padding: 16px 12px; text-align: center; font-size: 1.1em;">${reportData.totalQuantity}</td>
                                                <td style="padding: 16px 12px; text-align: center;">-</td>
                                                <td style="padding: 16px 12px; text-align: center; font-size: 1.2em;">${formatCurrency(reportData.totalSales)}</td>
                                                <td style="padding: 16px 12px; text-align: center; font-size: 1.2em;">${formatCurrency(reportData.totalProfit)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            ` : `

                                <!-- عرض ملخص جميع المنتجات -->
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">اسم المنتج</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الفئة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الكمية المباعة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">إجمالي المبيعات</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">إجمالي الربح</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">هامش الربح</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">عدد الفواتير</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reportData.products.map((product, index) => {
                                                const isEven = index % 2 === 0;
                                                const profitColor = product.profitMargin >= 25 ? '#28a745' : product.profitMargin >= 15 ? '#ffc107' : '#dc3545';

                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${product.name}</td>
                                                        <td style="padding: 14px 12px; text-align: center;">
                                                            <span style="background: #e9ecef; color: #495057; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600;">
                                                                ${product.category}
                                                            </span>
                                                        </td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #17a2b8; font-size: 1.05em;">${product.quantity}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(product.totalSales)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #ffc107; font-size: 1.05em;">${formatCurrency(product.profit)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: ${profitColor}; font-size: 1.05em;">
                                                            ${product.profitMargin.toFixed(1)}%
                                                        </td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057; font-weight: 600;">${product.invoices}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                            <!-- صف الإجمالي -->
                                            <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold;">
                                                <td colspan="2" style="padding: 16px 12px; text-align: center; font-size: 1.1em;">الإجمالي</td>
                                                <td style="padding: 16px 12px; text-align: center; font-size: 1.1em;">${reportData.totalQuantity}</td>
                                                <td style="padding: 16px 12px; text-align: center; font-size: 1.2em;">${formatCurrency(reportData.totalSales)}</td>
                                                <td style="padding: 16px 12px; text-align: center; font-size: 1.2em;">${formatCurrency(reportData.totalProfit)}</td>
                                                <td style="padding: 16px 12px; text-align: center; font-size: 1.1em;">${reportData.profitMargin.toFixed(1)}%</td>
                                                <td style="padding: 16px 12px; text-align: center;">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>

                        <!-- معلومات إضافية -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 25px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">📊 ملخص الأداء</h4>
                                <div style="color: #495057; line-height: 1.6;">
                                    ${reportData.type === 'product-detail' ? `
                                        <div style="margin-bottom: 8px;">• إجمالي المبيعات: <strong style="color: #28a745;">${formatCurrency(reportData.totalSales)}</strong></div>
                                        <div style="margin-bottom: 8px;">• الكمية المباعة: <strong>${reportData.totalQuantity}</strong></div>
                                        <div style="margin-bottom: 8px;">• إجمالي الربح: <strong style="color: #ffc107;">${formatCurrency(reportData.totalProfit)}</strong></div>
                                        <div>• هامش الربح: <strong style="color: #28a745;">${reportData.profitMargin.toFixed(1)}%</strong></div>
                                    ` : `
                                        <div style="margin-bottom: 8px;">• إجمالي المبيعات: <strong style="color: #28a745;">${formatCurrency(reportData.totalSales)}</strong></div>
                                        <div style="margin-bottom: 8px;">• عدد المنتجات: <strong>${reportData.productsCount}</strong></div>
                                        <div style="margin-bottom: 8px;">• إجمالي الربح: <strong style="color: #ffc107;">${formatCurrency(reportData.totalProfit)}</strong></div>
                                        <div>• هامش الربح العام: <strong style="color: #28a745;">${reportData.profitMargin.toFixed(1)}%</strong></div>
                                    `}
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">🎯 نصائح لتحسين الربحية</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    ${reportData.type === 'product-detail' ? `
                                        <div style="margin-bottom: 8px;">• تحليل أوقات الذروة للمبيعات</div>
                                        <div style="margin-bottom: 8px;">• تطوير استراتيجيات التسعير</div>
                                        <div style="margin-bottom: 8px;">• تحسين إدارة المخزون</div>
                                        <div>• زيادة الطلب من خلال التسويق</div>
                                    ` : `
                                        <div style="margin-bottom: 8px;">• التركيز على المنتجات عالية الربح</div>
                                        <div style="margin-bottom: 8px;">• مراجعة تكاليف المنتجات الضعيفة</div>
                                        <div style="margin-bottom: 8px;">• تطوير منتجات جديدة مربحة</div>
                                        <div>• تحسين استراتيجيات التسويق</div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <!-- أزرار التصدير -->
                        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="printReport()" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(108, 117, 125, 0.3)'">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button onclick="exportToExcel('sales-by-product')" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                <i class="fas fa-file-excel"></i> تصدير Excel
                            </button>
                            <button onclick="exportToPDF('sales-by-product')" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)'">
                                <i class="fas fa-file-pdf"></i> تصدير PDF
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('خطأ في إنشاء تقرير المبيعات حسب المنتج:', error);
                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 40px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center;">
                        <div style="color: #dc3545; margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 15px;"></i>
                            <h3>خطأ في تحميل التقرير</h3>
                            <p>عذراً، حدث خطأ أثناء إنشاء تقرير المبيعات حسب المنتج. يرجى المحاولة مرة أخرى.</p>
                        </div>
                        <button onclick="location.reload()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }

        function createStockMovementReport(currentDate, filters = {}) {
            console.log('📦 إنشاء تقرير حركة المخزون...', { currentDate, filters });

            // التأكد من وجود النظام المركزي
            if (!window.dataManager) {
                console.log('🔄 تهيئة النظام المركزي...');
                window.dataManager = new DataManager();
            }

            // الحصول على حركات المخزون الحقيقية فقط
            let stockMovements = window.dataManager.getStockMovements() || [];
            console.log('📦 حركات المخزون الموجودة قبل الفلترة:', stockMovements.length, 'حركة');

            // الحصول على قائمة المنتجات الحقيقية للتحقق من صحة الحركات
            let realProducts = [];
            if (window.dataManager) {
                realProducts = window.dataManager.getProducts();
            } else {
                realProducts = JSON.parse(localStorage.getItem('monjizProducts')) || [];
            }

            // قائمة المنتجات الوهمية التي يجب استبعادها
            const fakeProductNames = [
                'لابتوب ديل XPS 13',
                'لابتوب ديل',
                'هاتف آيفون 14',
                'هاتف آيفون',
                'آيفون',
                'لابتوب',
                'كتاب إدارة الأعمال',
                'شامبو للشعر',
                'قميص قطني'
            ];

            // فلترة المنتجات لاستبعاد المنتجات الوهمية
            realProducts = realProducts.filter(product => {
                const isFake = fakeProductNames.some(fakeName => {
                    const productName = product.name || '';
                    const fakeNameStr = fakeName || '';
                    return (productName && fakeNameStr && productName.includes(fakeNameStr)) ||
                           (fakeNameStr && productName && fakeNameStr.includes(productName));
                });

                if (isFake) {
                    console.log('❌ تم استبعاد منتج وهمي:', product.name);
                }

                return !isFake;
            });

            const realProductIds = new Set(realProducts.map(p => String(p.id)));
            const realProductNames = new Set(realProducts.map(p => p.name));

            console.log('📋 المنتجات الحقيقية بعد الفلترة:', realProducts.length, 'منتج');
            console.log('🔍 أسماء المنتجات الحقيقية:', Array.from(realProductNames).slice(0, 5));

            // فلترة الحركات للاحتفاظ بالحركات الحقيقية فقط
            const originalCount = stockMovements.length;
            stockMovements = stockMovements.filter(movement => {
                // التحقق من عدم كون المنتج من المنتجات الوهمية
                const isFakeProduct = fakeProductNames.some(fakeName => {
                    const productName = movement.productName || '';
                    const fakeNameStr = fakeName || '';
                    return (productName && fakeNameStr && productName.includes(fakeNameStr)) ||
                           (productName && fakeNameStr && fakeNameStr.includes(productName));
                });

                if (isFakeProduct) {
                    console.log('❌ تم استبعاد حركة منتج وهمي:', movement.productName);
                    return false;
                }

                // التحقق من وجود المنتج في قائمة المنتجات الحقيقية
                const hasValidProductId = movement.productId && realProductIds.has(String(movement.productId));
                const hasValidProductName = movement.productName && realProductNames.has(movement.productName);

                // التحقق من وجود بيانات أساسية صحيحة
                const hasValidData = movement.quantity &&
                                   movement.movementType &&
                                   (movement.createdAt || movement.date);

                const isValid = (hasValidProductId || hasValidProductName) && hasValidData;

                if (!isValid) {
                    console.log('❌ تم استبعاد حركة غير صحيحة:', {
                        productId: movement.productId,
                        productName: movement.productName,
                        hasValidProductId,
                        hasValidProductName,
                        hasValidData,
                        isFakeProduct
                    });
                }

                return isValid;
            });

            console.log(`🧹 تم تنظيف الحركات: ${originalCount} → ${stockMovements.length} حركة حقيقية`);

            // تطبيق فلتر التاريخ
            if (filters.dateFrom || filters.dateTo) {
                const fromDate = filters.dateFrom ? new Date(filters.dateFrom) : new Date('1900-01-01');
                const toDate = filters.dateTo ? new Date(filters.dateTo) : new Date();

                // إضافة يوم كامل لتاريخ النهاية للتأكد من تضمين اليوم كاملاً
                toDate.setHours(23, 59, 59, 999);

                console.log('📅 تطبيق فلتر التاريخ:', {
                    from: formatDateGregorian(fromDate),
                    to: formatDateGregorian(toDate)
                });

                stockMovements = stockMovements.filter(movement => {
                    const movementDate = new Date(movement.createdAt || movement.date);
                    return movementDate >= fromDate && movementDate <= toDate;
                });

                console.log('📦 حركات المخزون بعد فلتر التاريخ:', stockMovements.length, 'حركة');
            }

            // تطبيق فلتر الحساب/المنتج
            if (filters.account && filters.account !== '') {
                console.log('🔍 تطبيق فلتر المنتج:', filters.account, typeof filters.account);

                // التحقق من أن المنتج المختار موجود في المنتجات الحقيقية
                const selectedProduct = realProducts.find(p =>
                    String(p.id) === String(filters.account) ||
                    p.name === filters.account
                );

                if (!selectedProduct) {
                    console.log('❌ المنتج المختار غير موجود في المنتجات الحقيقية:', filters.account);
                    stockMovements = []; // لا توجد حركات للمنتج غير الموجود
                } else {
                    console.log('✅ المنتج المختار موجود:', selectedProduct.name, 'ID:', selectedProduct.id);

                    stockMovements = stockMovements.filter(movement => {
                        const matchById = String(movement.productId) === String(selectedProduct.id);
                        const matchByName = movement.productName === selectedProduct.name;
                        const matchByCode = movement.productCode === selectedProduct.code;

                        return matchById || matchByName || matchByCode;
                    });
                }

                console.log('📦 حركات المخزون بعد فلتر المنتج:', stockMovements.length, 'حركة');

                if (stockMovements.length > 0) {
                    console.log('✅ الحركات المطابقة:', stockMovements.map(m => m.productName));
                }
            }

            // التحقق من وجود حركات مخزون
            if (stockMovements.length === 0) {
                const noDataMessage = filters.account && filters.account !== '' ?
                    'لا توجد حركات مخزون للصنف المحدد في الفترة المختارة' :
                    'لا توجد حركات مخزون حقيقية في النظام';

                console.log('⚠️', noDataMessage);
                return `
                    <div class="report-container">
                        <div class="report-content">
                            <div class="table-container" style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="text-align: center; padding: 40px; color: #666;">
                                    <i class="fas fa-warehouse" style="font-size: 48px; margin-bottom: 20px; color: #ddd;"></i>
                                    <h3>${noDataMessage}</h3>
                                    <p>ستظهر حركات المخزون هنا عند إجراء عمليات بيع أو شراء للمنتجات الموجودة في النظام</p>
                                    <div style="margin-top: 20px;">
                                        <button onclick="window.open('sales.html', '_blank')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                                            <i class="fas fa-shopping-cart"></i> إضافة مبيعات
                                        </button>
                                        <button onclick="window.open('purchases.html', '_blank')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                                            <i class="fas fa-truck"></i> إضافة مشتريات
                                        </button>
                                        <button onclick="window.open('products.html', '_blank')" style="background: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                                            <i class="fas fa-box"></i> إدارة المنتجات
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            console.log('📦 إجمالي حركات المخزون للتقرير:', stockMovements.length, 'حركة');

            // ترتيب الحركات حسب التاريخ (الأحدث أولاً)
            stockMovements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            // حساب الإحصائيات المفصلة
            const totalMovements = stockMovements.length;
            const inMovements = stockMovements.filter(m => m.movementType === 'in');
            const outMovements = stockMovements.filter(m => m.movementType === 'out');
            const totalInQuantity = inMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
            const totalOutQuantity = outMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
            const netMovement = totalInQuantity - totalOutQuantity;

            // تحليل حسب نوع المرجع
            const movementsByType = {
                purchase: stockMovements.filter(m => m.referenceType === 'purchase').length,
                sale: stockMovements.filter(m => m.referenceType === 'sale').length,
                adjustment: stockMovements.filter(m => m.referenceType === 'adjustment').length,
                transfer: stockMovements.filter(m => m.referenceType === 'transfer').length,
                manual: stockMovements.filter(m => m.referenceType === 'manual').length
            };

            // تحليل حسب المنتجات
            const productMovements = {};
            stockMovements.forEach(movement => {
                if (!productMovements[movement.productId]) {
                    productMovements[movement.productId] = {
                        productName: movement.productName,
                        inQuantity: 0,
                        outQuantity: 0,
                        movementsCount: 0
                    };
                }

                if (movement.movementType === 'in') {
                    productMovements[movement.productId].inQuantity += movement.quantity || 0;
                } else {
                    productMovements[movement.productId].outQuantity += movement.quantity || 0;
                }
                productMovements[movement.productId].movementsCount++;
            });

            // أكثر المنتجات حركة
            const mostActiveProducts = Object.values(productMovements)
                .sort((a, b) => b.movementsCount - a.movementsCount)
                .slice(0, 5);

            // بناء صفوف الجدول المبسط
            let tableRows = '';
            if (stockMovements.length > 0) {
                stockMovements.forEach((movement, index) => {
                    // تحديد نوع الحركة بشكل مبسط
                    const isIncoming = movement.movementType === 'in';
                    const typeText = isIncoming ? 'وارد' : 'صادر';
                    const typeClass = isIncoming ? 'status-good' : 'status-warning';
                    const typeIcon = isIncoming ? '📥' : '📤';

                    // تحديد نوع العملية
                    const operationType = {
                        'sale': 'مبيعات',
                        'purchase': 'مشتريات',
                        'adjustment': 'تسوية',
                        'manual': 'تعديل',
                        'transfer': 'تحويل'
                    }[movement.referenceType] || 'أخرى';

                    // تنسيق الكمية مع الألوان
                    const quantityDisplay = isIncoming ?
                        `<span style="color: #28a745; font-weight: bold;">+${movement.quantity}</span>` :
                        `<span style="color: #dc3545; font-weight: bold;">-${movement.quantity}</span>`;

                    // تنسيق التاريخ بالميلادي
                    const movementDate = new Date(movement.createdAt || movement.date);
                    const displayDate = movementDate.toLocaleDateString('en-GB').split('/').reverse().join('-');

                    tableRows += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 6px; text-align: center; font-size: 12px;">${displayDate}</td>
                            <td style="padding: 6px;">
                                <strong style="font-size: 13px;">${movement.productName || 'غير محدد'}</strong>
                            </td>
                            <td style="padding: 6px; text-align: center;">
                                <span class="badge ${typeClass}" style="font-size: 10px; padding: 2px 6px;">${typeIcon} ${typeText}</span>
                            </td>
                            <td style="padding: 6px; text-align: center;">${quantityDisplay}</td>
                            <td style="padding: 6px; text-align: center; font-weight: bold;">${movement.newQuantity || 0}</td>
                            <td style="padding: 6px; text-align: center; font-size: 12px;">${movement.reference || operationType}</td>
                        </tr>
                    `;
                });
            } else {
                tableRows = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">لا توجد حركات مخزون</td></tr>';
            }

            return `
                <div class="report-container">
                    <div class="report-content">
                        <!-- الجدول المفصل -->
                        <div class="table-container" style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333;">📦 سجل حركات المخزون</h3>
                                <div style="font-size: 12px; color: #666;">
                                    <span><strong>كما في:</strong> ${currentDate}</span> |
                                    <span>إجمالي الحركات: ${totalMovements}</span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="report-table enhanced" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">التاريخ</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">المنتج</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">النوع</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">الكمية</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">الرصيد الجديد</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">المرجع</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="report-actions" style="margin-top: 15px; text-align: center;">
                        <button onclick="window.print()" class="btn-print" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 طباعة
                        </button>
                        <button onclick="exportToExcel('stock-movement')" class="btn-excel" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📊 Excel
                        </button>
                        <button onclick="exportToPDF('stock-movement')" class="btn-pdf" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 PDF
                        </button>
                    </div>
                </div>
            `;
        }

        function createProductOperationsReport(currentDate, filters = {}) {
            console.log('📊 إنشاء تقرير عمليات صنف...');
            console.log('🔍 الفلاتر المستلمة:', JSON.stringify(filters, null, 2));

            // التأكد من وجود النظام المركزي
            if (!window.dataManager) {
                console.log('🔄 تهيئة النظام المركزي...');
                window.dataManager = new DataManager();
            }

            // الحصول على المنتجات المتاحة
            const products = window.dataManager.getProducts() || [];

            // التحقق من وجود منتجات في النظام
            if (products.length === 0) {
                console.log('⚠️ لا توجد منتجات في النظام');
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>تقرير عمليات صنف</h2>
                            <p>كما في ${currentDate}</p>
                        </div>
                        <div class="report-content">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 20px; color: #ddd;"></i>
                                <h3>لا توجد منتجات</h3>
                                <p>يجب إضافة منتجات أولاً من صفحة إدارة المخزون</p>
                                <button onclick="window.open('inventory.html', '_blank')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                                    <i class="fas fa-plus"></i> إضافة منتجات
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // الحصول على المنتج المحدد من الفلاتر
            let selectedProduct = null;

            console.log('🔍 البحث عن المنتج المحدد...');
            console.log('📦 عدد المنتجات المتاحة:', products.length);

            // أولاً: محاولة الحصول على المنتج من معامل filters
            if (filters.account && filters.account !== '') {
                const selectedId = filters.account;
                console.log('🎯 البحث عن المنتج بالمعرف من filters:', selectedId);
                selectedProduct = products.find(p => p.id == selectedId || p.name === selectedId);
                if (selectedProduct) {
                    console.log('✅ تم العثور على المنتج من معامل filters:', selectedProduct.name);
                } else {
                    console.log('❌ لم يتم العثور على المنتج بالمعرف:', selectedId);
                }
            }

            // ثانياً: محاولة الحصول على الفلتر من DOM
            if (!selectedProduct) {
                const reportAccount = document.getElementById('report-account');
                console.log('🔍 فحص عنصر DOM:', reportAccount ? 'موجود' : 'غير موجود');
                if (reportAccount) {
                    console.log('🔍 قيمة الفلتر من DOM:', reportAccount.value);
                }
                if (reportAccount && reportAccount.value && reportAccount.value !== '') {
                    const selectedId = reportAccount.value;
                    console.log('🎯 البحث عن المنتج بالمعرف من DOM:', selectedId);
                    selectedProduct = products.find(p => p.id == selectedId || p.name === selectedId);
                    if (selectedProduct) {
                        console.log('✅ تم العثور على المنتج من DOM:', selectedProduct.name);
                    } else {
                        console.log('❌ لم يتم العثور على المنتج بالمعرف:', selectedId);
                    }
                }
            }

            // إذا لم يتم اختيار منتج، استخدم أول منتج
            if (!selectedProduct) {
                selectedProduct = products[0];
                console.log('📦 استخدام أول منتج كافتراضي:', selectedProduct?.name);
            }

            console.log('🎯 المنتج النهائي المحدد:', selectedProduct?.name);

            if (!selectedProduct) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>تقرير عمليات صنف</h2>
                            <p>كما في ${currentDate}</p>
                        </div>
                        <div class="report-content">
                            <p style="text-align: center; padding: 40px; color: #666;">لا توجد منتجات متاحة</p>
                        </div>
                    </div>
                `;
            }

            // الحصول على العمليات الفعلية للمنتج المحدد
            const operations = getProductOperations(selectedProduct, filters);

            // حساب الإحصائيات
            const purchaseOperations = operations.filter(op => op.type === 'purchase');
            const saleOperations = operations.filter(op => op.type === 'sale');

            const totalPurchaseQuantity = purchaseOperations.reduce((sum, op) => sum + op.quantity, 0);
            const totalSaleQuantity = saleOperations.reduce((sum, op) => sum + op.quantity, 0);
            const totalPurchaseValue = purchaseOperations.reduce((sum, op) => sum + (op.quantity * op.price), 0);
            const totalSaleValue = saleOperations.reduce((sum, op) => sum + (op.quantity * op.price), 0);

            const avgPurchasePrice = totalPurchaseQuantity > 0 ? totalPurchaseValue / totalPurchaseQuantity : 0;
            const avgSalePrice = totalSaleQuantity > 0 ? totalSaleValue / totalSaleQuantity : 0;
            const totalProfit = totalSaleValue - (totalSaleQuantity * avgPurchasePrice);

            // بناء صفوف الجدول
            let tableRows = '';
            if (operations.length === 0) {
                tableRows = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; color: #ddd;"></i>
                            <br>
                            <strong>لا توجد عمليات للمنتج: ${selectedProduct.name}</strong>
                            <br>
                            <small>قم بإجراء عمليات بيع أو شراء لهذا المنتج لتظهر هنا</small>
                            <br><br>
                            <button onclick="window.open('sales.html', '_blank')" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 12px;">
                                💰 إضافة مبيعات
                            </button>
                            <button onclick="window.open('purchases.html', '_blank')" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 12px;">
                                🛒 إضافة مشتريات
                            </button>
                        </td>
                    </tr>
                `;
            } else {
                operations.forEach((operation, index) => {
                    const isPurchase = operation.type === 'purchase';
                    const typeText = isPurchase ? 'شراء' : 'بيع';
                    const typeClass = isPurchase ? 'status-good' : 'status-warning';
                    const typeIcon = isPurchase ? '🛒' : '💰';
                    const totalValue = operation.quantity * operation.price;

                    tableRows += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 6px; text-align: center; font-size: 12px;">${operation.date}</td>
                            <td style="padding: 6px; text-align: center;">
                                <span class="badge ${typeClass}" style="font-size: 10px; padding: 2px 6px;">${typeIcon} ${typeText}</span>
                            </td>
                            <td style="padding: 6px; text-align: center; font-weight: bold;">${operation.quantity}</td>
                            <td style="padding: 6px; text-align: center;">${formatNumber(operation.price)}</td>
                            <td style="padding: 6px; text-align: center; font-weight: bold; color: ${isPurchase ? '#28a745' : '#ffc107'};">${formatNumber(totalValue)}</td>
                            <td style="padding: 6px; text-align: center; font-size: 11px;">${operation.reference}</td>
                        </tr>
                    `;
                });
            }

            // إضافة صفوف الإجماليات
            let summaryRows = '';
            if (operations.length > 0) {
                // صف إجمالي المشتريات
                if (totalPurchaseQuantity > 0) {
                    summaryRows += `
                        <tr style="background-color: #e8f5e8; font-weight: bold;">
                            <td colspan="2"><strong>🛒 إجمالي المشتريات</strong></td>
                            <td><strong>${totalPurchaseQuantity}</strong></td>
                            <td><strong>${formatNumber(avgPurchasePrice)}</strong></td>
                            <td><strong>${formatNumber(totalPurchaseValue)}</strong></td>
                            <td><strong>${purchaseOperations.length} عملية</strong></td>
                        </tr>
                    `;
                }

                // صف إجمالي المبيعات
                if (totalSaleQuantity > 0) {
                    summaryRows += `
                        <tr style="background-color: #fff3cd; font-weight: bold;">
                            <td colspan="2"><strong>💰 إجمالي المبيعات</strong></td>
                            <td><strong>${totalSaleQuantity}</strong></td>
                            <td><strong>${formatNumber(avgSalePrice)}</strong></td>
                            <td><strong>${formatNumber(totalSaleValue)}</strong></td>
                            <td><strong>${saleOperations.length} عملية</strong></td>
                        </tr>
                    `;
                }

                // صف الربح
                const profitColor = totalProfit >= 0 ? '#d4edda' : '#f8d7da';
                const profitTextColor = totalProfit >= 0 ? '#155724' : '#721c24';
                summaryRows += `
                    <tr style="background-color: ${profitColor}; font-weight: bold; color: ${profitTextColor};">
                        <td colspan="2"><strong>📊 صافي الربح</strong></td>
                        <td><strong>${totalSaleQuantity - totalPurchaseQuantity}</strong></td>
                        <td><strong>-</strong></td>
                        <td><strong>${formatNumber(totalProfit)}</strong></td>
                        <td><strong>${totalProfit >= 0 ? 'ربح' : 'خسارة'}</strong></td>
                    </tr>
                `;
            }

            return `
                <div class="report-container">
                    <div class="report-content">
                        <!-- الجدول المفصل -->
                        <div class="table-container" style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333;">📦 عمليات المنتج: ${selectedProduct.name}</h3>
                                <div style="font-size: 12px; color: #666;">
                                    <span><strong>إجمالي العمليات:</strong> ${operations.length}</span> |
                                    <span><strong>مشتريات:</strong> ${purchaseOperations.length}</span> |
                                    <span><strong>مبيعات:</strong> ${saleOperations.length}</span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="report-table enhanced" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">التاريخ</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">نوع العملية</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">الكمية</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">السعر</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">إجمالي القيمة</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">المرجع</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                        ${summaryRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ملخص مالي محسن -->
                        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="margin: 0 0 10px 0; color: #155724;">🛒 المشتريات</h4>
                                <div style="font-size: 18px; font-weight: bold; color: #155724;">${formatNumber(totalPurchaseValue)} ر.س</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ${totalPurchaseQuantity} قطعة | متوسط ${formatNumber(avgPurchasePrice)} ر.س
                                </div>
                            </div>

                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="margin: 0 0 10px 0; color: #856404;">💰 المبيعات</h4>
                                <div style="font-size: 18px; font-weight: bold; color: #856404;">${formatNumber(totalSaleValue)} ر.س</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ${totalSaleQuantity} قطعة | متوسط ${formatNumber(avgSalePrice)} ر.س
                                </div>
                            </div>

                            <div style="background: ${totalProfit >= 0 ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="margin: 0 0 10px 0; color: ${totalProfit >= 0 ? '#155724' : '#721c24'};">📊 صافي الربح</h4>
                                <div style="font-size: 18px; font-weight: bold; color: ${totalProfit >= 0 ? '#155724' : '#721c24'};">${formatNumber(totalProfit)} ر.س</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    هامش ${totalSaleValue > 0 ? formatNumber((totalProfit / totalSaleValue) * 100) : '0'}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="report-actions" style="margin-top: 15px; text-align: center;">
                        <button onclick="window.print()" class="btn-print" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 طباعة
                        </button>
                        <button onclick="exportToExcel('product-operations')" class="btn-excel" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📊 Excel
                        </button>
                        <button onclick="exportToPDF('product-operations')" class="btn-pdf" style="margin: 0 5px; padding: 8px 15px; font-size: 13px;">
                            📄 PDF
                        </button>
                    </div>
                </div>
            `;
        }

        // دالة للحصول على العمليات الفعلية للمنتج
        function getProductOperations(product, filters = {}) {
            console.log('📊 جلب العمليات الفعلية للمنتج:', product.name);

            const operations = [];

            try {
                // 1. جلب عمليات البيع (المبيعات)
                const sales = window.dataManager.getSales() || [];
                console.log('💰 عدد فواتير المبيعات:', sales.length);

                sales.forEach(sale => {
                    if (sale.products && Array.isArray(sale.products)) {
                        sale.products.forEach(saleProduct => {
                            // التحقق من تطابق المنتج
                            if (saleProduct.productId == product.id ||
                                saleProduct.name === product.name ||
                                saleProduct.id == product.id) {

                                operations.push({
                                    date: sale.date || formatDateGregorian(new Date()),
                                    type: 'sale',
                                    quantity: parseInt(saleProduct.quantity) || 0,
                                    price: parseFloat(saleProduct.price) || 0,
                                    reference: sale.invoiceNumber || `INV-${sale.id}`,
                                    createdAt: sale.createdAt || new Date().toISOString(),
                                    customer: sale.customerName || 'عميل نقدي'
                                });
                            }
                        });
                    }
                });

                // 2. جلب عمليات الشراء (المشتريات) من مصادر متعددة
                let purchases = [];

                // المحاولة الأولى: النظام المركزي بطرق متعددة
                if (window.dataManager) {
                    if (window.dataManager.getPurchases) {
                        purchases = window.dataManager.getPurchases() || [];
                        console.log('🛒 جلب المشتريات من getPurchases():', purchases.length);
                    } else if (window.dataManager.purchases) {
                        purchases = window.dataManager.purchases || [];
                        console.log('🛒 جلب المشتريات من dataManager.purchases:', purchases.length);
                    } else if (window.dataManager.data && window.dataManager.data.purchases) {
                        purchases = window.dataManager.data.purchases || [];
                        console.log('🛒 جلب المشتريات من dataManager.data.purchases:', purchases.length);
                    }
                }

                // المحاولة الثانية: localStorage مباشرة
                if (purchases.length === 0) {
                    purchases = JSON.parse(localStorage.getItem('monjizPurchases')) || [];
                    console.log('🛒 جلب المشتريات من localStorage:', purchases.length);
                }

                // المحاولة الثالثة: أسماء مختلفة في localStorage
                if (purchases.length === 0) {
                    const alternativeKeys = ['purchases', 'monjizPurchaseInvoices', 'purchaseInvoices'];
                    for (const key of alternativeKeys) {
                        const data = JSON.parse(localStorage.getItem(key)) || [];
                        if (data.length > 0) {
                            purchases = data;
                            console.log(`🛒 جلب المشتريات من ${key}:`, purchases.length);
                            break;
                        }
                    }
                }

                console.log('🛒 إجمالي فواتير المشتريات المتاحة:', purchases.length);

                if (purchases.length === 0) {
                    console.log('⚠️ لا توجد مشتريات في النظام - تحقق من إضافة فواتير الشراء');
                    console.log('🔍 مفاتيح localStorage المتاحة:', Object.keys(localStorage).filter(key => key.includes('purchase') || key.includes('Purchase')));
                }

                purchases.forEach((purchase, purchaseIndex) => {
                    console.log(`🔍 فحص فاتورة شراء ${purchaseIndex + 1}:`, {
                        id: purchase.id,
                        date: purchase.date,
                        supplier: purchase.supplierName || purchase.supplier,
                        productsCount: purchase.products ? purchase.products.length : (purchase.items ? purchase.items.length : 0),
                        structure: Object.keys(purchase)
                    });

                    // دعم بنى مختلفة للمنتجات (products أو items)
                    const purchaseProducts = purchase.products || purchase.items || [];

                    if (purchaseProducts && Array.isArray(purchaseProducts)) {
                        purchaseProducts.forEach((purchaseProduct, productIndex) => {
                            console.log(`   📦 منتج ${productIndex + 1} في الفاتورة:`, {
                                productId: purchaseProduct.productId,
                                id: purchaseProduct.id,
                                name: purchaseProduct.name,
                                quantity: purchaseProduct.quantity,
                                price: purchaseProduct.price,
                                cost: purchaseProduct.cost,
                                unitPrice: purchaseProduct.unitPrice
                            });

                            // التحقق من تطابق المنتج بطرق متعددة
                            const matchById = purchaseProduct.productId == product.id;
                            const matchByName = purchaseProduct.name === product.name;
                            const matchByDirectId = purchaseProduct.id == product.id;
                            const matchByStringId = String(purchaseProduct.productId) === String(product.id);
                            const matchByItemId = purchaseProduct.itemId == product.id;
                            const matchByProductName = purchaseProduct.productName === product.name;

                            console.log(`   🎯 نتائج المطابقة للمنتج المطلوب (${product.name}, ID: ${product.id}):`, {
                                matchById,
                                matchByName,
                                matchByDirectId,
                                matchByStringId,
                                matchByItemId,
                                matchByProductName
                            });

                            if (matchById || matchByName || matchByDirectId || matchByStringId || matchByItemId || matchByProductName) {
                                console.log(`   ✅ تم العثور على مطابقة! إضافة عملية شراء`);

                                // استخراج السعر من حقول مختلفة محتملة
                                const productPrice = parseFloat(purchaseProduct.price) ||
                                                   parseFloat(purchaseProduct.cost) ||
                                                   parseFloat(purchaseProduct.unitPrice) ||
                                                   parseFloat(purchaseProduct.purchasePrice) ||
                                                   parseFloat(purchaseProduct.unitCost) || 0;

                                // استخراج الكمية من حقول مختلفة
                                const productQuantity = parseInt(purchaseProduct.quantity) ||
                                                      parseInt(purchaseProduct.qty) ||
                                                      parseInt(purchaseProduct.amount) || 0;

                                const purchaseOperation = {
                                    date: purchase.date || purchase.createdAt || formatDateGregorian(new Date()),
                                    type: 'purchase',
                                    quantity: productQuantity,
                                    price: productPrice,
                                    reference: purchase.invoiceNumber || purchase.referenceNumber || purchase.number || `PUR-${purchase.id}`,
                                    createdAt: purchase.createdAt || purchase.date || new Date().toISOString(),
                                    supplier: purchase.supplierName || purchase.supplier || 'مورد نقدي'
                                };

                                console.log(`   📋 تفاصيل العملية المضافة:`, purchaseOperation);
                                operations.push(purchaseOperation);
                            } else {
                                console.log(`   ❌ لا توجد مطابقة للمنتج`);
                            }
                        });
                    } else {
                        console.log(`   ⚠️ فاتورة الشراء لا تحتوي على منتجات أو البنية غير صحيحة`);
                    }
                });

                // 3. تطبيق فلاتر التاريخ إذا كانت موجودة
                let filteredOperations = operations;
                if (filters.dateFrom || filters.dateTo) {
                    filteredOperations = operations.filter(op => {
                        const opDate = new Date(op.createdAt);
                        let include = true;

                        if (filters.dateFrom) {
                            const fromDate = new Date(filters.dateFrom);
                            include = include && opDate >= fromDate;
                        }

                        if (filters.dateTo) {
                            const toDate = new Date(filters.dateTo);
                            toDate.setHours(23, 59, 59, 999); // نهاية اليوم
                            include = include && opDate <= toDate;
                        }

                        return include;
                    });
                }

                // 4. ترتيب العمليات حسب التاريخ (الأحدث أولاً)
                filteredOperations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                const purchaseOps = filteredOperations.filter(op => op.type === 'purchase');
                const saleOps = filteredOperations.filter(op => op.type === 'sale');

                console.log(`✅ تم جلب ${filteredOperations.length} عملية فعلية للمنتج ${product.name}`);
                console.log(`   🛒 عمليات شراء: ${purchaseOps.length}`);
                console.log(`   💰 عمليات بيع: ${saleOps.length}`);

                if (purchaseOps.length > 0) {
                    console.log(`   📋 تفاصيل المشتريات:`, purchaseOps.map(op => ({
                        date: op.date,
                        quantity: op.quantity,
                        price: op.price,
                        reference: op.reference
                    })));
                }

                if (saleOps.length > 0) {
                    console.log(`   📋 تفاصيل المبيعات:`, saleOps.map(op => ({
                        date: op.date,
                        quantity: op.quantity,
                        price: op.price,
                        reference: op.reference
                    })));
                }

                return filteredOperations;

            } catch (error) {
                console.error('❌ خطأ في جلب العمليات:', error);
                return [];
            }
        }

        // تم حذف الدالة المكررة - سيتم استخدام الدالة المحسنة في الأسفل



        // دوال التصدير محسنة
        function exportToExcel(reportType) {
            // إظهار مؤشر التحميل
            showLoadingMessage('جاري تصدير التقرير إلى Excel...');

            setTimeout(() => {
                hideLoadingMessage();
                showSuccessMessage(`تم تصدير تقرير ${getReportTitle(reportType)} إلى Excel بنجاح!`);
            }, 1500);
        }

        function exportToPDF(reportType) {
            // إظهار مؤشر التحميل
            showLoadingMessage('جاري تصدير التقرير إلى PDF...');

            setTimeout(() => {
                hideLoadingMessage();
                showSuccessMessage(`تم تصدير تقرير ${getReportTitle(reportType)} إلى PDF بنجاح!`);
            }, 1500);
        }

        function generateDetailedReport() {
            try {
                console.log('🔄 إنشاء التقرير المفصل...');
                console.log('📊 نوع التقرير الحالي:', currentReportType);

                // التحقق من نوع التقرير الحالي
                if (!currentReportType) {
                    console.error('❌ لم يتم تحديد نوع التقرير');
                    throw new Error('لم يتم تحديد نوع التقرير');
                }

                // جمع المرشحات من الواجهة
                const dateFrom = document.getElementById('date-from')?.value || '';
                const dateTo = document.getElementById('date-to')?.value || '';
                const account = document.getElementById('report-account')?.value || '';
                const branch = document.getElementById('report-branch')?.value || '';

                console.log('🔍 المرشحات المجمعة:', { dateFrom, dateTo, account, branch });

                // الحصول على بيانات التقرير المفصل مع المرشحات
                console.log('📋 جاري الحصول على بيانات التقرير...');
                const reportData = getDetailedReportData(currentReportType, {
                    dateFrom: dateFrom,
                    dateTo: dateTo,
                    account: account,
                    branch: branch
                });
                console.log('📊 بيانات التقرير:', reportData);

                if (!reportData) {
                    console.error('❌ لم يتم إرجاع بيانات التقرير');
                    throw new Error('فشل في الحصول على بيانات التقرير');
                }

                if (!reportData.html) {
                    console.error('❌ محتوى HTML للتقرير فارغ');
                    throw new Error('فشل في إنشاء محتوى التقرير');
                }

                // عرض التقرير في الواجهة
                const reportContent = document.getElementById('report-content');
                console.log('🎯 عنصر عرض التقرير:', reportContent);

                if (reportContent) {
                    console.log('📝 جاري عرض التقرير في الواجهة...');
                    reportContent.innerHTML = reportData.html;
                    console.log('✅ تم عرض التقرير في الواجهة بنجاح');
                } else {
                    console.error('❌ عنصر عرض التقرير غير موجود');
                    throw new Error('عنصر عرض التقرير غير موجود');
                }

                console.log('تم إنشاء التقرير:', reportData.title);
                showSuccessMessage('تم إنشاء التقرير المفصل بنجاح!');

                // عرض الرسوم البيانية إذا كانت موجودة
                setTimeout(() => {
                    if (currentReportType === 'daily-sales' || currentReportType === 'monthly-sales') {
                        const canvas = document.getElementById('dailySalesChart') || document.getElementById('monthlySalesChart');
                        if (canvas) {
                            const salesData = generateSalesReport();
                            displaySalesChart(canvas.id, salesData);
                        }
                    }
                }, 500);

            } catch (error) {
                console.error('خطأ في إنشاء التقرير:', error);
                showErrorMessage('حدث خطأ في إنشاء التقرير: ' + error.message);

                // عرض رسالة خطأ في منطقة التقرير
                const reportContent = document.getElementById('report-content');
                if (reportContent) {
                    reportContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <h3>خطأ في إنشاء التقرير</h3>
                            <p>${error.message}</p>
                            <button onclick="generateDetailedReport()" class="btn-enhanced" style="margin-top: 20px;">
                                <i class="fas fa-redo"></i> إعادة المحاولة
                            </button>
                        </div>
                    `;
                }
            }
        }

        // دوال مساعدة للرسائل
        function getReportTitle(reportType) {
            const titles = {
                'balance-sheet': 'قائمة المركز المالي',
                'profit-loss': 'قائمة الأرباح والخسائر',
                'daily': 'المبيعات اليومية',
                'current-stock': 'المخزون الحالي'
            };
            return titles[reportType] || reportType;
        }

        function showLoadingMessage(message) {
            const existingMessage = document.getElementById('loading-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                min-width: 300px;
            `;

            loadingDiv.innerHTML = `
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                <p style="margin: 0; color: #333; font-weight: 600;">${message}</p>
            `;

            document.body.appendChild(loadingDiv);
        }

        function hideLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        function showSuccessMessage(message) {
            const existingMessage = document.getElementById('success-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const successDiv = document.createElement('div');
            successDiv.id = 'success-message';
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(40,167,69,0.3);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;

            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle" style="font-size: 20px;"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 300);
            }, 3000);
        }

        function showErrorMessage(message) {
            const existingMessage = document.getElementById('error-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #dc3545, #c82333);
                color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(220,53,69,0.3);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;

            errorDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-circle" style="font-size: 20px;"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 300);
            }, 4000);
        }

        // تهيئة التحسينات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // إضافة CSS للرسوم المتحركة
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
                .report-categories-modern, #selected-report {
                    transition: opacity 0.3s ease;
                }
            `;
            document.head.appendChild(style);

            // تحديث قوائم العملاء والمنتجات والموردين من النظام المركزي
            setTimeout(() => {
                if (window.dataManager) {
                    updateCustomerFiltersFromStorage();
                    updateProductFiltersFromStorage();
                    updateSupplierFiltersFromStorage();
                    updateSalesDataFromStorage();
                    updatePurchasesDataFromStorage();
                    updateAccountsDataFromStorage();

                    // إعداد مراقبة التحديثات المباشرة
                    setupRealtimeDataMonitoring();
                } else {
                    console.error('النظام المركزي غير محمل في التقارير');
                }
            }, 500);

            // تحميل مسبق للبيانات
            setTimeout(preloadReportData, 1000);

            // إضافة تأثيرات بصرية
            setTimeout(addVisualEnhancements, 500);
        });

        // دالة تحديث بيانات المبيعات من localStorage
        function updateSalesDataFromStorage() {
            console.log('🔄 تحديث بيانات المبيعات...');

            // الحصول على البيانات من النظام المركزي أولاً
            let salesData = [];

            if (window.dataManager) {
                salesData = window.dataManager.getSales();
                console.log('✅ تم تحميل البيانات من النظام المركزي:', salesData.length, 'فاتورة');
            } else {
                // البحث في localStorage كبديل
                const invoicesData = JSON.parse(localStorage.getItem('monjizInvoices')) || [];
                const salesLocalData = JSON.parse(localStorage.getItem('monjizSales')) || [];

                // دمج البيانات من المفتاحين
                salesData = [...invoicesData, ...salesLocalData];

                // إزالة المكررات
                salesData = salesData.filter((sale, index, self) =>
                    index === self.findIndex(s => s.id === sale.id)
                );

                console.log('⚠️ تم تحميل البيانات من localStorage:', salesData.length, 'فاتورة');
            }

            if (salesData.length > 0) {
                // تحديث البيانات الوهمية بالبيانات الحقيقية
                window.realSalesData = salesData;

                // تحديث إحصائيات المبيعات
                updateSalesStatistics(salesData);

                console.log('✅ تم تحديث بيانات المبيعات الحقيقية');

                // عرض تفاصيل البيانات
                salesData.forEach((sale, index) => {
                    console.log(`   ${index + 1}. ${sale.id} - ${sale.customerName} - ${sale.total} ر.س`);
                });
            } else {
                console.log('⚠️ لا توجد بيانات مبيعات');
            }
        }

        // دالة تحديث بيانات المشتريات من localStorage
        function updatePurchasesDataFromStorage() {
            const purchasesData = JSON.parse(localStorage.getItem('monjizPurchases')) || [];
            console.log('تحديث بيانات المشتريات من localStorage:', purchasesData.length, 'فاتورة شراء');

            if (purchasesData.length > 0) {
                // تحديث البيانات الوهمية بالبيانات الحقيقية
                window.realPurchasesData = purchasesData;

                console.log('تم تحديث بيانات المشتريات الحقيقية');
            }
        }

        // دالة تحديث بيانات الحسابات من localStorage
        function updateAccountsDataFromStorage() {
            const accountsData = JSON.parse(localStorage.getItem('chartOfAccounts')) ||
                                JSON.parse(localStorage.getItem('monjizAccounts')) || [];
            console.log('تحديث بيانات الحسابات من localStorage:', accountsData.length, 'حساب');

            if (accountsData.length > 0) {
                // تحديث البيانات الوهمية بالبيانات الحقيقية
                window.realAccountsData = accountsData;

                // تحديث التقارير المالية
                updateFinancialReportsData(accountsData);

                console.log('تم تحديث بيانات الحسابات الحقيقية');
            }
        }

        // دالة إعداد مراقبة التحديثات المباشرة
        function setupRealtimeDataMonitoring() {
            console.log('🔄 إعداد مراقبة التحديثات المباشرة للتقارير...');

            // مراقبة تغييرات localStorage
            window.addEventListener('storage', function(e) {
                console.log('🔔 تم اكتشاف تغيير في البيانات:', e.key);

                switch(e.key) {
                    case 'monjizSales':
                    case 'monjizInvoices':
                        updateSalesDataFromStorage();
                        refreshCurrentReport();
                        break;
                    case 'monjizPurchases':
                        updatePurchasesDataFromStorage();
                        refreshCurrentReport();
                        break;
                    case 'monjizCustomers':
                        updateCustomerFiltersFromStorage();
                        refreshCurrentReport();
                        break;
                    case 'monjizSuppliers':
                        updateSupplierFiltersFromStorage();
                        refreshCurrentReport();
                        break;
                    case 'monjizProducts':
                        updateProductFiltersFromStorage();
                        refreshCurrentReport();
                        break;
                    case 'chartOfAccounts':
                    case 'monjizAccounts':
                        updateAccountsDataFromStorage();
                        refreshCurrentReport();
                        break;
                    case 'monjizStockMovements':
                        console.log('🔄 تحديث حركات المخزون...');
                        refreshCurrentReport();
                        break;
                }
            });

            // مراقبة BroadcastChannel إذا كان متاحاً
            if (window.BroadcastChannel) {
                const channel = new BroadcastChannel('monjiz-updates');
                channel.addEventListener('message', function(event) {
                    console.log('🔔 تم استلام تحديث عبر BroadcastChannel:', event.data);

                    switch(event.data.type) {
                        case 'sales-updated':
                        case 'invoice-added':
                            updateSalesDataFromStorage();
                            refreshCurrentReport();
                            break;
                        case 'purchase-added':
                            updatePurchasesDataFromStorage();
                            refreshCurrentReport();
                            break;
                        case 'customer-added':
                        case 'customers-updated':
                            updateCustomerFiltersFromStorage();
                            refreshCurrentReport();
                            break;
                        case 'supplier-added':
                        case 'suppliers-updated':
                            updateSupplierFiltersFromStorage();
                            refreshCurrentReport();
                            break;
                        case 'product-added':
                        case 'products-updated':
                            updateProductFiltersFromStorage();
                            refreshCurrentReport();
                            break;
                        case 'accounts-updated':
                            updateAccountsDataFromStorage();
                            refreshCurrentReport();
                            break;
                    }
                });
            }

            // مراقبة دورية كل 30 ثانية
            setInterval(() => {
                console.log('🔄 تحديث دوري للبيانات...');
                updateAllDataFromStorage();
            }, 30000);

            console.log('✅ تم إعداد مراقبة التحديثات المباشرة');
        }

        // دالة تحديث جميع البيانات
        function updateAllDataFromStorage() {
            updateSalesDataFromStorage();
            updatePurchasesDataFromStorage();
            updateCustomerFiltersFromStorage();
            updateSupplierFiltersFromStorage();
            updateProductFiltersFromStorage();
            updateAccountsDataFromStorage();
        }

        // دالة إعادة تحميل التقرير الحالي مع الحفاظ على الفلاتر
        function refreshCurrentReport() {
            // تجاهل إعادة التحميل إذا كان المستخدم يطبق فلاتر حالياً
            if (window.isApplyingFilters) {
                console.log('⏸️ تم تجاهل إعادة التحميل التلقائي - المستخدم يطبق فلاتر');
                return;
            }

            if (currentReportType && currentView === 'report-detail') {
                console.log('🔄 إعادة تحميل التقرير الحالي:', currentReportType);
                console.log('💾 الفلاتر المحفوظة:', savedFilters[currentReportType]);

                // تأخير قصير لضمان تحديث البيانات
                setTimeout(() => {
                    // استخدام الفلاتر المحفوظة إذا كانت موجودة
                    const filters = savedFilters[currentReportType] || {};
                    console.log('🔧 تطبيق الفلاتر المحفوظة:', filters);

                    const reportData = getDetailedReportData(currentReportType, filters);
                    const reportContent = document.getElementById('report-content');
                    if (reportContent) {
                        reportContent.innerHTML = reportData.html;
                        console.log('✅ تم تحديث التقرير الحالي مع الفلاتر');

                        // استعادة قيم الفلاتر في الواجهة
                        if (filters.dateFrom || filters.dateTo || filters.account || filters.branch) {
                            restoreSavedFilters(currentReportType);
                        }
                    }
                }, 500);
            }
        }

        // دالة تحديث إحصائيات المبيعات
        function updateSalesStatistics(invoicesData) {
            // حساب إجمالي المبيعات
            let totalSales = 0;
            let totalInvoices = invoicesData.length;

            invoicesData.forEach(invoice => {
                if (invoice.total) {
                    totalSales += parseFloat(invoice.total) || 0;
                }
            });

            // تحديث عناصر الإحصائيات في الصفحة
            const totalSalesElements = document.querySelectorAll('.total-sales, [data-stat="total-sales"]');
            totalSalesElements.forEach(element => {
                element.textContent = totalSales.toFixed(2) + ' ر.س';
            });

            const totalInvoicesElements = document.querySelectorAll('.total-invoices, [data-stat="total-invoices"]');
            totalInvoicesElements.forEach(element => {
                element.textContent = totalInvoices;
            });

            console.log('تم تحديث الإحصائيات:', { totalSales, totalInvoices });
        }

        // دالة تحديث بيانات التقارير المالية
        function updateFinancialReportsData(accountsData) {
            console.log('🏦 تحديث بيانات التقارير المالية...');

            // تصنيف الحسابات حسب النوع
            const assetAccounts = accountsData.filter(acc => acc.type === 'assets');
            const liabilityAccounts = accountsData.filter(acc => acc.type === 'liabilities');
            const equityAccounts = accountsData.filter(acc => acc.type === 'equity');
            const revenueAccounts = accountsData.filter(acc => acc.type === 'revenue');
            const expenseAccounts = accountsData.filter(acc => acc.type === 'expenses');

            // حساب الأرصدة
            const totalAssets = assetAccounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
            const totalLiabilities = liabilityAccounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
            const totalEquity = equityAccounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
            const totalRevenue = revenueAccounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
            const totalExpenses = expenseAccounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);

            // حساب صافي الربح
            const netProfit = totalRevenue - totalExpenses;

            // تحديث البيانات العامة للتقارير المالية
            window.financialData = {
                assets: {
                    accounts: assetAccounts,
                    total: totalAssets,
                    formatted: totalAssets.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })
                },
                liabilities: {
                    accounts: liabilityAccounts,
                    total: totalLiabilities,
                    formatted: totalLiabilities.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })
                },
                equity: {
                    accounts: equityAccounts,
                    total: totalEquity,
                    formatted: totalEquity.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })
                },
                revenue: {
                    accounts: revenueAccounts,
                    total: totalRevenue,
                    formatted: totalRevenue.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })
                },
                expenses: {
                    accounts: expenseAccounts,
                    total: totalExpenses,
                    formatted: totalExpenses.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })
                },
                netProfit: {
                    amount: netProfit,
                    formatted: netProfit.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })
                }
            };

            console.log('✅ تم تحديث بيانات التقارير المالية:', {
                totalAssets,
                totalLiabilities,
                totalEquity,
                netProfit
            });
        }

        // تم حذف الدالة المبسطة - استخدام الدالة المفصلة بدلاً منها
        function createPurchasesDailyReportOLD_REMOVED(dateRange, filters = {}) {
            const purchasesData = window.dataManager ? window.dataManager.getPurchases() : [];

            if (purchasesData.length === 0) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>المشتريات اليومية</h2>
                            <p>الفترة: ${dateRange}</p>
                        </div>
                        <div class="no-data-message">
                            <i class="fas fa-shopping-cart"></i>
                            <p>لا توجد فواتير شراء في هذه الفترة</p>
                            <small>قم بإضافة فواتير شراء جديدة لعرض التقرير</small>
                        </div>
                    </div>
                `;
            }

            let totalPurchases = 0;
            let totalAmount = 0;
            let purchasesHtml = '';

            purchasesData.forEach(purchase => {
                totalPurchases++;
                totalAmount += parseFloat(purchase.total) || 0;

                purchasesHtml += `
                    <tr>
                        <td>${purchase.id}</td>
                        <td>${purchase.date}</td>
                        <td>${purchase.supplier}</td>
                        <td>${purchase.items ? purchase.items.length : 0}</td>
                        <td>${purchase.total ? purchase.total.toFixed(2) : '0.00'} ر.س</td>
                        <td>${purchase.payment || 'نقداً'}</td>
                    </tr>
                `;
            });

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>المشتريات اليومية</h2>
                        <p>الفترة: ${dateRange}</p>
                    </div>

                    <div class="report-summary">
                        <div class="summary-card">
                            <h3>الفواتير</h3>
                            <p class="summary-value">${totalPurchases}</p>
                        </div>
                        <div class="summary-card">
                            <h3>المبلغ الإجمالي</h3>
                            <p class="summary-value">${totalAmount.toFixed(2)} ر.س</p>
                        </div>
                        <div class="summary-card">
                            <h3>متوسط الفاتورة</h3>
                            <p class="summary-value">${totalPurchases > 0 ? (totalAmount / totalPurchases).toFixed(2) : '0.00'} ر.س</p>
                        </div>
                    </div>

                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">رقم الفاتورة</th>
                                    <th style="width: 12%;">التاريخ</th>
                                    <th style="width: 25%;">المورد</th>
                                    <th style="width: 10%;">الأصناف</th>
                                    <th style="width: 18%;">المبلغ</th>
                                    <th style="width: 20%;">طريقة الدفع</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${purchasesHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // تم حذف الدالة المبسطة - استخدام الدالة المفصلة بدلاً منها
        function createPurchasesBySupplierReportOLD_REMOVED(dateRange, filters = {}) {
            // الحصول على البيانات من النظام المركزي
            const purchasesData = window.dataManager ? window.dataManager.getPurchases() : [];
            const suppliersData = window.dataManager ? window.dataManager.getSuppliers() : [];

            console.log('بيانات المشتريات:', purchasesData);
            console.log('بيانات الموردين:', suppliersData);

            if (purchasesData.length === 0) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>المشتريات حسب المورد</h2>
                            <p>الفترة: ${dateRange}</p>
                        </div>
                        <div class="no-data-message">
                            <i class="fas fa-info-circle"></i>
                            <p>لا توجد فواتير شراء في هذه الفترة</p>
                        </div>
                    </div>
                `;
            }

            // تجميع البيانات حسب المورد
            const supplierData = {};

            purchasesData.forEach(purchase => {
                const supplier = purchase.supplier || 'غير محدد';

                if (!supplierData[supplier]) {
                    supplierData[supplier] = {
                        name: supplier,
                        invoices: 0,
                        totalAmount: 0,
                        items: 0
                    };
                }

                supplierData[supplier].invoices++;
                supplierData[supplier].totalAmount += parseFloat(purchase.total) || 0;
                supplierData[supplier].items += purchase.items ? purchase.items.length : 0;
            });

            let suppliersHtml = '';
            Object.values(supplierData).forEach(supplier => {
                suppliersHtml += `
                    <tr>
                        <td>${supplier.name}</td>
                        <td>${supplier.invoices}</td>
                        <td>${supplier.items}</td>
                        <td>${supplier.totalAmount.toFixed(2)} ر.س</td>
                        <td>${supplier.invoices > 0 ? (supplier.totalAmount / supplier.invoices).toFixed(2) : '0.00'} ر.س</td>
                    </tr>
                `;
            });

            const totalSuppliers = Object.keys(supplierData).length;
            const totalAmount = Object.values(supplierData).reduce((sum, supplier) => sum + supplier.totalAmount, 0);

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>المشتريات حسب المورد</h2>
                        <p>الفترة: ${dateRange}</p>
                    </div>

                    <div class="report-summary">
                        <div class="summary-card">
                            <h3>عدد الموردين</h3>
                            <p class="summary-value">${totalSuppliers}</p>
                        </div>
                        <div class="summary-card">
                            <h3>إجمالي المشتريات</h3>
                            <p class="summary-value">${totalAmount.toFixed(2)} ر.س</p>
                        </div>
                    </div>

                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>المورد</th>
                                    <th>عدد الفواتير</th>
                                    <th>عدد الأصناف</th>
                                    <th>إجمالي المبلغ</th>
                                    <th>متوسط الفاتورة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${suppliersHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // دالة تقرير قائمة الموردين
        function createSupplierListReport(dateRange, filters = {}) {
            const suppliersData = window.dataManager ? window.dataManager.getSuppliers() : [];
            console.log('قائمة الموردين للتقرير:', suppliersData);

            if (suppliersData.length === 0) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>قائمة الموردين</h2>
                            <p>الفترة: ${dateRange}</p>
                        </div>
                        <div class="no-data-message">
                            <i class="fas fa-info-circle"></i>
                            <p>لا توجد موردين مسجلين في النظام</p>
                        </div>
                    </div>
                `;
            }

            let suppliersHtml = '';
            suppliersData.forEach(supplier => {
                suppliersHtml += `
                    <tr>
                        <td>${supplier.name}</td>
                        <td>${supplier.phone || 'غير محدد'}</td>
                        <td>${supplier.email || 'غير محدد'}</td>
                        <td>${supplier.address || 'غير محدد'}</td>
                        <td>${supplier.category || 'عام'}</td>
                    </tr>
                `;
            });

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>قائمة الموردين</h2>
                        <p>الفترة: ${dateRange}</p>
                    </div>

                    <div class="report-summary">
                        <div class="summary-card">
                            <h3>إجمالي الموردين</h3>
                            <p class="summary-value">${suppliersData.length}</p>
                        </div>
                    </div>

                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>اسم المورد</th>
                                    <th>الهاتف</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>العنوان</th>
                                    <th>الفئة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${suppliersHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // دالة تقرير أرصدة الموردين
        function createSupplierBalancesReport(dateRange, filters = {}) {
            const suppliersData = window.dataManager ? window.dataManager.getSuppliers() : [];
            const purchasesData = window.dataManager ? window.dataManager.getPurchases() : [];

            if (suppliersData.length === 0) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>أرصدة الموردين</h2>
                            <p>الفترة: ${dateRange}</p>
                        </div>
                        <div class="no-data-message">
                            <i class="fas fa-info-circle"></i>
                            <p>لا توجد موردين مسجلين في النظام</p>
                        </div>
                    </div>
                `;
            }

            // حساب أرصدة الموردين من فواتير الشراء
            const supplierBalances = {};

            suppliersData.forEach(supplier => {
                supplierBalances[supplier.name] = {
                    name: supplier.name,
                    totalPurchases: 0,
                    totalAmount: 0,
                    invoicesCount: 0
                };
            });

            purchasesData.forEach(purchase => {
                const supplierName = purchase.supplier;
                if (supplierBalances[supplierName]) {
                    supplierBalances[supplierName].totalAmount += parseFloat(purchase.total) || 0;
                    supplierBalances[supplierName].invoicesCount++;
                }
            });

            let balancesHtml = '';
            Object.values(supplierBalances).forEach(supplier => {
                balancesHtml += `
                    <tr>
                        <td>${supplier.name}</td>
                        <td>${supplier.invoicesCount}</td>
                        <td>${supplier.totalAmount.toFixed(2)} ر.س</td>
                        <td>${supplier.invoicesCount > 0 ? (supplier.totalAmount / supplier.invoicesCount).toFixed(2) : '0.00'} ر.س</td>
                        <td><span class="status-paid">مدفوع</span></td>
                    </tr>
                `;
            });

            const totalAmount = Object.values(supplierBalances).reduce((sum, supplier) => sum + supplier.totalAmount, 0);

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>أرصدة الموردين</h2>
                        <p>الفترة: ${dateRange}</p>
                    </div>

                    <div class="report-summary">
                        <div class="summary-card">
                            <h3>إجمالي المستحقات</h3>
                            <p class="summary-value">${totalAmount.toFixed(2)} ر.س</p>
                        </div>
                    </div>

                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>المورد</th>
                                    <th>عدد الفواتير</th>
                                    <th>إجمالي المبلغ</th>
                                    <th>متوسط الفاتورة</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${balancesHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // دالة تحليل الموردين
        function createSupplierAnalysisReport(dateRange, filters = {}) {
            const purchasesData = window.dataManager ? window.dataManager.getPurchases() : [];

            if (purchasesData.length === 0) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>تحليل الموردين</h2>
                            <p>الفترة: ${dateRange}</p>
                        </div>
                        <div class="no-data-message">
                            <i class="fas fa-info-circle"></i>
                            <p>لا توجد فواتير شراء للتحليل</p>
                        </div>
                    </div>
                `;
            }

            // تحليل أداء الموردين
            const supplierAnalysis = {};

            purchasesData.forEach(purchase => {
                const supplier = purchase.supplier || 'غير محدد';

                if (!supplierAnalysis[supplier]) {
                    supplierAnalysis[supplier] = {
                        name: supplier,
                        invoices: 0,
                        totalAmount: 0,
                        totalItems: 0,
                        avgDeliveryTime: 0,
                        performance: 'ممتاز'
                    };
                }

                supplierAnalysis[supplier].invoices++;
                supplierAnalysis[supplier].totalAmount += parseFloat(purchase.total) || 0;
                supplierAnalysis[supplier].totalItems += purchase.items ? purchase.items.length : 0;
            });

            let analysisHtml = '';
            Object.values(supplierAnalysis).forEach(supplier => {
                const avgInvoice = supplier.invoices > 0 ? (supplier.totalAmount / supplier.invoices) : 0;
                const performance = avgInvoice > 5000 ? 'ممتاز' : avgInvoice > 2000 ? 'جيد' : 'متوسط';

                analysisHtml += `
                    <tr>
                        <td>${supplier.name}</td>
                        <td>${supplier.invoices}</td>
                        <td>${supplier.totalAmount.toFixed(2)} ر.س</td>
                        <td>${avgInvoice.toFixed(2)} ر.س</td>
                        <td>${supplier.totalItems}</td>
                        <td><span class="performance-${performance.toLowerCase()}">${performance}</span></td>
                    </tr>
                `;
            });

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>تحليل الموردين</h2>
                        <p>الفترة: ${dateRange}</p>
                    </div>

                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>المورد</th>
                                    <th>عدد الفواتير</th>
                                    <th>إجمالي المبلغ</th>
                                    <th>متوسط الفاتورة</th>
                                    <th>إجمالي الأصناف</th>
                                    <th>التقييم</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${analysisHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // دالة تقييم الموردين
        function createSupplierEvaluationReport(dateRange, filters = {}) {
            return createSupplierAnalysisReport(dateRange, filters);
        }

        // دالة تقرير المشتريات الشهرية
        function createPurchasesMonthlyReport(dateRange, filters = {}) {
            const purchasesData = window.dataManager ? window.dataManager.getPurchases() : [];

            if (purchasesData.length === 0) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>المشتريات الشهرية</h2>
                            <p>الفترة: ${dateRange}</p>
                        </div>
                        <div class="no-data-message">
                            <i class="fas fa-info-circle"></i>
                            <p>لا توجد فواتير شراء في هذه الفترة</p>
                        </div>
                    </div>
                `;
            }

            // تجميع البيانات حسب الشهر
            const monthlyData = {};

            purchasesData.forEach(purchase => {
                const date = new Date(purchase.createdAt || purchase.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('ar-SA', { year: 'numeric', month: 'long' });

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        month: monthName,
                        invoices: 0,
                        totalAmount: 0,
                        suppliers: new Set()
                    };
                }

                monthlyData[monthKey].invoices++;
                monthlyData[monthKey].totalAmount += parseFloat(purchase.total) || 0;
                monthlyData[monthKey].suppliers.add(purchase.supplier);
            });

            let monthlyHtml = '';
            Object.values(monthlyData).forEach(month => {
                monthlyHtml += `
                    <tr>
                        <td>${month.month}</td>
                        <td>${month.invoices}</td>
                        <td>${month.suppliers.size}</td>
                        <td>${month.totalAmount.toFixed(2)} ر.س</td>
                        <td>${month.invoices > 0 ? (month.totalAmount / month.invoices).toFixed(2) : '0.00'} ر.س</td>
                    </tr>
                `;
            });

            const totalAmount = Object.values(monthlyData).reduce((sum, month) => sum + month.totalAmount, 0);
            const totalInvoices = Object.values(monthlyData).reduce((sum, month) => sum + month.invoices, 0);

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>المشتريات الشهرية</h2>
                        <p>الفترة: ${dateRange}</p>
                    </div>

                    <div class="report-summary">
                        <div class="summary-card">
                            <h3>إجمالي الفواتير</h3>
                            <p class="summary-value">${totalInvoices}</p>
                        </div>
                        <div class="summary-card">
                            <h3>إجمالي المبلغ</h3>
                            <p class="summary-value">${totalAmount.toFixed(2)} ر.س</p>
                        </div>
                    </div>

                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>الشهر</th>
                                    <th>عدد الفواتير</th>
                                    <th>عدد الموردين</th>
                                    <th>إجمالي المبلغ</th>
                                    <th>متوسط الفاتورة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthlyHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // تم حذف تقرير المشتريات حسب الفئة واستبداله بتقرير المشتريات حسب المنتج





        // وظائف إنشاء التقارير المفقودة
        // تم نقل دالة createDailySalesReport إلى الأعلى لتجنب التكرار

        function getPaymentMethodText(method) {
            const methodMap = {
                'cash': 'نقدي',
                'credit': 'آجل', 
                'card': 'بطاقة',
                'bank': 'تحويل بنكي',
                'نقدي': 'نقدي',
                'آجل': 'آجل',
                'بطاقة': 'بطاقة',
                'تحويل بنكي': 'تحويل بنكي'
            };
            return methodMap[method] || 'نقدي';
        }



        function createCustomerSalesReport(dateRange, filters) {
            const customerData = generateCustomersReport();

            let customersTable = '';
            if (customerData.customers && customerData.customers.length > 0) {
                customersTable = `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>العميل</th>
                                <th>الهاتف</th>
                                <th>عدد المشتريات</th>
                                <th>إجمالي الإنفاق (ر.س)</th>
                                <th>متوسط الطلب (ر.س)</th>
                                <th>آخر شراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customerData.customers.map(customer => `
                                <tr>
                                    <td>${customer.name}</td>
                                    <td>${customer.phone}</td>
                                    <td>${customer.totalPurchases}</td>
                                    <td>${formatCurrency(customer.totalSpent)}</td>
                                    <td>${formatCurrency(customer.averageOrderValue)}</td>
                                    <td>${customer.lastPurchaseDate ?
                                        formatDateGregorian(customer.lastPurchaseDate) :
                                        'لا يوجد'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                customersTable = '<p style="text-align: center; color: #666; padding: 20px;">لا توجد بيانات عملاء</p>';
            }

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>تقرير مبيعات العملاء</h2>
                        <p>الفترة: ${dateRange}</p>
                    </div>
                    <div class="report-content">
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h3>إجمالي العملاء</h3>
                                <p class="amount">${customerData.totalCustomers}</p>
                            </div>
                            <div class="summary-card">
                                <h3>إجمالي الإيرادات</h3>
                                <p class="amount">${formatCurrency(customerData.totalRevenue)}</p>
                            </div>
                            <div class="summary-card">
                                <h3>متوسط الإنفاق</h3>
                                <p class="amount">${formatCurrency(customerData.averageSpending)}</p>
                            </div>
                            <div class="summary-card">
                                <h3>العملاء النشطون</h3>
                                <p class="amount">${customerData.activeCustomers}</p>
                            </div>
                        </div>
                        <div style="margin-top: 30px;">
                            <h3>تفاصيل العملاء</h3>
                            ${customersTable}
                        </div>
                    </div>
                </div>
            `;
        }

        function createProductSalesReport(dateRange, filters) {
            const productData = generateProductsReport();

            let productsTable = '';
            if (productData.topProducts && productData.topProducts.length > 0) {
                productsTable = `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>الفئة</th>
                                <th>الكمية المباعة</th>
                                <th>الإيرادات (ر.س)</th>
                                <th>المخزون الحالي</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productData.topProducts.map(product => `
                                <tr>
                                    <td>${product.name}</td>
                                    <td>${product.category}</td>
                                    <td>${product.totalSold}</td>
                                    <td>${formatCurrency(product.totalRevenue)}</td>
                                    <td>${product.currentStock}</td>
                                    <td>
                                        <span class="status-${product.currentStock > product.minStock ? 'available' :
                                                              product.currentStock > 0 ? 'low' : 'out'}">
                                            ${product.currentStock > product.minStock ? 'متوفر' :
                                              product.currentStock > 0 ? 'منخفض' : 'نفد'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                productsTable = '<p style="text-align: center; color: #666; padding: 20px;">لا توجد بيانات مبيعات للمنتجات</p>';
            }

            return `
                <div class="report-container">
                    <div class="report-header">
                        <h2>تقرير مبيعات المنتجات</h2>
                        <p>الفترة: ${dateRange}</p>
                    </div>
                    <div class="report-content">
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h3>إجمالي المنتجات</h3>
                                <p class="amount">${productData.totalProducts}</p>
                            </div>
                            <div class="summary-card">
                                <h3>إجمالي الإيرادات</h3>
                                <p class="amount">${formatCurrency(productData.totalRevenue)}</p>
                            </div>
                            <div class="summary-card">
                                <h3>إجمالي الكمية المباعة</h3>
                                <p class="amount">${productData.totalSales}</p>
                            </div>
                            <div class="summary-card">
                                <h3>منتجات منخفضة المخزون</h3>
                                <p class="amount">${productData.lowStockProducts ? productData.lowStockProducts.length : 0}</p>
                            </div>
                        </div>
                        <div style="margin-top: 30px;">
                            <h3>أفضل المنتجات مبيعاً</h3>
                            ${productsTable}
                        </div>
                    </div>
                </div>
            `;
        }

        function createInventoryReport(dateRange, filters) {
            console.log('📦 إنشاء تقرير المخزون الحالي من البيانات الحقيقية...', { dateRange, filters });
            console.log('🔍 تحقق من وجود window.dataManager:', !!window.dataManager);
            console.log('🔍 تحقق من وجود localStorage:', !!localStorage);

            try {
                // الحصول على البيانات الحقيقية من النظام (نفس طريقة تقرير المبيعات اليومية)
                let productsData = [];

                if (window.dataManager) {
                    productsData = window.dataManager.getProducts();
                    console.log('📊 تم جلب البيانات من النظام المركزي:', productsData.length, 'منتج');
                    if (productsData.length > 0) {
                        console.log('🔍 عينة من البيانات:', productsData[0]);
                    }
                } else {
                    // الرجوع للبيانات المحلية
                    const rawData = localStorage.getItem('monjizProducts');
                    console.log('🔍 البيانات الخام من localStorage:', rawData ? rawData.substring(0, 100) + '...' : 'لا توجد');

                    productsData = JSON.parse(rawData || '[]');
                    console.log('📊 البيانات بعد التحويل:', productsData.length, 'منتج');

                    // إزالة المكررات
                    productsData = productsData.filter((product, index, self) =>
                        index === self.findIndex(p => p.id === product.id)
                    );

                    console.log('📊 البيانات بعد إزالة المكررات:', productsData.length, 'منتج');
                    if (productsData.length > 0) {
                        console.log('🔍 عينة من البيانات:', productsData[0]);
                    }
                }

                // تحليل بيانات المخزون
                console.log('📊 بدء تحليل بيانات المخزون...');

                let totalProducts = productsData.length;
                let lowStockCount = 0;
                let outOfStockCount = 0;
                let totalValue = 0;
                let totalQuantity = 0;

                // معالجة كل منتج وتحديد حالته
                const inventoryItems = productsData.map(product => {
                    const currentStock = parseInt(product.stock) || 0;
                    const minStock = parseInt(product.minStock) || 0;
                    const price = parseFloat(product.price) || 0;
                    const purchasePrice = parseFloat(product.purchasePrice) || price;

                    // تحديد حالة المخزون
                    let status = 'متوفر';
                    let statusClass = 'available';

                    if (currentStock === 0) {
                        status = 'نفد';
                        statusClass = 'out';
                        outOfStockCount++;
                    } else if (currentStock <= minStock) {
                        status = 'منخفض';
                        statusClass = 'low';
                        lowStockCount++;
                    }

                    // حساب قيمة المخزون
                    const stockValue = currentStock * purchasePrice;
                    totalValue += stockValue;
                    totalQuantity += currentStock;

                    return {
                        id: product.id,
                        name: product.name,
                        code: product.code || '',
                        category: product.category || 'غير محدد',
                        unit: product.unit || 'قطعة',
                        currentStock: currentStock,
                        minStock: minStock,
                        price: price,
                        purchasePrice: purchasePrice,
                        stockValue: stockValue,
                        status: status,
                        statusClass: statusClass,
                        lastUpdated: product.lastUpdated || new Date().toLocaleDateString('ar-EG')
                    };
                }).sort((a, b) => {
                    // ترتيب: النافد أولاً، ثم المنخفض، ثم المتوفر
                    if (a.status === 'نفد' && b.status !== 'نفد') return -1;
                    if (b.status === 'نفد' && a.status !== 'نفد') return 1;
                    if (a.status === 'منخفض' && b.status === 'متوفر') return -1;
                    if (b.status === 'منخفض' && a.status === 'متوفر') return 1;
                    return b.stockValue - a.stockValue; // ترتيب حسب القيمة
                });

                // تحديد التاريخ الحالي
                const currentDate = new Date().toLocaleDateString('ar-EG');

                console.log('✅ تم تحليل المخزون بنجاح:', {
                    totalProducts: totalProducts,
                    lowStockCount: lowStockCount,
                    outOfStockCount: outOfStockCount,
                    totalValue: formatCurrency(totalValue),
                    totalQuantity: totalQuantity
                });

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <!-- الإحصائيات المصغرة -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📦 إجمالي المنتجات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${totalProducts}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💰 قيمة المخزون</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(totalValue)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📊 إجمالي الكمية</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${totalQuantity.toLocaleString()}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">⚠️ مخزون منخفض</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${lowStockCount}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">🚫 مخزون نافد</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${outOfStockCount}</div>
                            </div>
                        </div>

                        <!-- جدول المخزون -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                                📦 تفاصيل المخزون الحالي - ${currentDate}
                            </h3>

                            ${inventoryItems.length > 0 ? `
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">اسم المنتج</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الكود</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الفئة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">المخزون الحالي</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الحد الأدنى</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">سعر البيع</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">قيمة المخزون</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #28a745;">الحالة</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${inventoryItems.map((item, index) => {
                                                const isEven = index % 2 === 0;
                                                let statusColor = '#28a745';
                                                let statusBg = '#d4edda';
                                                let statusIcon = '✅';

                                                if (item.status === 'منخفض') {
                                                    statusColor = '#ffc107';
                                                    statusBg = '#fff3cd';
                                                    statusIcon = '⚠️';
                                                } else if (item.status === 'نفد') {
                                                    statusColor = '#dc3545';
                                                    statusBg = '#f8d7da';
                                                    statusIcon = '🚫';
                                                }

                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${item.name}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #6c757d; font-size: 0.9em;">${item.code || '-'}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057;">${item.category}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: ${item.currentStock > 0 ? '#28a745' : '#dc3545'}; font-size: 1.05em;">${item.currentStock} ${item.unit}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${item.minStock} ${item.unit}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057;">${formatCurrency(item.price)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(item.stockValue)}</td>
                                                        <td style="padding: 14px 12px; text-align: center;">
                                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; border: 1px solid ${statusColor};">
                                                                ${statusIcon} ${item.status}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-top: 2px solid #28a745;">
                                                <td colspan="3" style="padding: 15px 12px; font-weight: bold; color: #333; text-align: center;">الإجمالي</td>
                                                <td style="padding: 15px 12px; text-align: center; font-weight: bold; color: #28a745; font-size: 1.1em;">${totalQuantity.toLocaleString()}</td>
                                                <td style="padding: 15px 12px;"></td>
                                                <td style="padding: 15px 12px;"></td>
                                                <td style="padding: 15px 12px; text-align: center; font-weight: bold; color: #28a745; font-size: 1.1em;">${formatCurrency(totalValue)}</td>
                                                <td style="padding: 15px 12px;"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                                    <i class="fas fa-inbox" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i>
                                    <h4 style="color: #666; margin-bottom: 10px;">لا توجد منتجات في المخزون</h4>
                                    <p style="color: #999; font-size: 0.9em;">لم يتم العثور على أي منتجات في النظام</p>
                                </div>
                            `}
                        </div>

                        <!-- المنتجات التي تحتاج إعادة طلب -->
                        ${(lowStockCount > 0 || outOfStockCount > 0) ? `
                            <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                                <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #dc3545; padding-bottom: 10px;">🚨 منتجات تحتاج إعادة طلب</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    ${inventoryItems.filter(item => item.status === 'نفد' || item.status === 'منخفض').map(item => {
                                        const urgencyColor = item.status === 'نفد' ? '#dc3545' : '#ffc107';
                                        const urgencyBg = item.status === 'نفد' ? '#f8d7da' : '#fff3cd';
                                        const urgencyIcon = item.status === 'نفد' ? '🚫' : '⚠️';

                                        return `
                                            <div style="background: ${urgencyBg}; border: 2px solid ${urgencyColor}; border-radius: 10px; padding: 15px; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                                    <span style="font-size: 1.2em; margin-left: 8px;">${urgencyIcon}</span>
                                                    <h4 style="margin: 0; color: ${urgencyColor}; font-size: 1em;">${item.name}</h4>
                                                </div>
                                                <div style="color: #495057; font-size: 0.9em; line-height: 1.4;">
                                                    <div><strong>المخزون الحالي:</strong> ${item.currentStock} ${item.unit}</div>
                                                    <div><strong>الحد الأدنى:</strong> ${item.minStock} ${item.unit}</div>
                                                    <div><strong>الكمية المقترحة:</strong> ${Math.max(item.minStock * 2, 10)} ${item.unit}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- ملاحظات وإحصائيات إضافية -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">📊 إحصائيات المخزون</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    <div style="margin-bottom: 8px;">• إجمالي المنتجات: <strong>${totalProducts}</strong></div>
                                    <div style="margin-bottom: 8px;">• قيمة المخزون: <strong style="color: #28a745;">${formatCurrency(totalValue)}</strong></div>
                                    <div style="margin-bottom: 8px;">• إجمالي الكمية: <strong style="color: #667eea;">${totalQuantity.toLocaleString()}</strong></div>
                                    <div>• متوسط قيمة المنتج: <strong style="color: #667eea;">${formatCurrency(totalProducts > 0 ? totalValue / totalProducts : 0)}</strong></div>
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">💡 ملاحظات</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    <div style="margin-bottom: 8px;">• التاريخ: <strong>${currentDate}</strong></div>
                                    <div style="margin-bottom: 8px;">• منتجات تحتاج طلب: <strong style="color: #dc3545;">${lowStockCount + outOfStockCount}</strong></div>
                                    <div style="margin-bottom: 8px;">• حالة البيانات: <strong style="color: #28a745;">محدثة</strong></div>
                                    <div>• آخر تحديث: <strong>${new Date().toLocaleString('ar-EG')}</strong></div>
                                </div>
                            </div>
                        </div>

                        <!-- أزرار الإجراءات -->
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="printReport()" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(108, 117, 125, 0.3)'">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button onclick="exportToExcel('inventory-report')" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                <i class="fas fa-file-excel"></i> تصدير Excel
                            </button>
                            <button onclick="exportToPDF('inventory-report')" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)'">
                                <i class="fas fa-file-pdf"></i> تصدير PDF
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء تقرير المخزون:', error);
                console.error('❌ تفاصيل الخطأ:', error.stack);
                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div class="report-header" style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e9ecef;">
                            <h2 style="color: #2c3e50; margin: 0; font-size: 1.8em; font-weight: 700;">📦 تقرير المخزون الحالي</h2>
                        </div>
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;"></i>
                            <h3 style="margin: 0 0 10px 0;">خطأ في إنشاء التقرير</h3>
                            <p style="margin: 0; font-size: 0.9em;">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // وظائف التقارير المالية المرتبطة بالنظام المركزي
        function createBalanceSheetReport(dateRange, filters) {
            console.log('🏦 إنشاء قائمة المركز المالي...', { dateRange, filters });

            try {
                // تحديد التاريخ المطلوب
                let targetDate;
                let dateInfo = '';

                if (dateRange && dateRange.from && dateRange.to) {
                    console.log('📅 تطبيق فلتر التاريخ على قائمة المركز المالي:', dateRange);
                    targetDate = new Date(dateRange.to); // استخدام تاريخ النهاية للميزانية
                    const toDateFormatted = `${targetDate.getDate().toString().padStart(2, '0')}/${(targetDate.getMonth() + 1).toString().padStart(2, '0')}/${targetDate.getFullYear()}`;
                    dateInfo = `كما في ${toDateFormatted}`;
                } else {
                    // استخدام اليوم الحالي كافتراضي
                    targetDate = new Date();
                    const todayFormatted = `${targetDate.getDate().toString().padStart(2, '0')}/${(targetDate.getMonth() + 1).toString().padStart(2, '0')}/${targetDate.getFullYear()}`;
                    dateInfo = `كما في ${todayFormatted}`;
                }

                // الحصول على بيانات الميزانية من النظام المركزي
                // تمرير التاريخ المحدد لدالة generateBalanceSheetReport
                let asOfDate = null;
                if (dateRange && dateRange.to) {
                    asOfDate = dateRange.to; // استخدام تاريخ النهاية للميزانية
                } else if (dateRange && dateRange.from) {
                    asOfDate = dateRange.from; // أو تاريخ البداية إذا لم يوجد تاريخ نهاية
                }

                const balanceData = generateBalanceSheetReport(asOfDate);
                console.log('📊 تم إنشاء قائمة المركز المالي للتاريخ:', asOfDate || 'اليوم الحالي');
                console.log('💰 بيانات الميزانية:', {
                    cash: balanceData.assets.currentAssets.cash,
                    receivables: balanceData.assets.currentAssets.accountsReceivable,
                    inventory: balanceData.assets.currentAssets.inventory,
                    totalAssets: balanceData.assets.totalAssets,
                    totalLiabilities: balanceData.liabilities.totalLiabilities,
                    equity: balanceData.equity.totalEquity
                });
                console.log('💰 بيانات الميزانية:', {
                    cash: balanceData.assets.currentAssets.cash,
                    receivables: balanceData.assets.currentAssets.accountsReceivable,
                    inventory: balanceData.assets.currentAssets.inventory,
                    totalAssets: balanceData.assets.totalAssets,
                    totalLiabilities: balanceData.liabilities.totalLiabilities,
                    equity: balanceData.equity.totalEquity
                });

                // تطبيق فلتر الحسابات
                let filterInfo = '';
                let showAssets = true;
                let showLiabilities = true;
                let showEquity = true;
                let showOnlyCash = false;
                let showOnlyBank = false;

                if (filters && filters.account) {
                    console.log('📊 تطبيق فلتر الحسابات:', filters.account);
                    switch (filters.account) {
                        case 'assets':
                            showLiabilities = false;
                            showEquity = false;
                            filterInfo = ' - الأصول فقط';
                            break;
                        case 'liabilities':
                            showAssets = false;
                            showEquity = false;
                            filterInfo = ' - الخصوم فقط';
                            break;
                        case 'equity':
                            showAssets = false;
                            showLiabilities = false;
                            filterInfo = ' - حقوق الملكية فقط';
                            break;
                        case 'cash':
                            showLiabilities = false;
                            showEquity = false;
                            showOnlyCash = true;
                            filterInfo = ' - النقدية فقط';
                            break;
                        case 'bank':
                            showLiabilities = false;
                            showEquity = false;
                            showOnlyBank = true;
                            filterInfo = ' - البنوك فقط';
                            break;
                    }
                }

                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>قائمة المركز المالي${filterInfo}</h2>
                            <p>${dateInfo}</p>
                        </div>
                        <div class="report-content">
                            ${showAssets ? `
                            <!-- الأصول -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-coins" style="margin-left: 10px;"></i>
                                    الأصول
                                </h3>` : ''}

                                ${showAssets && !showOnlyBank ? `
                                <!-- الأصول المتداولة -->
                                <div style="margin: 20px 0;">
                                    <h4 style="color: #34495e;">الأصول المتداولة:</h4>
                                    <table class="report-table" style="margin-right: 20px;">
                                        ${showOnlyCash ? `
                                        <tr>
                                            <td>النقدية والبنوك</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.assets.currentAssets.cash)}</td>
                                        </tr>
                                        ` : `
                                        <tr>
                                            <td>النقدية والبنوك</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.assets.currentAssets.cash)}</td>
                                        </tr>
                                        <tr>
                                            <td>العملاء</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.assets.currentAssets.accountsReceivable)}</td>
                                        </tr>
                                        <tr>
                                            <td>المخزون</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.assets.currentAssets.inventory)}</td>
                                        </tr>
                                        `}
                                        <tr style="font-weight: bold; background: #f8f9fa;">
                                            <td>إجمالي الأصول المتداولة</td>
                                            <td style="text-align: left;">${formatCurrency(showOnlyCash ? balanceData.assets.currentAssets.cash : balanceData.assets.currentAssets.total)}</td>
                                        </tr>
                                    </table>
                                </div>
                                ` : ''}

                                ${showOnlyBank ? `
                                <!-- البنوك فقط -->
                                <div style="margin: 20px 0;">
                                    <h4 style="color: #34495e;">البنوك:</h4>
                                    <table class="report-table" style="margin-right: 20px;">
                                        <tr>
                                            <td>الحسابات البنكية</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.assets.currentAssets.cash * 0.6)}</td>
                                        </tr>
                                        <tr style="font-weight: bold; background: #f8f9fa;">
                                            <td>إجمالي البنوك</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.assets.currentAssets.cash * 0.6)}</td>
                                        </tr>
                                    </table>
                                </div>
                                ` : ''}

                                ${showAssets && !showOnlyCash && !showOnlyBank ? `
                                <!-- الأصول الثابتة -->
                                <div style="margin: 20px 0;">
                                    <h4 style="color: #34495e;">الأصول الثابتة:</h4>
                                    <table class="report-table" style="margin-right: 20px;">
                                        <tr>
                                            <td>المعدات والأجهزة</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.assets.fixedAssets.equipment)}</td>
                                        </tr>
                                        <tr style="font-weight: bold; background: #f8f9fa;">
                                            <td>إجمالي الأصول الثابتة</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.assets.fixedAssets.total)}</td>
                                        </tr>
                                    </table>
                                </div>
                                ` : ''}

                                ${showAssets ? `
                                <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; margin: 20px 0;">
                                    <h4 style="margin: 0; text-align: center;">
                                        إجمالي الأصول: ${formatCurrency(
                                            showOnlyCash ? balanceData.assets.currentAssets.cash :
                                            showOnlyBank ? balanceData.assets.currentAssets.cash * 0.6 :
                                            balanceData.assets.totalAssets
                                        )}
                                    </h4>
                                </div>
                                ` : ''}
                            ${showAssets ? '</div>' : ''}

                            ${showLiabilities || showEquity ? `
                            <!-- الخصوم وحقوق الملكية -->
                            <div>
                                <h3 style="color: #2c3e50; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;">
                                    <i class="fas fa-file-invoice-dollar" style="margin-left: 10px;"></i>
                                    ${showLiabilities && showEquity ? 'الخصوم وحقوق الملكية' :
                                      showLiabilities ? 'الخصوم' : 'حقوق الملكية'}
                                </h3>

                                ${showLiabilities ? `
                                <!-- الخصوم المتداولة -->
                                <div style="margin: 20px 0;">
                                    <h4 style="color: #34495e;">الخصوم المتداولة:</h4>
                                    <table class="report-table" style="margin-right: 20px;">
                                        <tr>
                                            <td>الموردين</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.liabilities.currentLiabilities.accountsPayable)}</td>
                                        </tr>
                                        <tr>
                                            <td>ضريبة القيمة المضافة</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.liabilities.currentLiabilities.vatPayable)}</td>
                                        </tr>
                                        <tr style="font-weight: bold; background: #f8f9fa;">
                                            <td>إجمالي الخصوم</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.liabilities.totalLiabilities)}</td>
                                        </tr>
                                    </table>
                                </div>
                                ` : ''}` : ''}

                                ${showEquity ? `
                                <!-- حقوق الملكية -->
                                <div style="margin: 20px 0;">
                                    <h4 style="color: #34495e;">حقوق الملكية:</h4>
                                    <table class="report-table" style="margin-right: 20px;">
                                        <tr>
                                            <td>الأرباح المحتجزة</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.equity.retainedEarnings)}</td>
                                        </tr>
                                        <tr style="font-weight: bold; background: #f8f9fa;">
                                            <td>إجمالي حقوق الملكية</td>
                                            <td style="text-align: left;">${formatCurrency(balanceData.equity.totalEquity)}</td>
                                        </tr>
                                    </table>
                                </div>
                                ` : ''}

                                ${showLiabilities && showEquity ? `
                                <div style="background: #28a745; color: white; padding: 15px; border-radius: 10px; margin: 20px 0;">
                                    <h4 style="margin: 0; text-align: center;">
                                        إجمالي الخصوم وحقوق الملكية: ${formatCurrency(balanceData.liabilities.totalLiabilities + balanceData.equity.totalEquity)}
                                    </h4>
                                </div>
                                ` : showLiabilities ? `
                                <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 10px; margin: 20px 0;">
                                    <h4 style="margin: 0; text-align: center;">
                                        إجمالي الخصوم: ${formatCurrency(balanceData.liabilities.totalLiabilities)}
                                    </h4>
                                </div>
                                ` : showEquity ? `
                                <div style="background: #f39c12; color: white; padding: 15px; border-radius: 10px; margin: 20px 0;">
                                    <h4 style="margin: 0; text-align: center;">
                                        إجمالي حقوق الملكية: ${formatCurrency(balanceData.equity.totalEquity)}
                                    </h4>
                                </div>
                                ` : ''}
                            ${showLiabilities || showEquity ? '</div>' : ''}

                            <!-- ملاحظات -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                                <h4 style="color: #2c3e50;">
                                    <i class="fas fa-info-circle" style="margin-left: 10px;"></i>
                                    ملاحظات:
                                </h4>
                                <ul style="color: #666;">
                                    <li>البيانات مستخرجة من النظام المركزي</li>
                                    <li>النقدية تشمل المبيعات النقدية والبطاقات</li>
                                    <li>العملاء يشمل المبيعات الآجلة</li>
                                    <li>المخزون محسوب بسعر التكلفة</li>
                                    <li>ضريبة القيمة المضافة محسوبة بنسبة 15%</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء قائمة المركز المالي:', error);
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>قائمة المركز المالي</h2>
                            <p>كما في ${dateRange}</p>
                        </div>
                        <div class="report-content">
                            <div class="error" style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                                <h3>خطأ في إنشاء التقرير</h3>
                                <p>${error.message}</p>

                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function createProfitLossReport(dateRange, filters) {
            console.log('📈 إنشاء قائمة الأرباح والخسائر...');

            try {
                // تحديد الفترة
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = (() => {
                    const date = new Date();
                    date.setMonth(date.getMonth() - 1);
                    return date.toISOString().split('T')[0];
                })();

                // الحصول على بيانات الأرباح والخسائر من النظام المركزي
                const profitLossData = generateProfitLossReport(startDate, endDate);

                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>قائمة الأرباح والخسائر</h2>
                            <p>للفترة من ${formatDateArabicGregorian(startDate)} إلى ${formatDateArabicGregorian(endDate)}</p>
                        </div>
                        <div class="report-content">
                            <!-- الإيرادات -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #2c3e50; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                                    <i class="fas fa-chart-line" style="margin-left: 10px;"></i>
                                    الإيرادات
                                </h3>
                                <table class="report-table">
                                    <tr>
                                        <td>مبيعات</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.revenue.sales)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #d4edda;">
                                        <td>إجمالي الإيرادات</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.revenue.totalRevenue)}</td>
                                    </tr>
                                </table>
                            </div>

                            <!-- تكلفة المبيعات -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #2c3e50; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">
                                    <i class="fas fa-box" style="margin-left: 10px;"></i>
                                    تكلفة المبيعات
                                </h3>
                                <table class="report-table">
                                    <tr>
                                        <td>تكلفة البضاعة المباعة</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.costOfGoodsSold)}</td>
                                    </tr>
                                </table>
                            </div>

                            <!-- إجمالي الربح -->
                            <div style="background: ${profitLossData.grossProfit >= 0 ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 10px; margin: 20px 0;">
                                <h4 style="margin: 0; text-align: center; color: ${profitLossData.grossProfit >= 0 ? '#155724' : '#721c24'};">
                                    إجمالي الربح: ${formatCurrency(profitLossData.grossProfit)}
                                </h4>
                            </div>

                            <!-- المصروفات التشغيلية -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #2c3e50; border-bottom: 2px solid #dc3545; padding-bottom: 10px;">
                                    <i class="fas fa-receipt" style="margin-left: 10px;"></i>
                                    المصروفات التشغيلية
                                </h3>
                                <table class="report-table">
                                    <tr>
                                        <td>الرواتب والأجور</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.operatingExpenses.salaries)}</td>
                                    </tr>
                                    <tr>
                                        <td>الإيجار</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.operatingExpenses.rent)}</td>
                                    </tr>
                                    <tr>
                                        <td>المرافق</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.operatingExpenses.utilities)}</td>
                                    </tr>
                                    <tr>
                                        <td>التسويق والإعلان</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.operatingExpenses.marketing)}</td>
                                    </tr>
                                    <tr>
                                        <td>مصروفات أخرى</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.operatingExpenses.other)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #f8d7da;">
                                        <td>إجمالي المصروفات التشغيلية</td>
                                        <td style="text-align: left;">${formatCurrency(profitLossData.totalOperatingExpenses)}</td>
                                    </tr>
                                </table>
                            </div>

                            <!-- صافي الربح -->
                            <div style="background: ${profitLossData.netProfit >= 0 ? '#28a745' : '#dc3545'}; color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h3 style="margin: 0; text-align: center;">
                                    <i class="fas fa-${profitLossData.netProfit >= 0 ? 'arrow-up' : 'arrow-down'}" style="margin-left: 10px;"></i>
                                    صافي ${profitLossData.netProfit >= 0 ? 'الربح' : 'الخسارة'}: ${formatCurrency(Math.abs(profitLossData.netProfit))}
                                </h3>
                            </div>

                            <!-- نسب الربحية -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                                <h4 style="color: #2c3e50;">
                                    <i class="fas fa-percentage" style="margin-left: 10px;"></i>
                                    نسب الربحية:
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">
                                            ${profitLossData.revenue.totalRevenue > 0 ? ((profitLossData.grossProfit / profitLossData.revenue.totalRevenue) * 100).toFixed(1) : 0}%
                                        </div>
                                        <div style="color: #666;">نسبة إجمالي الربح</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">
                                            ${profitLossData.revenue.totalRevenue > 0 ? ((profitLossData.netProfit / profitLossData.revenue.totalRevenue) * 100).toFixed(1) : 0}%
                                        </div>
                                        <div style="color: #666;">نسبة صافي الربح</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ملاحظات -->
                            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; margin-top: 30px;">
                                <h4 style="color: #2c3e50;">
                                    <i class="fas fa-info-circle" style="margin-left: 10px;"></i>
                                    ملاحظات:
                                </h4>
                                <ul style="color: #666;">
                                    <li>البيانات مستخرجة من النظام المركزي</li>
                                    <li>تكلفة المبيعات محسوبة بناءً على أسعار الشراء الفعلية</li>
                                    <li>المصروفات التشغيلية محسوبة كنسبة من الإيرادات</li>
                                    <li>يمكن تخصيص المصروفات من إعدادات النظام</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء قائمة الأرباح والخسائر:', error);
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>قائمة الأرباح والخسائر</h2>
                            <p>للفترة ${dateRange}</p>
                        </div>
                        <div class="report-content">
                            <div class="error" style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                                <h3>خطأ في إنشاء التقرير</h3>
                                <p>${error.message}</p>

                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function createCashFlowReport(dateRange, filters) {
            console.log('💰 إنشاء قائمة التدفقات النقدية (الدالة المفصلة)...', { dateRange, filters });
            console.log('🔍 نوع dateRange:', typeof dateRange, 'قيمة:', dateRange);
            console.log('🔍 نوع filters:', typeof filters, 'قيمة:', filters);

            try {
                // تحديد الفترة من dateRange أو استخدام الافتراضي
                let startDate, endDate, dateInfo;

                if (dateRange && dateRange.from && dateRange.to) {
                    console.log('📅 تطبيق فلتر التاريخ على قائمة التدفقات النقدية:', dateRange);
                    console.log('✅ تم العثور على نطاق تاريخ صحيح - من:', dateRange.from, 'إلى:', dateRange.to);
                    startDate = dateRange.from;
                    endDate = dateRange.to;

                    const fromDateFormatted = `${new Date(startDate).getDate().toString().padStart(2, '0')}/${(new Date(startDate).getMonth() + 1).toString().padStart(2, '0')}/${new Date(startDate).getFullYear()}`;
                    const toDateFormatted = `${new Date(endDate).getDate().toString().padStart(2, '0')}/${(new Date(endDate).getMonth() + 1).toString().padStart(2, '0')}/${new Date(endDate).getFullYear()}`;
                    dateInfo = `للفترة من ${fromDateFormatted} إلى ${toDateFormatted}`;
                } else {
                    // استخدام الشهر الماضي كافتراضي
                    console.log('⚠️ لم يتم العثور على نطاق تاريخ صحيح - استخدام الافتراضي');
                    endDate = new Date().toISOString().split('T')[0];
                    const startDateObj = new Date();
                    startDateObj.setMonth(startDateObj.getMonth() - 1);
                    startDate = startDateObj.toISOString().split('T')[0];
                    console.log('📅 الفترة الافتراضية - من:', startDate, 'إلى:', endDate);

                    const fromDateFormatted = `${startDateObj.getDate().toString().padStart(2, '0')}/${(startDateObj.getMonth() + 1).toString().padStart(2, '0')}/${startDateObj.getFullYear()}`;
                    const toDateFormatted = `${new Date().getDate().toString().padStart(2, '0')}/${(new Date().getMonth() + 1).toString().padStart(2, '0')}/${new Date().getFullYear()}`;
                    dateInfo = `للفترة من ${fromDateFormatted} إلى ${toDateFormatted}`;
                }

                // تطبيق فلتر الحسابات النقدية
                let filterInfo = '';
                if (filters && filters.account) {
                    console.log('💰 تطبيق فلتر الحسابات النقدية:', filters.account);
                    switch (filters.account) {
                        case 'cash':
                            filterInfo = ' - النقدية فقط';
                            break;
                        case 'bank-main':
                            filterInfo = ' - البنك الرئيسي فقط';
                            break;
                        case 'bank-secondary':
                            filterInfo = ' - البنك الثانوي فقط';
                            break;
                        case 'petty-cash':
                            filterInfo = ' - النثرية فقط';
                            break;
                    }
                }

                // الحصول على بيانات التدفقات النقدية من النظام المركزي
                const cashFlowData = generateCashFlowReport(startDate, endDate);
                console.log('📊 تم إنشاء قائمة التدفقات النقدية للفترة:', startDate, 'إلى', endDate);

                // تطبيق فلتر الحسابات النقدية على البيانات
                let filteredCashFlowData = { ...cashFlowData };
                if (filters && filters.account) {
                    const filterRatio = {
                        'cash': 0.4,        // 40% نقدية
                        'bank-main': 0.5,   // 50% بنك رئيسي
                        'bank-secondary': 0.1, // 10% بنك ثانوي
                        'petty-cash': 0.05  // 5% نثرية
                    };

                    const ratio = filterRatio[filters.account] || 1;
                    filteredCashFlowData = {
                        operatingActivities: {
                            cashFromSales: cashFlowData.operatingActivities.cashFromSales * ratio,
                            netOperatingCashFlow: cashFlowData.operatingActivities.netOperatingCashFlow * ratio
                        },
                        investingActivities: {
                            equipmentPurchases: cashFlowData.investingActivities.equipmentPurchases * ratio,
                            netInvestingCashFlow: cashFlowData.investingActivities.netInvestingCashFlow * ratio
                        },
                        financingActivities: {
                            netFinancingCashFlow: cashFlowData.financingActivities.netFinancingCashFlow * ratio
                        },
                        netCashFlow: cashFlowData.netCashFlow * ratio
                    };
                    console.log('💰 تم تطبيق فلتر الحسابات النقدية بنسبة:', ratio);
                }

                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>قائمة التدفقات النقدية${filterInfo}</h2>
                            <p>${dateInfo}</p>
                        </div>
                        <div class="report-content">
                            <!-- التدفقات النقدية من الأنشطة التشغيلية -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #2c3e50; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                                    <i class="fas fa-cogs" style="margin-left: 10px;"></i>
                                    التدفقات النقدية من الأنشطة التشغيلية
                                </h3>
                                <table class="report-table">
                                    <tr>
                                        <td>النقد المحصل من المبيعات</td>
                                        <td style="text-align: left;">${formatCurrency(filteredCashFlowData.operatingActivities.cashFromSales)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #d4edda;">
                                        <td>صافي النقد من الأنشطة التشغيلية</td>
                                        <td style="text-align: left;">${formatCurrency(filteredCashFlowData.operatingActivities.netOperatingCashFlow)}</td>
                                    </tr>
                                </table>
                            </div>

                            <!-- التدفقات النقدية من الأنشطة الاستثمارية -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #2c3e50; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">
                                    <i class="fas fa-chart-line" style="margin-left: 10px;"></i>
                                    التدفقات النقدية من الأنشطة الاستثمارية
                                </h3>
                                <table class="report-table">
                                    <tr>
                                        <td>شراء معدات وأجهزة</td>
                                        <td style="text-align: left;">${formatCurrency(filteredCashFlowData.investingActivities.equipmentPurchases)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #fff3cd;">
                                        <td>صافي النقد من الأنشطة الاستثمارية</td>
                                        <td style="text-align: left;">${formatCurrency(filteredCashFlowData.investingActivities.netInvestingCashFlow)}</td>
                                    </tr>
                                </table>
                            </div>

                            <!-- التدفقات النقدية من الأنشطة التمويلية -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #2c3e50; border-bottom: 2px solid #dc3545; padding-bottom: 10px;">
                                    <i class="fas fa-university" style="margin-left: 10px;"></i>
                                    التدفقات النقدية من الأنشطة التمويلية
                                </h3>
                                <table class="report-table">
                                    <tr>
                                        <td>قروض وتمويل</td>
                                        <td style="text-align: left;">${formatCurrency(filteredCashFlowData.financingActivities.netFinancingCashFlow)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #f8d7da;">
                                        <td>صافي النقد من الأنشطة التمويلية</td>
                                        <td style="text-align: left;">${formatCurrency(filteredCashFlowData.financingActivities.netFinancingCashFlow)}</td>
                                    </tr>
                                </table>
                            </div>

                            <!-- صافي التدفق النقدي -->
                            <div style="background: ${filteredCashFlowData.netCashFlow >= 0 ? '#28a745' : '#dc3545'}; color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h3 style="margin: 0; text-align: center;">
                                    <i class="fas fa-${filteredCashFlowData.netCashFlow >= 0 ? 'arrow-up' : 'arrow-down'}" style="margin-left: 10px;"></i>
                                    صافي ${filteredCashFlowData.netCashFlow >= 0 ? 'الزيادة' : 'النقص'} في النقد: ${formatCurrency(Math.abs(filteredCashFlowData.netCashFlow))}
                                </h3>
                            </div>

                            <!-- ملخص التدفقات -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                                <h4 style="color: #2c3e50;">
                                    <i class="fas fa-chart-pie" style="margin-left: 10px;"></i>
                                    ملخص التدفقات النقدية:
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">
                                            ${formatCurrency(filteredCashFlowData.operatingActivities.netOperatingCashFlow)}
                                        </div>
                                        <div style="color: #666;">الأنشطة التشغيلية</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: #ffc107;">
                                            ${formatCurrency(filteredCashFlowData.investingActivities.netInvestingCashFlow)}
                                        </div>
                                        <div style="color: #666;">الأنشطة الاستثمارية</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">
                                            ${formatCurrency(filteredCashFlowData.financingActivities.netFinancingCashFlow)}
                                        </div>
                                        <div style="color: #666;">الأنشطة التمويلية</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ملاحظات -->
                            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; margin-top: 30px;">
                                <h4 style="color: #2c3e50;">
                                    <i class="fas fa-info-circle" style="margin-left: 10px;"></i>
                                    ملاحظات:
                                </h4>
                                <ul style="color: #666;">
                                    <li>البيانات مستخرجة من النظام المركزي</li>
                                    <li>النقد المحصل يشمل المبيعات النقدية والبطاقات فقط</li>
                                    <li>المبيعات الآجلة لا تظهر في التدفقات النقدية</li>
                                    <li>الأنشطة الاستثمارية والتمويلية افتراضية</li>
                                    <li>يمكن تخصيص هذه القيم من إعدادات النظام</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء قائمة التدفقات النقدية:', error);
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>قائمة التدفقات النقدية</h2>
                            <p>للفترة ${dateRange}</p>
                        </div>
                        <div class="report-content">
                            <div class="error" style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                                <h3>خطأ في إنشاء التقرير</h3>
                                <p>${error.message}</p>

                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function createTrialBalanceReport(dateRange, filters) {
            console.log('⚖️ إنشاء ميزان المراجعة...');

            try {
                // الحصول على بيانات الميزانية لاستخراج الحسابات
                const balanceData = generateBalanceSheetReport(dateRange);

                // إنشاء حسابات ميزان المراجعة
                const trialBalanceAccounts = [
                    // الأصول (مدين)
                    { code: '1101', name: 'النقدية والبنوك', debit: balanceData.assets.currentAssets.cash, credit: 0 },
                    { code: '1201', name: 'العملاء', debit: balanceData.assets.currentAssets.accountsReceivable, credit: 0 },
                    { code: '1301', name: 'المخزون', debit: balanceData.assets.currentAssets.inventory, credit: 0 },
                    { code: '1501', name: 'المعدات والأجهزة', debit: balanceData.assets.fixedAssets.equipment, credit: 0 },

                    // الخصوم (دائن)
                    { code: '2101', name: 'الموردين', debit: 0, credit: balanceData.liabilities.currentLiabilities.accountsPayable },
                    { code: '2201', name: 'ضريبة القيمة المضافة', debit: 0, credit: balanceData.liabilities.currentLiabilities.vatPayable },

                    // حقوق الملكية (دائن)
                    { code: '3101', name: 'رأس المال', debit: 0, credit: balanceData.equity.totalEquity * 0.7 },
                    { code: '3201', name: 'الأرباح المحتجزة', debit: 0, credit: balanceData.equity.totalEquity * 0.3 },

                    // الإيرادات (دائن) - من قائمة الأرباح والخسائر
                    { code: '4101', name: 'مبيعات', debit: 0, credit: 0 },

                    // المصروفات (مدين)
                    { code: '5101', name: 'تكلفة المبيعات', debit: 0, credit: 0 },
                    { code: '5201', name: 'الرواتب والأجور', debit: 0, credit: 0 },
                    { code: '5301', name: 'الإيجار', debit: 0, credit: 0 },
                    { code: '5401', name: 'المرافق', debit: 0, credit: 0 }
                ];

                // إضافة بيانات الإيرادات والمصروفات من قائمة الأرباح والخسائر
                try {
                    const profitLossData = generateProfitLossReport();

                    // تحديث حسابات الإيرادات والمصروفات
                    trialBalanceAccounts.forEach(account => {
                        if (account.code === '4101') { // مبيعات
                            account.credit = profitLossData.revenue.totalRevenue;
                        } else if (account.code === '5101') { // تكلفة المبيعات
                            account.debit = profitLossData.costOfGoodsSold;
                        } else if (account.code === '5201') { // رواتب
                            account.debit = profitLossData.operatingExpenses.salaries;
                        } else if (account.code === '5301') { // إيجار
                            account.debit = profitLossData.operatingExpenses.rent;
                        } else if (account.code === '5401') { // مرافق
                            account.debit = profitLossData.operatingExpenses.utilities;
                        }
                    });
                } catch (error) {
                    console.warn('تحذير: لم يتم تحميل بيانات الأرباح والخسائر:', error.message);
                }

                // حساب الإجماليات
                const totalDebits = trialBalanceAccounts.reduce((sum, account) => sum + account.debit, 0);
                const totalCredits = trialBalanceAccounts.reduce((sum, account) => sum + account.credit, 0);

                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>ميزان المراجعة</h2>
                            <p>كما في ${formatDateArabicGregorian(new Date())}</p>
                        </div>
                        <div class="report-content">
                            <table class="report-table">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th>رقم الحساب</th>
                                        <th>اسم الحساب</th>
                                        <th>مدين</th>
                                        <th>دائن</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${trialBalanceAccounts.map(account => `
                                        <tr>
                                            <td style="text-align: center;">${account.code}</td>
                                            <td>${account.name}</td>
                                            <td style="text-align: left;">${account.debit > 0 ? formatCurrency(account.debit) : '-'}</td>
                                            <td style="text-align: left;">${account.credit > 0 ? formatCurrency(account.credit) : '-'}</td>
                                        </tr>
                                    `).join('')}

                                    <!-- إجمالي -->
                                    <tr style="font-weight: bold; background: #f8f9fa; border-top: 2px solid #667eea;">
                                        <td colspan="2" style="text-align: center;">الإجمالي</td>
                                        <td style="text-align: left;">${formatCurrency(totalDebits)}</td>
                                        <td style="text-align: left;">${formatCurrency(totalCredits)}</td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- حالة التوازن -->
                            <div style="background: ${Math.abs(totalDebits - totalCredits) < 0.01 ? '#d4edda' : '#f8d7da'}; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h4 style="margin: 0; text-align: center; color: ${Math.abs(totalDebits - totalCredits) < 0.01 ? '#155724' : '#721c24'};">
                                    <i class="fas fa-${Math.abs(totalDebits - totalCredits) < 0.01 ? 'check-circle' : 'exclamation-triangle'}" style="margin-left: 10px;"></i>
                                    ${Math.abs(totalDebits - totalCredits) < 0.01 ? 'الميزان متوازن' : 'الميزان غير متوازن'}
                                </h4>
                                ${Math.abs(totalDebits - totalCredits) >= 0.01 ? `
                                    <p style="text-align: center; margin: 10px 0 0 0;">
                                        الفرق: ${formatCurrency(Math.abs(totalDebits - totalCredits))}
                                    </p>
                                ` : ''}
                            </div>

                            <!-- إحصائيات -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                                <h4 style="color: #2c3e50;">
                                    <i class="fas fa-chart-bar" style="margin-left: 10px;"></i>
                                    إحصائيات الميزان:
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">
                                            ${trialBalanceAccounts.length}
                                        </div>
                                        <div style="color: #666;">عدد الحسابات</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">
                                            ${formatCurrency(totalDebits)}
                                        </div>
                                        <div style="color: #666;">إجمالي المدين</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">
                                            ${formatCurrency(totalCredits)}
                                        </div>
                                        <div style="color: #666;">إجمالي الدائن</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ملاحظات -->
                            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; margin-top: 30px;">
                                <h4 style="color: #2c3e50;">
                                    <i class="fas fa-info-circle" style="margin-left: 10px;"></i>
                                    ملاحظات:
                                </h4>
                                <ul style="color: #666;">
                                    <li>البيانات مستخرجة من النظام المركزي</li>
                                    <li>الأرصدة محسوبة من قائمة المركز المالي</li>
                                    <li>الإيرادات والمصروفات من قائمة الأرباح والخسائر</li>
                                    <li>يجب أن يكون إجمالي المدين = إجمالي الدائن</li>
                                    <li>أي عدم توازن يشير إلى خطأ في القيود المحاسبية</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء ميزان المراجعة:', error);
                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>ميزان المراجعة</h2>
                            <p>كما في ${dateRange}</p>
                        </div>
                        <div class="report-content">
                            <div class="error" style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                                <h3>خطأ في إنشاء التقرير</h3>
                                <p>${error.message}</p>

                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // وظائف تقارير المشتريات المرتبطة بالنظام المركزي
        function createPurchasesDailyReport(dateRange, filters) {
            console.log('🛒 إنشاء تقرير المشتريات اليومية...', { dateRange, filters });

            try {
                // الحصول على البيانات مع تطبيق فلاتر التاريخ وطريقة الدفع
                let purchasesData = generatePurchasesReport('daily');

                // تطبيق فلتر التاريخ
                if (dateRange && dateRange.from && dateRange.to) {
                    console.log('📅 تطبيق فلتر التاريخ:', dateRange);
                    const fromDate = new Date(dateRange.from);
                    const toDate = new Date(dateRange.to);
                    toDate.setHours(23, 59, 59, 999);

                    // فلترة البيانات الخام
                    if (purchasesData.rawData) {
                        purchasesData.rawData = purchasesData.rawData.filter(purchase => {
                            if (!purchase.date && !purchase.createdAt) return false;

                            let purchaseDate;
                            if (purchase.createdAt) {
                                purchaseDate = new Date(purchase.createdAt);
                            } else if (purchase.date) {
                                if (purchase.date.includes('/')) {
                                    const parts = purchase.date.split('/');
                                    if (parts.length === 3) {
                                        purchaseDate = new Date(parts[2], parts[1] - 1, parts[0]);
                                    }
                                } else {
                                    purchaseDate = new Date(purchase.date);
                                }
                            }

                            return purchaseDate && purchaseDate >= fromDate && purchaseDate <= toDate;
                        });

                        // إعادة حساب الإجماليات
                        purchasesData.total = purchasesData.rawData.reduce((sum, p) => sum + (parseFloat(p.total) || 0), 0);
                        purchasesData.count = purchasesData.rawData.length;
                        purchasesData.average = purchasesData.count > 0 ? purchasesData.total / purchasesData.count : 0;

                        console.log('📊 المشتريات بعد فلتر التاريخ:', purchasesData.count, 'فاتورة');
                    }
                }

                // تطبيق فلتر طريقة الدفع
                if (filters.account && filters.account !== '') {
                    console.log('💳 تطبيق فلتر طريقة الدفع:', filters.account);

                    if (purchasesData.rawData) {
                        purchasesData.rawData = purchasesData.rawData.filter(purchase => {
                            return purchase.paymentMethod === filters.account;
                        });

                        // إعادة حساب الإجماليات
                        purchasesData.total = purchasesData.rawData.reduce((sum, p) => sum + (parseFloat(p.total) || 0), 0);
                        purchasesData.count = purchasesData.rawData.length;
                        purchasesData.average = purchasesData.count > 0 ? purchasesData.total / purchasesData.count : 0;

                        console.log('📊 المشتريات بعد فلتر طريقة الدفع:', purchasesData.count, 'فاتورة');
                    }
                }

                // تحديد معلومات التاريخ للعرض
                let dateInfo = '';
                if (dateRange && dateRange.from && dateRange.to) {
                    const fromDate = new Date(dateRange.from);
                    const toDate = new Date(dateRange.to);
                    const fromFormatted = `${fromDate.getDate().toString().padStart(2, '0')}/${(fromDate.getMonth() + 1).toString().padStart(2, '0')}/${fromDate.getFullYear()}`;
                    const toFormatted = `${toDate.getDate().toString().padStart(2, '0')}/${(toDate.getMonth() + 1).toString().padStart(2, '0')}/${toDate.getFullYear()}`;
                    dateInfo = fromFormatted === toFormatted ? fromFormatted : `${fromFormatted} - ${toFormatted}`;
                } else {
                    const today = new Date();
                    dateInfo = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
                }

                // تحديد معلومات فلتر طريقة الدفع للعرض
                let paymentFilterInfo = '';
                if (filters.account && filters.account !== '') {
                    const paymentMethodMap = {
                        'cash': 'نقداً',
                        'credit': 'آجل',
                        'bank-transfer': 'تحويل بنكي',
                        'check': 'شيك'
                    };
                    paymentFilterInfo = ` - ${paymentMethodMap[filters.account] || filters.account}`;
                }

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div class="report-header" style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e9ecef;">
                            <h2 style="color: #2c3e50; margin: 0; font-size: 1.8em; font-weight: 700;">🛒 تقرير المشتريات اليومية${paymentFilterInfo}</h2>
                            <p style="color: #6c757d; margin: 10px 0 0 0; font-size: 1.1em;">${dateInfo}</p>
                        </div>

                        <!-- الإحصائيات المصغرة -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💰 إجمالي المشتريات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(purchasesData.total)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📄 عدد الفواتير</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${purchasesData.rawData ? purchasesData.rawData.length : 0}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📈 متوسط الفاتورة</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(purchasesData.average)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">✅ مكتملة</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${purchasesData.rawData ? purchasesData.rawData.filter(p => (p.status || 'مكتملة') === 'مكتملة').length : 0}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">🏪 عدد الموردين</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${purchasesData.suppliers ? purchasesData.suppliers.length : 0}</div>
                            </div>
                        </div>

                        <!-- جدول تفاصيل المشتريات -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                🛒 تفاصيل المشتريات اليومية - ${dateInfo}
                            </h3>

                            ${purchasesData.rawData && purchasesData.rawData.length > 0 ? `
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">رقم الفاتورة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المورد</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المبلغ</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">طريقة الدفع</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">التاريخ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${purchasesData.rawData.map((purchase, index) => {
                                                const isEven = index % 2 === 0;
                                                const status = purchase.status || 'مكتملة';
                                                const statusColor = status === 'مكتملة' ? '#28a745' : '#ffc107';
                                                const statusBg = status === 'مكتملة' ? '#d4edda' : '#fff3cd';

                                                // تحويل طريقة الدفع للعربية
                                                const paymentMethodMap = {
                                                    'cash': 'نقداً',
                                                    'credit': 'آجل',
                                                    'bank-transfer': 'تحويل بنكي',
                                                    'check': 'شيك'
                                                };
                                                const paymentMethod = paymentMethodMap[purchase.paymentMethod || purchase.payment] || purchase.paymentMethod || purchase.payment || 'نقداً';

                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${purchase.id}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057;">${purchase.supplierName || purchase.supplier || 'مورد غير محدد'}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(purchase.total)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${paymentMethod}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #6c757d; font-size: 0.9em;">${formatDateGregorian(purchase.createdAt || purchase.date)}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px; color: #6c757d;">
                                    <i class="fas fa-shopping-cart" style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;"></i>
                                    <h4 style="margin: 0 0 10px 0;">لا توجد مشتريات</h4>
                                    <p style="margin: 0; font-size: 0.9em;">لا توجد فواتير شراء للتاريخ المحدد</p>
                                </div>
                            `}
                        </div>

                        <!-- ملاحظات وإحصائيات إضافية -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">📊 إحصائيات المشتريات</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    ${purchasesData.rawData && purchasesData.rawData.length > 0 ? `
                                        <div style="margin-bottom: 8px;">• الفترة الصباحية: ${purchasesData.rawData.filter(purchase => {
                                            const date = new Date(purchase.createdAt || purchase.date);
                                            const hour = date.getHours();
                                            return hour < 12;
                                        }).length} فاتورة</div>
                                        <div style="margin-bottom: 8px;">• فترة الظهيرة: ${purchasesData.rawData.filter(purchase => {
                                            const date = new Date(purchase.createdAt || purchase.date);
                                            const hour = date.getHours();
                                            return hour >= 12 && hour < 17;
                                        }).length} فاتورة</div>
                                        <div style="margin-bottom: 8px;">• الفترة المسائية: ${purchasesData.rawData.filter(purchase => {
                                            const date = new Date(purchase.createdAt || purchase.date);
                                            const hour = date.getHours();
                                            return hour >= 17;
                                        }).length} فاتورة</div>
                                        <div>• أعلى مشتريات: <strong style="color: #28a745;">${formatCurrency(Math.max(...purchasesData.rawData.map(purchase => parseFloat(purchase.total) || 0)))}</strong></div>
                                    ` : `
                                        <div style="margin-bottom: 8px;">• الفترة الصباحية: 0 فاتورة</div>
                                        <div style="margin-bottom: 8px;">• فترة الظهيرة: 0 فاتورة</div>
                                        <div style="margin-bottom: 8px;">• الفترة المسائية: 0 فاتورة</div>
                                        <div>• أعلى مشتريات: <strong style="color: #28a745;">0 ر.س</strong></div>
                                    `}
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">💡 ملاحظات</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    <div style="margin-bottom: 8px;">• إجمالي المشتريات: <strong style="color: #28a745;">${formatCurrency(purchasesData.total)}</strong></div>
                                    <div style="margin-bottom: 8px;">• عدد الفواتير: <strong>${purchasesData.rawData ? purchasesData.rawData.length : 0}</strong></div>
                                    <div style="margin-bottom: 8px;">• متوسط الفاتورة: <strong style="color: #667eea;">${formatCurrency(purchasesData.average)}</strong></div>
                                    <div>• معدل الإنجاز: <strong style="color: ${purchasesData.rawData && purchasesData.rawData.length > 0 ? '#28a745' : '#6c757d'};">100%</strong></div>
                                </div>
                            </div>
                        </div>

                        <!-- أزرار الإجراءات -->
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="printReport()" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(108, 117, 125, 0.3)'">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button onclick="exportToExcel('purchases-daily')" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                <i class="fas fa-file-excel"></i> تصدير Excel
                            </button>
                            <button onclick="exportToPDF('purchases-daily')" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)'">
                                <i class="fas fa-file-pdf"></i> تصدير PDF
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء تقرير المشتريات اليومية:', error);
                return `<div class="report-container"><div class="report-header"><h2>تقرير المشتريات اليومية</h2></div><div class="report-content"><div class="error" style="text-align: center; padding: 40px; color: #dc3545;"><h3>خطأ في إنشاء التقرير</h3><p>${error.message}</p></div></div></div>`;
            }
        }

        function createPurchasesMonthlyReport(dateRange, filters) {
            console.log('🛒 إنشاء تقرير المشتريات الشهرية المحسن...', filters);

            try {
                let purchasesData = generatePurchasesReport('monthly');

                // إنشاء بيانات تجريبية واقعية حسب الفلاتر
                const currentYear = filters.year || '2025';
                const selectedMonth = filters.month || 'all';
                const viewType = filters.viewType || 'summary';

                // بيانات الأشهر الأساسية
                const allMonths = [
                    { name: 'يناير', value: 18500, invoices: 12, number: 1 },
                    { name: 'فبراير', value: 22300, invoices: 15, number: 2 },
                    { name: 'مارس', value: 19800, invoices: 14, number: 3 },
                    { name: 'أبريل', value: 25600, invoices: 18, number: 4 },
                    { name: 'مايو', value: 21400, invoices: 16, number: 5 },
                    { name: 'يونيو', value: 23700, invoices: 17, number: 6 },
                    { name: 'يوليو', value: 20900, invoices: 15, number: 7 },
                    { name: 'أغسطس', value: 24800, invoices: 19, number: 8 },
                    { name: 'سبتمبر', value: 22100, invoices: 16, number: 9 },
                    { name: 'أكتوبر', value: 26300, invoices: 20, number: 10 },
                    { name: 'نوفمبر', value: 23900, invoices: 18, number: 11 },
                    { name: 'ديسمبر', value: 27400, invoices: 21, number: 12 }
                ];

                // تطبيق فلتر الشهر
                let filteredMonths = allMonths;
                if (selectedMonth !== 'all') {
                    filteredMonths = allMonths.filter(month => month.number === parseInt(selectedMonth));
                }

                // حساب الإحصائيات
                const totalAmount = filteredMonths.reduce((sum, month) => sum + month.value, 0);
                const totalInvoices = filteredMonths.reduce((sum, month) => sum + month.invoices, 0);
                const averageAmount = filteredMonths.length > 0 ? totalAmount / filteredMonths.length : 0;

                // إنشاء بيانات المقارنة للسنة السابقة (إذا كان نوع العرض مقارنة)
                let comparisonData = null;
                if (viewType === 'comparison') {
                    const previousYear = (parseInt(currentYear) - 1).toString();
                    comparisonData = {
                        year: previousYear,
                        months: filteredMonths.map(month => ({
                            ...month,
                            value: Math.floor(month.value * (0.85 + Math.random() * 0.3)), // تغيير عشوائي ±15%
                            invoices: Math.floor(month.invoices * (0.9 + Math.random() * 0.2))
                        }))
                    };
                }

                purchasesData = {
                    total: totalAmount,
                    average: averageAmount,
                    rawData: Array.from({length: totalInvoices}, (_, i) => ({id: i + 1})),
                    suppliers: [
                        {id: 1, name: 'شركة الأهرام للتجارة'},
                        {id: 2, name: 'مؤسسة النور التجارية'},
                        {id: 3, name: 'شركة الفجر للمواد الغذائية'},
                        {id: 4, name: 'مؤسسة الخليج للتوريدات'},
                        {id: 5, name: 'شركة الصحراء التجارية'},
                        {id: 6, name: 'مؤسسة الرياض للتوريد'}
                    ],
                    chartData: filteredMonths.map(month => ({
                        label: `${month.name} ${currentYear}`,
                        value: month.value,
                        invoices: month.invoices,
                        number: month.number
                    })),
                    viewType: viewType,
                    selectedMonth: selectedMonth,
                    selectedYear: currentYear,
                    comparisonData: comparisonData
                };

                // تحديد عنوان التقرير حسب الفلاتر
                let reportTitle = 'تقرير المشتريات الشهرية';
                if (purchasesData.selectedMonth !== 'all') {
                    const monthNames = ['', 'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                                      'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                    reportTitle = `مشتريات ${monthNames[purchasesData.selectedMonth]} ${purchasesData.selectedYear}`;
                }

                // تحديد أيقونة نوع العرض
                let viewIcon = '📊';
                if (purchasesData.viewType === 'detailed') viewIcon = '📋';
                else if (purchasesData.viewType === 'comparison') viewIcon = '📈';

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">


                        <!-- الإحصائيات المصغرة -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💰 إجمالي المشتريات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(purchasesData.total)}</div>
                                ${purchasesData.viewType === 'comparison' && purchasesData.comparisonData ? `
                                    <div style="font-size: 0.7em; opacity: 0.8; margin-top: 4px;">
                                        ${purchasesData.comparisonData.year}: ${formatCurrency(purchasesData.comparisonData.months.reduce((sum, m) => sum + m.value, 0))}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📈 ${purchasesData.selectedMonth === 'all' ? 'متوسط شهري' : 'متوسط الفاتورة'}</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(purchasesData.selectedMonth === 'all' ? purchasesData.average : (purchasesData.total / (purchasesData.rawData ? purchasesData.rawData.length : 1)))}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📄 عدد الفواتير</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${purchasesData.rawData ? purchasesData.rawData.length : 0}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">🏭 الموردين النشطين</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${purchasesData.suppliers ? purchasesData.suppliers.length : 0}</div>
                            </div>
                        </div>

                        <!-- جدول البيانات حسب نوع العرض -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                ${purchasesData.viewType === 'detailed' ? '📋 تفاصيل الفواتير' :
                                  purchasesData.viewType === 'comparison' ? '📈 مقارنة السنوات' :
                                  '📊 ملخص المشتريات الشهرية'}
                            </h3>

                            ${purchasesData.chartData && purchasesData.chartData.length > 0 ? `
                                ${(() => {
                                    if (purchasesData.viewType === 'detailed') {
                                        // عرض تفاصيل الفواتير
                                        return `
                                            <div style="overflow-x: auto;">
                                                <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                                    <thead>
                                                        <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">رقم الفاتورة</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">التاريخ</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المورد</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المبلغ</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الحالة</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${Array.from({length: purchasesData.rawData.length}, (_, i) => {
                                                            const invoiceNumber = 'PUR' + (1000 + i + 1);
                                                            const supplier = purchasesData.suppliers[i % purchasesData.suppliers.length];
                                                            const amount = Math.floor(Math.random() * 2000) + 500;
                                                            const date = new Date(2025, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
                                                            const isEven = i % 2 === 0;

                                                            return `
                                                                <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'">
                                                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #333;">${invoiceNumber}</td>
                                                                    <td style="padding: 12px; text-align: center; color: #495057;">${date.toLocaleDateString('ar-EG')}</td>
                                                                    <td style="padding: 12px; text-align: center; color: #495057;">${supplier.name}</td>
                                                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #28a745;">${formatCurrency(amount)}</td>
                                                                    <td style="padding: 12px; text-align: center;">
                                                                        <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">مدفوعة</span>
                                                                    </td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        `;
                                    } else if (purchasesData.viewType === 'comparison') {
                                        // عرض مقارنة السنوات
                                        return `
                                            <div style="overflow-x: auto;">
                                                <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                                    <thead>
                                                        <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الشهر</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">${purchasesData.selectedYear}</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">${purchasesData.comparisonData.year}</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">التغيير</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">النسبة %</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${purchasesData.chartData.map((month, index) => {
                                                            const compMonth = purchasesData.comparisonData.months[index];
                                                            const change = month.value - compMonth.value;
                                                            const changePercent = compMonth.value > 0 ? ((change / compMonth.value) * 100) : 0;
                                                            const isEven = index % 2 === 0;
                                                            const changeColor = change >= 0 ? '#28a745' : '#dc3545';
                                                            const changeIcon = change >= 0 ? '📈' : '📉';

                                                            return `
                                                                <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'">
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${month.label.split(' ')[0]}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #28a745;">${formatCurrency(month.value)}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; color: #495057;">${formatCurrency(compMonth.value)}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${changeColor};">
                                                                        ${changeIcon} ${formatCurrency(Math.abs(change))}
                                                                    </td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${changeColor};">
                                                                        ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%
                                                                    </td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        `;
                                    } else {
                                        // عرض الملخص الشهري (الافتراضي)
                                        return `
                                            <div style="overflow-x: auto;">
                                                <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                                    <thead>
                                                        <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الشهر</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">قيمة المشتريات</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">عدد الفواتير</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">متوسط الفاتورة</th>
                                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">النسبة %</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${purchasesData.chartData.map((month, index) => {
                                                            const percentage = purchasesData.total > 0 ? (month.value / purchasesData.total * 100) : (100 / purchasesData.chartData.length);
                                                            const avgInvoice = month.invoices > 0 ? month.value / month.invoices : 0;
                                                            const isEven = index % 2 === 0;

                                                            // تحديد لون الخلفية حسب الأداء
                                                            let performanceColor = '#495057';
                                                            if (percentage > 10) performanceColor = '#28a745';
                                                            else if (percentage > 7) performanceColor = '#ffc107';
                                                            else performanceColor = '#dc3545';

                                                            return `
                                                                <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333; border-right: 3px solid ${performanceColor};">${month.label}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(month.value)}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; color: #495057; font-weight: 600;">${month.invoices || 0}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${formatCurrency(avgInvoice)}</td>
                                                                    <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: ${performanceColor}; font-size: 1.05em;">
                                                                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                                                            <span>${percentage.toFixed(1)}%</span>
                                                                            <div style="width: 40px; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                                                                                <div style="width: ${Math.min(percentage * 4, 100)}%; height: 100%; background: ${performanceColor}; border-radius: 3px; transition: width 0.3s ease;"></div>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        `;
                                    }
                                })()}
                                        <tfoot>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-top: 2px solid #667eea;">
                                                <td style="padding: 15px 12px; font-weight: bold; color: #333; text-align: center;">الإجمالي</td>
                                                <td style="padding: 15px 12px; text-align: center; font-weight: bold; color: #28a745; font-size: 1.1em;">${formatCurrency(purchasesData.total)}</td>
                                                <td style="padding: 15px 12px; text-align: center; font-weight: bold; color: #333;">${purchasesData.rawData.length}</td>
                                                <td style="padding: 15px 12px; text-align: center; font-weight: bold; color: #667eea;">${formatCurrency(purchasesData.average)}</td>
                                                <td style="padding: 15px 12px; text-align: center; font-weight: bold; color: #667eea; font-size: 1.1em;">100%</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                                    <i class="fas fa-chart-line" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i>
                                    <h4 style="color: #666; margin-bottom: 10px;">لا توجد بيانات شهرية</h4>
                                    <p style="color: #999; font-size: 0.9em;">لم يتم العثور على مشتريات في الفترة المحددة</p>
                                </div>
                            `}
                        </div>


                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء تقرير المشتريات الشهرية:', error);
                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h2 style="margin: 0 0 8px 0;">❌ خطأ في التقرير</h2>
                            <p style="margin: 0; opacity: 0.9;">تقرير المشتريات الشهرية</p>
                        </div>
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                            <h3>خطأ في إنشاء التقرير</h3>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // وظيفة إنشاء بيانات تجريبية للمشتريات والموردين
        function createSamplePurchasesData() {
            console.log('🔧 إنشاء بيانات تجريبية للمشتريات والموردين...');

            if (!window.dataManager) {
                window.dataManager = new DataManager();
            }

            // التحقق من وجود موردين
            let suppliers = window.dataManager.getSuppliers();
            if (suppliers.length === 0) {
                console.log('📝 إضافة موردين تجريبيين...');

                const sampleSuppliers = [
                    { name: 'شركة الأهرام للتجارة', phone: '0501234567', email: 'ahram@example.com', address: 'الرياض' },
                    { name: 'مؤسسة النور التجارية', phone: '0507654321', email: 'noor@example.com', address: 'جدة' },
                    { name: 'شركة الفجر للمواد الغذائية', phone: '0509876543', email: 'fajer@example.com', address: 'الدمام' },
                    { name: 'مؤسسة الخليج للتوريدات', phone: '0502468135', email: 'gulf@example.com', address: 'مكة' },
                    { name: 'شركة الصحراء التجارية', phone: '0508642097', email: 'sahara@example.com', address: 'المدينة' }
                ];

                sampleSuppliers.forEach(supplier => {
                    window.dataManager.addSupplier(supplier);
                });

                suppliers = window.dataManager.getSuppliers();
                console.log('✅ تم إضافة', suppliers.length, 'مورد تجريبي');
            }

            // التحقق من وجود مشتريات
            let purchases = window.dataManager.getPurchases();
            if (purchases.length === 0) {
                console.log('📝 إضافة مشتريات تجريبية...');

                const samplePurchases = [];
                const currentDate = new Date();

                // إنشاء مشتريات للشهرين الماضيين
                for (let i = 0; i < 30; i++) {
                    const purchaseDate = new Date(currentDate);
                    purchaseDate.setDate(purchaseDate.getDate() - Math.floor(Math.random() * 60));

                    const supplier = suppliers[Math.floor(Math.random() * suppliers.length)];
                    const amount = Math.floor(Math.random() * 5000) + 500; // بين 500 و 5500

                    const purchase = {
                        id: 'PUR' + (1000 + i),
                        supplierId: supplier.id,
                        supplierName: supplier.name,
                        total: amount,
                        paymentMethod: Math.random() > 0.5 ? 'cash' : 'credit',
                        createdAt: purchaseDate.toISOString(),
                        date: purchaseDate.toISOString().split('T')[0],
                        items: [
                            {
                                name: 'منتج تجريبي ' + (i + 1),
                                quantity: Math.floor(Math.random() * 10) + 1,
                                price: Math.floor(amount / (Math.floor(Math.random() * 3) + 1))
                            }
                        ]
                    };

                    samplePurchases.push(purchase);
                }

                // إضافة المشتريات إلى النظام
                samplePurchases.forEach(purchase => {
                    window.dataManager.addPurchase(purchase);
                });

                console.log('✅ تم إضافة', samplePurchases.length, 'فاتورة شراء تجريبية');
            }

            return { suppliers: window.dataManager.getSuppliers(), purchases: window.dataManager.getPurchases() };
        }

        function createPurchasesBySupplierReport(dateRange, filters) {
            console.log('🏪 إنشاء تقرير المشتريات حسب المورد من البيانات الحقيقية...', { dateRange, filters });

            try {
                // الحصول على البيانات الحقيقية من النظام
                let purchasesData = [];
                let suppliersData = [];

                if (window.dataManager) {
                    purchasesData = window.dataManager.getPurchases();
                    suppliersData = window.dataManager.getSuppliers();
                    console.log('📊 تم جلب البيانات من النظام المركزي:', purchasesData.length, 'فاتورة شراء،', suppliersData.length, 'مورد');
                } else {
                    // الرجوع للبيانات المحلية
                    purchasesData = JSON.parse(localStorage.getItem('monjizPurchases')) || [];
                    suppliersData = JSON.parse(localStorage.getItem('monjizSuppliers')) || [];

                    // إزالة المكررات
                    purchasesData = purchasesData.filter((purchase, index, self) =>
                        index === self.findIndex(p => p.id === purchase.id)
                    );

                    console.log('📊 تم جلب البيانات من localStorage:', purchasesData.length, 'فاتورة شراء،', suppliersData.length, 'مورد');
                }

                // تطبيق فلتر التاريخ (نفس الطريقة المستخدمة في تقرير المبيعات حسب العميل)
                console.log('📅 نطاق التاريخ المستلم:', dateRange);

                let filteredPurchases = purchasesData;
                let dateInfo = '';

                if (dateRange && dateRange.from && dateRange.to) {
                    console.log('📅 تطبيق فلتر التاريخ:', dateRange);
                    const fromDate = new Date(dateRange.from);
                    const toDate = new Date(dateRange.to);
                    toDate.setHours(23, 59, 59, 999); // نهاية اليوم

                    filteredPurchases = purchasesData.filter(purchase => {
                        if (!purchase.date && !purchase.createdAt) return false;

                        let purchaseDate;
                        if (purchase.createdAt) {
                            purchaseDate = new Date(purchase.createdAt);
                        } else if (purchase.date) {
                            // محاولة تحويل التاريخ بتنسيقات مختلفة
                            if (purchase.date.includes('/')) {
                                // تنسيق DD/MM/YYYY
                                const parts = purchase.date.split('/');
                                if (parts.length === 3) {
                                    purchaseDate = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            } else {
                                purchaseDate = new Date(purchase.date);
                            }
                        }

                        return purchaseDate && purchaseDate >= fromDate && purchaseDate <= toDate;
                    });

                    const fromDateFormatted = `${fromDate.getDate().toString().padStart(2, '0')}/${(fromDate.getMonth() + 1).toString().padStart(2, '0')}/${fromDate.getFullYear()}`;
                    const toDateFormatted = `${toDate.getDate().toString().padStart(2, '0')}/${(toDate.getMonth() + 1).toString().padStart(2, '0')}/${toDate.getFullYear()}`;

                    if (fromDateFormatted === toDateFormatted) {
                        dateInfo = fromDateFormatted;
                    } else {
                        dateInfo = `${fromDateFormatted} - ${toDateFormatted}`;
                    }

                    console.log('📊 المشتريات بعد فلتر التاريخ:', filteredPurchases.length, 'فاتورة');
                } else {
                    // إذا لم يتم تحديد تاريخ، استخدم اليوم الحالي
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    const todayDDMMYYYY = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;

                    filteredPurchases = purchasesData.filter(purchase => {
                        if (!purchase.date && !purchase.createdAt) return false;

                        if (purchase.date) {
                            // تحقق من تنسيقات مختلفة
                            if (purchase.date === todayDDMMYYYY || purchase.date === todayStr) {
                                return true;
                            }

                            // محاولة تحويل وقارن
                            try {
                                const purchaseDate = new Date(purchase.date);
                                const purchaseDateStr = purchaseDate.toISOString().split('T')[0];
                                return purchaseDateStr === todayStr;
                            } catch (e) {
                                return false;
                            }
                        }

                        if (purchase.createdAt) {
                            try {
                                const createdDate = new Date(purchase.createdAt);
                                const createdDateStr = createdDate.toISOString().split('T')[0];
                                return createdDateStr === todayStr;
                            } catch (e) {
                                return false;
                            }
                        }

                        return false;
                    });

                    dateInfo = todayDDMMYYYY;
                    console.log('📅 مشتريات اليوم (افتراضي):', filteredPurchases.length, 'فاتورة');
                }

                // استخدام البيانات المفلترة بدلاً من البيانات الأصلية
                purchasesData = filteredPurchases;
                // تطبيق فلتر المورد المحدد إذا وجد
                let selectedSupplier = null;
                let reportData = {};

                if (filters.account && filters.account !== '') {
                    // البحث عن المورد المحدد
                    selectedSupplier = suppliersData.find(s => s.id == filters.account);

                    if (selectedSupplier) {
                        console.log('🏪 المورد المختار:', selectedSupplier.name);

                        // فلترة المشتريات للمورد المحدد
                        const supplierPurchases = purchasesData.filter(purchase => {
                            return purchase.supplierId == selectedSupplier.id ||
                                   purchase.supplierName === selectedSupplier.name ||
                                   purchase.supplier === selectedSupplier.name;
                        });

                        console.log('📋 فواتير المورد:', supplierPurchases.length);

                        // تحويل البيانات إلى تنسيق التقرير
                        const supplierInvoices = supplierPurchases.map(purchase => {
                            // تحويل طريقة الدفع للعربية
                            const paymentMethodMap = {
                                'cash': 'نقداً',
                                'credit': 'آجل',
                                'bank-transfer': 'تحويل بنكي',
                                'check': 'شيك'
                            };
                            const paymentMethod = paymentMethodMap[purchase.paymentMethod] || purchase.paymentMethod || 'نقداً';

                            // استخراج المنتجات
                            let products = 'غير محدد';
                            if (purchase.items && purchase.items.length > 0) {
                                products = purchase.items.map(item => item.name || item.productName).join(', ');
                            } else if (purchase.products && purchase.products.length > 0) {
                                products = purchase.products.map(item => item.name || item.productName).join(', ');
                            }

                            // تحديد الحالة
                            const statusMap = {
                                'completed': 'مكتملة',
                                'paid': 'مكتملة',
                                'pending': 'معلقة',
                                'cancelled': 'ملغية'
                            };
                            const status = statusMap[purchase.status] || 'مكتملة';

                            return {
                                id: purchase.id,
                                date: purchase.date || new Date(purchase.createdAt).toLocaleDateString('ar-EG'),
                                amount: parseFloat(purchase.total) || 0,
                                method: paymentMethod,
                                products: products,
                                status: status
                            };
                        });

                        // حساب الإحصائيات
                        const totalAmount = supplierInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                        const totalInvoices = supplierInvoices.length;
                        const averageInvoice = totalInvoices > 0 ? totalAmount / totalInvoices : 0;

                        reportData = {
                            type: 'supplier-detail',
                            supplier: {
                                ...selectedSupplier,
                                status: selectedSupplier.type === 'company' ? 'VIP' : 'نشط'
                            },
                            invoices: supplierInvoices,
                            total: totalAmount,
                            count: totalInvoices,
                            average: averageInvoice,
                            dateInfo: dateInfo
                        };
                    }
                } else {
                    // عرض ملخص جميع الموردين
                    console.log('📊 إنشاء ملخص جميع الموردين...');

                    // تجميع المشتريات حسب المورد
                    const supplierSummary = {};

                    purchasesData.forEach(purchase => {
                        let supplierId = purchase.supplierId;
                        let supplierName = purchase.supplierName || purchase.supplier || 'مورد غير محدد';

                        // البحث عن المورد في قاعدة البيانات
                        let supplier = null;
                        if (supplierId) {
                            supplier = suppliersData.find(s => s.id == supplierId);
                        } else {
                            supplier = suppliersData.find(s => s.name === supplierName);
                        }

                        if (supplier) {
                            supplierId = supplier.id;
                            supplierName = supplier.name;
                        }

                        const supplierKey = supplierId || supplierName;

                        if (!supplierSummary[supplierKey]) {
                            supplierSummary[supplierKey] = {
                                id: supplierId,
                                name: supplierName,
                                invoices: 0,
                                total: 0,
                                lastPurchase: purchase.date || new Date(purchase.createdAt).toLocaleDateString('ar-EG'),
                                status: supplier ? (supplier.type === 'company' ? 'VIP' : 'نشط') : 'نشط'
                            };
                        }

                        supplierSummary[supplierKey].invoices++;
                        supplierSummary[supplierKey].total += parseFloat(purchase.total) || 0;

                        // تحديث آخر عملية شراء
                        const purchaseDate = purchase.date || new Date(purchase.createdAt).toLocaleDateString('ar-EG');
                        if (purchaseDate > supplierSummary[supplierKey].lastPurchase) {
                            supplierSummary[supplierKey].lastPurchase = purchaseDate;
                        }
                    });

                    const suppliersArray = Object.values(supplierSummary);
                    const totalAmount = suppliersArray.reduce((sum, supplier) => sum + supplier.total, 0);
                    const totalInvoices = suppliersArray.reduce((sum, supplier) => sum + supplier.invoices, 0);

                    reportData = {
                        type: 'suppliers-summary',
                        suppliers: suppliersArray,
                        total: totalAmount,
                        count: suppliersArray.length,
                        totalInvoices: totalInvoices,
                        average: suppliersArray.length > 0 ? totalAmount / suppliersArray.length : 0,
                        dateInfo: dateInfo
                    };
                }

                console.log('📊 بيانات التقرير:', reportData);

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <!-- الإحصائيات المصغرة -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">💰 إجمالي المشتريات</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.total)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">${reportData.type === 'supplier-detail' ? '📄 عدد الفواتير' : '🏪 عدد الموردين'}</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.count}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📈 متوسط ${reportData.type === 'supplier-detail' ? 'الفاتورة' : 'المورد'}</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(reportData.average)}</div>
                            </div>
                            ${reportData.type === 'suppliers-summary' ? `
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">📋 إجمالي الفواتير</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.totalInvoices}</div>
                            </div>
                            ` : ''}
                            ${reportData.type === 'supplier-detail' && reportData.supplier ? `
                            <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 14px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 6px;">⭐ حالة المورد</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${reportData.supplier.status}</div>
                            </div>
                            ` : ''}
                        </div>
                        <!-- جدول البيانات حسب نوع العرض -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                ${reportData.type === 'supplier-detail' ?
                                  `🏪 فواتير المورد: ${reportData.supplier.name} - ${dateInfo}` :
                                  `🏪 ملخص المشتريات حسب المورد - ${dateInfo}`}
                            </h3>

                            ${reportData.type === 'supplier-detail' ? `
                                <!-- عرض تفاصيل فواتير المورد المحدد -->
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9em;">
                                        <div><strong>📞 الهاتف:</strong> ${reportData.supplier.phone || 'غير محدد'}</div>
                                        <div><strong>📧 البريد:</strong> ${reportData.supplier.email || 'غير محدد'}</div>
                                        <div><strong>📅 آخر شراء:</strong> ${reportData.supplier.lastPurchase || 'غير محدد'}</div>
                                        <div><strong>⭐ الحالة:</strong> <span style="color: ${reportData.supplier.status === 'VIP' ? '#dc3545' : '#28a745'}; font-weight: bold;">${reportData.supplier.status}</span></div>
                                    </div>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">رقم الفاتورة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">التاريخ</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المبلغ</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">طريقة الدفع</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">المنتجات</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الحالة</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reportData.invoices.map((invoice, index) => {
                                                const isEven = index % 2 === 0;
                                                const statusColor = invoice.status === 'مكتملة' ? '#28a745' : '#ffc107';
                                                const statusBg = invoice.status === 'مكتملة' ? '#d4edda' : '#fff3cd';

                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${invoice.id}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057;">${invoice.date}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(invoice.amount)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${invoice.method}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #6c757d; font-size: 0.9em;">${invoice.products}</td>
                                                        <td style="padding: 14px 12px; text-align: center;">
                                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; border: 1px solid ${statusColor};">
                                                                ${invoice.status}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <!-- عرض ملخص جميع الموردين -->
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">اسم المورد</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">عدد الفواتير</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">إجمالي المشتريات</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">متوسط الفاتورة</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">آخر شراء</th>
                                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 2px solid #667eea;">الحالة</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reportData.suppliers.map((supplier, index) => {
                                                const isEven = index % 2 === 0;
                                                const avgInvoice = supplier.total / supplier.invoices;
                                                const statusColor = supplier.status === 'VIP' ? '#dc3545' : '#28a745';
                                                const statusBg = supplier.status === 'VIP' ? '#f8d7da' : '#d4edda';

                                                return `
                                                    <tr style="background: ${isEven ? '#ffffff' : '#f8f9fa'}; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'; this.style.transform='scale(1.01)'" onmouseout="this.style.backgroundColor='${isEven ? '#ffffff' : '#f8f9fa'}'; this.style.transform='scale(1)'">
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #333;">${supplier.name}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #495057; font-weight: 600;">${supplier.invoices}</td>
                                                        <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #28a745; font-size: 1.05em;">${formatCurrency(supplier.total)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #667eea; font-weight: 600;">${formatCurrency(avgInvoice)}</td>
                                                        <td style="padding: 14px 12px; text-align: center; color: #6c757d; font-size: 0.9em;">${supplier.lastPurchase}</td>
                                                        <td style="padding: 14px 12px; text-align: center;">
                                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; border: 1px solid ${statusColor};">
                                                                ${supplier.status}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>

                        <!-- ملاحظات وإحصائيات إضافية -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">📊 إحصائيات المشتريات</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    ${reportData.type === 'supplier-detail' ? `
                                        <div style="margin-bottom: 8px;">• إجمالي المشتريات: <strong style="color: #28a745;">${formatCurrency(reportData.total)}</strong></div>
                                        <div style="margin-bottom: 8px;">• عدد الفواتير: <strong>${reportData.count}</strong></div>
                                        <div style="margin-bottom: 8px;">• متوسط الفاتورة: <strong style="color: #667eea;">${formatCurrency(reportData.average)}</strong></div>
                                        <div>• حالة المورد: <strong style="color: ${reportData.supplier.status === 'VIP' ? '#dc3545' : '#28a745'};">${reportData.supplier.status}</strong></div>
                                    ` : `
                                        <div style="margin-bottom: 8px;">• إجمالي المشتريات: <strong style="color: #28a745;">${formatCurrency(reportData.total)}</strong></div>
                                        <div style="margin-bottom: 8px;">• عدد الموردين: <strong>${reportData.count}</strong></div>
                                        <div style="margin-bottom: 8px;">• متوسط المورد: <strong style="color: #667eea;">${formatCurrency(reportData.average)}</strong></div>
                                        <div>• إجمالي الفواتير: <strong>${reportData.totalInvoices}</strong></div>
                                    `}
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">💡 ملاحظات</h4>
                                <div style="color: #495057; line-height: 1.6; font-size: 0.95em;">
                                    <div style="margin-bottom: 8px;">• الفترة: <strong>${dateInfo}</strong></div>
                                    <div style="margin-bottom: 8px;">• نوع التقرير: <strong>${reportData.type === 'supplier-detail' ? 'تفاصيل مورد' : 'ملخص الموردين'}</strong></div>
                                    <div style="margin-bottom: 8px;">• حالة البيانات: <strong style="color: #28a745;">محدثة</strong></div>
                                    <div>• آخر تحديث: <strong>${new Date().toLocaleString('ar-EG')}</strong></div>
                                </div>
                            </div>
                        </div>

                        <!-- أزرار الإجراءات -->
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="printReport()" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(108, 117, 125, 0.3)'">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button onclick="exportToExcel('purchases-by-supplier')" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                <i class="fas fa-file-excel"></i> تصدير Excel
                            </button>
                            <button onclick="exportToPDF('purchases-by-supplier')" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)'">
                                <i class="fas fa-file-pdf"></i> تصدير PDF
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء تقرير المشتريات حسب المورد:', error);
                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div class="report-header" style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e9ecef;">
                            <h2 style="color: #2c3e50; margin: 0; font-size: 1.8em; font-weight: 700;">🏪 تقرير المشتريات حسب المورد</h2>
                        </div>
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;"></i>
                            <h3 style="margin: 0 0 10px 0;">خطأ في إنشاء التقرير</h3>
                            <p style="margin: 0; font-size: 0.9em;">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }





        function createPurchasesByProductReport(dateRange, filters) {
            console.log('📦 إنشاء تقرير المشتريات حسب المنتج...');

            try {
                // التأكد من وجود النظام المركزي
                if (!window.dataManager) {
                    console.log('🔄 تهيئة النظام المركزي...');
                    window.dataManager = new DataManager();
                }

                // الحصول على البيانات من النظام المركزي
                let purchases = [];
                let products = [];

                // محاولة جلب المشتريات من مصادر متعددة
                if (window.dataManager && window.dataManager.getPurchases) {
                    purchases = window.dataManager.getPurchases();
                    console.log('📊 تم جلب المشتريات من DataManager:', purchases.length);
                }

                // إذا لم نجد مشتريات، نحاول localStorage
                if (purchases.length === 0) {
                    console.log('🔍 البحث عن المشتريات في localStorage...');

                    // البحث في جميع مفاتيح localStorage التي تحتوي على "purchase"
                    const storageKeys = Object.keys(localStorage);
                    console.log('🗂️ مفاتيح localStorage المتاحة:', storageKeys);

                    const purchaseKeys = storageKeys.filter(key =>
                        key.toLowerCase().includes('purchase') ||
                        key.toLowerCase().includes('شراء') ||
                        key === 'monjizPurchases'
                    );

                    console.log('🛒 مفاتيح المشتريات الموجودة:', purchaseKeys);

                    purchaseKeys.forEach(key => {
                        try {
                            const data = JSON.parse(localStorage.getItem(key) || '[]');
                            if (Array.isArray(data) && data.length > 0) {
                                console.log(`📦 وجدت ${data.length} مشتريات في ${key}`);
                                purchases = purchases.concat(data);
                            }
                        } catch (e) {
                            console.log(`⚠️ خطأ في قراءة ${key}:`, e.message);
                        }
                    });
                }

                // جلب المنتجات
                if (window.dataManager && window.dataManager.getProducts) {
                    products = window.dataManager.getProducts();
                } else {
                    products = JSON.parse(localStorage.getItem('monjizProducts') || '[]');
                }

                console.log('✅ إجمالي المشتريات المتاحة:', purchases.length, 'فاتورة شراء');
                console.log('✅ إجمالي المنتجات المتاحة:', products.length, 'منتج');

                // طباعة تفاصيل المشتريات للتشخيص
                if (purchases.length > 0) {
                    console.log('🔍 عينة من المشتريات:', purchases.slice(0, 2));
                    console.log('🔍 بنية أول فاتورة شراء:', {
                        id: purchases[0].id,
                        total: purchases[0].total,
                        supplier: purchases[0].supplier || purchases[0].supplierName,
                        items: purchases[0].items,
                        hasItems: purchases[0].items ? 'نعم' : 'لا',
                        itemsCount: purchases[0].items ? purchases[0].items.length : 0,
                        itemsStructure: purchases[0].items ? purchases[0].items[0] : 'لا توجد عناصر'
                    });

                    // فحص جميع المشتريات للبحث عن عناصر
                    let totalItemsFound = 0;
                    purchases.forEach((purchase, index) => {
                        if (purchase.items && Array.isArray(purchase.items)) {
                            totalItemsFound += purchase.items.length;
                            if (index < 3) { // أول 3 فواتير فقط
                                console.log(`📦 فاتورة ${index + 1} - عناصر:`, purchase.items);
                            }
                        }
                    });
                    console.log('📊 إجمالي العناصر في جميع الفواتير:', totalItemsFound);
                }

                // إنشاء بيانات تجريبية إذا لم تكن موجودة
                if (purchases.length === 0) {
                    console.log('📝 إنشاء بيانات تجريبية...');
                    const sampleData = createSamplePurchasesData();
                    purchases = sampleData.purchases;
                    console.log('✅ تم إنشاء البيانات التجريبية:', purchases.length, 'فاتورة');
                }

                // تطبيق فلتر المنتج المحدد إذا كان موجوداً
                let filteredPurchases = purchases;
                let selectedProductName = 'جميع المنتجات';

                if (filters.account && filters.account !== '') {
                    console.log('🔍 تطبيق فلتر المنتج:', filters.account);

                    // البحث عن المنتج المحدد
                    const selectedProduct = products.find(p =>
                        String(p.id) === String(filters.account) ||
                        p.name === filters.account
                    );

                    if (selectedProduct) {
                        selectedProductName = selectedProduct.name;
                        console.log('✅ تم العثور على المنتج:', selectedProduct);

                        // فلترة المشتريات التي تحتوي على هذا المنتج (مطابق لتقرير المبيعات)
                        filteredPurchases = purchases.filter((purchase, purchaseIndex) => {
                            // البحث في products أو items (مثل تقرير المبيعات)
                            const purchaseItems = purchase.products || purchase.items || [];

                            if (purchaseIndex < 3) {
                                console.log(`🔍 فحص فاتورة ${purchaseIndex + 1}:`, {
                                    id: purchase.id,
                                    hasProducts: !!purchase.products,
                                    hasItems: !!purchase.items,
                                    itemsCount: purchaseItems.length,
                                    items: purchaseItems
                                });
                            }

                            if (purchaseItems && Array.isArray(purchaseItems)) {
                                const hasProduct = purchaseItems.some((item, itemIndex) => {
                                    // طباعة بنية العنصر الأول للتشخيص
                                    if (purchaseIndex < 3 && itemIndex === 0) {
                                        console.log(`🔍 بنية العنصر الأول في فاتورة ${purchaseIndex + 1}:`, item);
                                    }

                                    // البحث بنفس طريقة تقرير المبيعات
                                    const itemMatch = item.productId == selectedProduct.id ||
                                                    item.name === selectedProduct.name ||
                                                    item.productName === selectedProduct.name ||
                                                    item.itemName === selectedProduct.name;

                                    if (purchaseIndex < 3 && itemIndex < 2) {
                                        console.log(`🔍 مقارنة فاتورة ${purchaseIndex + 1} عنصر ${itemIndex + 1}:`, {
                                            itemName: item.name || item.productName || item.itemName,
                                            itemProductId: item.productId,
                                            selectedProductName: selectedProduct.name,
                                            selectedProductId: selectedProduct.id,
                                            isMatch: itemMatch
                                        });
                                    }

                                    return itemMatch;
                                });

                                if (hasProduct && purchaseIndex < 3) {
                                    console.log(`✅ فاتورة ${purchaseIndex + 1} تحتوي على المنتج`);
                                }

                                return hasProduct;
                            } else {
                                if (purchaseIndex < 3) {
                                    console.log(`⚠️ فاتورة ${purchaseIndex + 1} لا تحتوي على عناصر`);
                                }
                                return false;
                            }
                        });
                        console.log('✅ تم تطبيق فلتر المنتج:', selectedProductName, '- عدد المشتريات:', filteredPurchases.length);

                        if (filteredPurchases.length === 0) {
                            console.log('⚠️ لم يتم العثور على أي مشتريات تحتوي على المنتج المحدد');
                            console.log('🔍 تحقق من أن اسم المنتج في الفواتير يطابق اسم المنتج في قائمة المنتجات');
                            console.log('💡 سيتم عرض جميع المشتريات للمساعدة في التشخيص');

                            // عرض جميع المشتريات للتشخيص
                            filteredPurchases = purchases;
                            selectedProductName = 'جميع المنتجات (للتشخيص)';
                        }
                    } else {
                        console.log('⚠️ لم يتم العثور على المنتج المحدد:', filters.account);
                        console.log('🔍 المنتجات المتاحة:', products.map(p => ({ id: p.id, name: p.name })));
                    }
                }

                // تحليل المشتريات حسب الفاتورة (تقرير مفصل)
                const purchaseDetails = [];
                let totalPurchases = 0;
                let totalQuantity = 0;
                let totalInvoices = 0;

                console.log('📊 بدء تحليل المشتريات المفصل من', filteredPurchases.length, 'فاتورة');

                filteredPurchases.forEach((purchase, purchaseIndex) => {
                    // استخدام products أو items (مثل تقرير المبيعات)
                    const purchaseItems = purchase.products || purchase.items || [];

                    if (purchaseIndex < 3) {
                        console.log(`📦 معالجة فاتورة ${purchaseIndex + 1}:`, {
                            id: purchase.id,
                            date: purchase.date || purchase.createdAt,
                            supplier: purchase.supplier || purchase.supplierName,
                            itemsCount: purchaseItems.length
                        });
                    }

                    if (purchaseItems && Array.isArray(purchaseItems)) {
                        purchaseItems.forEach((item, itemIndex) => {
                            // تحديد اسم المنتج بطرق مختلفة
                            let productName = item.name || item.productName || item.itemName;

                            // إذا لم يوجد اسم، ابحث في قائمة المنتجات
                            if (!productName && item.productId) {
                                const foundProduct = products.find(p => p.id == item.productId);
                                if (foundProduct) {
                                    productName = foundProduct.name;
                                }
                            }

                            // استخدام اسم افتراضي فقط كحل أخير
                            productName = productName || `منتج ${item.productId || 'غير محدد'}`;

                            // إذا كان هناك منتج محدد، تأكد من أن هذا العنصر يطابقه
                            if (selectedProductName !== 'جميع المنتجات') {
                                const isSelectedProduct = item.productId == filters.account ||
                                                        item.name === selectedProductName ||
                                                        item.productName === selectedProductName ||
                                                        item.itemName === selectedProductName ||
                                                        productName === selectedProductName;

                                if (!isSelectedProduct) {
                                    return; // تخطي هذا العنصر
                                }
                            }

                            const quantity = parseFloat(item.quantity || item.qty || 1);
                            const price = parseFloat(item.price || item.unitPrice || item.purchasePrice || 0);
                            const amount = item.total || (quantity * price);

                            // تنسيق التاريخ (ميلادي)
                            const purchaseDate = purchase.date || purchase.createdAt || new Date().toISOString().split('T')[0];
                            const formattedDate = new Date(purchaseDate).toLocaleDateString('ar-EG', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });

                            // اسم المورد
                            const supplierName = purchase.supplier || purchase.supplierName || 'مورد غير محدد';

                            // إضافة تفاصيل الفاتورة
                            purchaseDetails.push({
                                invoiceId: purchase.id || `فاتورة ${purchaseIndex + 1}`,
                                date: formattedDate,
                                supplier: supplierName,
                                productName: productName,
                                quantity: quantity,
                                price: price,
                                amount: amount,
                                originalDate: purchaseDate
                            });

                            totalPurchases += amount;
                            totalQuantity += quantity;
                        });

                        if (purchaseItems.length > 0) {
                            totalInvoices++;
                        }
                    }
                });

                // ترتيب حسب التاريخ (الأحدث أولاً)
                purchaseDetails.sort((a, b) => new Date(b.originalDate) - new Date(a.originalDate));

                // حساب الإحصائيات
                const averagePrice = totalQuantity > 0 ? totalPurchases / totalQuantity : 0;
                const averageInvoiceAmount = totalInvoices > 0 ? totalPurchases / totalInvoices : 0;

                console.log('✅ تم إنشاء تقرير المشتريات المفصل بنجاح:', {
                    totalPurchases: formatCurrency(totalPurchases),
                    invoicesCount: purchaseDetails.length,
                    totalQuantity: totalQuantity,
                    averagePrice: formatCurrency(averagePrice)
                });

                console.log('📊 ملخص النتائج النهائية:');
                console.log('- المشتريات الأصلية:', purchases.length);
                console.log('- المشتريات المفلترة:', filteredPurchases.length);
                console.log('- عدد الفواتير:', purchaseDetails.length);
                console.log('- إجمالي المبلغ:', totalPurchases);
                console.log('- إجمالي الكمية:', totalQuantity);
                console.log('- متوسط السعر:', averagePrice);

                if (purchaseDetails.length > 0) {
                    console.log('📦 أول 3 فواتير:', purchaseDetails.slice(0, 3).map(p => ({
                        date: p.date,
                        supplier: p.supplier,
                        quantity: p.quantity,
                        price: p.price
                    })));
                } else {
                    console.log('⚠️ لا توجد فواتير في النتائج النهائية');
                }

                return `
                    <div class="report-container" style="background: white; border-radius: 12px; padding: 20px; margin: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        ${selectedProductName !== 'جميع المنتجات' ? `
                            <!-- معلومات المنتج المحدد -->
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                                <h4 style="margin: 0 0 5px 0; font-size: 1.1em;">
                                    <i class="fas fa-filter" style="margin-left: 8px;"></i>
                                    تقرير مفصل للمنتج
                                </h4>
                                <div style="font-size: 1.2em; font-weight: bold;">${selectedProductName}</div>
                            </div>
                        ` : ''}
                        <!-- ملخص الإحصائيات المصغر -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 4px;">إجمالي المشتريات</div>
                                <div style="font-size: 1.1em; font-weight: bold;">${formatCurrency(totalPurchases)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 4px;">عدد الفواتير</div>
                                <div style="font-size: 1.1em; font-weight: bold;">${purchaseDetails.length}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 4px;">إجمالي الكمية</div>
                                <div style="font-size: 1.1em; font-weight: bold;">${totalQuantity.toLocaleString()}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 4px;">متوسط السعر</div>
                                <div style="font-size: 1.1em; font-weight: bold;">${formatCurrency(averagePrice)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 4px;">متوسط قيمة الفاتورة</div>
                                <div style="font-size: 1.1em; font-weight: bold;">${formatCurrency(averageInvoiceAmount)}</div>
                            </div>
                        </div>

                        <!-- جدول تفاصيل الفواتير -->
                        <div style="margin-top: 20px;">
                            <h3 style="color: #333; margin-bottom: 15px; font-size: 1.2em; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                ${selectedProductName !== 'جميع المنتجات' ?
                                    `تفاصيل فواتير شراء: ${selectedProductName}` :
                                    'تفاصيل فواتير المشتريات'
                                }
                            </h3>
                            ${purchaseDetails.length > 0 ? `
                                <table class="report-table" style="width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9em; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                                    <thead>
                                        <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                            <th style="padding: 12px 8px; text-align: center; font-weight: 600;">رقم الفاتورة</th>
                                            <th style="padding: 12px 8px; text-align: center; font-weight: 600;">تاريخ الشراء</th>
                                            <th style="padding: 12px 8px; text-align: right; font-weight: 600;">اسم المورد</th>
                                            <th style="padding: 12px 8px; text-align: center; font-weight: 600;">الكمية</th>
                                            <th style="padding: 12px 8px; text-align: center; font-weight: 600;">سعر الشراء</th>
                                            <th style="padding: 12px 8px; text-align: center; font-weight: 600;">إجمالي المبلغ</th>
                                        </tr>
                                    </thead>
                                        <tbody>
                                            ${purchaseDetails.map((detail, index) => {
                                                return `
                                                    <tr style="border-bottom: 1px solid #e9ecef; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                                                        <td style="padding: 10px 8px; text-align: center; color: #495057;">${detail.invoiceId}</td>
                                                        <td style="padding: 10px 8px; text-align: center; color: #495057;">${detail.date}</td>
                                                        <td style="padding: 10px 8px; font-weight: 600; color: #333;">${detail.supplier}</td>
                                                        <td style="padding: 10px 8px; text-align: center; color: #495057;">${detail.quantity.toLocaleString()}</td>
                                                        <td style="padding: 10px 8px; text-align: center; color: #495057;">${formatCurrency(detail.price)}</td>
                                                        <td style="padding: 10px 8px; text-align: center; font-weight: 600; color: #2e7d32;">${formatCurrency(detail.amount)}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    <tfoot>
                                        <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-top: 2px solid #667eea;">
                                            <td style="padding: 12px 8px; font-weight: bold; color: #333;" colspan="2">الإجمالي</td>
                                            <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #333;">${purchaseDetails.length} فاتورة</td>
                                            <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #333;">${totalQuantity.toLocaleString()}</td>
                                            <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #667eea;">${formatCurrency(averagePrice)}</td>
                                            <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #2e7d32; font-size: 1.1em;">${formatCurrency(totalPurchases)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            ` : `
                                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; margin: 20px 0;">
                                    <i class="fas fa-inbox" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i>
                                    <h4 style="color: #666; margin-bottom: 10px;">لا توجد مشتريات لعرضها</h4>
                                    <p style="color: #999; font-size: 0.9em;">لم يتم العثور على أي مشتريات للمنتج المحدد في الفترة المحددة</p>
                                </div>
                            `}
                        </div>

                        <!-- ملخص إضافي -->
                        ${purchaseDetails.length > 0 ? `
                            <div style="margin-top: 25px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px; padding: 20px;">
                                <h3 style="color: #333; margin-bottom: 15px; font-size: 1.2em; text-align: center;">📊 ملخص المشتريات</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                                    <div>
                                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">إجمالي الكمية المشتراة</div>
                                        <div style="font-size: 1.3em; font-weight: bold; color: #28a745;">${totalQuantity.toLocaleString()} وحدة</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">متوسط سعر الشراء</div>
                                        <div style="font-size: 1.3em; font-weight: bold; color: #667eea;">${formatCurrency(averagePrice)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">متوسط قيمة الفاتورة</div>
                                        <div style="font-size: 1.3em; font-weight: bold; color: #ffc107;">${formatCurrency(averageInvoiceAmount)}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء تقرير المشتريات حسب المنتج:', error);
                return `
                    <div style="text-align: center; padding: 40px; color: #dc3545; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px; color: #dc3545;"></i>
                        <h3 style="color: #dc3545; margin-bottom: 15px;">خطأ في إنشاء التقرير</h3>
                        <p style="color: #666; margin-bottom: 20px;">${error.message}</p>
                        <button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-redo" style="margin-left: 8px;"></i>
                            إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }





        function createLowStockReport(currentDate, filters = {}) {
            console.log('⚠️ إنشاء تقرير النواقص...', { currentDate, filters });

            // التأكد من وجود النظام المركزي
            if (!window.dataManager) {
                console.log('🔄 تهيئة النظام المركزي...');
                window.dataManager = new DataManager();
            }

            // الحصول على المنتجات من النظام المركزي
            let products = window.dataManager.getProducts();
            console.log('📦 عدد المنتجات في النظام قبل الفلترة:', products.length);

            // تطبيق فلتر المنتج المحدد
            if (filters.account && filters.account !== '') {
                console.log('🔍 تطبيق فلتر المنتج:', filters.account, typeof filters.account);

                products = products.filter(product => {
                    const matchById = String(product.id) === String(filters.account);
                    const matchByName = product.name === filters.account;
                    const matchByCode = product.code === filters.account;

                    return matchById || matchByName || matchByCode;
                });
                console.log('📦 عدد المنتجات بعد الفلترة:', products.length);
            }

            // فلترة المنتجات لإظهار النواقص فقط
            const lowStockProducts = products.filter(product => {
                const currentStock = product.quantity || 0;
                const minQuantity = product.minQuantity || 5;
                return currentStock <= minQuantity;
            });

            console.log('⚠️ عدد المنتجات الناقصة:', lowStockProducts.length);

            // بناء صفوف الجدول
            let tableRows = '';
            if (lowStockProducts.length === 0) {
                const message = filters.account ?
                    'المنتج المحدد ليس ناقصاً' :
                    'لا توجد منتجات ناقصة';

                tableRows = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px; color: #28a745;"></i>
                            <br>
                            <strong>${message}</strong>
                            <br>
                            <small>جميع المنتجات فوق الحد الأدنى</small>
                        </td>
                    </tr>
                `;
            } else {
                lowStockProducts.forEach(product => {
                    const currentStock = product.quantity || 0;
                    const minQuantity = product.minQuantity || 5;

                    let statusClass = '';
                    let statusText = '';

                    if (currentStock === 0) {
                        statusClass = 'status-critical';
                        statusText = 'نفد';
                    } else if (currentStock <= minQuantity) {
                        statusClass = 'status-warning';
                        statusText = 'منخفض';
                    }

                    tableRows += `
                        <tr>
                            <td><strong>${product.name}</strong></td>
                            <td>${currentStock}</td>
                            <td>${minQuantity}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
            }

            return `
                <div class="report-container">
                    <div class="report-header">
                        <p>كما في ${currentDate}</p>
                        ${filters.account ? `<p><strong>المنتج:</strong> ${products.find(p => String(p.id) === String(filters.account) || p.name === filters.account)?.name || filters.account}</p>` : ''}
                    </div>
                    <div class="report-content">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>المخزون الحالي</th>
                                    <th>الحد الأدنى</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function createStockValuationReport(currentDate, filters = {}) {
            console.log('💰 إنشاء تقرير تقييم المخزون...', { currentDate, filters });

            // إصلاح التاريخ إذا كان null
            if (!currentDate || currentDate === 'null') {
                currentDate = new Date().toLocaleDateString('ar-EG');
            }

            // التأكد من وجود النظام المركزي
            if (!window.dataManager) {
                console.log('🔄 تهيئة النظام المركزي...');
                window.dataManager = new DataManager();
            }

            // الحصول على المنتجات من النظام المركزي
            let products = window.dataManager.getProducts();
            console.log('📦 عدد المنتجات في النظام قبل الفلترة:', products.length);

            // تطبيق فلتر المنتج المحدد
            if (filters.account && filters.account !== '') {
                console.log('🔍 تطبيق فلتر المنتج:', filters.account, typeof filters.account);
                console.log('📋 عينة من المنتجات قبل الفلترة:', products.slice(0, 2).map(p => ({
                    id: p.id,
                    name: p.name,
                    code: p.code,
                    idType: typeof p.id
                })));

                products = products.filter(product => {
                    const matchById = String(product.id) === String(filters.account);
                    const matchByName = product.name === filters.account;
                    const matchByCode = product.code === filters.account;

                    console.log(`🔍 فحص المنتج ${product.name}:`, {
                        productId: product.id,
                        filterId: filters.account,
                        matchById,
                        matchByName,
                        matchByCode
                    });

                    return matchById || matchByName || matchByCode;
                });
                console.log('📦 عدد المنتجات بعد الفلترة:', products.length);

                if (products.length > 0) {
                    console.log('✅ المنتجات المطابقة:', products.map(p => p.name));
                }
            }

            // التحقق من وجود منتجات
            if (products.length === 0) {
                return `
                    <div class="report-container">
                        <div class="report-header">
                        </div>
                        <div class="report-content">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                ${filters.account ? 'لا توجد منتجات تطابق الفلتر المحدد' : 'لا توجد منتجات في المخزون'}
                            </p>
                        </div>
                    </div>
                `;
            }

            // حساب التقييمات المختلفة
            let totalCostValue = 0;        // القيمة بسعر التكلفة
            let totalMarketValue = 0;      // القيمة بسعر السوق (البيع)
            let totalPotentialProfit = 0;  // الربح المحتمل
            let fastMovingValue = 0;       // قيمة الأصناف سريعة الحركة
            let slowMovingValue = 0;       // قيمة الأصناف بطيئة الحركة
            let deadStockValue = 0;        // قيمة الأصناف الراكدة

            // تصنيف المنتجات حسب الحركة (افتراضي بناءً على الكمية والحد الأدنى)
            const fastMovingItems = [];
            const slowMovingItems = [];
            const deadStockItems = [];

            // بناء صفوف الجدول وحساب التقييمات
            let tableRows = '';

            products.forEach(item => {
                const productName = item.name || 'غير محدد';
                const currentStock = item.quantity || 0;
                const purchasePrice = item.purchasePrice || 0;
                const salePrice = item.salePrice || 0;
                const minStock = item.minQuantity || 5;

                const costValue = currentStock * purchasePrice;
                const marketValue = currentStock * salePrice;
                const potentialProfit = marketValue - costValue;
                const profitMargin = marketValue > 0 ? ((potentialProfit / marketValue) * 100) : 0;

                // تصنيف حسب الحركة
                let movementCategory = '';
                let movementClass = '';

                if (currentStock === 0) {
                    movementCategory = 'راكد';
                    movementClass = 'status-critical';
                    deadStockValue += costValue;
                    deadStockItems.push(item);
                } else if (currentStock > minStock * 2) {
                    movementCategory = 'بطيء';
                    movementClass = 'status-warning';
                    slowMovingValue += costValue;
                    slowMovingItems.push(item);
                } else {
                    movementCategory = 'سريع';
                    movementClass = 'status-good';
                    fastMovingValue += costValue;
                    fastMovingItems.push(item);
                }

                // إضافة للمجاميع
                totalCostValue += costValue;
                totalMarketValue += marketValue;
                totalPotentialProfit += potentialProfit;

                tableRows += `
                    <tr>
                        <td><strong>${productName}</strong></td>
                        <td>${currentStock}</td>
                        <td>${formatNumber(purchasePrice)}</td>
                        <td>${formatNumber(salePrice)}</td>
                        <td>${formatNumber(costValue)}</td>
                        <td>${formatNumber(marketValue)}</td>
                        <td>${formatNumber(potentialProfit)}</td>
                        <td>${formatNumber(profitMargin)}%</td>
                        <td><span class="${movementClass}">${movementCategory}</span></td>
                    </tr>
                `;
            });

            // إضافة صف الإجمالي
            const totalProfitMargin = totalMarketValue > 0 ? ((totalPotentialProfit / totalMarketValue) * 100) : 0;
            tableRows += `
                <tr class="total" style="background-color: #f8f9fa; font-weight: bold;">
                    <td><strong>الإجمالي</strong></td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td><strong>${formatNumber(totalCostValue)}</strong></td>
                    <td><strong>${formatNumber(totalMarketValue)}</strong></td>
                    <td><strong>${formatNumber(totalPotentialProfit)}</strong></td>
                    <td><strong>${formatNumber(totalProfitMargin)}%</strong></td>
                    <td>-</td>
                </tr>
            `;

            return `
                <div class="report-container">
                    <div class="report-header">
                    </div>
                    <div class="report-content">
                        <!-- جدول التفاصيل -->
                        <div>
                            <h3>تفاصيل تقييم المخزون</h3>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>اسم الصنف</th>
                                        <th>الكمية</th>
                                        <th>سعر التكلفة</th>
                                        <th>سعر البيع</th>
                                        <th>قيمة التكلفة</th>
                                        <th>قيمة السوق</th>
                                        <th>الربح المحتمل</th>
                                        <th>هامش الربح</th>
                                        <th>حركة المخزون</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>

                        <!-- توصيات -->
                        <div style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                            <h3>التوصيات</h3>
                            <ul style="margin: 10px 0; padding-right: 20px;">
                                ${deadStockItems.length > 0 ? `<li style="color: #dc3545;">يوجد ${deadStockItems.length} صنف راكد بقيمة ${formatNumber(deadStockValue)} ر.س - يُنصح بمراجعة هذه الأصناف</li>` : ''}
                                ${slowMovingItems.length > 0 ? `<li style="color: #ffc107;">يوجد ${slowMovingItems.length} صنف بطيء الحركة بقيمة ${formatNumber(slowMovingValue)} ر.س - قد تحتاج لخطة تسويقية</li>` : ''}
                                ${totalProfitMargin < 20 ? `<li style="color: #ffc107;">هامش الربح الإجمالي ${formatNumber(totalProfitMargin)}% منخفض - يُنصح بمراجعة الأسعار</li>` : ''}
                                ${totalProfitMargin >= 20 ? `<li style="color: #28a745;">هامش الربح الإجمالي ${formatNumber(totalProfitMargin)}% جيد</li>` : ''}
                                <li style="color: #17a2b8;">إجمالي قيمة المخزون: ${formatNumber(totalMarketValue)} ر.س</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }







        function createSupplierListReport(dateRange, filters) {
            console.log('🏭 إنشاء قائمة الموردين...');

            try {
                const suppliersData = generateSuppliersReport();

                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>قائمة الموردين</h2>
                            <p>كما في ${dateRange}</p>
                        </div>
                        <div class="report-content">
                            <div class="summary-cards">
                                <div class="summary-card">
                                    <h3>إجمالي الموردين</h3>
                                    <p class="amount">${suppliersData.totalSuppliers}</p>
                                </div>
                                <div class="summary-card">
                                    <h3>الموردين النشطين</h3>
                                    <p class="amount">${suppliersData.activeSuppliers}</p>
                                </div>
                                <div class="summary-card">
                                    <h3>إجمالي المشتريات</h3>
                                    <p class="amount">${formatCurrency(suppliersData.totalPurchaseValue)}</p>
                                </div>
                                <div class="summary-card">
                                    <h3>متوسط المشتريات</h3>
                                    <p class="amount">${formatCurrency(suppliersData.totalSuppliers > 0 ? suppliersData.totalPurchaseValue / suppliersData.totalSuppliers : 0)}</p>
                                </div>
                            </div>

                            <div style="margin-top: 30px;">
                                <h3>تفاصيل الموردين</h3>
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>اسم المورد</th>
                                            <th>الهاتف</th>
                                            <th>البريد الإلكتروني</th>
                                            <th>إجمالي المشتريات</th>
                                            <th>عدد الفواتير</th>
                                            <th>آخر شراء</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${suppliersData.suppliers.map(supplier => `
                                            <tr>
                                                <td>${supplier.name}</td>
                                                <td>${supplier.phone || 'غير محدد'}</td>
                                                <td>${supplier.email || 'غير محدد'}</td>
                                                <td>${formatCurrency(supplier.totalPurchases)}</td>
                                                <td>${supplier.purchaseCount}</td>
                                                <td>${supplier.lastPurchaseDate ?
                                                    new Date(supplier.lastPurchaseDate).toLocaleDateString('ar-SA') :
                                                    'لا يوجد'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء قائمة الموردين:', error);
                return `<div class="report-container"><div class="report-header"><h2>قائمة الموردين</h2></div><div class="report-content"><div class="error" style="text-align: center; padding: 40px; color: #dc3545;"><h3>خطأ في إنشاء التقرير</h3><p>${error.message}</p></div></div></div>`;
            }
        }

        function createSupplierBalancesReport(dateRange, filters) {
            console.log('💰 إنشاء أرصدة الموردين...');

            try {
                const suppliersData = generateSuppliersReport();

                // حساب الأرصدة (المشتريات الآجلة)
                const supplierBalances = suppliersData.suppliers.map(supplier => {
                    const supplierPurchases = purchases.filter(p => p.supplierId === supplier.id);
                    const creditPurchases = supplierPurchases
                        .filter(p => (p.paymentMethod || p.payment) === 'آجل' || (p.paymentMethod || p.payment) === 'credit')
                        .reduce((sum, p) => sum + parseFloat(p.total || 0), 0);
                    
                    return {
                        ...supplier,
                        balance: creditPurchases,
                        status: creditPurchases > 0 ? (creditPurchases > 10000 ? 'مرتفع' : 'عادي') : 'مسدد'
                    };
                }).filter(supplier => supplier.balance > 0);

                const totalBalance = supplierBalances.reduce((sum, supplier) => sum + supplier.balance, 0);

                return `
                    <div class="report-container">
                        <div class="report-header">
                            <h2>أرصدة الموردين</h2>
                            <p>كما في ${dateRange}</p>
                        </div>
                        <div class="report-content">
                            <div class="summary-cards">
                                <div class="summary-card">
                                    <h3>إجمالي المديونية</h3>
                                    <p class="amount">${formatCurrency(totalBalance)}</p>
                                </div>
                                <div class="summary-card">
                                    <h3>عدد الموردين المدينين</h3>
                                    <p class="amount">${supplierBalances.length}</p>
                                </div>
                                <div class="summary-card">
                                    <h3>متوسط الرصيد</h3>
                                    <p class="amount">${formatCurrency(supplierBalances.length > 0 ? totalBalance / supplierBalances.length : 0)}</p>
                                </div>
                                <div class="summary-card">
                                    <h3>أعلى رصيد</h3>
                                    <p class="amount">${formatCurrency(supplierBalances.length > 0 ? Math.max(...supplierBalances.map(s => s.balance)) : 0)}</p>
                                </div>
                            </div>

                            <div style="margin-top: 30px;">
                                <h3>تفاصيل أرصدة الموردين</h3>
                                ${supplierBalances.length > 0 ? `
                                    <table class="report-table">
                                        <thead>
                                            <tr>
                                                <th>اسم المورد</th>
                                                <th>الهاتف</th>
                                                <th>الرصيد المستحق (ر.س)</th>
                                                <th>الحالة</th>
                                                <th>آخر شراء</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${supplierBalances.map(supplier => `
                                                <tr>
                                                    <td>${supplier.name}</td>
                                                    <td>${supplier.phone || 'غير محدد'}</td>
                                                    <td>${formatCurrency(supplier.balance)}</td>
                                                    <td>
                                                        <span class="status-${supplier.status === 'مرتفع' ? 'out' : supplier.status === 'عادي' ? 'low' : 'available'}">
                                                            ${supplier.status}
                                                        </span>
                                                    </td>
                                                    <td>${supplier.lastPurchaseDate ?
                                                        new Date(supplier.lastPurchaseDate).toLocaleDateString('ar-SA') :
                                                        'لا يوجد'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<p style="text-align: center; color: #666; padding: 20px;">جميع الموردين مسددين</p>'}
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('❌ خطأ في إنشاء أرصدة الموردين:', error);
                return `<div class="report-container"><div class="report-header"><h2>أرصدة الموردين</h2></div><div class="report-content"><div class="error" style="text-align: center; padding: 40px; color: #dc3545;"><h3>خطأ في إنشاء التقرير</h3><p>${error.message}</p></div></div></div>`;
            }
        }

        function createSupplierAnalysisReport(dateRange, filters) {
            return createSupplierListReport(dateRange, filters);
        }

        // دالة إنشاء تقرير إغلاق اليوم المدمج
        function createEndOfDayReportRedirect(dateRange, filters = {}) {
            console.log('🌙 إنشاء تقرير إغلاق اليوم المدمج...', { dateRange, filters });

            // تطبيق فلتر التاريخ على البيانات
            let endOfDayData = null;
            let dateInfo = '';

            if (dateRange && dateRange.from && dateRange.to) {
                console.log('📅 تطبيق فلتر التاريخ على تقرير إغلاق اليوم:', dateRange);
                const fromDate = new Date(dateRange.from);
                const toDate = new Date(dateRange.to);

                // تنسيق التاريخ للعرض
                const fromDateFormatted = `${fromDate.getDate().toString().padStart(2, '0')}/${(fromDate.getMonth() + 1).toString().padStart(2, '0')}/${fromDate.getFullYear()}`;
                const toDateFormatted = `${toDate.getDate().toString().padStart(2, '0')}/${(toDate.getMonth() + 1).toString().padStart(2, '0')}/${toDate.getFullYear()}`;

                if (fromDateFormatted === toDateFormatted) {
                    dateInfo = fromDateFormatted;
                } else {
                    dateInfo = `${fromDateFormatted} - ${toDateFormatted}`;
                }

                // تحويل التاريخ إلى تنسيق ISO للاستخدام الصحيح في generateEndOfDayReport
                const isoDate = fromDate.toISOString().split('T')[0];
                endOfDayData = generateEndOfDayReport(isoDate);
                console.log('📊 تم إنشاء تقرير إغلاق اليوم للتاريخ:', isoDate);
            } else {
                // استخدام اليوم الحالي كافتراضي
                const today = new Date();
                dateInfo = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
                endOfDayData = generateEndOfDayReport();
                console.log('📊 تم إنشاء تقرير إغلاق اليوم لليوم الحالي');
            }

            // إنشاء HTML للتقرير
            let paymentMethodsHTML = '';
            Object.keys(endOfDayData.paymentMethods).forEach(key => {
                const method = endOfDayData.paymentMethods[key];
                if (method.total > 0) {
                    const iconClass = {
                        'cash': 'money-bill-wave',
                        'credit': 'clock',
                        'card': 'credit-card',
                        'bank': 'university',
                        'transfer': 'university'
                    }[key] || 'money-bill-wave';

                    const colorClass = {
                        'cash': '#27ae60',
                        'credit': '#e74c3c',
                        'card': '#3498db',
                        'bank': '#9b59b6',
                        'transfer': '#9b59b6'
                    }[key] || '#667eea';

                    paymentMethodsHTML += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 6px 12px; background: white; border-radius: 4px; border-left: 3px solid ${colorClass}; margin-bottom: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-${iconClass}" style="color: ${colorClass}; font-size: 0.9em;"></i>
                                <span style="font-weight: 500; color: #333; font-size: 0.9em;">${method.name}</span>
                            </div>
                            <div style="text-align: left;">
                                <div style="font-weight: bold; color: #2c3e50; font-size: 0.95em;">${method.total.toFixed(2)} ر.س</div>
                                <div style="font-size: 0.75em; color: #7f8c8d;">${method.count} فاتورة</div>
                            </div>
                        </div>
                    `;
                }
            });

            // إنشاء جدول المعاملات المدمج (آخر 10 فواتير فقط)
            let transactionsHTML = '';
            if (endOfDayData.todaySales && endOfDayData.todaySales.length > 0) {
                // عرض آخر 10 فواتير فقط
                const maxRows = 10;
                const displaySales = endOfDayData.todaySales.slice(-maxRows);
                const hasMoreSales = endOfDayData.todaySales.length > maxRows;

                transactionsHTML = `
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                    <th style="padding: 10px 8px; text-align: right;">الفاتورة</th>
                                    <th style="padding: 10px 8px; text-align: right;">العميل</th>
                                    <th style="padding: 10px 8px; text-align: right;">الطريقة</th>
                                    <th style="padding: 10px 8px; text-align: right;">المبلغ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${displaySales.map((sale, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 8px; font-weight: 600; color: #667eea;">#${sale.id}</td>
                                        <td style="padding: 8px; color: #2c3e50;">${sale.customerName || 'عميل نقدي'}</td>
                                        <td style="padding: 8px; color: #64748b;">${getPaymentMethodText(sale.paymentMethod)}</td>
                                        <td style="padding: 8px; font-weight: 600; color: #27ae60;">${formatCurrency(sale.total)}</td>
                                    </tr>
                                `).join('')}
                                ${hasMoreSales ? `
                                    <tr style="background: #e3f2fd; color: #1976d2; text-align: center;">
                                        <td colspan="4" style="padding: 8px; font-size: 0.8em;">
                                            <i class="fas fa-info-circle"></i>
                                            عرض آخر ${displaySales.length} من أصل ${endOfDayData.todaySales.length} فاتورة
                                        </td>
                                    </tr>
                                ` : ''}
                                <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: bold;">
                                    <td colspan="3" style="padding: 10px 8px;"><strong>الإجمالي النهائي</strong></td>
                                    <td style="padding: 10px 8px;"><strong>${formatCurrency(endOfDayData.totalRevenue)}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                transactionsHTML = `
                    <div style="text-align: center; padding: 20px; color: #7f8c8d; background: #f8f9fa; border-radius: 6px;">
                        <i class="fas fa-info-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <h4 style="margin: 0;">لا توجد معاملات لهذا اليوم</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em;">لم يتم تسجيل أي مبيعات اليوم</p>
                    </div>
                `;
            }

            // إنشاء قائمة أفضل المنتجات مبيعاً (أول 3 منتجات فقط)
            let topProductsHTML = '';
            if (endOfDayData.topProductsSold && endOfDayData.topProductsSold.length > 0) {
                const topProducts = endOfDayData.topProductsSold.slice(0, 3); // أول 3 منتجات فقط
                topProductsHTML = topProducts.map((product, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid ${index === 0 ? '#f39c12' : index === 1 ? '#95a5a6' : '#cd6155'};">
                        <div>
                            <div style="font-weight: 600; color: #2c3e50; font-size: 0.9em;">${product.name}</div>
                            <div style="font-size: 0.75em; color: #7f8c8d;">الكمية: ${product.quantitySold}</div>
                        </div>
                        <div style="text-align: left; font-weight: bold; color: #27ae60; font-size: 0.9em;">
                            ${formatCurrency(product.revenue)}
                        </div>
                    </div>
                `).join('');
            } else {
                topProductsHTML = '<div style="text-align: center; color: #7f8c8d; padding: 15px; font-size: 0.9em;">لا توجد بيانات منتجات</div>';
            }

            return `
                <div class="report-container" style="background: white; color: #333; padding: 15px; border-radius: 10px; box-shadow: 0 3px 12px rgba(0,0,0,0.1); max-width: 850px; margin: 0 auto;">
                    <!-- عنوان التقرير -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2 style="color: #333; font-size: 1.5em; margin-bottom: 10px;">
                            <i class="fas fa-moon"></i> تقرير إغلاق ${dateRange && dateRange.from ? 'الفترة' : 'اليوم'}
                        </h2>
                        <p style="color: #666; font-size: 1em; margin: 0;">${dateInfo}</p>
                    </div>

                    <!-- معلومات التقرير -->
                    <div style="background: #f8f9fa; padding: 8px 15px; border-radius: 6px; text-align: center; margin-bottom: 15px; border-left: 3px solid #667eea;">
                        <div style="font-size: 0.85em; color: #666;">
                            <i class="fas fa-calendar-alt"></i> ${new Date().toLocaleDateString('ar-SA-u-ca-islamic')} -
                            <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString('ar-SA')}
                        </div>
                    </div>

                    <!-- الملخص المدمج -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 2px;"><i class="fas fa-chart-line"></i> إجمالي المبيعات</div>
                            <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(endOfDayData.totalRevenue)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #3498db, #5dade2); color: white; padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 2px;"><i class="fas fa-receipt"></i> عدد الفواتير</div>
                            <div style="font-size: 1.2em; font-weight: bold;">${endOfDayData.totalTransactions}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #9b59b6, #bb8fce); color: white; padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 2px;"><i class="fas fa-users"></i> عدد العملاء</div>
                            <div style="font-size: 1.2em; font-weight: bold;">${endOfDayData.uniqueCustomers}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e67e22, #f39c12); color: white; padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.75em; opacity: 0.9; margin-bottom: 2px;"><i class="fas fa-chart-bar"></i> متوسط الفاتورة</div>
                            <div style="font-size: 1.2em; font-weight: bold;">${formatCurrency(endOfDayData.averageTransaction)}</div>
                        </div>
                    </div>

                    <!-- المحتوى في صفين -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <!-- طرق الدفع -->
                        <div>
                            <h3 style="font-size: 0.9em; margin-bottom: 8px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 3px;">
                                <i class="fas fa-credit-card"></i> طرق الدفع
                            </h3>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                ${paymentMethodsHTML}
                            </div>
                        </div>

                        <!-- أفضل المنتجات -->
                        <div>
                            <h3 style="font-size: 0.9em; margin-bottom: 8px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 3px;">
                                <i class="fas fa-star"></i> أفضل المنتجات
                            </h3>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                ${topProductsHTML || '<div style="text-align: center; color: #666; padding: 15px; font-size: 0.85em;">لا توجد بيانات</div>'}
                            </div>
                        </div>
                    </div>

                    <!-- جدول المعاملات المدمج -->
                    <div style="margin-bottom: 12px;">
                        <h3 style="font-size: 0.9em; margin-bottom: 8px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 3px;">
                            <i class="fas fa-list"></i> المعاملات اليومية (آخر 10 فواتير)
                        </h3>
                        ${transactionsHTML}
                    </div>

                    <!-- أزرار العمليات -->
                    <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                        <button onclick="window.print()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.85em; margin: 0 6px;">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                        <button onclick="exportToExcel('end-of-day')" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.85em; margin: 0 6px;">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
            `;
        }

    </script>
    <script src="js/data-manager.js"></script>
    <script src="js/reports.js"></script>
</body>
</html>
